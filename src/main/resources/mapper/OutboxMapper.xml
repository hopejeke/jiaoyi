<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiaoyi.mapper.OutboxMapper">
    
    <resultMap id="OutboxResultMap" type="com.jiaoyi.entity.Outbox">
        <id property="id" column="id"/>
        <result property="shardId" column="shard_id"/>
        <result property="topic" column="topic"/>
        <result property="tag" column="tag"/>
        <result property="messageKey" column="message_key"/>
        <result property="messageBody" column="message_body"/>
        <result property="status" column="status" 
                typeHandler="com.jiaoyi.handler.OutboxStatusTypeHandler"/>
        <result property="retryCount" column="retry_count"/>
        <result property="errorMessage" column="error_message"/>
        <result property="createdAt" column="created_at"/>
        <result property="sentAt" column="sent_at"/>
    </resultMap>
    
    <insert id="insert" parameterType="com.jiaoyi.entity.Outbox" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO outbox (
            shard_id, topic, tag, message_key, message_body, status, retry_count, error_message, created_at, sent_at
        ) VALUES (
            #{shardId},
            #{topic}, 
            #{tag}, 
            #{messageKey}, 
            #{messageBody}, 
            #{status, typeHandler=com.jiaoyi.handler.OutboxStatusTypeHandler}, 
            #{retryCount}, 
            #{errorMessage}, 
            #{createdAt}, 
            #{sentAt}
        )
    </insert>
    
    <select id="selectById" resultMap="OutboxResultMap">
        SELECT * FROM outbox WHERE id = #{id}
    </select>
    
    <!-- 固定分片模式：根据分片ID列表查询数据 -->
    <!-- 使用固定分片数量，每个节点处理多个分片 -->
    <!-- 查询方式：WHERE shard_id IN (0,3,6,9) 可以使用索引，性能更好 -->
    <select id="selectPendingMessagesByShard" resultMap="OutboxResultMap">
        SELECT * FROM outbox 
        WHERE status = 'PENDING' 
          AND shard_id IN
          <foreach collection="shardIds" item="shardId" open="(" separator="," close=")">
              #{shardId}
          </foreach>
        ORDER BY created_at ASC 
        LIMIT #{limit}
    </select>
    
    <update id="updateStatusToSent">
        UPDATE outbox 
        SET status = 'SENT',
            sent_at = #{sentAt}
        WHERE id = #{id}
    </update>
    
    <update id="updateStatusToFailed">
        UPDATE outbox 
        SET status = 'FAILED',
            error_message = #{errorMessage},
            retry_count = #{retryCount}
        WHERE id = #{id}
    </update>
    
    <update id="incrementRetryCount">
        UPDATE outbox 
        SET retry_count = retry_count + 1
        WHERE id = #{id}
    </update>
    
    <update id="updateShardId">
        UPDATE outbox 
        SET shard_id = #{shardId}
        WHERE id = #{id}
    </update>
    
</mapper>

