<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiaoyi.product.mapper.primary.PoiItemStockMapper">
    
    <resultMap id="BaseResultMap" type="com.jiaoyi.product.entity.PoiItemStock">
        <id column="id" property="id"/>
        <result column="brand_id" property="brandId"/>
        <result column="store_id" property="storeId"/>
        <result column="object_type" property="objectType"/>
        <result column="object_id" property="objectId"/>
        <result column="stock_status" property="stockStatus"/>
        <result column="stock_type" property="stockType"/>
        <result column="plan_quantity" property="planQuantity"/>
        <result column="real_quantity" property="realQuantity"/>
        <result column="auto_restore_type" property="autoRestoreType"/>
        <result column="auto_restore_at" property="autoRestoreAt"/>
        <result column="shared_pool_quantity" property="sharedPoolQuantity"/>
        <result column="last_manual_set_time" property="lastManualSetTime"/>
        <result column="allocation_mode" property="allocationMode"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>
    
    <select id="selectByBrandIdAndStoreIdAndObjectId" resultMap="BaseResultMap">
        SELECT * FROM poi_item_stock
        WHERE brand_id = #{brandId}
          AND store_id = #{storeId}
          AND object_id = #{objectId}
        LIMIT 1
    </select>
    
    <select id="selectByIdForUpdate" resultMap="BaseResultMap">
        SELECT * FROM poi_item_stock
        WHERE id = #{id}
        FOR UPDATE
    </select>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO poi_item_stock (
            brand_id, store_id, object_type, object_id,
            stock_status, stock_type, plan_quantity, real_quantity,
            auto_restore_type, auto_restore_at,
            shared_pool_quantity, last_manual_set_time, allocation_mode,
            created_at, updated_at
        ) VALUES (
            #{brandId}, #{storeId}, #{objectType}, #{objectId},
            #{stockStatus}, #{stockType}, #{planQuantity}, #{realQuantity},
            #{autoRestoreType}, #{autoRestoreAt},
            #{sharedPoolQuantity}, #{lastManualSetTime}, #{allocationMode},
            #{createdAt}, #{updatedAt}
        )
    </insert>
    
    <update id="updateStock">
        UPDATE poi_item_stock
        SET stock_status = #{stockStatus},
            stock_type = #{stockType},
            plan_quantity = #{planQuantity},
            real_quantity = #{realQuantity},
            auto_restore_type = #{autoRestoreType},
            auto_restore_at = #{autoRestoreAt},
            updated_at = #{updatedAt}
        WHERE id = #{id}
          AND brand_id = #{brandId}
          AND store_id = #{storeId}
          AND updated_at = #{oldUpdatedAt}
    </update>
    
    <!-- 原子扣减库存（相对变更） -->
    <update id="atomicDeduct">
        UPDATE poi_item_stock
        SET real_quantity = real_quantity - #{delta},
            updated_at = NOW()
        WHERE id = #{id}
          AND real_quantity >= #{delta}
    </update>
    
    <!-- 原子扣减共享池库存 -->
    <update id="atomicDeductSharedPool">
        UPDATE poi_item_stock
        SET shared_pool_quantity = shared_pool_quantity - #{delta},
            real_quantity = real_quantity - #{delta},
            updated_at = NOW()
        WHERE id = #{id}
          AND shared_pool_quantity >= #{delta}
    </update>
    
    <!-- 强制更新库存值（绝对设置冲突合并后） -->
    <update id="forceUpdateQuantity">
        UPDATE poi_item_stock
        SET real_quantity = #{realQuantity},
            last_manual_set_time = #{lastManualSetTime},
            stock_status = CASE WHEN #{realQuantity} &lt;= 0 THEN 2 ELSE 1 END,
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>
    
    <!-- 更新库存状态 -->
    <update id="updateStockStatus">
        UPDATE poi_item_stock
        SET stock_status = #{stockStatus},
            real_quantity = CASE WHEN #{stockStatus} = 2 THEN 0 ELSE real_quantity END,
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>
    
    <!-- 更新共享池库存 -->
    <update id="updateSharedPoolQuantity">
        UPDATE poi_item_stock
        SET shared_pool_quantity = #{sharedPoolQuantity},
            updated_at = NOW()
        WHERE id = #{id}
    </update>
    
    <select id="selectByBrandIdAndStoreId" resultMap="BaseResultMap">
        SELECT * FROM poi_item_stock
        WHERE brand_id = #{brandId}
          AND store_id = #{storeId}
        ORDER BY id DESC
    </select>

    <update id="atomicReturnToSharedPool">
        UPDATE poi_item_stock
        SET shared_pool_quantity = shared_pool_quantity + #{qty},
            real_quantity = real_quantity + #{qty},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <update id="atomicIncreaseRealQuantity">
        UPDATE poi_item_stock
        SET real_quantity = real_quantity + #{qty},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 带安全线底线的原子扣减：扣减后 real_quantity 不能低于 safetyFloor（方案二 SAFETY_STOCK） -->
    <update id="atomicDeductWithFloor">
        UPDATE poi_item_stock
        SET real_quantity = real_quantity - #{delta},
            updated_at = NOW()
        WHERE id = #{id}
          AND real_quantity >= #{delta}
          AND (real_quantity - #{delta}) >= #{safetyFloor}
    </update>

    <update id="updateAllocationMode">
        UPDATE poi_item_stock
        SET allocation_mode = #{allocationMode},
            updated_at = NOW()
        WHERE id = #{id}
    </update>
</mapper>
