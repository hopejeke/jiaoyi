<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiaoyi.product.mapper.primary.PoiItemStockLogMapper">
    
    <resultMap id="BaseResultMap" type="com.jiaoyi.product.entity.PoiItemStockLog">
        <id column="id" property="id"/>
        <result column="brand_id" property="brandId"/>
        <result column="store_id" property="storeId"/>
        <result column="stock_id" property="stockId"/>
        <result column="content" property="content"/>
        <result column="change_type" property="changeType"/>
        <result column="delta" property="delta"/>
        <result column="source" property="source"/>
        <result column="order_id" property="orderId"/>
        <result column="deduct_source" property="deductSource"/>
        <result column="channel_code" property="channelCode"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO poi_item_stock_log (
            brand_id, store_id, stock_id, content,
            change_type, delta, source, order_id,
            deduct_source, channel_code,
            created_at
        ) VALUES (
            #{brandId}, #{storeId}, #{stockId}, #{content},
            #{changeType}, #{delta}, #{source}, #{orderId},
            #{deductSource}, #{channelCode},
            #{createdAt}
        )
    </insert>
    
    <select id="selectByStockId" resultMap="BaseResultMap">
        SELECT * FROM poi_item_stock_log
        WHERE stock_id = #{stockId}
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <select id="selectByBrandIdAndStoreId" resultMap="BaseResultMap">
        SELECT * FROM poi_item_stock_log
        WHERE brand_id = #{brandId}
          AND store_id = #{storeId}
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- 根据订单ID检查是否已存在（幂等性） -->
    <select id="countByOrderId" resultType="int">
        SELECT COUNT(*) FROM poi_item_stock_log
        WHERE order_id = #{orderId}
    </select>
    
    <!-- 计算指定时间之后的 RELATIVE_DELTA 变更总量 -->
    <select id="sumDeltaSince" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(delta), 0) FROM poi_item_stock_log
        WHERE stock_id = #{stockId}
          AND change_type = 'RELATIVE_DELTA'
          AND created_at > #{sinceTime}
    </select>

    <!-- 根据订单ID查询扣减记录（RELATIVE_DELTA 且 delta&lt;0），用于按源头归还 -->
    <select id="selectDeductLogsByOrderId" resultMap="BaseResultMap">
        SELECT * FROM poi_item_stock_log
        WHERE order_id = #{orderId}
          AND change_type = 'RELATIVE_DELTA'
          AND delta &lt; 0
        ORDER BY id
    </select>

    <!-- 是否已有该订单该库存的归还记录（幂等） -->
    <select id="countReturnByOrderIdAndStockId" resultType="int">
        SELECT COUNT(*) FROM poi_item_stock_log
        WHERE order_id = #{orderId}
          AND stock_id = #{stockId}
          AND change_type = 'RETURN'
    </select>

    <!-- 是否已有该订单该库存的扣减记录（按行幂等，支持一单多品） -->
    <select id="countDeductByOrderIdAndStockId" resultType="int">
        SELECT COUNT(*) FROM poi_item_stock_log
        WHERE order_id = #{orderId}
          AND stock_id = #{stockId}
          AND change_type = 'RELATIVE_DELTA'
          AND delta &lt; 0
    </select>
</mapper>
