<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiaoyi.product.mapper.primary.PoiItemStockLogMapper">
    
    <resultMap id="BaseResultMap" type="com.jiaoyi.product.entity.PoiItemStockLog">
        <id column="id" property="id"/>
        <result column="brand_id" property="brandId"/>
        <result column="poi_id" property="poiId"/>
        <result column="stock_id" property="stockId"/>
        <result column="content" property="content"/>
        <result column="change_type" property="changeType"/>
        <result column="delta" property="delta"/>
        <result column="source" property="source"/>
        <result column="order_id" property="orderId"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO poi_item_stock_log (
            brand_id, poi_id, stock_id, content,
            change_type, delta, source, order_id,
            created_at
        ) VALUES (
            #{brandId}, #{poiId}, #{stockId}, #{content},
            #{changeType}, #{delta}, #{source}, #{orderId},
            #{createdAt}
        )
    </insert>
    
    <select id="selectByStockId" resultMap="BaseResultMap">
        SELECT * FROM poi_item_stock_log
        WHERE stock_id = #{stockId}
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <select id="selectByBrandIdAndPoiId" resultMap="BaseResultMap">
        SELECT * FROM poi_item_stock_log
        WHERE brand_id = #{brandId}
          AND poi_id = #{poiId}
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- 根据订单ID检查是否已存在（幂等性） -->
    <select id="countByOrderId" resultType="int">
        SELECT COUNT(*) FROM poi_item_stock_log
        WHERE order_id = #{orderId}
    </select>
    
    <!-- 计算指定时间之后的 RELATIVE_DELTA 变更总量 -->
    <select id="sumDeltaSince" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(delta), 0) FROM poi_item_stock_log
        WHERE stock_id = #{stockId}
          AND change_type = 'RELATIVE_DELTA'
          AND created_at > #{sinceTime}
    </select>
    
</mapper>
