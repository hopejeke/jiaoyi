<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiaoyi.product.mapper.primary.OversellRecordMapper">
    
    <resultMap id="BaseResultMap" type="com.jiaoyi.product.entity.OversellRecord">
        <id column="id" property="id"/>
        <result column="brand_id" property="brandId"/>
        <result column="store_id" property="storeId"/>
        <result column="stock_id" property="stockId"/>
        <result column="object_id" property="objectId"/>
        <result column="oversell_quantity" property="oversellQuantity"/>
        <result column="source" property="source"/>
        <result column="status" property="status"/>
        <result column="resolved_by" property="resolvedBy"/>
        <result column="resolved_at" property="resolvedAt"/>
        <result column="remark" property="remark"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO oversell_record (
            brand_id, store_id, stock_id, object_id,
            oversell_quantity, source, status, remark, created_at
        ) VALUES (
            #{brandId}, #{storeId}, #{stockId}, #{objectId},
            #{oversellQuantity}, #{source}, #{status}, #{remark}, NOW()
        )
    </insert>
    
    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM oversell_record WHERE id = #{id}
    </select>
    
    <select id="selectByBrandIdAndStoreId" resultMap="BaseResultMap">
        SELECT * FROM oversell_record
        WHERE brand_id = #{brandId}
          AND store_id = #{storeId}
        <if test="status != null">
          AND status = #{status}
        </if>
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <update id="updateStatus">
        UPDATE oversell_record
        SET status = #{status},
            resolved_by = #{resolvedBy},
            resolved_at = NOW(),
            remark = #{remark}
        WHERE id = #{id}
    </update>
    
</mapper>
