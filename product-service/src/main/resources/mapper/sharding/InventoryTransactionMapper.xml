<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiaoyi.product.mapper.sharding.InventoryTransactionMapper">

    <!-- 结果映射 -->
    <resultMap id="InventoryTransactionResultMap" type="com.jiaoyi.product.entity.InventoryTransaction">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="order_id" property="orderId"/>
        <result column="transaction_type" property="transactionType"/>
        <result column="quantity" property="quantity"/>
        <result column="before_stock" property="beforeStock"/>
        <result column="after_stock" property="afterStock"/>
        <result column="before_locked" property="beforeLocked"/>
        <result column="after_locked" property="afterLocked"/>
        <result column="remark" property="remark"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- 插入库存变动记录 -->
    <insert id="insert" parameterType="com.jiaoyi.product.entity.InventoryTransaction" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO inventory_transactions (
            product_id, order_id, transaction_type, quantity, before_stock, after_stock,
            before_locked, after_locked, remark, create_time
        ) VALUES (
            #{productId}, #{orderId}, #{transactionType}, #{quantity}, #{beforeStock}, #{afterStock},
            #{beforeLocked}, #{afterLocked}, #{remark}, #{createTime}
        )
    </insert>

    <!-- 根据商品ID查询变动记录 -->
    <select id="selectByProductId" parameterType="long" resultMap="InventoryTransactionResultMap">
        SELECT * FROM inventory_transactions 
        WHERE product_id = #{productId} 
        ORDER BY create_time DESC
    </select>

    <!-- 根据订单ID查询变动记录 -->
    <select id="selectByOrderId" parameterType="long" resultMap="InventoryTransactionResultMap">
        SELECT * FROM inventory_transactions 
        WHERE order_id = #{orderId} 
        ORDER BY create_time DESC
    </select>

    <!-- 统计商品总入库数量 -->
    <select id="sumInQuantityByProductId" parameterType="long" resultType="long">
        SELECT COALESCE(SUM(quantity), 0) FROM inventory_transactions 
        WHERE product_id = #{productId} AND transaction_type = 'IN'
    </select>

    <!-- 统计商品总出库数量 -->
    <select id="sumOutQuantityByProductId" parameterType="long" resultType="long">
        SELECT COALESCE(SUM(quantity), 0) FROM inventory_transactions 
        WHERE product_id = #{productId} AND transaction_type = 'OUT'
    </select>

</mapper>

