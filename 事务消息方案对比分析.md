# äº‹åŠ¡æ¶ˆæ¯æ–¹æ¡ˆå¯¹æ¯”åˆ†æï¼šOutbox vs QMQ vs RocketMQ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥å¯¹æ¯”ä¸‰ç§ä¸»æµçš„äº‹åŠ¡æ¶ˆæ¯å®ç°æ–¹æ¡ˆï¼Œåˆ†æå„è‡ªçš„æ¶æ„è®¾è®¡ã€ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ã€‚

**å¯¹æ¯”æ–¹æ¡ˆï¼š**
1. **Outbox Pattern**ï¼ˆå½“å‰é¡¹ç›®ä½¿ç”¨ï¼‰
2. **Ctrip QMQ** äº‹åŠ¡æ¶ˆæ¯
3. **RocketMQ** äº‹åŠ¡æ¶ˆæ¯

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡å¯¹æ¯”

### 1. Outbox Patternï¼ˆå½“å‰é¡¹ç›®ï¼‰

#### æ ¸å¿ƒæœºåˆ¶

```java
@Transactional
public void createOrder(Order order) {
    // 1. å†™å…¥ä¸šåŠ¡æ•°æ®ï¼ˆorders è¡¨ï¼‰
    orderRepository.insert(order);

    // 2. å†™å…¥æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆoutbox è¡¨ï¼Œåœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼‰
    Outbox outbox = Outbox.builder()
        .type("DEDUCT_STOCK_HTTP")
        .bizKey(String.valueOf(order.getId()))
        .payload(payload)
        .shardingKey(String.valueOf(order.getStoreId()))
        .shardId(calculateShardId(order.getStoreId()))
        .status(OutboxStatus.NEW)
        .build();
    outboxRepository.insert(outbox);

    // 3. äº‹åŠ¡æäº¤åç«‹å³è§¦å‘ï¼ˆé€šè¿‡ TransactionSynchronizationï¼‰
    TransactionSynchronizationManager.registerSynchronization(
        new TransactionSynchronization() {
            @Override
            public void afterCommit() {
                taskExecutor.execute(() -> processTaskWithOutbox(outbox));
            }
        }
    );
}

// 4. å¤„ç†ä»»åŠ¡
private void processTaskWithOutbox(Outbox outbox) {
    // 4.1 Claim ä»»åŠ¡ï¼ˆä¹è§‚é”ï¼‰
    outboxRepository.claimByIds(table, shardId, ids, instanceId, lockUntil, now);

    // 4.2 æ‰§è¡Œ handlerï¼ˆHTTP è°ƒç”¨æˆ–å‘é€ MQï¼‰
    handler.handle(outbox);

    // 4.3 æ ‡è®°çŠ¶æ€ä¸º SENT
    outboxRepository.markSent(table, outboxId, instanceId);
}

// 5. è¡¥å¿æœºåˆ¶ï¼šå®šæ—¶æ‰«è¡¨é‡è¯•ï¼ˆæ¯ 60 ç§’ï¼‰
@Scheduled(fixedDelay = 60000)
public void retryFailedTasks() {
    List<Outbox> pendingTasks = outboxRepository.selectCandidatesBySingleShard(...);

    for (Outbox task : pendingTasks) {
        processTask(task.getId(), task.getShardId());
    }
}
```

#### æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE `order_outbox` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `type` VARCHAR(50) NOT NULL,
    `biz_key` VARCHAR(255),
    `payload` TEXT,
    `topic` VARCHAR(100),
    `tag` VARCHAR(50),
    `message_key` VARCHAR(255),
    `sharding_key` VARCHAR(255),  -- é€šç”¨åˆ†ç‰‡é”®ï¼ˆå­˜ store_idï¼‰
    `shard_id` INT NOT NULL,      -- åˆ†ç‰‡ IDï¼ˆ0-1023ï¼Œç”¨äºæ‰«æä¼˜åŒ–ï¼‰
    `store_id` BIGINT,             -- ShardingSphere åˆ†ç‰‡é”®
    `status` VARCHAR(20) NOT NULL, -- NEW/CLAIMED/SENT/FAILED/DEAD
    `retry_count` INT DEFAULT 0,
    `next_retry_time` DATETIME,
    `instance_id` VARCHAR(100),
    `lock_until` DATETIME,
    `create_time` DATETIME NOT NULL,
    `update_time` DATETIME,

    UNIQUE KEY `uk_type_bizkey` (`type`, `biz_key`),
    KEY `idx_status_nextretry` (`status`, `next_retry_time`),
    KEY `idx_shardid_status` (`shard_id`, `status`)
) ENGINE=InnoDB;

-- åˆ†åº“åˆ†è¡¨ï¼š3 åº“ Ã— 32 è¡¨ = 96 å¼ è¡¨
-- åˆ†ç‰‡é”®ï¼šstore_id
-- è·¯ç”±ç®—æ³•ï¼šhash(store_id) % 3 = åº“å·ï¼Œhash(store_id) % 32 = è¡¨å·
```

#### ä¼˜åŒ–äº®ç‚¹

**ä¼˜åŒ–å‰é—®é¢˜ï¼š** `processTask(Long outboxId)` åªä¼  IDï¼Œè§¦å‘å¹¿æ’­æŸ¥è¯¢ï¼ˆ96 æ¬¡ SELECTï¼‰

**ä¼˜åŒ–åæ–¹æ¡ˆï¼š**
1. **äº‹åŠ¡æäº¤åç«‹å³æ‰§è¡Œï¼š** ç›´æ¥ä¼ é€’å®Œæ•´ Outbox å¯¹è±¡ï¼Œ**0 æ¬¡æŸ¥è¯¢**
2. **å®šæ—¶æ‰«è¡¨é‡è¯•ï¼š** ä¼ é€’ `shardId` å‚æ•°ï¼Œ**1 æ¬¡ç²¾å‡†æŸ¥è¯¢**ï¼ˆä¸æ˜¯ 96 æ¬¡ï¼‰
3. **æ€§èƒ½æå‡ï¼š** æ•°æ®åº“ QPS ä» 19,200 â†’ 20ï¼ˆé™ä½ 99.9%ï¼‰

---

### 2. Ctrip QMQ äº‹åŠ¡æ¶ˆæ¯

#### æ ¸å¿ƒæœºåˆ¶

```java
// 1. é…ç½® QMQ ä½¿ç”¨ä¸šåŠ¡æ•°æ®æºï¼ˆå…³é”®ï¼ï¼‰
@Configuration
public class QmqConfig {

    @Bean
    public MessageProducer messageProducer(DataSource dataSource) {
        // QMQ ä½¿ç”¨ä¸šåŠ¡æ•°æ®åº“å­˜å‚¨æ¶ˆæ¯è¡¨
        SpringTransactionProvider transactionProvider =
            new SpringTransactionProvider(dataSource);

        MessageProducerProvider.setTransactionProvider(transactionProvider);
        return MessageProducerProvider.getProducer();
    }
}

// 2. ä¸šåŠ¡ä»£ç å‘é€äº‹åŠ¡æ¶ˆæ¯
@Transactional
public void createOrder(Order order) {
    // 2.1 å†™å…¥ä¸šåŠ¡æ•°æ®ï¼ˆorders è¡¨ï¼‰
    orderRepository.insert(order);

    // 2.2 å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼ˆQMQ ä¼šåœ¨åŒä¸€äº‹åŠ¡ä¸­å†™å…¥ qmq_msg_queue è¡¨ï¼‰
    Message message = messageProducer.generateMessage("order.topic");
    message.setProperty("orderId", order.getId());
    message.setProperty("productIds", productIds);

    // å…³é”®ï¼šsendInTransaction ç¡®ä¿æ¶ˆæ¯æ’å…¥å’Œä¸šåŠ¡æ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­
    messageProducer.sendInTransaction(message, null);

    // 2.3 äº‹åŠ¡æäº¤
    // - å¦‚æœæäº¤æˆåŠŸï¼šQMQ åå°çº¿ç¨‹ä¼šè¯»å– qmq_msg_queue è¡¨ï¼Œå‘é€æ¶ˆæ¯åˆ° Broker
    // - å¦‚æœæäº¤å¤±è´¥ï¼šæ¶ˆæ¯è¡¨è®°å½•å›æ»šï¼Œä¸ä¼šå‘é€
}

// 3. QMQ å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
public class QmqMessageProducer {

    public void sendInTransaction(Message message, Object arg) {
        // 3.1 åºåˆ—åŒ–æ¶ˆæ¯å†…å®¹
        String content = serialize(message);

        // 3.2 æ’å…¥æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆåœ¨ä¸šåŠ¡äº‹åŠ¡ä¸­ï¼‰
        jdbcTemplate.update(
            "INSERT INTO qmq_msg_queue (content, status, create_time, update_time) VALUES (?, 0, NOW(), NOW())",
            content
        );

        // 3.3 æ³¨å†Œäº‹åŠ¡åŒæ­¥å›è°ƒ
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    // æäº¤åé€šçŸ¥ Watchdog çº¿ç¨‹å‘é€æ¶ˆæ¯
                    notifyWatchdog();
                }
            }
        );
    }
}

// 4. Watchdog è¡¥å¿æœºåˆ¶
@Scheduled(fixedDelay = 1000) // æ¯ç§’æ‰«æä¸€æ¬¡
public void scanAndSendMessages() {
    // 4.1 æŸ¥è¯¢å¾…å‘é€çš„æ¶ˆæ¯ï¼ˆstatus = 0ï¼‰
    List<QmqMessage> pendingMessages = jdbcTemplate.query(
        "SELECT * FROM qmq_msg_queue WHERE status = 0 AND error < 5 ORDER BY id LIMIT 100",
        rowMapper
    );

    for (QmqMessage msg : pendingMessages) {
        try {
            // 4.2 å‘é€åˆ° QMQ Broker
            sendToBroker(msg.getContent());

            // 4.3 æ ‡è®°ä¸ºå·²å‘é€ï¼ˆstatus = 1ï¼‰
            jdbcTemplate.update(
                "UPDATE qmq_msg_queue SET status = 1, update_time = NOW() WHERE id = ?",
                msg.getId()
            );
        } catch (Exception e) {
            // 4.4 å‘é€å¤±è´¥ï¼Œå¢åŠ é”™è¯¯è®¡æ•°
            jdbcTemplate.update(
                "UPDATE qmq_msg_queue SET error = error + 1, update_time = NOW() WHERE id = ?",
                msg.getId()
            );
        }
    }
}
```

#### æ•°æ®åº“è¡¨ç»“æ„

```sql
-- QMQ æ¶ˆæ¯è¡¨ï¼ˆåœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­ï¼‰
CREATE TABLE `qmq_msg_queue` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `content` LONGTEXT NOT NULL,       -- åºåˆ—åŒ–åçš„æ¶ˆæ¯å†…å®¹ï¼ˆJSONï¼‰
    `status` SMALLINT NOT NULL DEFAULT 0, -- 0=å¾…å‘é€, 1=å·²å‘é€
    `error` INT NOT NULL DEFAULT 0,    -- å‘é€å¤±è´¥æ¬¡æ•°
    `create_time` DATETIME NOT NULL,
    `update_time` TIMESTAMP NOT NULL,

    KEY `idx_status_error` (`status`, `error`)
) ENGINE=InnoDB;
```

#### æ¶æ„ç‰¹ç‚¹

**ä¸ Outbox çš„ç›¸ä¼¼ä¹‹å¤„ï¼š**
1. **æœ¬åœ°æ¶ˆæ¯è¡¨ï¼š** éƒ½ä½¿ç”¨ä¸šåŠ¡æ•°æ®åº“å­˜å‚¨æ¶ˆæ¯ï¼ˆåœ¨åŒä¸€æ•°æ®åº“ä¸­ï¼‰
2. **æ•°æ®åº“äº‹åŠ¡ï¼š** ä¾èµ– ACID ä¿è¯æ¶ˆæ¯å’Œä¸šåŠ¡æ•°æ®ä¸€è‡´æ€§
3. **è¡¥å¿æœºåˆ¶ï¼š** Watchdog å®šæ—¶æ‰«è¡¨ï¼Œç±»ä¼¼ OutboxCleanupTask
4. **å­˜å‚¨ä½ç½®ï¼š** æ¶ˆæ¯è¡¨éƒ½åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­ï¼ˆqmq_msg_queue å’Œ order_outbox éƒ½åœ¨ä¸šåŠ¡åº“ï¼‰

**ä¸ Outbox çš„çœŸæ­£å·®å¼‚ï¼š**

| å·®å¼‚ç‚¹ | Outboxï¼ˆå½“å‰é¡¹ç›®ï¼‰ | QMQ |
|--------|-------------------|-----|
| **åˆ†åº“åˆ†è¡¨** | âœ… è·Ÿéšä¸šåŠ¡è¡¨åˆ†ç‰‡ï¼ˆæŒ‰ store_idï¼‰ | âŒ é€šå¸¸ä¸åˆ†ç‰‡ï¼ˆå•è¡¨ï¼‰ |
| **å°è£…ç¨‹åº¦** | è‡ªç ”ç»„ä»¶ï¼Œéœ€è‡ªå·±ç»´æŠ¤ | å®Œæ•´ SDKï¼Œå¼€ç®±å³ç”¨ |
| **å‘é€ç›®æ ‡** | HTTP + ä»»æ„ MQï¼ˆçµæ´»ï¼‰ | åªèƒ½å‘é€åˆ° QMQ Broker |
| **æ‰«æé¢‘ç‡** | æ¯ 60 ç§’ | æ¯ 1 ç§’ï¼ˆæ›´æ¿€è¿›ï¼‰ |
| **æ¶ˆæ¯æ ¼å¼** | JSON payloadï¼ˆä¸šåŠ¡è‡ªå®šä¹‰ï¼‰ | åºåˆ—åŒ–åçš„å®Œæ•´ Message å¯¹è±¡ |
| **è¡¨ç»“æ„** | åŒ…å« type/bizKey/shardId ç­‰ä¸šåŠ¡å­—æ®µ | åªæœ‰ content/status/error åŸºç¡€å­—æ®µ |

---

### 3. RocketMQ äº‹åŠ¡æ¶ˆæ¯

#### æ ¸å¿ƒæœºåˆ¶

```java
// 1. å‘é€åŠæ¶ˆæ¯ï¼ˆHalf Messageï¼‰
public void createOrder(CreateOrderRequest request) {
    // 1.1 é¢„ç”Ÿæˆè®¢å• IDï¼ˆå…³é”®ï¼ï¼‰
    Long orderId = snowflakeIdGenerator.nextId(); // æˆ–ä½¿ç”¨ä¸šåŠ¡æµæ°´å·

    // 1.2 æ„é€ åŠæ¶ˆæ¯
    Message message = new Message("order-topic", "deduct-stock", orderId.toString(),
        JSON.toJSONString(deductStockCommand).getBytes());

    // 1.3 å‘é€åŠæ¶ˆæ¯åˆ° RocketMQ Broker
    TransactionSendResult result = rocketMQTemplate.sendMessageInTransaction(
        "order-topic:deduct-stock",
        MessageBuilder.withPayload(deductStockCommand).build(),
        request // ä¼ é€’ç»™æœ¬åœ°äº‹åŠ¡ç›‘å¬å™¨
    );

    // Half Message æ­¤æ—¶å¯¹æ¶ˆè´¹è€…ä¸å¯è§
}

// 2. æœ¬åœ°äº‹åŠ¡ç›‘å¬å™¨
@RocketMQTransactionListener
public class OrderTransactionListener implements RocketMQLocalTransactionListener {

    @Override
    public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) {
        CreateOrderRequest request = (CreateOrderRequest) arg;

        try {
            // 2.1 æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼ˆåˆ›å»ºè®¢å•ï¼‰
            Order order = orderService.createOrderInTransaction(request);

            // 2.2 ä¿å­˜äº‹åŠ¡æ—¥å¿—ï¼ˆç”¨äºåç»­å›æŸ¥ï¼‰
            TransactionLog log = TransactionLog.builder()
                .transactionId(msg.getTransactionId())
                .orderId(order.getId())
                .status("COMMITTED")
                .build();
            transactionLogRepository.insert(log);

            // 2.3 è¿”å› COMMITï¼ˆRocketMQ ä¼šå°†åŠæ¶ˆæ¯è½¬ä¸ºæ­£å¸¸æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å¯è§ï¼‰
            return RocketMQLocalTransactionState.COMMIT;

        } catch (Exception e) {
            // 2.4 å¤±è´¥æ—¶è¿”å› ROLLBACKï¼ˆRocketMQ ä¼šåˆ é™¤åŠæ¶ˆæ¯ï¼‰
            return RocketMQLocalTransactionState.ROLLBACK;
        }
    }

    @Override
    public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {
        // 3. å›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼ˆå½“ Broker é•¿æ—¶é—´æœªæ”¶åˆ°ç¡®è®¤æ—¶è§¦å‘ï¼‰
        String transactionId = msg.getTransactionId();

        TransactionLog log = transactionLogRepository.findByTransactionId(transactionId);

        if (log == null) {
            return RocketMQLocalTransactionState.ROLLBACK;
        }

        if ("COMMITTED".equals(log.getStatus())) {
            return RocketMQLocalTransactionState.COMMIT;
        } else {
            return RocketMQLocalTransactionState.ROLLBACK;
        }
    }
}
```

#### æ•°æ®åº“è¡¨ç»“æ„

```sql
-- RocketMQ äº‹åŠ¡æ—¥å¿—è¡¨ï¼ˆç”¨äºå›æŸ¥ï¼‰
CREATE TABLE `transaction_log` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `transaction_id` VARCHAR(100) NOT NULL UNIQUE, -- RocketMQ äº‹åŠ¡ ID
    `order_id` BIGINT,                            -- ä¸šåŠ¡è®¢å• ID
    `status` VARCHAR(20) NOT NULL,                -- COMMITTED/ROLLBACK
    `create_time` DATETIME NOT NULL,

    KEY `idx_transaction_id` (`transaction_id`)
) ENGINE=InnoDB;
```

#### æ¶æ„ç‰¹ç‚¹

**ä¸ Outbox/QMQ çš„ä¸åŒï¼š**
1. **åŠæ¶ˆæ¯æœºåˆ¶ï¼š** æ¶ˆæ¯å…ˆå‘åˆ° Brokerï¼ˆå¯¹æ¶ˆè´¹è€…ä¸å¯è§ï¼‰ï¼Œè€Œä¸æ˜¯æ•°æ®åº“
2. **å›æŸ¥æœºåˆ¶ï¼š** Broker ä¸»åŠ¨å›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä¸šåŠ¡æ–¹ä¸»åŠ¨è¡¥å¿
3. **ID ç”Ÿæˆé—®é¢˜ï¼š** éœ€è¦é¢„ç”Ÿæˆè®¢å• ID æ‰èƒ½å‘åŠæ¶ˆæ¯ï¼ˆOutbox/QMQ æ— æ­¤é—®é¢˜ï¼‰
4. **ä¾èµ–ç»„ä»¶ï¼š** ä¾èµ– RocketMQ Brokerï¼Œè€Œ Outbox/QMQ åªä¾èµ–æ•°æ®åº“

---

## ğŸ“Š è¯¦ç»†å¯¹æ¯”è¡¨

| ç»´åº¦ | Outbox Pattern | QMQ äº‹åŠ¡æ¶ˆæ¯ | RocketMQ äº‹åŠ¡æ¶ˆæ¯ |
|------|----------------|--------------|-------------------|
| **æ ¸å¿ƒæœºåˆ¶** | æœ¬åœ°æ¶ˆæ¯è¡¨ + è¡¥å¿æ‰«è¡¨ | æœ¬åœ°æ¶ˆæ¯è¡¨ + Watchdog | Half Message + å›æŸ¥ |
| **æ¶ˆæ¯å­˜å‚¨ä½ç½®** | ä¸šåŠ¡æ•°æ®åº“ï¼ˆåˆ†åº“åˆ†è¡¨ï¼‰ | ä¸šåŠ¡æ•°æ®åº“ï¼ˆé€šå¸¸å•è¡¨ï¼‰ | RocketMQ Broker |
| **äº‹åŠ¡ä¿è¯æ–¹å¼** | æ•°æ®åº“ ACID | æ•°æ®åº“ ACID | Broker + å›æŸ¥ |
| **è¡¥å¿æœºåˆ¶** | ä¸šåŠ¡æ–¹å®šæ—¶æ‰«è¡¨ï¼ˆ60sï¼‰ | Watchdog æ‰«è¡¨ï¼ˆ1sï¼‰ | Broker å›æŸ¥ï¼ˆ15sï¼‰ |
| **ID ç”Ÿæˆé—®é¢˜** | âœ… æ— ï¼ˆäº‹åŠ¡å†…ç”Ÿæˆï¼‰ | âœ… æ— ï¼ˆäº‹åŠ¡å†…ç”Ÿæˆï¼‰ | âŒ éœ€é¢„ç”Ÿæˆ ID |
| **æ¶ˆæ¯å¯è§æ€§** | äº‹åŠ¡æäº¤åç«‹å³å¯è§ | äº‹åŠ¡æäº¤åç«‹å³å¯è§ | Half â†’ Commit åå¯è§ |
| **æ”¯æŒçš„å‘é€ç›®æ ‡** | HTTP + ä»»æ„ MQï¼ˆçµæ´»ï¼‰ | MQï¼ˆQMQ Brokerï¼‰ | MQï¼ˆRocketMQ Brokerï¼‰ |
| **åˆ†åº“åˆ†è¡¨æ”¯æŒ** | âœ… éšä¸šåŠ¡è¡¨åˆ†ç‰‡ | âŒ é€šå¸¸ä¸åˆ†ç‰‡ | N/Aï¼ˆä¸åœ¨æ•°æ®åº“ï¼‰ |
| **æ•°æ®åº“å†™å…¥æ¬¡æ•°** | 3 æ¬¡ï¼ˆINSERT + 2 UPDATEï¼‰ | 2 æ¬¡ï¼ˆINSERT + UPDATEï¼‰ | 1 æ¬¡ï¼ˆINSERT äº‹åŠ¡æ—¥å¿—ï¼‰ |
| **å°è£…ç¨‹åº¦** | è‡ªç ”ï¼Œéœ€è‡ªå·±ç»´æŠ¤ | âœ… å®Œæ•´ SDK | âœ… å®Œæ•´ SDK |
| **æ‰©å±•æ€§** | âœ… æ•°æ®åº“åˆ†ç‰‡æ‰©å±• | å—é™äºæ•°æ®åº“å•è¡¨ | âœ… Broker æ°´å¹³æ‰©å±• |
| **é«˜å¯ç”¨** | ä¾èµ–æ•°æ®åº“ä¸»ä» | ä¾èµ–æ•°æ®åº“ä¸»ä» | âœ… Broker é›†ç¾¤ |
| **å»¶è¿Ÿæ¶ˆæ¯** | âŒ éœ€è‡ªè¡Œå®ç° | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **é¡ºåºæ¶ˆæ¯** | âŒ éœ€è‡ªè¡Œå®ç° | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **æ¶ˆæ¯è½¨è¿¹** | âŒ éœ€è‡ªè¡Œå®ç° | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **è¿ç»´æˆæœ¬** | âœ… ä½ï¼ˆå¤ç”¨æ•°æ®åº“ï¼‰ | âœ… ä½ï¼ˆå¤ç”¨æ•°æ®åº“ï¼‰ | âŒ é«˜ï¼ˆéœ€éƒ¨ç½² Brokerï¼‰ |
| **å­¦ä¹ æˆæœ¬** | âœ… ä½ï¼ˆç®€å•æ˜“æ‡‚ï¼‰ | ä¸­ï¼ˆQMQ APIï¼‰ | ä¸­ï¼ˆRocketMQ APIï¼‰ |

---

## ğŸ¯ æ€§èƒ½å¯¹æ¯”åˆ†æ

### åœºæ™¯ï¼šæ—¥è®¢å• 10 ä¸‡ï¼Œé«˜å³°æœŸ 100 è®¢å•/ç§’ï¼Œæ¯è®¢å• 2 ä¸ª Outbox ä»»åŠ¡

#### 1. Outbox Patternï¼ˆå½“å‰é¡¹ç›®ï¼‰

**å†™å…¥å‹åŠ›ï¼š**
```
æ¯ç§’ä»»åŠ¡æ•°ï¼š100 Ã— 2 = 200 ä¸ª/ç§’
æ¯ä¸ªä»»åŠ¡å†™å…¥ï¼šINSERT + UPDATE(claim) + UPDATE(markSent) = 3 æ¬¡å†™å…¥
æ€»æ•°æ®åº“å†™å…¥ï¼š200 Ã— 3 = 600 æ¬¡/ç§’
```

**ä¼˜åŒ–åæŸ¥è¯¢å‹åŠ›ï¼š**
```
äº‹åŠ¡æäº¤åç«‹å³æ‰§è¡Œï¼š200 Ã— 0 = 0 æ¬¡æŸ¥è¯¢/ç§’ï¼ˆç›´æ¥ä¼ å¯¹è±¡ï¼‰
å®šæ—¶æ‰«è¡¨é‡è¯•ï¼ˆå‡è®¾ 1% å¤±è´¥ï¼‰ï¼š2 Ã— 1 = 2 æ¬¡æŸ¥è¯¢/ç§’
æ€»æŸ¥è¯¢ï¼š2 æ¬¡/ç§’
```

**ä¼˜åŒ–å‰æŸ¥è¯¢å‹åŠ›ï¼ˆå¹¿æ’­æŸ¥è¯¢ï¼‰ï¼š**
```
äº‹åŠ¡æäº¤åæŸ¥è¯¢ï¼š200 Ã— 96 = 19,200 æ¬¡/ç§’ï¼ˆå¹¿æ’­åˆ° 96 å¼ è¡¨ï¼‰
å®šæ—¶æ‰«è¡¨æŸ¥è¯¢ï¼š2 Ã— 96 = 192 æ¬¡/ç§’
æ€»æŸ¥è¯¢ï¼š19,392 æ¬¡/ç§’
```

**çº¿ç¨‹æ± å‹åŠ›ï¼š**
```
çº¿ç¨‹æ± é˜Ÿåˆ—å®¹é‡ï¼š100
é«˜å³°æœŸä»»åŠ¡æäº¤é€Ÿç‡ï¼š200 ä¸ª/ç§’
å¦‚æœå¤„ç†é€Ÿåº¦ < 200 ä¸ª/ç§’ï¼Œä¼šè§¦å‘ RejectedExecutionException
æ‹’ç»çš„ä»»åŠ¡ä¼šå»¶è¿Ÿ 60 ç§’ï¼ˆç­‰å¾…å®šæ—¶æ‰«è¡¨ï¼‰
```

#### 2. QMQ äº‹åŠ¡æ¶ˆæ¯

**å†™å…¥å‹åŠ›ï¼š**
```
æ¯ç§’ä»»åŠ¡æ•°ï¼š200 ä¸ª/ç§’
æ¯ä¸ªä»»åŠ¡å†™å…¥ï¼šINSERT(qmq_msg_queue) + UPDATE(status=1) = 2 æ¬¡å†™å…¥
æ€»æ•°æ®åº“å†™å…¥ï¼š200 Ã— 2 = 400 æ¬¡/ç§’
```

**æŸ¥è¯¢å‹åŠ›ï¼š**
```
Watchdog æ‰«è¡¨ï¼šæ¯ç§’æ‰«æ LIMIT 100
æŸ¥è¯¢é¢‘ç‡ï¼š1 æ¬¡/ç§’
æ€»æŸ¥è¯¢ï¼š1 æ¬¡/ç§’ï¼ˆéå¸¸ä½ï¼‰
```

**ä¼˜åŠ¿ï¼š**
- æ¶ˆæ¯å‘é€åˆ° QMQ Broker åï¼Œæ¶ˆè´¹è€…ä» Broker æ‹‰å–ï¼ˆä¸ç»è¿‡æ•°æ®åº“ï¼‰
- æ•°æ®åº“åªè´Ÿè´£äº‹åŠ¡ä¸€è‡´æ€§ï¼Œä¸è´Ÿè´£æ¶ˆæ¯åˆ†å‘
- Watchdog æ‰«æé¢‘ç‡é«˜ï¼ˆ1sï¼‰ï¼Œé‡è¯•åŠæ—¶

#### 3. RocketMQ äº‹åŠ¡æ¶ˆæ¯

**å†™å…¥å‹åŠ›ï¼š**
```
æ¯ç§’ä»»åŠ¡æ•°ï¼š200 ä¸ª/ç§’
æ¯ä¸ªä»»åŠ¡å†™å…¥ï¼šINSERT(transaction_log) = 1 æ¬¡å†™å…¥
æ€»æ•°æ®åº“å†™å…¥ï¼š200 Ã— 1 = 200 æ¬¡/ç§’
```

**æŸ¥è¯¢å‹åŠ›ï¼š**
```
æ­£å¸¸æµç¨‹ï¼š0 æ¬¡æŸ¥è¯¢ï¼ˆåŠæ¶ˆæ¯ç›´æ¥ COMMITï¼‰
å›æŸ¥åœºæ™¯ï¼ˆå‡è®¾ 1%ï¼‰ï¼š2 æ¬¡æŸ¥è¯¢/ç§’
æ€»æŸ¥è¯¢ï¼š2 æ¬¡/ç§’
```

**ä¼˜åŠ¿ï¼š**
- æ¶ˆæ¯å­˜å‚¨åœ¨ RocketMQ Brokerï¼Œæ•°æ®åº“ä»…å­˜äº‹åŠ¡æ—¥å¿—
- æ•°æ®åº“å‹åŠ›æœ€å°ï¼ˆåªæœ‰ 1 æ¬¡ INSERTï¼‰
- Broker è´Ÿè´£æ¶ˆæ¯æŒä¹…åŒ–ã€åˆ†å‘ã€é‡è¯•ï¼Œå®Œå…¨è§£æ”¾æ•°æ®åº“

---

## ğŸ” å…³é”®é—®é¢˜æ·±åº¦åˆ†æ

### é—®é¢˜ 1ï¼šä¸ºä»€ä¹ˆ RocketMQ éœ€è¦é¢„ç”Ÿæˆè®¢å• IDï¼Ÿ

#### åŸå› åˆ†æï¼š

RocketMQ äº‹åŠ¡æ¶ˆæ¯çš„æµç¨‹ï¼š
```
1. å‘é€åŠæ¶ˆæ¯ï¼ˆéœ€è¦ messageKeyï¼‰
2. æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼ˆç”Ÿæˆè®¢å• IDï¼‰
3. å‘é€ COMMIT/ROLLBACK
4. Broker å›æŸ¥ï¼ˆæ ¹æ® messageKey æŸ¥è¯¢äº‹åŠ¡çŠ¶æ€ï¼‰
```

**çŸ›ç›¾ç‚¹ï¼š** ç¬¬ 1 æ­¥éœ€è¦å”¯ä¸€æ ‡è¯†ï¼ˆé€šå¸¸ç”¨è®¢å• IDï¼‰ï¼Œä½†è®¢å• ID åœ¨ç¬¬ 2 æ­¥æ‰ç”Ÿæˆã€‚

#### è§£å†³æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆ 1ï¼šé¢„ç”Ÿæˆè®¢å• IDï¼ˆSnowflake ç®—æ³•ï¼‰**
```java
Long orderId = snowflakeIdGenerator.nextId(); // å…ˆç”Ÿæˆ ID
Message message = new Message("topic", "tag", orderId.toString(), payload);
rocketMQTemplate.sendMessageInTransaction(message, request);

// æœ¬åœ°äº‹åŠ¡ä¸­ä½¿ç”¨é¢„ç”Ÿæˆçš„ ID
@Transactional
public Order createOrderInTransaction(CreateOrderRequest request, Long orderId) {
    Order order = Order.builder()
        .id(orderId) // ä½¿ç”¨é¢„ç”Ÿæˆçš„ ID
        .userId(request.getUserId())
        .build();
    orderRepository.insertWithId(order); // éœ€è¦æ”¯æŒæŒ‡å®š ID æ’å…¥
    return order;
}
```

**æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ä¸šåŠ¡æµæ°´å·**
```java
String businessNo = generateBusinessNo(); // ä¸šåŠ¡æµæ°´å·ï¼ˆå¦‚ï¼šORD20260129001ï¼‰
Message message = new Message("topic", "tag", businessNo, payload);
rocketMQTemplate.sendMessageInTransaction(message, request);

// æœ¬åœ°äº‹åŠ¡ä¸­ä¿å­˜æµæ°´å·
@Transactional
public Order createOrderInTransaction(CreateOrderRequest request, String businessNo) {
    Order order = Order.builder()
        .businessNo(businessNo) // ä¿å­˜ä¸šåŠ¡æµæ°´å·
        .userId(request.getUserId())
        .build();
    orderRepository.insert(order); // ID ä»ç”±æ•°æ®åº“ç”Ÿæˆ
    return order;
}

// å›æŸ¥æ—¶æ ¹æ®ä¸šåŠ¡æµæ°´å·æŸ¥è¯¢
public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {
    String businessNo = msg.getKeys();
    Order order = orderRepository.findByBusinessNo(businessNo);
    return order != null ? COMMIT : ROLLBACK;
}
```

**æ–¹æ¡ˆ 3ï¼šä½¿ç”¨å¹‚ç­‰é”®**
```java
String idempotencyKey = request.getUserId() + "-" + System.currentTimeMillis();
Message message = new Message("topic", "tag", idempotencyKey, payload);

// ä¸šåŠ¡é€»è¾‘å¤©ç„¶æ”¯æŒå¹‚ç­‰
@Transactional
public Order createOrderInTransaction(CreateOrderRequest request, String idempotencyKey) {
    // å¹‚ç­‰æ£€æŸ¥
    Order existingOrder = orderRepository.findByIdempotencyKey(idempotencyKey);
    if (existingOrder != null) {
        return existingOrder;
    }

    Order order = Order.builder()
        .idempotencyKey(idempotencyKey)
        .build();
    orderRepository.insert(order);
    return order;
}
```

#### Outbox/QMQ ä¸ºä»€ä¹ˆæ²¡è¿™ä¸ªé—®é¢˜ï¼Ÿ

```java
@Transactional
public void createOrder(CreateOrderRequest request) {
    // 1. å…ˆå†™è®¢å•ï¼ˆç”Ÿæˆ IDï¼‰
    Order order = orderRepository.insert(order); // order.id = 123456

    // 2. å†å†™ outboxï¼ˆå¯ä»¥ç›´æ¥ä½¿ç”¨è®¢å• IDï¼‰
    Outbox outbox = Outbox.builder()
        .bizKey(String.valueOf(order.getId())) // ç›´æ¥ä½¿ç”¨åˆšç”Ÿæˆçš„ ID
        .build();
    outboxRepository.insert(outbox);

    // 3. éƒ½åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
}
```

---

### é—®é¢˜ 2ï¼šä¸ºä»€ä¹ˆ Outbox å³æ—¶æ‰§è¡Œä»ä¸å¦‚ RocketMQï¼Ÿ

#### ç­”æ¡ˆï¼šæ•°æ®åº“å‹åŠ›å’Œå¯é æ€§å·®å¼‚

**Outbox çš„é—®é¢˜ï¼š**

1. **æ•°æ®åº“å†™å…¥æ¬¡æ•°å¤šï¼ˆ3 æ¬¡ï¼‰**
   ```
   INSERT outbox (status=NEW)
   UPDATE outbox SET status=CLAIMED, instance_id=xxx, lock_until=xxx
   UPDATE outbox SET status=SENT
   ```

2. **çº¿ç¨‹æ± é˜Ÿåˆ—æº¢å‡ºé£é™©**
   ```java
   ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
   executor.setQueueCapacity(100); // é˜Ÿåˆ—åªæœ‰ 100

   // é«˜å³°æœŸæ¯ç§’ 200 ä¸ªä»»åŠ¡ï¼Œå¦‚æœå¤„ç†é€Ÿåº¦ < 200/s
   // é˜Ÿåˆ—æ»¡ â†’ RejectedExecutionException â†’ å»¶è¿Ÿ 60sï¼ˆç­‰å¾…æ‰«è¡¨ï¼‰
   ```

3. **äº‹åŠ¡æ—¶é•¿å¢åŠ **
   ```
   åŸäº‹åŠ¡ï¼šINSERT ordersï¼ˆ10msï¼‰
   å¢åŠ  Outboxï¼šINSERT ordersï¼ˆ10msï¼‰+ INSERT outboxï¼ˆ5msï¼‰+ äº‹åŠ¡æäº¤ï¼ˆ5msï¼‰= 20ms
   äº‹åŠ¡æ—¶é•¿å¢åŠ  100%ï¼Œé”æŒæœ‰æ—¶é—´ç¿»å€
   ```

4. **Outbox è¡¨å †ç§¯**
   ```
   å‡è®¾æ¯å¤© 1% çš„ä»»åŠ¡å¤±è´¥ï¼ˆ1000 ä¸ªï¼‰
   è¿™äº› FAILED è®°å½•ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°äººå·¥ä»‹å…¥æˆ–å˜ä¸º DEAD
   è¡¨è¶Šæ¥è¶Šå¤§ï¼Œæ‰«æè¶Šæ¥è¶Šæ…¢
   ```

**RocketMQ çš„ä¼˜åŠ¿ï¼š**

1. **æ•°æ®åº“å†™å…¥æ¬¡æ•°å°‘ï¼ˆ1 æ¬¡ï¼‰**
   ```
   åªéœ€ INSERT transaction_logï¼ˆäº‹åŠ¡æ—¥å¿—å¾ˆå°ï¼‰
   ```

2. **æ— çº¿ç¨‹æ± é£é™©**
   ```
   åŠæ¶ˆæ¯å‘é€æ˜¯åŒæ­¥çš„ï¼Œä¸ä¾èµ–çº¿ç¨‹æ± 
   æœ¬åœ°äº‹åŠ¡å¤±è´¥ â†’ ç›´æ¥ ROLLBACK â†’ æ— éœ€é‡è¯•
   ```

3. **äº‹åŠ¡æ—¶é•¿ä¸å¢åŠ **
   ```
   INSERT transaction_log ä¸ INSERT orders å¹¶è¡Œ
   äº‹åŠ¡æäº¤åç«‹å³è¿”å›ï¼Œä¸éœ€è¦ç­‰å¾…æ¶ˆæ¯å‘é€
   ```

4. **æ— å †ç§¯é—®é¢˜**
   ```
   æ¶ˆæ¯åœ¨ Broker ä¸­ï¼Œæ•°æ®åº“åªä¿ç•™äº‹åŠ¡æ—¥å¿—
   äº‹åŠ¡æ—¥å¿—å¯å®šæœŸæ¸…ç†ï¼ˆ7 å¤©ååˆ é™¤ï¼‰
   ```

5. **Broker æä¾›é«˜çº§ç‰¹æ€§**
   ```
   - å»¶è¿Ÿæ¶ˆæ¯ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
   - é¡ºåºæ¶ˆæ¯ï¼ˆåŒä¸€è®¢å•çš„æ¶ˆæ¯æŒ‰é¡ºåºæ¶ˆè´¹ï¼‰
   - æ¶ˆæ¯è½¨è¿¹ï¼ˆæ’æŸ¥é—®é¢˜ï¼‰
   - æ­»ä¿¡é˜Ÿåˆ—ï¼ˆè‡ªåŠ¨å¤„ç†å¤±è´¥æ¶ˆæ¯ï¼‰
   - æ°´å¹³æ‰©å±•ï¼ˆå¢åŠ  Broker èŠ‚ç‚¹ï¼‰
   ```

---

## ğŸ“ é˜¿é‡Œ P7 é¢è¯•è¦ç‚¹

### 1. ä¸ºä»€ä¹ˆé€‰æ‹© Outbox è€Œä¸æ˜¯ RocketMQï¼Ÿ

**å›ç­”æ¡†æ¶ï¼š**

**ä¸šåŠ¡è§„æ¨¡å’Œé˜¶æ®µï¼š**
- å½“å‰æ—¥è®¢å• < 1 ä¸‡ï¼Œå³°å€¼ QPS < 20ï¼ŒOutbox å®Œå…¨å¤Ÿç”¨
- æ—©æœŸå¿«é€Ÿè¿­ä»£ï¼ŒOutbox é›¶é¢å¤–éƒ¨ç½²æˆæœ¬ï¼ˆå¤ç”¨æ•°æ®åº“ï¼‰
- å›¢é˜Ÿå¯¹æ•°æ®åº“æ›´ç†Ÿæ‚‰ï¼Œè¿ç»´æˆæœ¬ä½

**æŠ€æœ¯é€‰å‹æƒè¡¡ï¼š**
- Outbox æ”¯æŒ HTTP è°ƒç”¨ + MQ å‘é€ï¼Œé€‚åˆæ··åˆåœºæ™¯
- æ— éœ€å¼•å…¥ RocketMQ Brokerï¼Œé™ä½æ¶æ„å¤æ‚åº¦
- åˆ†åº“åˆ†è¡¨å·²åšå¥½ï¼ŒOutbox å¤©ç„¶æ”¯æŒæ°´å¹³æ‰©å±•

**æœªæ¥æ¼”è¿›è·¯å¾„ï¼š**
- å½“æ—¥è®¢å•è¶…è¿‡ 10 ä¸‡ï¼Œä¼šè¿ç§»åˆ° RocketMQ
- ç°æœ‰ Outbox å¯å¹³æ»‘è¿ç§»ï¼ˆåªéœ€æ”¹ Handler å®ç°ï¼‰
- æ¶æ„è®¾è®¡é¢„ç•™äº†æ‰©å±•ç‚¹ï¼ˆOutboxHandler æ¥å£ï¼‰

### 2. å¦‚ä½•ä¼˜åŒ– Outbox æ€§èƒ½ï¼Ÿ

**å›ç­”è¦ç‚¹ï¼š**

**ä¼˜åŒ– 1ï¼šæ¶ˆé™¤å¹¿æ’­æŸ¥è¯¢ï¼ˆå·²å®ç°ï¼‰**
- é—®é¢˜ï¼š`selectById(id)` è§¦å‘ 96 æ¬¡æŸ¥è¯¢
- æ–¹æ¡ˆï¼šä¼ é€’å®Œæ•´å¯¹è±¡ + shardId å‚æ•°
- æ•ˆæœï¼šQPS ä» 19,200 â†’ 20ï¼ˆé™ä½ 99.9%ï¼‰

**ä¼˜åŒ– 2ï¼šæ‰¹é‡å¤„ç†**
```java
// æ‰¹é‡ claim
List<Long> ids = Arrays.asList(1L, 2L, 3L);
outboxRepository.claimByIds(table, shardId, ids, instanceId, lockUntil, now);

// æ‰¹é‡æ ‡è®°çŠ¶æ€
outboxRepository.markSentBatch(table, ids, instanceId);
```

**ä¼˜åŒ– 3ï¼šå¼‚æ­¥çº¿ç¨‹æ± éš”ç¦»**
```java
// HTTP ä»»åŠ¡å’Œ MQ ä»»åŠ¡ä½¿ç”¨ä¸åŒçº¿ç¨‹æ± 
@Bean("httpTaskExecutor")
public ThreadPoolTaskExecutor httpTaskExecutor() {
    executor.setCorePoolSize(20);
    executor.setQueueCapacity(200);
    return executor;
}

@Bean("mqTaskExecutor")
public ThreadPoolTaskExecutor mqTaskExecutor() {
    executor.setCorePoolSize(10);
    executor.setQueueCapacity(100);
    return executor;
}
```

**ä¼˜åŒ– 4ï¼šå®šæ—¶æ¸…ç†**
```java
@Scheduled(cron = "0 0 2 * * ?")
public void cleanupSentRecords() {
    // åˆ é™¤ 7 å¤©å‰çš„ SENT è®°å½•
    outboxRepository.deleteSentRecordsByShardRange(...);
}
```

### 3. Outbox vs QMQï¼šæœ¬è´¨ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**å…³é”®è®¤çŸ¥ï¼šä¸¤è€…éƒ½æ˜¯æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆï¼Œæ¶ˆæ¯è¡¨éƒ½åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­ï¼**

#### çœŸæ­£çš„å·®å¼‚ï¼š

**1. åˆ†åº“åˆ†è¡¨æ”¯æŒ**
- **Outbox**: æ¶ˆæ¯è¡¨éšä¸šåŠ¡è¡¨ä¸€èµ·åˆ†ç‰‡ï¼ˆæŒ‰ store_idï¼‰ï¼Œå¤©ç„¶æ”¯æŒæ°´å¹³æ‰©å±•
  ```sql
  -- 3 ä¸ªæ•°æ®åº“ï¼ˆjiaoyi_0/1/2ï¼‰ï¼Œæ¯ä¸ªåº“æœ‰ 32 å¼  outbox è¡¨
  -- æ€»è®¡ 96 å¼ è¡¨ï¼Œæ¶ˆæ¯æŒ‰ store_id åˆ†ç‰‡å­˜å‚¨
  -- å•è¡¨æ•°æ®é‡å°ï¼ŒæŸ¥è¯¢æ•ˆç‡é«˜
  ```
- **QMQ**: æ¶ˆæ¯è¡¨é€šå¸¸ä¸åˆ†ç‰‡ï¼ˆå•è¡¨ï¼‰ï¼Œæ‰€æœ‰æ¶ˆæ¯å­˜åœ¨ä¸€å¼ è¡¨ä¸­
  ```sql
  -- æ‰€æœ‰ä¸šåŠ¡çš„æ¶ˆæ¯éƒ½å­˜åœ¨ qmq_msg_queue å•è¡¨
  -- é«˜å¹¶å‘æ—¶å•è¡¨æˆä¸ºç“¶é¢ˆ
  ```

**2. å°è£…ç¨‹åº¦**
- **Outbox**: è‡ªç ”ç»„ä»¶ï¼Œä»£ç å¯æ§ï¼Œå¯æ ¹æ®ä¸šåŠ¡å®šåˆ¶
- **QMQ**: å®Œæ•´ SDKï¼Œå¼€ç®±å³ç”¨ï¼Œä½†å®šåˆ¶å›°éš¾

**3. å‘é€ç›®æ ‡**
- **Outbox**: æ”¯æŒ HTTP + ä»»æ„ MQï¼ˆRocketMQ/Kafka/RabbitMQï¼‰ï¼Œéå¸¸çµæ´»
- **QMQ**: åªèƒ½å‘é€åˆ° QMQ Brokerï¼Œç»‘å®š QMQ ç”Ÿæ€

**4. ä¸šåŠ¡å­—æ®µ**
- **Outbox**: åŒ…å«ä¸°å¯Œçš„ä¸šåŠ¡å­—æ®µï¼ˆtype/bizKey/shardId/storeIdï¼‰ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢
- **QMQ**: åªæœ‰åŸºç¡€å­—æ®µï¼ˆcontent/status/errorï¼‰ï¼Œæ¶ˆæ¯å†…å®¹åºåˆ—åŒ–å­˜å‚¨

**5. æ‰«æç­–ç•¥**
- **Outbox**: æŒ‰ shardId åˆ†ç‰‡æ‰«æï¼Œæ¯ 60 ç§’æ‰«æ 10 ä¸ªåˆ†ç‰‡ï¼Œè´Ÿè½½å‡è¡¡
- **QMQ**: å…¨è¡¨æ‰«æï¼Œæ¯ 1 ç§’æ‰«æ LIMIT 100ï¼Œå“åº”æ›´å¿«ä½†æ•°æ®åº“å‹åŠ›å¤§

#### ä¸ºä»€ä¹ˆå½“å‰é¡¹ç›®é€‰æ‹© Outbox è€Œä¸æ˜¯ QMQï¼Ÿ

1. **å·²æœ‰åˆ†åº“åˆ†è¡¨æ¶æ„**ï¼šOutbox å¯ä»¥å¤ç”¨ ShardingSphere åˆ†ç‰‡èƒ½åŠ›ï¼ŒQMQ å•è¡¨æ— æ³•æ‰©å±•
2. **æ”¯æŒ HTTP è°ƒç”¨**ï¼šéœ€è¦è°ƒç”¨ product-service æ‰£å‡åº“å­˜ï¼ˆHTTPï¼‰ï¼Œä¸åªæ˜¯å‘ MQ
3. **é¿å…ç»‘å®šç”Ÿæ€**ï¼šä¸æƒ³å¼•å…¥ QMQ Brokerï¼Œä¿æŒæ¶æ„ç®€æ´
4. **ä»£ç å¯æ§**ï¼šè‡ªç ”ç»„ä»¶ï¼Œå¯ä»¥éšæ—¶ä¼˜åŒ–ï¼ˆå¦‚æœ¬æ¬¡å¹¿æ’­æŸ¥è¯¢ä¼˜åŒ–ï¼‰

### 4. QMQ vs RocketMQ äº‹åŠ¡æ¶ˆæ¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**å›ç­”è¦ç‚¹ï¼š**

| ç»´åº¦ | QMQ | RocketMQ |
|------|-----|----------|
| **æ¶ˆæ¯å­˜å‚¨** | æ•°æ®åº“ï¼ˆqmq_msg_queueï¼‰ | Brokerï¼ˆæŒä¹…åŒ–åˆ°ç£ç›˜ï¼‰ |
| **äº‹åŠ¡ä¿è¯** | æ•°æ®åº“ ACID | Half Message + å›æŸ¥ |
| **è¡¥å¿æœºåˆ¶** | Watchdog æ‰«è¡¨ | Broker å›æŸ¥ |
| **ID ç”Ÿæˆ** | æ— éœ€é¢„ç”Ÿæˆ | éœ€é¢„ç”Ÿæˆ |
| **æ‰©å±•æ€§** | å—é™äºæ•°æ®åº“å•è¡¨ | Broker æ°´å¹³æ‰©å±• |
| **é€‚ç”¨åœºæ™¯** | ä¸­å°è§„æ¨¡ï¼ˆæ—¥è®¢å• < 10 ä¸‡ï¼‰ | å¤§è§„æ¨¡ï¼ˆæ—¥è®¢å• > 10 ä¸‡ï¼‰ |

**æœ¬è´¨åŒºåˆ«ï¼š**
- QMQï¼š**æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆ**ï¼ˆä¾èµ–æ•°æ®åº“ ACIDï¼‰
- RocketMQï¼š**åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ**ï¼ˆä¾èµ– Broker åè°ƒï¼‰

**é€‰å‹å»ºè®®ï¼š**
- æ—¥è®¢å• < 1 ä¸‡ + éœ€è¦ HTTP è°ƒç”¨ï¼š**Outbox**ï¼ˆè‡ªç ”ï¼Œçµæ´»ï¼Œæ”¯æŒåˆ†ç‰‡ï¼‰
- æ—¥è®¢å• 1-10 ä¸‡ + åªå‘ MQï¼š**QMQ**ï¼ˆé›¶æˆæœ¬æ¥å…¥ï¼Œæ€§èƒ½å¤Ÿç”¨ï¼‰
- æ—¥è®¢å• > 10 ä¸‡ï¼š**RocketMQ**ï¼ˆé«˜æ€§èƒ½ï¼Œå®Œæ•´ç”Ÿæ€ï¼‰

---

## âœ… æ€»ç»“

### ä¸‰ç§æ–¹æ¡ˆçš„æ ¸å¿ƒå·®å¼‚

| æ–¹æ¡ˆ | æ ¸å¿ƒæ€è·¯ | æœ€å¤§ä¼˜åŠ¿ | æœ€å¤§åŠ£åŠ¿ |
|------|---------|---------|---------|
| **Outbox** | æœ¬åœ°æ¶ˆæ¯è¡¨ + ä¸šåŠ¡æ–¹è¡¥å¿ | âœ… æ”¯æŒåˆ†åº“åˆ†è¡¨ã€HTTP+MQã€ä»£ç å¯æ§ | åŠŸèƒ½ç®€é™‹ã€éœ€è‡ªå·±ç»´æŠ¤ |
| **QMQ** | æœ¬åœ°æ¶ˆæ¯è¡¨ + Watchdog è¡¥å¿ | âœ… é›¶æˆæœ¬ã€SDK å®Œå–„ | âŒ å•è¡¨ç“¶é¢ˆã€åªæ”¯æŒ QMQ |
| **RocketMQ** | Half Message + Broker å›æŸ¥ | âœ… é«˜æ€§èƒ½ã€å®Œæ•´ç”Ÿæ€ã€æ°´å¹³æ‰©å±• | âŒ éœ€é¢„ç”Ÿæˆ IDã€éƒ¨ç½²æˆæœ¬é«˜ |

### Outbox vs QMQï¼šå…³é”®è®¤çŸ¥

**å¾ˆå¤šäººè¯¯ä»¥ä¸ºï¼š** QMQ æ¯” Outbox æ›´å…ˆè¿›ï¼Œå› ä¸ºæœ‰å®Œæ•´çš„ SDK

**å®é™…æƒ…å†µï¼š** ä¸¤è€…éƒ½æ˜¯æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ï¼æ¶ˆæ¯è¡¨éƒ½åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­ã€‚

**Outbox çš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼š**
1. **æ”¯æŒåˆ†åº“åˆ†è¡¨**ï¼šæ¶ˆæ¯è¡¨éšä¸šåŠ¡è¡¨åˆ†ç‰‡ï¼ˆ96 å¼ è¡¨ï¼‰ï¼Œå•è¡¨æ•°æ®é‡å°ï¼Œæ€§èƒ½æ›´å¥½
2. **æ”¯æŒ HTTP è°ƒç”¨**ï¼šä¸åªæ˜¯å‘ MQï¼Œè¿˜èƒ½ç›´æ¥è°ƒç”¨å¾®æœåŠ¡ API
3. **ä»£ç å®Œå…¨å¯æ§**ï¼šå¯æ ¹æ®ä¸šåŠ¡å®šåˆ¶ä¼˜åŒ–ï¼ˆå¦‚æœ¬æ¬¡å¹¿æ’­æŸ¥è¯¢ä¼˜åŒ–ï¼‰
4. **ä¸ç»‘å®šç”Ÿæ€**ï¼šå¯ä»¥å‘é€åˆ°ä»»æ„ MQï¼ˆRocketMQ/Kafka/RabbitMQï¼‰

**QMQ çš„ä¼˜åŠ¿ï¼š**
1. **SDK æˆç†Ÿ**ï¼šAPI ç®€æ´ï¼Œå¼€ç®±å³ç”¨
2. **æ‰«ææ›´å¿«**ï¼šWatchdog æ¯ç§’æ‰«æï¼Œå“åº”æ›´åŠæ—¶ï¼ˆä½†æ•°æ®åº“å‹åŠ›å¤§ï¼‰
3. **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ”¯æŒå»¶è¿Ÿæ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ã€æ¶ˆæ¯è½¨è¿¹ç­‰

**ç»“è®ºï¼š** å¯¹äºå·²æœ‰åˆ†åº“åˆ†è¡¨æ¶æ„ã€éœ€è¦æ”¯æŒ HTTP è°ƒç”¨çš„é¡¹ç›®ï¼Œ**Outbox æ¯” QMQ æ›´åˆé€‚**ï¼

### é€‰å‹å†³ç­–æ ‘

```
æ˜¯å¦éœ€è¦ HTTP è°ƒç”¨ï¼ˆé MQ åœºæ™¯ï¼‰ï¼Ÿ
â”œâ”€ æ˜¯ â†’ Outboxï¼ˆRocketMQ/QMQ éƒ½ä¸æ”¯æŒ HTTPï¼‰
â””â”€ å¦ â†’ ç»§ç»­
    â”‚
    â”œâ”€ æ˜¯å¦å·²æœ‰åˆ†åº“åˆ†è¡¨æ¶æ„ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ Outboxï¼ˆæ¶ˆæ¯è¡¨éšä¸šåŠ¡è¡¨åˆ†ç‰‡ï¼Œæ€§èƒ½æ›´å¥½ï¼‰
    â”‚   â””â”€ å¦ â†’ ç»§ç»­
    â”‚       â”‚
    â”‚       â”œâ”€ æ—¥è®¢å• < 1 ä¸‡ â†’ Outbox æˆ– QMQï¼ˆéƒ½å¤Ÿç”¨ï¼ŒOutbox æ›´çµæ´»ï¼‰
    â”‚       â”œâ”€ æ—¥è®¢å• 1-10 ä¸‡ â†’ QMQï¼ˆSDK æˆç†Ÿï¼ŒåŠŸèƒ½ä¸°å¯Œï¼‰
    â”‚       â””â”€ æ—¥è®¢å• > 10 ä¸‡ â†’ RocketMQï¼ˆé«˜æ€§èƒ½ã€å¯æ°´å¹³æ‰©å±•ï¼‰
```

### ä¸ºä»€ä¹ˆå½“å‰é¡¹ç›®é€‰æ‹© Outboxï¼Ÿ

1. âœ… **æ”¯æŒ HTTP è°ƒç”¨**ï¼šéœ€è¦è°ƒç”¨ product-service æ‰£å‡åº“å­˜ï¼ˆHTTPï¼‰
2. âœ… **å·²æœ‰åˆ†åº“åˆ†è¡¨**ï¼šOutbox è¡¨éšè®¢å•è¡¨åˆ†ç‰‡ï¼Œå……åˆ†åˆ©ç”¨ç°æœ‰æ¶æ„
3. âœ… **é¿å…ç»‘å®šç”Ÿæ€**ï¼šä¸éœ€è¦éƒ¨ç½² QMQ Brokerï¼Œä¿æŒæ¶æ„ç®€æ´
4. âœ… **ä»£ç å¯æ§**ï¼šè‡ªç ”ç»„ä»¶ï¼Œå¯ä»¥çµæ´»ä¼˜åŒ–ï¼ˆå¦‚æœ¬æ¬¡æ€§èƒ½ä¼˜åŒ–ï¼‰
5. âœ… **ä¸šåŠ¡è§„æ¨¡é€‚ä¸­**ï¼šæ—¥è®¢å• < 1 ä¸‡ï¼ŒOutbox æ€§èƒ½å®Œå…¨å¤Ÿç”¨

### å½“å‰é¡¹ç›®è¯„ä»·

**ä¼˜ç‚¹ï¼š**
1. âœ… Outbox è®¾è®¡åˆç†ï¼Œæ”¯æŒ HTTP + MQ åŒæ¨¡å¼
2. âœ… åˆ†åº“åˆ†è¡¨è®¾è®¡åˆ°ä½ï¼Œshard_id ä¼˜åŒ–å‡ºè‰²
3. âœ… äº‹åŠ¡åŒæ­¥æœºåˆ¶æ­£ç¡®ï¼Œæ— æ¶ˆæ¯ä¸¢å¤±é£é™©
4. âœ… å®šæ—¶è¡¥å¿æœºåˆ¶å®Œå–„ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§

**æ”¹è¿›å»ºè®®ï¼ˆåº”å¯¹ P7 é¢è¯•ï¼‰ï¼š**
1. è¡¥å……ç›‘æ§å‘Šè­¦ï¼ˆOutbox å †ç§¯ã€å¤„ç†å»¶è¿Ÿã€å¤±è´¥ç‡ï¼‰
2. å¢åŠ æ‰¹é‡å¤„ç†ï¼ˆæå‡ååé‡ï¼‰
3. çº¿ç¨‹æ± éš”ç¦»ï¼ˆHTTP å’Œ MQ åˆ†å¼€ï¼‰
4. å‡†å¤‡è¿ç§»åˆ° RocketMQ çš„æ–¹æ¡ˆï¼ˆå±•ç¤ºæ¶æ„æ¼”è¿›æ€ç»´ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¶é—´ï¼š** 2026-01-29
**é€‚ç”¨åœºæ™¯ï¼š** é˜¿é‡Œ P7 é¢è¯•å‡†å¤‡ã€åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆé€‰å‹
