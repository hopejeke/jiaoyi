# æ”¯ä»˜è¯·æ±‚å¡«å†™ç¤ºä¾‹

## ğŸ“‹ æ”¯ä»˜è¯·æ±‚å‚æ•°è¯´æ˜

### 1. åˆ›å»ºè®¢å•è¯·æ±‚

**æ¥å£**: `POST /orders`

**è¯·æ±‚ä½“**:
```json
{
  "userId": 94,
  "receiverName": "å¼ ä¸‰",
  "receiverPhone": "13800138000",
  "receiverAddress": "åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“",
  "remark": "è¯·å°½å¿«å‘è´§",
  "orderItems": [
    {
      "productId": 2002,
      "productName": "è´¨æœ´çš„é’¢é‹å­",
      "productImage": "https://example.com/shoe.jpg",
      "unitPrice": 634.75,
      "quantity": 10
    }
  ]
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 1,
    "orderNo": "ORD1703123456789ABCDEFGH",
    "userId": 94,
    "status": "PENDING",
    "totalAmount": 6347.50,
    "receiverName": "å¼ ä¸‰",
    "receiverPhone": "13800138000",
    "receiverAddress": "åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“",
    "remark": "è¯·å°½å¿«å‘è´§",
    "createTime": "2024-01-01 10:00:00",
    "orderItems": [...]
  }
}
```

---

### 2. æ”¯ä»˜è®¢å•è¯·æ±‚

**æ¥å£**: `POST /orders/{orderId}/pay`

**è¯·æ±‚ä½“**:
```json
{
  "paymentMethod": "ALIPAY",
  "amount": 634750,
  "channel": "WEB",
  "clientIp": "192.168.1.100",
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
  "remark": "æ”¯ä»˜å®æ”¯ä»˜"
}
```

**å‚æ•°è¯´æ˜**:
- `paymentMethod`: æ”¯ä»˜æ–¹å¼
  - `ALIPAY`: æ”¯ä»˜å®æ”¯ä»˜
  - `WECHAT`: å¾®ä¿¡æ”¯ä»˜
  - `BANK`: é“¶è¡Œå¡æ”¯ä»˜
- `amount`: æ”¯ä»˜é‡‘é¢ï¼ˆåˆ†ï¼‰ï¼Œä¾‹å¦‚ï¼š634750 = 6347.50å…ƒ
- `channel`: æ”¯ä»˜æ¸ é“
  - `WEB`: ç½‘é¡µæ”¯ä»˜
  - `APP`: åº”ç”¨æ”¯ä»˜
  - `H5`: æ‰‹æœºç½‘é¡µæ”¯ä»˜
- `clientIp`: å®¢æˆ·ç«¯IPåœ°å€
- `userAgent`: ç”¨æˆ·ä»£ç†ä¿¡æ¯
- `remark`: å¤‡æ³¨ä¿¡æ¯

**å“åº”**:
```json
{
  "success": true,
  "message": "æ”¯ä»˜å¤„ç†æˆåŠŸ",
  "data": {
    "paymentNo": "PAY1703123456789ABCDEFGH",
    "status": "PENDING",
    "paymentMethod": "ALIPAY",
    "amount": 634750,
    "payUrl": "https://openapi.alipay.com/gateway.do?charset=UTF-8&method=alipay.trade.page.pay&sign=...",
    "remark": "æ”¯ä»˜å®æ”¯ä»˜è®¢å•åˆ›å»ºæˆåŠŸ"
  }
}
```

---

## ğŸš€ å®Œæ•´æµ‹è¯•æµç¨‹

### 1. åˆ›å»ºè®¢å•

```bash
curl -X POST http://localhost:8080/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 94,
    "receiverName": "å¼ ä¸‰",
    "receiverPhone": "13800138000",
    "receiverAddress": "åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“",
    "remark": "è¯·å°½å¿«å‘è´§",
    "orderItems": [
      {
        "productId": 2002,
        "productName": "è´¨æœ´çš„é’¢é‹å­",
        "productImage": "https://example.com/shoe.jpg",
        "unitPrice": 634.75,
        "quantity": 10
      }
    ]
  }'
```

### 2. æ”¯ä»˜è®¢å•

```bash
curl -X POST http://localhost:8080/orders/1/pay \
  -H "Content-Type: application/json" \
  -d '{
    "paymentMethod": "ALIPAY",
    "amount": 634750,
    "channel": "WEB",
    "clientIp": "192.168.1.100",
    "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "remark": "æ”¯ä»˜å®æ”¯ä»˜"
  }'
```

### 3. æŸ¥è¯¢æ”¯ä»˜ç»“æœ

```bash
curl -X GET http://localhost:8080/api/payment/query/PAY1703123456789ABCDEFGH
```

---

## ğŸ’¡ å‰ç«¯é›†æˆç¤ºä¾‹

### JavaScript ç¤ºä¾‹

```javascript
// 1. åˆ›å»ºè®¢å•
async function createOrder() {
  const orderData = {
    userId: 94,
    receiverName: "å¼ ä¸‰",
    receiverPhone: "13800138000",
    receiverAddress: "åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“",
    remark: "è¯·å°½å¿«å‘è´§",
    orderItems: [
      {
        productId: 2002,
        productName: "è´¨æœ´çš„é’¢é‹å­",
        productImage: "https://example.com/shoe.jpg",
        unitPrice: 634.75,
        quantity: 10
      }
    ]
  };
  
  const response = await fetch('/orders', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(orderData)
  });
  
  const result = await response.json();
  return result.data;
}

// 2. æ”¯ä»˜è®¢å•
async function payOrder(orderId) {
  const paymentData = {
    paymentMethod: "ALIPAY",
    amount: 634750, // 6347.50å…ƒ * 100
    channel: "WEB",
    clientIp: "192.168.1.100",
    userAgent: navigator.userAgent,
    remark: "æ”¯ä»˜å®æ”¯ä»˜"
  };
  
  const response = await fetch(`/orders/${orderId}/pay`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(paymentData)
  });
  
  const result = await response.json();
  
  if (result.success && result.data.payUrl) {
    // è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢
    window.location.href = result.data.payUrl;
  }
}

// 3. æŸ¥è¯¢æ”¯ä»˜ç»“æœ
async function queryPayment(paymentNo) {
  const response = await fetch(`/api/payment/query/${paymentNo}`);
  const result = await response.json();
  return result.data;
}
```

### Vue.js ç¤ºä¾‹

```vue
<template>
  <div>
    <h2>è®¢å•æ”¯ä»˜</h2>
    <form @submit.prevent="createOrder">
      <input v-model="orderForm.receiverName" placeholder="æ”¶è´§äººå§“å" required>
      <input v-model="orderForm.receiverPhone" placeholder="æ”¶è´§äººç”µè¯" required>
      <input v-model="orderForm.receiverAddress" placeholder="æ”¶è´§åœ°å€" required>
      <button type="submit">åˆ›å»ºè®¢å•</button>
    </form>
    
    <div v-if="order">
      <h3>è®¢å•ä¿¡æ¯</h3>
      <p>è®¢å•å·: {{ order.orderNo }}</p>
      <p>æ€»é‡‘é¢: {{ order.totalAmount }}å…ƒ</p>
      <button @click="payOrder">æ”¯ä»˜å®æ”¯ä»˜</button>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      orderForm: {
        userId: 94,
        receiverName: '',
        receiverPhone: '',
        receiverAddress: '',
        remark: '',
        orderItems: [
          {
            productId: 2002,
            productName: "è´¨æœ´çš„é’¢é‹å­",
            productImage: "https://example.com/shoe.jpg",
            unitPrice: 634.75,
            quantity: 10
          }
        ]
      },
      order: null
    }
  },
  methods: {
    async createOrder() {
      try {
        const response = await fetch('/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.orderForm)
        });
        
        const result = await response.json();
        if (result.success) {
          this.order = result.data;
        }
      } catch (error) {
        console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
      }
    },
    
    async payOrder() {
      try {
        const paymentData = {
          paymentMethod: "ALIPAY",
          amount: Math.round(this.order.totalAmount * 100), // è½¬æ¢ä¸ºåˆ†
          channel: "WEB",
          clientIp: "192.168.1.100",
          userAgent: navigator.userAgent,
          remark: "æ”¯ä»˜å®æ”¯ä»˜"
        };
        
        const response = await fetch(`/orders/${this.order.id}/pay`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(paymentData)
        });
        
        const result = await response.json();
        if (result.success && result.data.payUrl) {
          window.location.href = result.data.payUrl;
        }
      } catch (error) {
        console.error('æ”¯ä»˜å¤±è´¥:', error);
      }
    }
  }
}
</script>
```

---

## ğŸ“± ç§»åŠ¨ç«¯ç¤ºä¾‹

### å¾®ä¿¡å°ç¨‹åº

```javascript
// åˆ›å»ºè®¢å•
wx.request({
  url: 'https://your-domain.com/orders',
  method: 'POST',
  data: {
    userId: 94,
    receiverName: "å¼ ä¸‰",
    receiverPhone: "13800138000",
    receiverAddress: "åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“",
    orderItems: [
      {
        productId: 2002,
        productName: "è´¨æœ´çš„é’¢é‹å­",
        unitPrice: 634.75,
        quantity: 10
      }
    ]
  },
  success: function(res) {
    if (res.data.success) {
      // æ”¯ä»˜è®¢å•
      wx.request({
        url: `https://your-domain.com/orders/${res.data.data.id}/pay`,
        method: 'POST',
        data: {
          paymentMethod: "WECHAT",
          amount: 634750,
          channel: "APP"
        },
        success: function(payRes) {
          if (payRes.data.success) {
            // è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
            wx.requestPayment({
              timeStamp: payRes.data.data.timeStamp,
              nonceStr: payRes.data.data.nonceStr,
              package: payRes.data.data.package,
              signType: payRes.data.data.signType,
              paySign: payRes.data.data.paySign,
              success: function() {
                console.log('æ”¯ä»˜æˆåŠŸ');
              }
            });
          }
        }
      });
    }
  }
});
```

---

## ğŸ”§ æµ‹è¯•å·¥å…·

### Postman æµ‹è¯•

1. **åˆ›å»ºè®¢å•**
   - Method: POST
   - URL: `http://localhost:8080/orders`
   - Headers: `Content-Type: application/json`
   - Body: ä½¿ç”¨ä¸Šé¢çš„JSONç¤ºä¾‹

2. **æ”¯ä»˜è®¢å•**
   - Method: POST
   - URL: `http://localhost:8080/orders/1/pay`
   - Headers: `Content-Type: application/json`
   - Body: ä½¿ç”¨ä¸Šé¢çš„æ”¯ä»˜JSONç¤ºä¾‹

3. **æŸ¥è¯¢æ”¯ä»˜ç»“æœ**
   - Method: GET
   - URL: `http://localhost:8080/api/payment/query/PAY1703123456789ABCDEFGH`

### æµè§ˆå™¨æµ‹è¯•

```html
<!DOCTYPE html>
<html>
<head>
    <title>æ”¯ä»˜æµ‹è¯•</title>
</head>
<body>
    <button onclick="testPayment()">æµ‹è¯•æ”¯ä»˜</button>
    
    <script>
        async function testPayment() {
            // 1. åˆ›å»ºè®¢å•
            const orderResponse = await fetch('/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: 94,
                    receiverName: "å¼ ä¸‰",
                    receiverPhone: "13800138000",
                    receiverAddress: "åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“",
                    orderItems: [
                        {
                            productId: 2002,
                            productName: "è´¨æœ´çš„é’¢é‹å­",
                            unitPrice: 634.75,
                            quantity: 10
                        }
                    ]
                })
            });
            
            const orderResult = await orderResponse.json();
            console.log('è®¢å•åˆ›å»ºç»“æœ:', orderResult);
            
            if (orderResult.success) {
                // 2. æ”¯ä»˜è®¢å•
                const paymentResponse = await fetch(`/orders/${orderResult.data.id}/pay`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentMethod: "ALIPAY",
                        amount: 634750,
                        channel: "WEB",
                        clientIp: "192.168.1.100",
                        userAgent: navigator.userAgent,
                        remark: "æ”¯ä»˜å®æ”¯ä»˜"
                    })
                });
                
                const paymentResult = await paymentResponse.json();
                console.log('æ”¯ä»˜ç»“æœ:', paymentResult);
                
                if (paymentResult.success && paymentResult.data.payUrl) {
                    // 3. è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢
                    window.open(paymentResult.data.payUrl, '_blank');
                }
            }
        }
    </script>
</body>
</html>
```
