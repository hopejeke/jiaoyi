<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jiaoyi.order.mapper.UserOrderIndexMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.jiaoyi.order.entity.UserOrderIndex">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="order_id" property="orderId"/>
        <result column="store_id" property="storeId"/>
        <result column="merchant_id" property="merchantId"/>
        <result column="order_status" property="orderStatus"/>
        <result column="order_type" property="orderType"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 插入索引记录 -->
    <insert id="insert" parameterType="com.jiaoyi.order.entity.UserOrderIndex"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_order_index (
            user_id,
            order_id,
            store_id,
            merchant_id,
            order_status,
            order_type,
            total_amount,
            created_at
        ) VALUES (
            #{userId},
            #{orderId},
            #{storeId},
            #{merchantId},
            #{orderStatus},
            #{orderType},
            #{totalAmount},
            #{createdAt}
        )
    </insert>

    <!-- 批量插入索引记录 -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO user_order_index (
            user_id,
            order_id,
            store_id,
            merchant_id,
            order_status,
            order_type,
            total_amount,
            created_at
        ) VALUES
        <foreach collection="indexes" item="item" separator=",">
            (
                #{item.userId},
                #{item.orderId},
                #{item.storeId},
                #{item.merchantId},
                #{item.orderStatus},
                #{item.orderType},
                #{item.totalAmount},
                #{item.createdAt}
            )
        </foreach>
    </insert>

    <!-- 根据用户ID查询订单索引列表（按创建时间倒序） -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT
            id,
            user_id,
            order_id,
            store_id,
            merchant_id,
            order_status,
            order_type,
            total_amount,
            created_at,
            updated_at
        FROM user_order_index
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <!-- 根据用户ID和订单状态查询订单索引列表 -->
    <select id="selectByUserIdAndStatus" resultMap="BaseResultMap">
        SELECT
            id,
            user_id,
            order_id,
            store_id,
            merchant_id,
            order_status,
            order_type,
            total_amount,
            created_at,
            updated_at
        FROM user_order_index
        WHERE user_id = #{userId}
          AND order_status = #{orderStatus}
        ORDER BY created_at DESC
    </select>

    <!-- 根据用户ID分页查询订单索引列表 -->
    <select id="selectByUserIdWithPage" resultMap="BaseResultMap">
        SELECT
            id,
            user_id,
            order_id,
            store_id,
            merchant_id,
            order_status,
            order_type,
            total_amount,
            created_at,
            updated_at
        FROM user_order_index
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 更新订单状态 -->
    <update id="updateOrderStatus">
        UPDATE user_order_index
        SET order_status = #{orderStatus},
            updated_at = NOW()
        WHERE order_id = #{orderId}
          AND user_id = #{userId}
    </update>

    <!-- 根据订单ID和用户ID删除索引记录 -->
    <delete id="deleteByOrderIdAndUserId">
        DELETE FROM user_order_index
        WHERE order_id = #{orderId}
          AND user_id = #{userId}
    </delete>

    <!-- 根据订单ID查询索引记录（会触发广播查询，仅用于补偿） -->
    <select id="selectByOrderId" resultMap="BaseResultMap">
        SELECT
            id,
            user_id,
            order_id,
            store_id,
            merchant_id,
            order_status,
            order_type,
            total_amount,
            created_at,
            updated_at
        FROM user_order_index
        WHERE order_id = #{orderId}
        LIMIT 1
    </select>

</mapper>
