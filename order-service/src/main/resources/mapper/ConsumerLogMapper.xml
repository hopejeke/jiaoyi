<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiaoyi.order.mapper.ConsumerLogMapper">
    
    <resultMap id="ConsumerLogResultMap" type="com.jiaoyi.order.entity.ConsumerLog">
        <id property="id" column="id"/>
        <result property="consumerGroup" column="consumer_group"/>
        <result property="topic" column="topic"/>
        <result property="tag" column="tag"/>
        <result property="messageKey" column="message_key"/>
        <result property="messageId" column="message_id"/>
        <result property="status" column="status" 
                typeHandler="com.jiaoyi.order.handler.ConsumerStatusTypeHandler"/>
        <result property="errorMessage" column="error_message"/>
        <result property="retryCount" column="retry_count"/>
        <result property="createdAt" column="created_at"/>
        <result property="processedAt" column="processed_at"/>
    </resultMap>
    
    <!-- 尝试插入消费记录（幂等：如果 consumer_group + message_key 已存在则忽略） -->
    <insert id="tryInsert" parameterType="com.jiaoyi.order.entity.ConsumerLog">
        INSERT IGNORE INTO consumer_log (
            consumer_group, topic, tag, message_key, message_id, 
            status, error_message, retry_count, created_at, processed_at
        ) VALUES (
            #{consumerGroup},
            #{topic},
            #{tag},
            #{messageKey},
            #{messageId},
            #{status, typeHandler=com.jiaoyi.order.handler.ConsumerStatusTypeHandler},
            #{errorMessage},
            #{retryCount},
            #{createdAt},
            #{processedAt}
        )
    </insert>
    
    <select id="selectByConsumerGroupAndMessageKey" resultMap="ConsumerLogResultMap">
        SELECT * FROM consumer_log 
        WHERE consumer_group = #{consumerGroup} AND message_key = #{messageKey}
    </select>
    
    <update id="updateStatusToSuccess">
        UPDATE consumer_log 
        SET status = 'SUCCESS',
            processed_at = #{processedAt}
        WHERE consumer_group = #{consumerGroup} AND message_key = #{messageKey}
    </update>
    
    <update id="updateStatusToFailed">
        UPDATE consumer_log 
        SET status = 'FAILED',
            error_message = #{errorMessage},
            retry_count = #{retryCount},
            processed_at = #{processedAt}
        WHERE consumer_group = #{consumerGroup} AND message_key = #{messageKey}
    </update>
    
    <update id="incrementRetryCount">
        UPDATE consumer_log 
        SET retry_count = retry_count + 1
        WHERE consumer_group = #{consumerGroup} AND message_key = #{messageKey}
    </update>
    
</mapper>



