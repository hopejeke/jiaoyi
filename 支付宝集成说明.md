# 支付宝支付集成说明

## 🔧 配置步骤

### 1. 获取支付宝开发者账号

1. 访问 [支付宝开放平台](https://open.alipay.com/)
2. 注册开发者账号
3. 创建应用，获取以下信息：
   - 应用ID (APPID)
   - 商户私钥 (PRIVATE_KEY)
   - 支付宝公钥 (ALIPAY_PUBLIC_KEY)

### 2. 配置应用参数

修改 `src/main/resources/application.yml`：

```yaml
alipay:
  app-id: 你的应用ID
  private-key: 你的商户私钥
  alipay-public-key: 支付宝公钥
  gateway-url: https://openapi.alipay.com/gateway.do
  sign-type: RSA2
  charset: UTF-8
  format: JSON
  notify-url: http://你的域名/api/payment/alipay/notify
  return-url: http://你的域名/api/payment/alipay/return
```

### 3. 配置回调地址

在支付宝开放平台配置：
- **异步通知地址**: `http://你的域名/api/payment/alipay/notify`
- **同步返回地址**: `http://你的域名/api/payment/alipay/return`

## 🚀 使用方式

### 1. 创建支付订单

**接口**: `POST /orders/{orderId}/pay`

**请求示例**:
```json
{
  "paymentMethod": "ALIPAY",
  "amount": 634750,
  "channel": "WEB",
  "clientIp": "192.168.1.100",
  "userAgent": "Mozilla/5.0...",
  "remark": "支付宝支付"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "支付处理成功",
  "data": {
    "paymentNo": "PAY1703123456789ABCDEFGH",
    "status": "PENDING",
    "paymentMethod": "ALIPAY",
    "amount": 634750,
    "payUrl": "https://openapi.alipay.com/gateway.do?...",
    "remark": "支付宝支付订单创建成功"
  }
}
```

### 2. 跳转支付

前端获取 `payUrl` 后，跳转到支付宝支付页面：

```javascript
// 跳转到支付宝支付页面
window.location.href = response.data.payUrl;
```

### 3. 查询支付结果

**接口**: `GET /api/payment/query/{paymentNo}`

**响应示例**:
```json
{
  "success": true,
  "message": "查询成功",
  "data": {
    "paymentNo": "PAY1703123456789ABCDEFGH",
    "status": "SUCCESS",
    "paymentMethod": "ALIPAY",
    "amount": 634750,
    "payTime": "2024-01-01 10:05:00",
    "thirdPartyTradeNo": "2024010122001234567890123456",
    "remark": "支付宝支付成功"
  }
}
```

## 📋 支付流程

1. **创建支付订单** → 返回支付URL
2. **跳转支付页面** → 用户在支付宝完成支付
3. **支付成功回调** → 系统自动更新订单状态
4. **查询支付结果** → 确认支付状态

## 🔍 测试环境

### 沙箱环境配置

```yaml
alipay:
  gateway-url: https://openapi.alipaydev.com/gateway.do
  app-id: 沙箱应用ID
  private-key: 沙箱商户私钥
  alipay-public-key: 沙箱支付宝公钥
```

### 沙箱测试账号

- **买家账号**: 沙箱环境提供的测试账号
- **支付密码**: 沙箱环境提供的测试密码

## ⚠️ 注意事项

1. **生产环境**：必须使用正式的应用ID和密钥
2. **HTTPS**：生产环境必须使用HTTPS
3. **签名验证**：必须验证支付宝回调的签名
4. **幂等性**：处理回调时要保证幂等性
5. **超时处理**：设置合理的支付超时时间

## 🛠️ 开发调试

### 1. 启动应用

```bash
mvn clean compile -U -s settings.xml
mvn spring-boot:run -s settings.xml
```

### 2. 测试支付

```bash
# 创建订单
curl -X POST http://localhost:8080/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 94,
    "receiverName": "张三",
    "receiverPhone": "13800138000",
    "receiverAddress": "北京市朝阳区xxx街道",
    "orderItems": [{
      "productId": 2002,
      "productName": "测试商品",
      "unitPrice": 100.00,
      "quantity": 1
    }]
  }'

# 支付订单
curl -X POST http://localhost:8080/orders/1/pay \
  -H "Content-Type: application/json" \
  -d '{
    "paymentMethod": "ALIPAY",
    "amount": 10000,
    "channel": "WEB"
  }'
```

### 3. 查看日志

```bash
tail -f logs/jiaoyi.log
```
