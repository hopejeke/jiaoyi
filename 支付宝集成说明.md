# æ”¯ä»˜å®æ”¯ä»˜é›†æˆè¯´æ˜

## ğŸ”§ é…ç½®æ­¥éª¤

### 1. è·å–æ”¯ä»˜å®å¼€å‘è€…è´¦å·

1. è®¿é—® [æ”¯ä»˜å®å¼€æ”¾å¹³å°](https://open.alipay.com/)
2. æ³¨å†Œå¼€å‘è€…è´¦å·
3. åˆ›å»ºåº”ç”¨ï¼Œè·å–ä»¥ä¸‹ä¿¡æ¯ï¼š
   - åº”ç”¨ID (APPID)
   - å•†æˆ·ç§é’¥ (PRIVATE_KEY)
   - æ”¯ä»˜å®å…¬é’¥ (ALIPAY_PUBLIC_KEY)

### 2. é…ç½®åº”ç”¨å‚æ•°

ä¿®æ”¹ `src/main/resources/application.yml`ï¼š

```yaml
alipay:
  app-id: ä½ çš„åº”ç”¨ID
  private-key: ä½ çš„å•†æˆ·ç§é’¥
  alipay-public-key: æ”¯ä»˜å®å…¬é’¥
  gateway-url: https://openapi.alipay.com/gateway.do
  sign-type: RSA2
  charset: UTF-8
  format: JSON
  notify-url: http://ä½ çš„åŸŸå/api/payment/alipay/notify
  return-url: http://ä½ çš„åŸŸå/api/payment/alipay/return
```

### 3. é…ç½®å›è°ƒåœ°å€

åœ¨æ”¯ä»˜å®å¼€æ”¾å¹³å°é…ç½®ï¼š
- **å¼‚æ­¥é€šçŸ¥åœ°å€**: `http://ä½ çš„åŸŸå/api/payment/alipay/notify`
- **åŒæ­¥è¿”å›åœ°å€**: `http://ä½ çš„åŸŸå/api/payment/alipay/return`

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. åˆ›å»ºæ”¯ä»˜è®¢å•

**æ¥å£**: `POST /orders/{orderId}/pay`

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "paymentMethod": "ALIPAY",
  "amount": 634750,
  "channel": "WEB",
  "clientIp": "192.168.1.100",
  "userAgent": "Mozilla/5.0...",
  "remark": "æ”¯ä»˜å®æ”¯ä»˜"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æ”¯ä»˜å¤„ç†æˆåŠŸ",
  "data": {
    "paymentNo": "PAY1703123456789ABCDEFGH",
    "status": "PENDING",
    "paymentMethod": "ALIPAY",
    "amount": 634750,
    "payUrl": "https://openapi.alipay.com/gateway.do?...",
    "remark": "æ”¯ä»˜å®æ”¯ä»˜è®¢å•åˆ›å»ºæˆåŠŸ"
  }
}
```

### 2. è·³è½¬æ”¯ä»˜

å‰ç«¯è·å– `payUrl` åï¼Œè·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢ï¼š

```javascript
// è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢
window.location.href = response.data.payUrl;
```

### 3. æŸ¥è¯¢æ”¯ä»˜ç»“æœ

**æ¥å£**: `GET /api/payment/query/{paymentNo}`

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "paymentNo": "PAY1703123456789ABCDEFGH",
    "status": "SUCCESS",
    "paymentMethod": "ALIPAY",
    "amount": 634750,
    "payTime": "2024-01-01 10:05:00",
    "thirdPartyTradeNo": "2024010122001234567890123456",
    "remark": "æ”¯ä»˜å®æ”¯ä»˜æˆåŠŸ"
  }
}
```

## ğŸ“‹ æ”¯ä»˜æµç¨‹

1. **åˆ›å»ºæ”¯ä»˜è®¢å•** â†’ è¿”å›æ”¯ä»˜URL
2. **è·³è½¬æ”¯ä»˜é¡µé¢** â†’ ç”¨æˆ·åœ¨æ”¯ä»˜å®å®Œæˆæ”¯ä»˜
3. **æ”¯ä»˜æˆåŠŸå›è°ƒ** â†’ ç³»ç»Ÿè‡ªåŠ¨æ›´æ–°è®¢å•çŠ¶æ€
4. **æŸ¥è¯¢æ”¯ä»˜ç»“æœ** â†’ ç¡®è®¤æ”¯ä»˜çŠ¶æ€

## ğŸ” æµ‹è¯•ç¯å¢ƒ

### æ²™ç®±ç¯å¢ƒé…ç½®

```yaml
alipay:
  gateway-url: https://openapi.alipaydev.com/gateway.do
  app-id: æ²™ç®±åº”ç”¨ID
  private-key: æ²™ç®±å•†æˆ·ç§é’¥
  alipay-public-key: æ²™ç®±æ”¯ä»˜å®å…¬é’¥
```

### æ²™ç®±æµ‹è¯•è´¦å·

- **ä¹°å®¶è´¦å·**: æ²™ç®±ç¯å¢ƒæä¾›çš„æµ‹è¯•è´¦å·
- **æ”¯ä»˜å¯†ç **: æ²™ç®±ç¯å¢ƒæä¾›çš„æµ‹è¯•å¯†ç 

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒ**ï¼šå¿…é¡»ä½¿ç”¨æ­£å¼çš„åº”ç”¨IDå’Œå¯†é’¥
2. **HTTPS**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
3. **ç­¾åéªŒè¯**ï¼šå¿…é¡»éªŒè¯æ”¯ä»˜å®å›è°ƒçš„ç­¾å
4. **å¹‚ç­‰æ€§**ï¼šå¤„ç†å›è°ƒæ—¶è¦ä¿è¯å¹‚ç­‰æ€§
5. **è¶…æ—¶å¤„ç†**ï¼šè®¾ç½®åˆç†çš„æ”¯ä»˜è¶…æ—¶æ—¶é—´

## ğŸ› ï¸ å¼€å‘è°ƒè¯•

### 1. å¯åŠ¨åº”ç”¨

```bash
mvn clean compile -U -s settings.xml
mvn spring-boot:run -s settings.xml
```

### 2. æµ‹è¯•æ”¯ä»˜

```bash
# åˆ›å»ºè®¢å•
curl -X POST http://localhost:8080/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 94,
    "receiverName": "å¼ ä¸‰",
    "receiverPhone": "13800138000",
    "receiverAddress": "åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“",
    "orderItems": [{
      "productId": 2002,
      "productName": "æµ‹è¯•å•†å“",
      "unitPrice": 100.00,
      "quantity": 1
    }]
  }'

# æ”¯ä»˜è®¢å•
curl -X POST http://localhost:8080/orders/1/pay \
  -H "Content-Type: application/json" \
  -d '{
    "paymentMethod": "ALIPAY",
    "amount": 10000,
    "channel": "WEB"
  }'
```

### 3. æŸ¥çœ‹æ—¥å¿—

```bash
tail -f logs/jiaoyi.log
```
