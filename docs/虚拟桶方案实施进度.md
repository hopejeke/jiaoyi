# è™šæ‹Ÿæ¡¶æ–¹æ¡ˆå®æ–½è¿›åº¦

## âœ… å·²å®Œæˆ

### 1. æ‰©å±•è·¯ç”±è¡¨ç»“æ„
- âœ… åˆ›å»ºå‡çº§ SQLï¼š`upgrade_product_shard_bucket_route.sql`
- âœ… æ·»åŠ å­—æ®µï¼š`tbl_id`, `version`, `target_ds_id`, `target_tbl_id`
- âœ… åˆå§‹åŒ–è¡¨è·¯ç”±æ•°æ®ï¼ˆ`bucket_id % 32`ï¼‰

### 2. æ‰©å±• ProductRouteCache
- âœ… æ·»åŠ è¡¨è·¯ç”±ç¼“å­˜ï¼š`tableRouteMap`
- âœ… æ·»åŠ ç‰ˆæœ¬å·ç¼“å­˜ï¼š`versionMap`
- âœ… æ·»åŠ è¿ç§»ç›®æ ‡ç¼“å­˜ï¼š`migrationTargetMap`
- âœ… æ›´æ–°åŠ è½½é€»è¾‘ï¼ˆå…¨é‡å’Œå¢é‡ï¼‰
- âœ… æ·»åŠ æ–°æ–¹æ³•ï¼š`getTableId()`, `isMigrating()`, `getMigrationTarget()`, `getVersion()`

### 3. åˆ›å»º SpringContextHolder
- âœ… å®ç° `SpringContextHolder` å·¥å…·ç±»
- âœ… æ”¯æŒåœ¨é Spring ç®¡ç†çš„ç±»ä¸­è·å– Bean

### 4. åˆ›å»ºæ–°çš„åˆ†ç‰‡ç®—æ³•
- âœ… `ProductShardIdDatabaseShardingAlgorithmV2`ï¼ˆä½¿ç”¨è·¯ç”±è¡¨ï¼‰
- âœ… `ProductShardIdTableShardingAlgorithmV2`ï¼ˆä½¿ç”¨è·¯ç”±è¡¨ï¼‰
- âœ… æ”¯æŒé™çº§ä¸ºå–æ¨¡ç®—æ³•ï¼ˆ`fallback-to-mod`ï¼‰
- âœ… æ”¯æŒè¿ç§»çŠ¶æ€ï¼ˆMIGRATING æ—¶è¿”å›æºåº“/æºè¡¨ï¼‰

### 5. æ³¨å†Œ SPI
- âœ… åˆ›å»º SPI æ³¨å†Œæ–‡ä»¶ï¼š`META-INF/services/org.apache.shardingsphere.sharding.spi.ShardingAlgorithm`

### 6. æ›´æ–° ShardingSphere é…ç½®
- âœ… æ·»åŠ æ–°ç®—æ³•é…ç½®ï¼ˆV2 ç‰ˆæœ¬ï¼‰
- âœ… ä¿ç•™æ—§ç®—æ³•é…ç½®ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰

### 7. åˆ›å»º bucket_id å­—æ®µæ·»åŠ  SQL
- âœ… åˆ›å»º SQL è„šæœ¬ï¼š`add_bucket_id_to_tables.sql`
- âœ… æ”¯æŒæ‰€æœ‰ä¸šåŠ¡è¡¨ï¼ˆstore_products, product_sku, inventory, inventory_transactions, outboxï¼‰

### 8. å®ç°è‡ªåŠ¨å¡«å……æ‹¦æˆªå™¨
- âœ… åˆ›å»º `BucketIdAutoFillInterceptor`
- âœ… æ”¯æŒä» `product_shard_id` å¡«å……
- âœ… æ”¯æŒä» `store_id` è®¡ç®—å¡«å……
- âœ… æ³¨å†Œåˆ° MyBatis SqlSessionFactory

---

## ğŸ“‹ å¾…æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1ï¼šæ‰§è¡Œ SQL å‡çº§è·¯ç”±è¡¨

```sql
-- æ‰§è¡Œå‡çº§è„šæœ¬
SOURCE product-service/src/main/resources/sql/upgrade_product_shard_bucket_route.sql;
```

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
DESC product_shard_bucket_route;

-- éªŒè¯è¡¨è·¯ç”±åˆ†å¸ƒ
SELECT ds_name, tbl_id, COUNT(*) as bucket_count
FROM product_shard_bucket_route
GROUP BY ds_name, tbl_id
ORDER BY ds_name, tbl_id;
```

### æ­¥éª¤2ï¼šæ‰§è¡Œ SQL æ·»åŠ  bucket_id å­—æ®µ

```sql
-- åœ¨æ¯ä¸ªåˆ†ç‰‡åº“ä¸­æ‰§è¡Œ
SOURCE product-service/src/main/resources/sql/add_bucket_id_to_tables.sql;
```

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
DESC store_products_00;
DESC outbox_00;

-- éªŒè¯æ•°æ®ï¼ˆbucket_id åº”è¯¥ç­‰äº product_shard_idï¼‰
SELECT bucket_id, product_shard_id, COUNT(*) 
FROM store_products_00 
GROUP BY bucket_id, product_shard_id 
LIMIT 10;
```

### æ­¥éª¤3ï¼šé‡å¯åº”ç”¨éªŒè¯

1. é‡å¯åº”ç”¨
2. æ£€æŸ¥æ—¥å¿—ï¼š
   - `ProductRouteCache` åˆå§‹åŒ–æˆåŠŸ
   - `SpringContextHolder` åˆå§‹åŒ–æˆåŠŸ
   - æ–°åˆ†ç‰‡ç®—æ³•åŠ è½½æˆåŠŸ

3. éªŒè¯è·¯ç”±ï¼š
   - æ’å…¥æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦æ­£ç¡®è·¯ç”±
   - æ£€æŸ¥ `bucket_id` æ˜¯å¦è‡ªåŠ¨å¡«å……

### æ­¥éª¤4ï¼šç°åº¦åˆ‡æ¢ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å¹³æ»‘åˆ‡æ¢ï¼Œå¯ä»¥ï¼š

1. **é˜¶æ®µ1**ï¼šéƒ¨ç½²æ–°ä»£ç ï¼Œä½†é…ç½®ä½¿ç”¨æ—§ç®—æ³•ï¼ˆ`product_shard_id_database_old`ï¼‰
2. **é˜¶æ®µ2**ï¼šéªŒè¯æ–°ä»£ç æ— é—®é¢˜åï¼Œåˆ‡æ¢é…ç½®ä½¿ç”¨æ–°ç®—æ³•ï¼ˆ`product_shard_id_database`ï¼‰
3. **é˜¶æ®µ3**ï¼šè§‚å¯Ÿä¸€æ®µæ—¶é—´ï¼Œç¡®è®¤æ— é—®é¢˜åç§»é™¤æ—§ç®—æ³•

---

## ğŸ” éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯

- [ ] è·¯ç”±è¡¨å‡çº§æˆåŠŸï¼ˆå­—æ®µå­˜åœ¨ï¼‰
- [ ] è·¯ç”±ç¼“å­˜åŠ è½½æˆåŠŸï¼ˆ1024 æ¡è·¯ç”±ï¼‰
- [ ] è¡¨è·¯ç”±ç¼“å­˜åŠ è½½æˆåŠŸï¼ˆ1024 æ¡ï¼‰
- [ ] æ–°åˆ†ç‰‡ç®—æ³•æ³¨å†ŒæˆåŠŸ
- [ ] æ’å…¥æ•°æ®æ—¶ `bucket_id` è‡ªåŠ¨å¡«å……
- [ ] æ•°æ®è·¯ç”±æ­£ç¡®ï¼ˆåº“å’Œè¡¨ï¼‰

### æ€§èƒ½éªŒè¯

- [ ] è·¯ç”±æŸ¥è¯¢æ€§èƒ½ï¼ˆåº”è¯¥å¾ˆå¿«ï¼Œä½¿ç”¨ç¼“å­˜ï¼‰
- [ ] æ’å…¥æ€§èƒ½ï¼ˆæ‹¦æˆªå™¨å¼€é”€å¯å¿½ç•¥ï¼‰
- [ ] ç¼“å­˜åˆ·æ–°æ€§èƒ½ï¼ˆå¢é‡åˆ·æ–°ï¼‰

### å…¼å®¹æ€§éªŒè¯

- [ ] æ—§æ•°æ®å…¼å®¹ï¼ˆå·²æœ‰æ•°æ® `bucket_id` æ­£ç¡®ï¼‰
- [ ] é™çº§åŠŸèƒ½ï¼ˆè·¯ç”±è¡¨ä¸å¯ç”¨æ—¶é™çº§ä¸ºå–æ¨¡ï¼‰
- [ ] è¿ç§»çŠ¶æ€ï¼ˆMIGRATING æ—¶è¿”å›æºåº“ï¼‰

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œé¡ºåº**ï¼š
   - å…ˆæ‰§è¡Œè·¯ç”±è¡¨å‡çº§ SQL
   - å†æ‰§è¡Œ bucket_id å­—æ®µæ·»åŠ  SQL
   - æœ€åé‡å¯åº”ç”¨

2. **å›æ»šæ–¹æ¡ˆ**ï¼š
   - å¦‚æœæ–°ç®—æ³•æœ‰é—®é¢˜ï¼Œå¯ä»¥åˆ‡æ¢å›æ—§ç®—æ³•ï¼ˆ`product_shard_id_database_old`ï¼‰
   - è·¯ç”±è¡¨å­—æ®µå¯ä»¥ä¿ç•™ï¼ˆä¸å½±å“æ—§ç®—æ³•ï¼‰

3. **æ€§èƒ½å½±å“**ï¼š
   - è·¯ç”±æŸ¥è¯¢ä½¿ç”¨ç¼“å­˜ï¼Œæ€§èƒ½å½±å“å¯å¿½ç•¥
   - æ‹¦æˆªå™¨åªåœ¨ INSERT æ—¶æ‰§è¡Œï¼Œå¼€é”€å¾ˆå°

4. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - å‡çº§åéœ€è¦åˆå§‹åŒ–å·²æœ‰æ•°æ®çš„ `bucket_id`
   - SQL è„šæœ¬å·²åŒ…å«åˆå§‹åŒ–é€»è¾‘ï¼ˆ`UPDATE ... SET bucket_id = product_shard_id`ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **æ‰§è¡Œ SQL è„šæœ¬**ï¼ˆè·¯ç”±è¡¨å‡çº§ + bucket_id å­—æ®µæ·»åŠ ï¼‰
2. **é‡å¯åº”ç”¨éªŒè¯**
3. **æµ‹è¯•è·¯ç”±åŠŸèƒ½**
4. **å‡†å¤‡æ‰©å®¹è¿ç§»æ–¹æ¡ˆ**ï¼ˆå¦‚æœéœ€è¦ï¼‰


