# é«˜å³°æ‹’å•åŠŸèƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼ˆP7é¢è¯•å‡†å¤‡ï¼‰

## å½“å‰å®ç°å›é¡¾

### æ¶æ„
```
è¯·æ±‚ â†’ å…¨å±€é™æµ(RateLimiter) â†’ é˜²é‡å¤æäº¤(Redissoné”)
     â†’ é«˜å³°æ‹’å•æ£€æŸ¥(DBç»Ÿè®¡) â†’ è®¢å•åˆ›å»º
```

### ä¼˜ç‚¹
1. å¤šå±‚æ¬¡é˜²å¾¡ï¼šå…¨å±€+å•†æˆ·çº§+é˜²é‡
2. ä¸šåŠ¡ç»“åˆå¥½ï¼šåŸºäºå•†æˆ·å®é™…èƒ½åŠ›
3. æœ‰é™çº§å…œåº•ï¼šæ”¯ä»˜é™çº§+è¶…æ—¶å®šæ—¶ä»»åŠ¡

### ä¸è¶³
1. DBæŸ¥è¯¢æˆä¸ºç“¶é¢ˆï¼ˆé«˜å¹¶å‘ä¸‹ï¼‰
2. å›ºå®šæ—¶é—´çª—å£ï¼Œæœ‰çªåˆºé—®é¢˜
3. ç¼ºå°‘ç›‘æ§å’ŒåŠ¨æ€è°ƒæ•´

---

## ä¼˜åŒ–æ–¹æ¡ˆï¼ˆé¢è¯•åŠ åˆ†é¡¹ï¼‰

### æ–¹æ¡ˆä¸€ï¼šRedisæ»‘åŠ¨çª—å£æ›¿ä»£DBæŸ¥è¯¢

**å½“å‰å®ç°ï¼ˆDBæŸ¥è¯¢ï¼‰ï¼š**
```java
// PeakHourRejectionService.java L90-100
int orderCount = orderMapper.countOrdersByMerchantAndTimeRange(
    merchantId,
    validTimeRangeStart,
    Instant.now()
);
```

**ä¼˜åŒ–åï¼ˆRedisæ»‘åŠ¨çª—å£ï¼‰ï¼š**
```java
public class RedisSlidingWindowCounter {

    /**
     * ä½¿ç”¨Redis Sorted Setå®ç°æ»‘åŠ¨çª—å£è®¡æ•°
     * @param merchantId å•†æˆ·ID
     * @param windowMinutes æ—¶é—´çª—å£ï¼ˆåˆ†é’Ÿï¼‰
     * @return çª—å£å†…è®¢å•æ•°
     */
    public int countInWindow(Long merchantId, int windowMinutes) {
        String key = "merchant:orders:" + merchantId;
        long now = System.currentTimeMillis();
        long windowStart = now - windowMinutes * 60 * 1000;

        // 1. æ¸…ç†è¿‡æœŸæ•°æ®
        redisTemplate.opsForZSet().removeRangeByScore(key, 0, windowStart);

        // 2. ç»Ÿè®¡çª—å£å†…æ•°é‡
        Long count = redisTemplate.opsForZSet().count(key, windowStart, now);

        return count == null ? 0 : count.intValue();
    }

    /**
     * æ–°è®¢å•åˆ›å»ºåè°ƒç”¨
     */
    public void recordOrder(Long merchantId, Long orderId) {
        String key = "merchant:orders:" + merchantId;
        long now = System.currentTimeMillis();
        redisTemplate.opsForZSet().add(key, orderId.toString(), now);

        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆçª—å£æ—¶é—´çš„2å€ï¼‰
        redisTemplate.expire(key, windowMinutes * 2, TimeUnit.MINUTES);
    }
}
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
- DBæŸ¥è¯¢ï¼š100msï¼ˆé«˜å³°æœŸï¼‰
- Redisæ»‘åŠ¨çª—å£ï¼š<5ms
- **æ€§èƒ½æå‡20å€**

---

### æ–¹æ¡ˆäºŒï¼šæ¥å…¥Sentinelæµæ§æ¡†æ¶

**ä¸ºä»€ä¹ˆé€‰Sentinelï¼š**
1. é˜¿é‡Œå¼€æºï¼Œç”Ÿäº§éªŒè¯å……åˆ†
2. æ”¯æŒå¤šç§é™æµç®—æ³•ï¼ˆä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ã€æ»‘åŠ¨çª—å£ï¼‰
3. è‡ªé€‚åº”é™æµï¼ˆæ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´ï¼‰
4. çƒ­ç‚¹å‚æ•°é™æµï¼ˆé’ˆå¯¹ç‰¹å®šå•†æˆ·ï¼‰
5. å®æ—¶ç›‘æ§å¤§ç›˜

**æ”¹é€ æ–¹æ¡ˆï¼š**
```java
@Service
public class PeakHourRejectionServiceV2 {

    @SentinelResource(
        value = "checkMerchantCapacity",
        blockHandler = "handleBlock",
        fallback = "handleFallback"
    )
    public CapabilityOfOrder judgeCapabilityOfOrder(Long merchantId) {
        // 1. çƒ­ç‚¹å‚æ•°é™æµï¼ˆé’ˆå¯¹é«˜å¹¶å‘å•†æˆ·ï¼‰
        Entry entry = null;
        try {
            entry = SphU.entry("merchant_capacity_check",
                EntryType.IN,
                1,
                merchantId); // çƒ­ç‚¹å‚æ•°

            // 2. åŸæœ‰é€»è¾‘ï¼šæŸ¥è¯¢Redisæ»‘åŠ¨çª—å£
            int orderCount = redisSlidingWindowCounter.countInWindow(
                merchantId,
                config.getTimeInterval()
            );

            // 3. åˆ¤æ–­æ˜¯å¦è¶…è½½
            if (orderCount >= config.getQtyOfOrders()) {
                // è§¦å‘æ‹’å•
                return buildRejectionResult(config);
            }

            return CapabilityOfOrder.ok();

        } catch (BlockException e) {
            // Sentinelé™æµè§¦å‘
            log.warn("å•†æˆ· {} è§¦å‘Sentinelé™æµ", merchantId);
            return buildRejectionResult("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");

        } finally {
            if (entry != null) {
                entry.exit(1, merchantId);
            }
        }
    }

    /**
     * ç†”æ–­é™çº§å¤„ç†
     */
    public CapabilityOfOrder handleFallback(Long merchantId, Throwable ex) {
        log.error("å•†æˆ·èƒ½åŠ›æ£€æŸ¥å¼‚å¸¸é™çº§, merchantId: {}", merchantId, ex);
        // é™çº§ç­–ç•¥ï¼šå…è®¸æ¥å•ï¼ˆä¼˜å…ˆä¿è¯ç”¨æˆ·ä½“éªŒï¼‰
        return CapabilityOfOrder.ok();
    }
}
```

**Sentinelè§„åˆ™é…ç½®ï¼š**
```java
@Configuration
public class SentinelRuleConfig {

    @PostConstruct
    public void initRules() {
        // 1. çƒ­ç‚¹å‚æ•°é™æµè§„åˆ™
        ParamFlowRule rule = new ParamFlowRule("merchant_capacity_check")
            .setParamIdx(0) // merchantIdå‚æ•°
            .setCount(100)  // æ¯ä¸ªå•†æˆ·100 QPS
            .setGrade(RuleConstant.FLOW_GRADE_QPS)
            .setDurationInSec(1);
        ParamFlowRuleManager.loadRules(Collections.singletonList(rule));

        // 2. ç³»ç»Ÿè‡ªé€‚åº”é™æµï¼ˆæ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´ï¼‰
        SystemRule systemRule = new SystemRule();
        systemRule.setAvgRt(100);        // å¹³å‡å“åº”æ—¶é—´ > 100msè§¦å‘é™æµ
        systemRule.setMaxThread(200);    // æœ€å¤§çº¿ç¨‹æ•°200
        systemRule.setQps(5000);         // ç³»ç»Ÿæ•´ä½“QPS 5000
        SystemRuleManager.loadRules(Collections.singletonList(systemRule));

        // 3. ç†”æ–­é™çº§è§„åˆ™
        DegradeRule degradeRule = new DegradeRule("merchant_capacity_check")
            .setGrade(CircuitBreakerStrategy.ERROR_RATIO.getType())
            .setCount(0.5)               // é”™è¯¯ç‡ > 50%
            .setTimeWindow(60)           // ç†”æ–­60ç§’
            .setMinRequestAmount(10)     // æœ€å°è¯·æ±‚æ•°10
            .setStatIntervalMs(10000);   // ç»Ÿè®¡çª—å£10ç§’
        DegradeRuleManager.loadRules(Collections.singletonList(degradeRule));
    }
}
```

---

### æ–¹æ¡ˆä¸‰ï¼šå¢åŠ ç›‘æ§å’Œå‘Šè­¦

**1. MetricsæŒ‡æ ‡é‡‡é›†ï¼š**
```java
@Service
public class OrderMetricsService {

    private final MeterRegistry meterRegistry;

    // è®¡æ•°å™¨ï¼šæ‹’å•æ¬¡æ•°
    private final Counter rejectionCounter;

    // è®¡æ—¶å™¨ï¼šå¤„ç†è€—æ—¶
    private final Timer capacityCheckTimer;

    // ä»ªè¡¨ç›˜ï¼šå½“å‰è®¢å•æ•°
    private final Gauge currentOrdersGauge;

    public OrderMetricsService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;

        this.rejectionCounter = Counter.builder("order.rejection.count")
            .description("é«˜å³°æ‹’å•æ¬¡æ•°")
            .tag("type", "peak_hour")
            .register(meterRegistry);

        this.capacityCheckTimer = Timer.builder("order.capacity.check.duration")
            .description("å•†æˆ·èƒ½åŠ›æ£€æŸ¥è€—æ—¶")
            .register(meterRegistry);

        this.currentOrdersGauge = Gauge.builder("order.current.count", this,
            service -> getCurrentOrderCount())
            .description("å½“å‰è®¢å•æ•°")
            .register(meterRegistry);
    }

    /**
     * è®°å½•æ‹’å•äº‹ä»¶
     */
    public void recordRejection(Long merchantId, String reason) {
        rejectionCounter.increment();

        // æ‰“å°æ—¥å¿—ä¾›ELKé‡‡é›†
        log.warn("METRIC|ORDER_REJECTION|merchantId={}|reason={}", merchantId, reason);
    }

    /**
     * è®°å½•æ£€æŸ¥è€—æ—¶
     */
    public <T> T recordCheckTime(Supplier<T> supplier) {
        return capacityCheckTimer.record(supplier);
    }
}
```

**2. Prometheus + Grafanaå¤§ç›˜ï¼š**
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'order-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['localhost:8080']
```

**3. å‘Šè­¦è§„åˆ™ï¼ˆPrometheus Alertmanagerï¼‰ï¼š**
```yaml
# alert_rules.yml
groups:
  - name: order_alerts
    interval: 30s
    rules:
      # æ‹’å•ç‡å‘Šè­¦
      - alert: HighRejectionRate
        expr: |
          rate(order_rejection_count[5m]) > 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "è®¢å•æ‹’å•ç‡è¿‡é«˜"
          description: "æœ€è¿‘5åˆ†é’Ÿæ‹’å•ç‡ > 10æ¬¡/åˆ†é’Ÿ"

      # å•†æˆ·èƒ½åŠ›æ£€æŸ¥è€—æ—¶å‘Šè­¦
      - alert: SlowCapacityCheck
        expr: |
          histogram_quantile(0.99,
            rate(order_capacity_check_duration_bucket[5m])
          ) > 0.5
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "å•†æˆ·èƒ½åŠ›æ£€æŸ¥æ…¢æŸ¥è¯¢"
          description: "P99è€—æ—¶ > 500msï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½ç“¶é¢ˆ"
```

**4. æ—¥å¿—é‡‡é›†ï¼ˆELKï¼‰ï¼š**
```java
// ç»“æ„åŒ–æ—¥å¿—
log.info("ORDER_REJECTION|merchantId={}|reason=PEAK_HOUR|" +
         "qtyOfOrders={}|threshold={}|nextOpenAt={}",
         merchantId, orderCount, threshold, nextOpenAt);
```

---

### æ–¹æ¡ˆå››ï¼šåŠ¨æ€è°ƒæ•´é™æµé˜ˆå€¼ï¼ˆæœºå™¨å­¦ä¹ ï¼‰

**èƒŒæ™¯ï¼š**
å½“å‰é˜ˆå€¼æ˜¯é™æ€é…ç½®ï¼ˆå¦‚ï¼š10åˆ†é’Ÿ10å•ï¼‰ï¼Œä½†å•†æˆ·èƒ½åŠ›æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼š
- å‘¨æœ« vs å·¥ä½œæ—¥
- åˆé¤ vs æ™šé¤é«˜å³°
- ä¿ƒé”€æ´»åŠ¨æœŸé—´

**æ–¹æ¡ˆï¼šåŸºäºå†å²æ•°æ®è®­ç»ƒæ¨¡å‹**
```python
# è®­ç»ƒè„šæœ¬ï¼ˆPython + Scikit-learnï¼‰
import pandas as pd
from sklearn.ensemble import RandomForestRegressor

# 1. ç‰¹å¾å·¥ç¨‹
features = [
    'hour',              # æ—¶æ®µï¼ˆ0-23ï¼‰
    'day_of_week',       # æ˜ŸæœŸï¼ˆ0-6ï¼‰
    'is_holiday',        # æ˜¯å¦èŠ‚å‡æ—¥
    'weather',           # å¤©æ°”ï¼ˆæ™´/é›¨/é›ªï¼‰
    'promotion_active',  # æ˜¯å¦ä¿ƒé”€
    'avg_prep_time_7d'   # è¿‡å»7å¤©å¹³å‡åˆ¶ä½œæ—¶é—´
]

target = 'orders_per_10min'  # ç›®æ ‡ï¼š10åˆ†é’Ÿå†…è®¢å•æ•°

# 2. è®­ç»ƒæ¨¡å‹
model = RandomForestRegressor(n_estimators=100)
model.fit(X_train[features], y_train)

# 3. é¢„æµ‹å•†æˆ·èƒ½åŠ›
predicted_capacity = model.predict(current_features)

# 4. åŠ¨æ€è®¾ç½®é˜ˆå€¼
threshold = int(predicted_capacity * 0.9)  # é¢„æµ‹å€¼çš„90%ä½œä¸ºé˜ˆå€¼
```

**Javaé›†æˆï¼š**
```java
@Service
public class DynamicThresholdService {

    private final RestTemplate restTemplate;

    /**
     * è°ƒç”¨Pythonæ¨¡å‹æœåŠ¡è·å–åŠ¨æ€é˜ˆå€¼
     */
    public int getDynamicThreshold(Long merchantId) {
        try {
            ThresholdRequest request = ThresholdRequest.builder()
                .merchantId(merchantId)
                .hour(LocalDateTime.now().getHour())
                .dayOfWeek(LocalDateTime.now().getDayOfWeek().getValue())
                .build();

            ThresholdResponse response = restTemplate.postForObject(
                "http://ml-service:5000/predict/threshold",
                request,
                ThresholdResponse.class
            );

            return response.getThreshold();

        } catch (Exception e) {
            log.error("è·å–åŠ¨æ€é˜ˆå€¼å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼", e);
            return getDefaultThreshold(merchantId);
        }
    }
}
```

---

## æ€§èƒ½å¯¹æ¯”æ€»ç»“

| æ–¹æ¡ˆ | å“åº”æ—¶é—´ | ååé‡ | å‡†ç¡®æ€§ | å®ç°éš¾åº¦ |
|-----|---------|-------|--------|---------|
| **å½“å‰æ–¹æ¡ˆï¼ˆDBæŸ¥è¯¢ï¼‰** | 100ms | 1000 QPS | é«˜ | ä½ |
| **æ–¹æ¡ˆä¸€ï¼ˆRedisæ»‘åŠ¨çª—å£ï¼‰** | <5ms | 20000 QPS | é«˜ | ä¸­ |
| **æ–¹æ¡ˆäºŒï¼ˆSentinelï¼‰** | <10ms | 50000 QPS | é«˜ | ä¸­ |
| **æ–¹æ¡ˆä¸‰ï¼ˆç›‘æ§å‘Šè­¦ï¼‰** | - | - | - | ä¸­ |
| **æ–¹æ¡ˆå››ï¼ˆåŠ¨æ€é˜ˆå€¼ï¼‰** | <10ms | 20000 QPS | æé«˜ | é«˜ |

---

## é¢è¯•è¯æœ¯å»ºè®®

### å¼€åœºï¼ˆ1åˆ†é’Ÿï¼‰
> "æˆ‘è´Ÿè´£è®¾è®¡äº†é«˜å³°æ‹’å•åŠŸèƒ½ï¼Œæ ¸å¿ƒæ€è·¯æ˜¯åŸºäºå•†æˆ·å†å²å¤„ç†èƒ½åŠ›ï¼Œåœ¨è¶…è½½æ—¶ä¸»åŠ¨æ‹’å•ã€‚å®ç°äº†ä¸‰å±‚æµé‡æ§åˆ¶ï¼šå…¨å±€é™æµã€å•†æˆ·çº§é™æµã€é˜²é‡å¤æäº¤ï¼Œå¹¶æœ‰é™çº§å…œåº•æœºåˆ¶ã€‚"

### æ·±å…¥ï¼ˆ2-3åˆ†é’Ÿï¼‰
> "æŠ€æœ¯é€‰å‹ä¸Šï¼Œæˆ‘ç”¨Guava RateLimiterå®ç°ä»¤ç‰Œæ¡¶ï¼ŒRedissonåšåˆ†å¸ƒå¼é”ã€‚å•†æˆ·çº§é™æµæ˜¯æ ¸å¿ƒï¼Œé€šè¿‡ç»Ÿè®¡æ—¶é—´çª—å£å†…çš„è®¢å•æ•°åˆ¤æ–­æ˜¯å¦è¶…è½½ã€‚"

### åæ€ï¼ˆ1-2åˆ†é’Ÿï¼‰â­
> "å›é¡¾è¿™ä¸ªæ–¹æ¡ˆï¼Œæœ‰å‡ ä¸ªå¯ä»¥ä¼˜åŒ–çš„ç‚¹ï¼š
> 1. **ç”¨Redisæ»‘åŠ¨çª—å£æ›¿ä»£DBæŸ¥è¯¢**ï¼Œæ€§èƒ½æå‡20å€
> 2. **æ¥å…¥Sentinel**ï¼Œå®ç°çƒ­ç‚¹å‚æ•°é™æµå’Œç†”æ–­é™çº§
> 3. **å¢åŠ ç›‘æ§**ï¼Œæ¥å…¥Prometheus + Grafana
> 4. **åŠ¨æ€é˜ˆå€¼**ï¼ŒåŸºäºæœºå™¨å­¦ä¹ é¢„æµ‹å•†æˆ·èƒ½åŠ›"

### é«˜é˜¶æ€è€ƒï¼ˆåŠ åˆ†é¡¹ï¼‰
> "å¦‚æœè®©æˆ‘é‡æ–°è®¾è®¡ï¼Œæˆ‘ä¼šå‚è€ƒSentinelçš„è‡ªé€‚åº”é™æµæ€æƒ³ï¼Œç»“åˆç³»ç»Ÿè´Ÿè½½ï¼ˆCPUã€RTã€çº¿ç¨‹æ•°ï¼‰å’Œä¸šåŠ¡æŒ‡æ ‡ï¼ˆè®¢å•å®Œæˆç‡ï¼‰åŠ¨æ€è°ƒæ•´é˜ˆå€¼ã€‚è¿™æ ·æ—¢ä¿æŠ¤ç³»ç»Ÿï¼Œåˆæœ€å¤§åŒ–æ¥å•é‡ã€‚"

---

## é¢è¯•å®˜å¯èƒ½è¿½é—®çš„é—®é¢˜ï¼ˆæå‰å‡†å¤‡ï¼‰

### Q1: ä¸ºä»€ä¹ˆç”¨Guava RateLimiterè€Œä¸æ˜¯Redisé™æµï¼Ÿ
**ç­”ï¼š**
- Guavaé€‚åˆå•æœºé™æµï¼Œæ€§èƒ½æé«˜ï¼ˆçº¯å†…å­˜æ“ä½œï¼‰
- Redisé€‚åˆåˆ†å¸ƒå¼é™æµï¼Œä½†æœ‰ç½‘ç»œå¼€é”€
- æˆ‘ä»¬çš„å…¨å±€é™æµæ˜¯**å•å®ä¾‹é™æµ**ï¼ˆæ¯ä¸ªå®ä¾‹1000 QPSï¼‰ï¼Œæ‰€ä»¥ç”¨Guava
- å¦‚æœè¦åš**é›†ç¾¤æ€»é™æµ**ï¼ˆæ‰€æœ‰å®ä¾‹å…±äº«1000 QPSï¼‰ï¼Œå°±ç”¨Redis

### Q2: æ—¶é—´çª—å£æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ
**ç­”ï¼š**
- å½“å‰æ˜¯**å›ºå®šçª—å£**ï¼Œåœ¨çª—å£è¾¹ç•Œæœ‰**çªåˆºé—®é¢˜**ï¼ˆä¸´ç•Œç‚¹å¯èƒ½ç¬é—´åŒå€æµé‡ï¼‰
- ä¼˜åŒ–æ–¹æ¡ˆï¼š**æ»‘åŠ¨çª—å£**ï¼ˆRedis Sorted Setï¼‰
- è¿›é˜¶æ–¹æ¡ˆï¼š**æ¼æ¡¶ç®—æ³•**ï¼ˆå¹³æ»‘æµé‡ï¼‰æˆ–**ä»¤ç‰Œæ¡¶+æ¼æ¡¶ç»“åˆ**

### Q3: å¦‚æœRedisæŒ‚äº†æ€ä¹ˆåŠï¼Ÿ
**ç­”ï¼š**
- å½“å‰æ–¹æ¡ˆä¼šé™çº§åˆ°DBæŸ¥è¯¢ï¼ˆå¯ç”¨æ€§ > æ€§èƒ½ï¼‰
- æ›´å¥½çš„æ–¹æ¡ˆï¼š**æœ¬åœ°ç¼“å­˜+RedisåŒå†™**ï¼ˆCaffeine + Redisï¼‰
- RedisæŒ‚äº†ï¼Œè¯»å–æœ¬åœ°ç¼“å­˜ï¼ˆå¯èƒ½æœ‰çŸ­æš‚ä¸å‡†ç¡®ï¼Œä½†ç³»ç»Ÿå¯ç”¨ï¼‰

### Q4: å¦‚ä½•é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼Ÿ
**ç­”ï¼š**
- é—®é¢˜ï¼šå¤§é‡è¯·æ±‚åŒæ—¶æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„å•†æˆ·é…ç½®
- æ–¹æ¡ˆï¼š**å¸ƒéš†è¿‡æ»¤å™¨** + **ç©ºå€¼ç¼“å­˜**
- Redissonå®ç°ï¼š`RBloomFilter`

### Q5: åˆ†å¸ƒå¼é”å¦‚æœæ­»é”æ€ä¹ˆåŠï¼Ÿ
**ç­”ï¼š**
- Redissonè‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼ˆWatchdogï¼‰
- è®¾ç½®**leaseTime**ï¼ˆæœ€å¤§æŒæœ‰æ—¶é—´20ç§’ï¼‰
- ä¸šåŠ¡ä»£ç try-finallyç¡®ä¿é‡Šæ”¾
- ç›‘æ§ï¼šé”æŒæœ‰æ—¶é—´ > é˜ˆå€¼å‘Šè­¦

---

## æ€»ç»“

è¿™ä¸ªé«˜å³°æ‹’å•åŠŸèƒ½æ˜¯ä¸€ä¸ª**ä¸­ç­‰åä¸Š**çš„P7é¢è¯•è¯é¢˜ï¼š

### âœ… ä¼˜ç‚¹ï¼š
1. ä½“ç°äº†å¤šå±‚æ¬¡æ¶æ„è®¾è®¡èƒ½åŠ›
2. æœ‰ä¸šåŠ¡ç†è§£ï¼ˆå•†æˆ·èƒ½åŠ›è¯„ä¼°ï¼‰
3. æœ‰é™çº§å®¹é”™æ€ç»´
4. æŠ€æœ¯æ ˆæ‰å®ï¼ˆåˆ†å¸ƒå¼é”ã€é™æµã€AOPï¼‰

### âš ï¸ éœ€è¦è¡¥å……ï¼š
1. å‡†å¤‡ä¼˜åŒ–æ–¹æ¡ˆï¼ˆRedisæ»‘åŠ¨çª—å£ã€Sentinelï¼‰
2. å‡†å¤‡ç›‘æ§æ–¹æ¡ˆï¼ˆPrometheusã€Grafanaï¼‰
3. å‡†å¤‡å‹æµ‹æ•°æ®ï¼ˆè¯æ˜æ€§èƒ½æå‡ï¼‰
4. å‡†å¤‡åæ€æ€»ç»“ï¼ˆå±•ç¤ºæ€è€ƒæ·±åº¦ï¼‰

### ğŸ¯ é¢è¯•ç­–ç•¥ï¼š
- **ä¸è¦å¹ç‰›**ï¼šå¦è¯šå½“å‰å®ç°çš„ä¸è¶³
- **å±•ç¤ºæ€è€ƒ**ï¼šé‡ç‚¹è®²ä¼˜åŒ–æ–¹æ¡ˆå’Œåæ€
- **é‡åŒ–æŒ‡æ ‡**ï¼šå‡†å¤‡æ€§èƒ½æ•°æ®ï¼ˆQPSã€å“åº”æ—¶é—´ï¼‰
- **ä¸šåŠ¡ç»“åˆ**ï¼šå¼ºè°ƒå•†æˆ·èƒ½åŠ›è¯„ä¼°çš„ä¸šåŠ¡ä»·å€¼

**é¢„ç¥é¢è¯•æˆåŠŸï¼** ğŸš€
