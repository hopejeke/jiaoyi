# 订单费用计算说明

## 一、订单总金额计算公式

```
总金额 = 小计 + 配送费 + 税费 + 小费 + 在线服务费 - 优惠金额
```

### 各项费用说明

1. **小计 (Subtotal)**
   - 所有商品单价 × 数量的总和
   - 不包含任何费用

2. **配送费 (Delivery Fee)**
   - 仅配送订单 (`DELIVERY`) 需要
   - 自取/堂食订单配送费为 0

3. **税费 (Tax)**
   - 基于小计计算（扣除优惠后）
   - 税率从商户配置中获取，默认 0%

4. **小费 (Tips)**
   - 用户可选，默认 0

5. **在线服务费 (Service Fee / Charge)**
   - 平台服务费
   - 从商户配置中获取

6. **优惠金额 (Discount)**
   - 优惠券折扣金额
   - 从总金额中扣除

---

## 二、配送费计算逻辑

### 2.1 DoorDash 配送（如果商户配置了 DoorDash）

**流程：**
1. 调用 DoorDash API 获取报价 (`quoted_fee`)
2. 加 10% buffer 以应对费用波动：
   ```
   用户支付的配送费 = quoted_fee + quoted_fee × 10%
   ```
3. 保存 `deliveryFeeQuoted`（DoorDash 报价）到订单

**示例：**
- DoorDash 报价：$5.00
- Buffer (10%)：$0.50
- **用户支付：$5.50**

**费用差额处理：**
- 如果实际账单费用 (`billed_fee`) 与报价不同，会产生差额 (`variance`)
- 差额归因规则：
  - 如果 `billed_fee > quoted_fee`：差额由商户或平台承担
  - 如果 `billed_fee < quoted_fee`：差额归平台所有

### 2.2 本地配送（非 DoorDash）

根据商户配置的配送费类型计算：

#### A. 固定费率 (FLAT_RATE)
```
配送费 = 固定金额（如 $5.00）
```

#### B. 邮编区域费率 (ZONE_RATE)
```
根据收货地址邮编匹配区域费率
配送费 = 匹配区域的固定价格
```

#### C. 距离可变费率 (VARIABLE_RATE)
```
根据商户地址到收货地址的距离计算
配送费 = 根据距离段匹配的费率
```

**通用规则：**
- 检查免配送费门槛：如果小计 ≥ 门槛金额，配送费 = 0
- 应用最小/最大配送费限制
- 如果未配置，默认配送费 = $5.00

---

## 三、税费计算

```
税费 = (小计 - 优惠金额) × 税率
```

- 税率从商户配置中获取
- 默认税率为 0%
- 税费保留 2 位小数

---

## 四、在线服务费计算

根据商户配置的服务费类型：

1. **固定金额 (FIXED)**
   ```
   服务费 = 固定金额
   ```

2. **百分比 (PERCENTAGE)**
   ```
   服务费 = 小计 × 百分比
   ```

3. **阶梯费率 (TIERED)**
   ```
   根据订单金额匹配阶梯费率
   服务费 = 匹配阶梯的费率
   ```

4. **无服务费 (NONE)**
   ```
   服务费 = 0
   ```

---

## 五、DoorDash 费用结算流程

### 5.1 订单创建时
- 调用 DoorDash `quoteDelivery` API 获取报价
- 用户支付：`quoted_fee + 10% buffer`
- 保存 `deliveryFeeQuoted` 到订单

### 5.2 支付成功后
- 调用 DoorDash `createDelivery` API 创建配送订单
- 传递 `quoted_fee` 给 DoorDash

### 5.3 账单结算时（定期）
- 调用 DoorDash `getBill` API 获取实际账单
- 计算差额：`variance = billed_fee - quoted_fee`
- 根据归因规则处理差额

### 5.4 费用字段说明

| 字段 | 说明 | 来源 |
|------|------|------|
| `deliveryFeeQuoted` | DoorDash 报价 | `quoteDelivery` API |
| `deliveryFeeChargedToUser` | 用户实际支付 | `quoted_fee + 10% buffer` |
| `deliveryFeeBilled` | DoorDash 实际账单 | `getBill` API |
| `deliveryFeeVariance` | 费用差额 | `billed_fee - quoted_fee` |

---

## 六、费用计算示例

### 示例 1：DoorDash 配送订单

**订单信息：**
- 小计：$50.00
- DoorDash 报价：$5.00
- 税率：8%
- 在线服务费：$2.00
- 优惠：-$10.00

**计算过程：**
1. 配送费 = $5.00 + ($5.00 × 10%) = **$5.50**
2. 税费 = ($50.00 - $10.00) × 8% = **$3.20**
3. 小费 = $0.00
4. 在线服务费 = **$2.00**
5. 优惠 = **-$10.00**

**总金额 = $50.00 + $5.50 + $3.20 + $0.00 + $2.00 - $10.00 = $50.70**

### 示例 2：本地配送订单（固定费率）

**订单信息：**
- 小计：$30.00
- 配送费类型：FLAT_RATE
- 固定配送费：$5.00
- 税率：8%
- 在线服务费：$1.50
- 优惠：$0.00

**计算过程：**
1. 配送费 = **$5.00**
2. 税费 = $30.00 × 8% = **$2.40**
3. 小费 = $0.00
4. 在线服务费 = **$1.50**
5. 优惠 = $0.00

**总金额 = $30.00 + $5.00 + $2.40 + $0.00 + $1.50 - $0.00 = $38.90**

---

## 七、注意事项

1. **DoorDash Buffer**
   - 10% buffer 是为了应对 DoorDash 实际费用可能高于报价的情况
   - 如果实际费用低于报价，差额归平台所有

2. **费用精度**
   - 所有费用保留 2 位小数
   - 使用 `RoundingMode.HALF_UP` 四舍五入

3. **总金额限制**
   - 总金额不能为负数
   - 如果计算结果 < 0，则设为 0

4. **免配送费门槛**
   - 如果小计达到门槛金额，配送费自动为 0
   - 此规则适用于所有配送费类型





