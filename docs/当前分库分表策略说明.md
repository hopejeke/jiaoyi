# å½“å‰åˆ†åº“åˆ†è¡¨ç­–ç•¥è¯´æ˜

## ğŸ“Š æ•´ä½“æ¶æ„

### æ•°æ®æºé…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®æºæ¶æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   ds_base    â”‚    â”‚     ds0       â”‚    â”‚     ds1       â”‚â”‚
â”‚  â”‚   (jiaoyi)   â”‚    â”‚(jiaoyi_      â”‚    â”‚(jiaoyi_      â”‚â”‚
â”‚  â”‚              â”‚    â”‚ product_0)   â”‚    â”‚ product_1)   â”‚â”‚
â”‚  â”‚ éåˆ†ç‰‡è¡¨ï¼š    â”‚    â”‚              â”‚    â”‚              â”‚â”‚
â”‚  â”‚ - stores     â”‚    â”‚ åˆ†ç‰‡è¡¨ï¼š      â”‚    â”‚ åˆ†ç‰‡è¡¨ï¼š      â”‚â”‚
â”‚  â”‚ - users     â”‚    â”‚ - store_      â”‚    â”‚ - store_      â”‚â”‚
â”‚  â”‚ - outbox_   â”‚    â”‚   products   â”‚    â”‚   products   â”‚â”‚
â”‚  â”‚   node      â”‚    â”‚ - product_skuâ”‚    â”‚ - product_skuâ”‚â”‚
â”‚  â”‚             â”‚    â”‚ - inventory  â”‚    â”‚ - inventory  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                          â”‚     ds2       â”‚                  â”‚
â”‚                          â”‚(jiaoyi_      â”‚                  â”‚
â”‚                          â”‚ product_2)   â”‚                  â”‚
â”‚                          â”‚              â”‚                  â”‚
â”‚                          â”‚ åˆ†ç‰‡è¡¨ï¼š      â”‚                  â”‚
â”‚                          â”‚ - store_     â”‚                  â”‚
â”‚                          â”‚   products   â”‚                  â”‚
â”‚                          â”‚ - product_sku â”‚                  â”‚
â”‚                          â”‚ - inventory  â”‚                  â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æºåˆ—è¡¨**ï¼š
- **ds_base**ï¼šåŸºç¡€æ•°æ®åº“ `jiaoyi`ï¼Œå­˜å‚¨éåˆ†ç‰‡è¡¨
- **ds0**ï¼šåˆ†ç‰‡åº“ `jiaoyi_product_0`
- **ds1**ï¼šåˆ†ç‰‡åº“ `jiaoyi_product_1`
- **ds2**ï¼šåˆ†ç‰‡åº“ `jiaoyi_product_2`

---

## ğŸ¯ æ ¸å¿ƒåˆ†ç‰‡ç­–ç•¥ï¼šè™šæ‹Ÿæ¡¶ï¼ˆVirtual Bucketï¼‰æ–¹æ¡ˆ

### è®¾è®¡æ€æƒ³

```
ä¸šåŠ¡é”® (store_id) â†’ è™šæ‹Ÿæ¡¶ (bucket_id = product_shard_id) â†’ ç‰©ç†è½ç‚¹ (ds + table)
     â†“                        â†“                              â†“
  å›ºå®šç®—æ³•              å›ºå®š1024ä¸ªæ¡¶                     å¯é…ç½®æ˜ å°„è¡¨
  (Murmur3)           (æ°¸ä¸æ”¹å˜)                        (æ”¯æŒåŠ¨æ€æ‰©å®¹)
```

### å…³é”®å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| **è™šæ‹Ÿæ¡¶æ€»æ•°** | 1024 | å›ºå®šä¸å˜ï¼Œæ°¸ä¸æ”¹å˜ |
| **åˆ†ç‰‡åº“æ•°é‡** | 3 | ds0, ds1, ds2 |
| **æ¯åº“åˆ†è¡¨æ•°** | 32 | table_00 ~ table_31 |
| **åˆ†ç‰‡é”®** | `product_shard_id` | åŸºäº `store_id` è®¡ç®—ï¼ˆ0-1023ï¼‰ |

---

## ğŸ”‘ åˆ†ç‰‡é”®è®¡ç®—

### 1. product_shard_id è®¡ç®—ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰

```java
// ä½¿ç”¨ Murmur3 å“ˆå¸Œç®—æ³•
product_shard_id = hash(store_id) & 1023  // 0-1023
```

**å®ç°ä½ç½®**ï¼š`ProductShardUtil.calculateProductShardId(storeId)`

**ç‰¹ç‚¹**ï¼š
- âœ… åˆ†å¸ƒå‡åŒ€ï¼ˆMurmur3 å“ˆå¸Œï¼‰
- âœ… ç»“æœç¨³å®šï¼ˆç›¸åŒ store_id æ€»æ˜¯å¾—åˆ°ç›¸åŒçš„ product_shard_idï¼‰
- âœ… æ°¸ä¸æ”¹å˜ï¼ˆ1024 ä¸ªæ¡¶å›ºå®šï¼‰

### 2. ç‰©ç†è·¯ç”±ï¼ˆé€šè¿‡è·¯ç”±è¡¨ï¼‰

```java
// æŸ¥è¯¢è·¯ç”±è¡¨ product_shard_bucket_route
ds_name = routeMap.get(product_shard_id)      // ds0/ds1/ds2
tbl_id = tableRouteMap.get(product_shard_id) // 0-31
```

**è·¯ç”±è¡¨ç»“æ„**ï¼š`product_shard_bucket_route`
```sql
CREATE TABLE product_shard_bucket_route (
    bucket_id INT PRIMARY KEY,        -- è™šæ‹Ÿæ¡¶IDï¼ˆ0-1023ï¼‰
    ds_name VARCHAR(32) NOT NULL,     -- æ•°æ®æºåç§°ï¼ˆds0/ds1/ds2ï¼‰
    tbl_id INT NOT NULL,              -- è¡¨åç¼€ï¼ˆ0-31ï¼‰
    status VARCHAR(16),                -- çŠ¶æ€ï¼ˆNORMAL/MIGRATINGï¼‰
    version BIGINT,                   -- ç‰ˆæœ¬å·ï¼ˆç”¨äºç¼“å­˜æ›´æ–°ï¼‰
    target_ds_id VARCHAR(32),         -- è¿ç§»ç›®æ ‡æ•°æ®æº
    target_tbl_id INT,                -- è¿ç§»ç›®æ ‡è¡¨
    ...
);
```

**è·¯ç”±ç¼“å­˜**ï¼š`ProductRouteCache`
- å¯åŠ¨æ—¶å…¨é‡åŠ è½½ï¼ˆ1024 æ¡ï¼‰
- å®šæ—¶åˆ·æ–°ï¼ˆæ¯ 10 ç§’ï¼‰
- æ”¯æŒå¢é‡æ›´æ–°ï¼ˆåŸºäº `updated_at`ï¼‰
- æ”¯æŒå¼ºåˆ¶åˆ·æ–°ï¼ˆæ‰©å®¹æ—¶ï¼‰

---

## ğŸ“‹ åˆ†ç‰‡è¡¨é…ç½®

### 1. å•†å“ç›¸å…³è¡¨ï¼ˆä½¿ç”¨ `product_shard_id` åˆ†ç‰‡ï¼‰

| è¡¨å | åˆ†ç‰‡é”® | åˆ†åº“ç®—æ³• | åˆ†è¡¨ç®—æ³• | ç‰©ç†è¡¨æ•°é‡ |
|------|--------|----------|----------|------------|
| `store_products` | `product_shard_id` | è·¯ç”±è¡¨æŸ¥è¯¢ | è·¯ç”±è¡¨æŸ¥è¯¢ | 3åº“ Ã— 32è¡¨ = 96å¼  |
| `product_sku` | `product_shard_id` | è·¯ç”±è¡¨æŸ¥è¯¢ | è·¯ç”±è¡¨æŸ¥è¯¢ | 3åº“ Ã— 32è¡¨ = 96å¼  |
| `inventory` | `product_shard_id` | è·¯ç”±è¡¨æŸ¥è¯¢ | è·¯ç”±è¡¨æŸ¥è¯¢ | 3åº“ Ã— 32è¡¨ = 96å¼  |
| `inventory_transactions` | `product_shard_id` | è·¯ç”±è¡¨æŸ¥è¯¢ | è·¯ç”±è¡¨æŸ¥è¯¢ | 3åº“ Ã— 32è¡¨ = 96å¼  |
| `inventory_deduction_idempotency` | `product_shard_id` | è·¯ç”±è¡¨æŸ¥è¯¢ | ä¸åˆ†è¡¨ | 3åº“ Ã— 1è¡¨ = 3å¼  |

**ç»‘å®šè¡¨å…³ç³»**ï¼š
```java
// store_products, product_sku, inventory, inventory_transactions ç»‘å®š
// ç¡®ä¿åŒä¸€å•†å“çš„æ‰€æœ‰æ•°æ®åœ¨åŒä¸€åˆ†ç‰‡
bindingTableGroups: "store_products,product_sku,inventory,inventory_transactions"
```

### 2. Outbox è¡¨ï¼ˆä½¿ç”¨ `store_id` åˆ†ç‰‡ï¼‰

| è¡¨å | åˆ†ç‰‡é”® | åˆ†åº“ç®—æ³• | åˆ†è¡¨ç®—æ³• | ç‰©ç†è¡¨æ•°é‡ |
|------|--------|----------|----------|------------|
| `outbox` | `store_id` | è®¡ç®— `product_shard_id` åå–æ¨¡ | è®¡ç®— `product_shard_id` åå–æ¨¡ | 3åº“ Ã— 32è¡¨ = 96å¼  |

**ç®—æ³•é€»è¾‘**ï¼š
```java
// 1. store_id â†’ product_shard_id
product_shard_id = ProductShardUtil.calculateProductShardId(storeId);

// 2. product_shard_id â†’ ds_index
ds_index = product_shard_id % 3;  // ds0/ds1/ds2

// 3. product_shard_id â†’ table_index
table_index = product_shard_id % 32;  // table_00..table_31
```

### 3. Merchants ç›¸å…³è¡¨ï¼ˆä½¿ç”¨ `merchant_id` åˆ†ç‰‡ï¼‰

| è¡¨å | åˆ†ç‰‡é”® | åˆ†åº“ç®—æ³• | åˆ†è¡¨ç®—æ³• | ç‰©ç†è¡¨æ•°é‡ |
|------|--------|----------|----------|------------|
| `merchants` | `merchant_id` | å“ˆå¸Œå–æ¨¡ | å“ˆå¸Œå–æ¨¡ | 3åº“ Ã— 3è¡¨ = 9å¼  |
| `store_services` | `merchant_id` | å“ˆå¸Œå–æ¨¡ | å“ˆå¸Œå–æ¨¡ | 3åº“ Ã— 3è¡¨ = 9å¼  |
| `menu_items` | `merchant_id` | å“ˆå¸Œå–æ¨¡ | å“ˆå¸Œå–æ¨¡ | 3åº“ Ã— 3è¡¨ = 9å¼  |

### 4. éåˆ†ç‰‡è¡¨ï¼ˆå­˜å‚¨åœ¨ `ds_base`ï¼‰

| è¡¨å | æ•°æ®æº | è¯´æ˜ |
|------|--------|------|
| `stores` | ds_base | åº—é“ºåŸºç¡€ä¿¡æ¯ |
| `users` | ds_base | ç”¨æˆ·ä¿¡æ¯ |
| `outbox_node` | ds_base | Outbox èŠ‚ç‚¹ä¿¡æ¯ |
| `snowflake_worker` | ds_base | é›ªèŠ±ç®—æ³• Worker é…ç½® |

---

## ğŸ”§ åˆ†ç‰‡ç®—æ³•å®ç°

### 1. æ•°æ®åº“è·¯ç”±ç®—æ³•

#### V2 ç‰ˆæœ¬ï¼ˆæ¨èï¼Œä½¿ç”¨è·¯ç”±è¡¨ï¼‰

**ç±»å**ï¼š`ProductShardIdDatabaseShardingAlgorithmV2`

**é€»è¾‘**ï¼š
```java
1. ä» ProductRouteCache è·å–è·¯ç”±
   ds_name = routeCache.getDataSourceName(product_shard_id);

2. å¦‚æœè·¯ç”±è¡¨ä¸å¯ç”¨ï¼Œé™çº§ä¸ºå–æ¨¡ç®—æ³•
   ds_index = product_shard_id % 3;
   ds_name = "ds" + ds_index;
```

**é…ç½®**ï¼š
```java
algorithmClassName: "com.jiaoyi.product.config.ProductShardIdDatabaseShardingAlgorithmV2"
use-routing-table: true
fallback-to-mod: true
ds-count: 3
ds-prefix: "ds"
```

#### æ—§ç‰ˆæœ¬ï¼ˆå…¼å®¹æ¨¡å¼ï¼Œä¿ç•™å¤‡ç”¨ï¼‰

**ç±»å**ï¼š`ProductShardIdDatabaseShardingAlgorithm`

**é€»è¾‘**ï¼š
```java
ds_index = product_shard_id % dsCount;
ds_name = dsPrefix + ds_index;
```

### 2. è¡¨è·¯ç”±ç®—æ³•

#### V2 ç‰ˆæœ¬ï¼ˆæ¨èï¼Œä½¿ç”¨è·¯ç”±è¡¨ï¼‰

**ç±»å**ï¼š`ProductShardIdTableShardingAlgorithmV2`

**é€»è¾‘**ï¼š
```java
1. ä» ProductRouteCache è·å–è¡¨è·¯ç”±
   tbl_id = routeCache.getTableId(product_shard_id);
   table_name = logic_table + "_" + String.format("%02d", tbl_id);

2. å¦‚æœè·¯ç”±è¡¨ä¸å¯ç”¨ï¼Œé™çº§ä¸ºå–æ¨¡ç®—æ³•
   tbl_id = product_shard_id % 32;
   table_name = logic_table + "_" + String.format("%02d", tbl_id);
```

#### æ—§ç‰ˆæœ¬ï¼ˆå…¼å®¹æ¨¡å¼ï¼Œä¿ç•™å¤‡ç”¨ï¼‰

**ç±»å**ï¼š`ProductShardIdTableShardingAlgorithm`

**é€»è¾‘**ï¼š
```java
tbl_id = product_shard_id % tableCountPerDb;
table_name = logic_table + "_" + String.format("%02d", tbl_id);
```

---

## ğŸš€ æ‰©å®¹æ–¹æ¡ˆ

### æ‰©å®¹æµç¨‹ï¼ˆ3åº“ â†’ 4åº“ï¼‰

```
Step 1: è§„åˆ’è¿ç§»çš„ bucket
  - ä» ds0/ds1/ds2 å„é€‰ä¸€éƒ¨åˆ† bucket è¿ç§»åˆ° ds4
  - ç›®æ ‡ï¼šæ¯ä¸ª ds çº¦ 256 ä¸ª bucketï¼ˆ1024/4ï¼‰

Step 2: æ ‡è®°è¿ç§»çŠ¶æ€
  - æ›´æ–° product_shard_bucket_route è¡¨
  - status = 'MIGRATING'
  - å¡«å…… target_ds_id å’Œ target_tbl_id
  - version + 1ï¼ˆè§¦å‘ç¼“å­˜åˆ·æ–°ï¼‰

Step 3: æ•°æ®è¿ç§»
  - æŒ‰ bucket_id ç­›é€‰æ•°æ®
  - ä»æºåº“æ‹·è´åˆ°ç›®æ ‡åº“
  - å¢é‡åŒæ­¥ï¼ˆCDC/binlogï¼‰

Step 4: åˆ‡æ¢è·¯ç”±
  - æ›´æ–° mappingï¼šds_name = target_ds_id
  - status = 'NORMAL'
  - æ¸…ç©º target_ds_id/target_tbl_id
  - version + 1ï¼ˆè§¦å‘ç¼“å­˜åˆ·æ–°ï¼‰

Step 5: æ¸…ç† & è§‚å¯Ÿ
  - è§‚å¯Ÿä¸€æ®µæ—¶é—´ï¼Œç¡®è®¤æ— å¼‚å¸¸
  - åˆ é™¤æºåº“å†å²æ•°æ®ï¼ˆå¯é€‰ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… åªè¿ç§»éƒ¨åˆ† bucketï¼Œä¸æ˜¯å…¨é‡è¿ç§»
- âœ… æ— éœ€ä¿®æ”¹åˆ†ç‰‡ç®—æ³•ä»£ç 
- âœ… æ”¯æŒå›æ»šï¼ˆæ”¹å›è·¯ç”±è¡¨å³å¯ï¼‰
- âœ… æ”¯æŒåŒå†™ï¼ˆè¿ç§»æœŸé—´ï¼‰

---

## ğŸ“ˆ è·¯ç”±åˆ†å¸ƒç¤ºä¾‹

### åˆå§‹åˆ†å¸ƒï¼ˆ3åº“ï¼Œå‡åŒ€åˆ†é…ï¼‰

```
bucket_id èŒƒå›´      â†’  ds_name  â†’  tbl_id
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0-341              â†’  ds0      â†’  0-31
342-683            â†’  ds1      â†’  0-31
684-1023            â†’  ds2      â†’  0-31
```

### æ‰©å®¹ååˆ†å¸ƒï¼ˆ4åº“ï¼‰

```
bucket_id èŒƒå›´      â†’  ds_name  â†’  tbl_id
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0-255              â†’  ds0      â†’  0-31
256-511             â†’  ds1      â†’  0-31
512-767             â†’  ds2      â†’  0-31
768-1023            â†’  ds3      â†’  0-31
```

---

## ğŸ” æŸ¥è¯¢è·¯ç”±ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ ¹æ® store_id æŸ¥è¯¢å•†å“

```sql
-- ä¸šåŠ¡SQL
SELECT * FROM store_products WHERE store_id = 1217411378021662720;

-- ShardingSphere è·¯ç”±è¿‡ç¨‹ï¼š
-- 1. è®¡ç®— product_shard_id = hash(1217411378021662720) & 1023 = 342
-- 2. æŸ¥è¯¢è·¯ç”±è¡¨ï¼šds_name = "ds1", tbl_id = 10
-- 3. å®é™…SQLï¼šSELECT * FROM store_products_10 WHERE store_id = 1217411378021662720;
-- 4. æ‰§è¡Œä½ç½®ï¼šds1 (jiaoyi_product_1)
```

### ç¤ºä¾‹2ï¼šæ ¹æ® product_shard_id æŸ¥è¯¢ï¼ˆæ¨èï¼‰

```sql
-- ä¸šåŠ¡SQLï¼ˆåŒ…å«åˆ†ç‰‡é”®ï¼‰
SELECT * FROM store_products 
WHERE store_id = 1217411378021662720 
  AND product_shard_id = 342;

-- ShardingSphere è·¯ç”±è¿‡ç¨‹ï¼š
-- 1. ç›´æ¥ä½¿ç”¨ product_shard_id = 342
-- 2. æŸ¥è¯¢è·¯ç”±è¡¨ï¼šds_name = "ds1", tbl_id = 10
-- 3. å®é™…SQLï¼šSELECT * FROM store_products_10 
--            WHERE store_id = 1217411378021662720 
--              AND product_shard_id = 342;
-- 4. æ‰§è¡Œä½ç½®ï¼šds1 (jiaoyi_product_1)
```

### ç¤ºä¾‹3ï¼šæ— åˆ†ç‰‡é”®æŸ¥è¯¢ï¼ˆå…¨åº“æ‰«æï¼‰

```sql
-- ä¸šåŠ¡SQLï¼ˆæ— åˆ†ç‰‡é”®ï¼‰
SELECT * FROM store_products WHERE product_name LIKE '%å•†å“%';

-- ShardingSphere è·¯ç”±è¿‡ç¨‹ï¼š
-- 1. æ— åˆ†ç‰‡é”®ï¼Œå¹¿æ’­æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡
-- 2. å®é™…SQLï¼ˆ96æ¡ï¼‰ï¼š
--    - ds0.store_products_00: SELECT * FROM store_products_00 WHERE product_name LIKE '%å•†å“%';
--    - ds0.store_products_01: SELECT * FROM store_products_01 WHERE product_name LIKE '%å•†å“%';
--    - ... (å…±96æ¡SQL)
--    - ds2.store_products_31: SELECT * FROM store_products_31 WHERE product_name LIKE '%å•†å“%';
-- 3. åˆå¹¶ç»“æœè¿”å›
```

---

## âš™ï¸ è‡ªåŠ¨å¡«å……æœºåˆ¶

### bucket_id è‡ªåŠ¨å¡«å……

**æ‹¦æˆªå™¨**ï¼š`BucketIdAutoFillInterceptor`

**è§¦å‘æ—¶æœº**ï¼šINSERT æ“ä½œæ—¶

**å¡«å……é€»è¾‘**ï¼š
```java
1. å¦‚æœå·²æœ‰ bucket_idï¼Œä¸è¦†ç›–
2. å¦‚æœ product_shard_id æœ‰å€¼ï¼Œbucket_id = product_shard_id
3. å¦‚æœ store_id æœ‰å€¼ï¼Œè®¡ç®— bucket_id = ProductShardUtil.calculateProductShardId(storeId)
```

**æ”¯æŒçš„è¡¨**ï¼š
- `store_products`
- `product_sku`
- `inventory`
- `inventory_transactions`
- `outbox`
- `inventory_deduction_idempotency`

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. è·¯ç”±ç¼“å­˜

- **å…¨é‡ç¼“å­˜**ï¼šå¯åŠ¨æ—¶åŠ è½½ 1024 æ¡è·¯ç”±åˆ°å†…å­˜
- **å¢é‡åˆ·æ–°**ï¼šæ¯ 10 ç§’æ£€æŸ¥æ›´æ–°ï¼Œåªæ‹‰å–å˜æ›´è®°å½•
- **å¼ºåˆ¶åˆ·æ–°**ï¼šæ”¯æŒä¸»åŠ¨åˆ·æ–°ï¼ˆæ‰©å®¹æ—¶ï¼‰

### 2. ç»‘å®šè¡¨ä¼˜åŒ–

- `store_products`, `product_sku`, `inventory`, `inventory_transactions` ç»‘å®š
- ç¡®ä¿ JOIN æŸ¥è¯¢åªæŸ¥è¯¢ä¸€ä¸ªåˆ†ç‰‡

### 3. åˆ†ç‰‡é”®å»ºè®®

- âœ… **æ¨è**ï¼šæŸ¥è¯¢æ—¶åŒ…å« `product_shard_id` æˆ– `store_id`
- âŒ **é¿å…**ï¼šæ— åˆ†ç‰‡é”®çš„æŸ¥è¯¢ï¼ˆä¼šå…¨åº“æ‰«æï¼‰

---

## ğŸ” ä¸»é”®ç”Ÿæˆç­–ç•¥

### é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰

**é…ç½®**ï¼š
```java
key-generator-name: "snowflake"
```

**ç‰¹ç‚¹**ï¼š
- âœ… å…¨å±€å”¯ä¸€
- âœ… åˆ†å¸ƒå¼ç”Ÿæˆ
- âœ… æ€§èƒ½é«˜ï¼ˆæœ¬åœ°ç”Ÿæˆï¼Œæ— éœ€æ•°æ®åº“ï¼‰

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. åˆ†ç‰‡é”®å¿…é¡»åŒ…å«åœ¨æŸ¥è¯¢ä¸­

- âœ… **æ­£ç¡®**ï¼š`WHERE store_id = ?` æˆ– `WHERE product_shard_id = ?`
- âŒ **é”™è¯¯**ï¼š`WHERE product_name = ?`ï¼ˆæ— åˆ†ç‰‡é”®ï¼Œä¼šå…¨åº“æ‰«æï¼‰

### 2. è·¯ç”±è¡¨å¿…é¡»å®Œæ•´

- å¿…é¡»åŒ…å« 0-1023 çš„æ‰€æœ‰ bucket
- åˆå§‹åŒ–å¤±è´¥ä¼šå¯¼è‡´åº”ç”¨å¯åŠ¨å¤±è´¥

### 3. è¿ç§»æœŸé—´

- çŠ¶æ€ä¸º `MIGRATING` æ—¶ï¼Œè·¯ç”±åˆ°æºåº“
- æ”¯æŒåŒå†™ï¼ˆå†™å…¥æºåº“å’Œç›®æ ‡åº“ï¼‰

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **è™šæ‹Ÿæ¡¶æ–¹æ¡ˆ**ï¼šå›ºå®š 1024 ä¸ªæ¡¶ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹
2. **è·¯ç”±è¡¨ç¼“å­˜**ï¼šå†…å­˜ç¼“å­˜ï¼Œæ€§èƒ½é«˜
3. **é™çº§æœºåˆ¶**ï¼šè·¯ç”±è¡¨ä¸å¯ç”¨æ—¶é™çº§ä¸ºå–æ¨¡
4. **è¿ç§»æ”¯æŒ**ï¼šæ”¯æŒåœ¨çº¿è¿ç§»ï¼Œæ— éœ€åœæœº

### åˆ†ç‰‡è§„æ¨¡

- **åˆ†ç‰‡åº“**ï¼š3 ä¸ªï¼ˆds0, ds1, ds2ï¼‰
- **åˆ†ç‰‡è¡¨**ï¼šæ¯åº“ 32 å¼ è¡¨ï¼ˆå•†å“ç›¸å…³è¡¨ï¼‰
- **æ€»è¡¨æ•°**ï¼š96 å¼ è¡¨ï¼ˆå•†å“ç›¸å…³ï¼‰+ 9 å¼ è¡¨ï¼ˆmerchants ç›¸å…³ï¼‰+ éåˆ†ç‰‡è¡¨

### æ‰©å®¹èƒ½åŠ›

- **å½“å‰**ï¼š3 åº“ Ã— 32 è¡¨ = 96 å¼ è¡¨
- **å¯æ‰©å®¹è‡³**ï¼šN åº“ Ã— 32 è¡¨ï¼ˆåªéœ€ä¿®æ”¹è·¯ç”±è¡¨ï¼‰
- **è¿ç§»æˆæœ¬**ï¼šåªè¿ç§»éƒ¨åˆ† bucketï¼Œä¸æ˜¯å…¨é‡è¿ç§»


