# 分片配置代码位置

## 一、核心配置文件

### 1.1 ShardingSphere 主配置

**文件路径**：`order-service/src/main/java/com/jiaoyi/order/config/ShardingSphereConfig.java`

**关键方法**：
- `shardingSphereDataSource()` - 创建 ShardingSphere 数据源
- `createShardingRuleConfiguration()` - 创建分片规则配置
- `createOrdersTableRule()` - **订单表分片规则**（第164行）
- `createOutboxTableRule()` - **Outbox表分片规则**（第383行）
- `createOrderItemsTableRule()` - 订单项表分片规则
- `createPaymentsTableRule()` - 支付表分片规则
- `createRefundsTableRule()` - 退款表分片规则
- `buildActualDataNodes()` - 构建实际数据节点字符串

**代码位置**：
```java
// 订单表分片规则（第164-176行）
private ShardingTableRuleConfiguration createOrdersTableRule() {
    String actualDataNodes = buildActualDataNodes("orders", 3, 32);
    ShardingTableRuleConfiguration tableRule = 
        new ShardingTableRuleConfiguration("orders", actualDataNodes);
    tableRule.setDatabaseShardingStrategy(
        new StandardShardingStrategyConfiguration("store_id", "store_id_database"));
    tableRule.setTableShardingStrategy(
        new StandardShardingStrategyConfiguration("store_id", "store_id_table"));
    return tableRule;
}

// Outbox表分片规则（第383-396行）
private ShardingTableRuleConfiguration createOutboxTableRule() {
    String actualDataNodes = buildActualDataNodes("outbox", 3, 32);
    ShardingTableRuleConfiguration tableRule = 
        new ShardingTableRuleConfiguration("outbox", actualDataNodes);
    tableRule.setDatabaseShardingStrategy(
        new StandardShardingStrategyConfiguration("store_id", "store_id_database"));
    tableRule.setTableShardingStrategy(
        new StandardShardingStrategyConfiguration("store_id", "store_id_table"));
    return tableRule;
}
```

---

## 二、分片算法实现

### 2.1 数据库分片算法

**文件路径**：`order-service/src/main/java/com/jiaoyi/order/config/StoreIdDatabaseShardingAlgorithm.java`

**关键方法**：
- `init(Properties props)` - 初始化（读取 ds-count, ds-prefix）
- `doSharding(Collection<String> availableTargetNames, PreciseShardingValue<Long> shardingValue)` - 精确分片
- `doSharding(Collection<String> availableTargetNames, RangeShardingValue<Long> shardingValue)` - 范围分片

**算法逻辑**：
```java
// 第33-53行
@Override
public String doSharding(Collection<String> availableTargetNames, 
                        PreciseShardingValue<Long> shardingValue) {
    Long storeId = shardingValue.getValue();
    // 计算 shard_id = hash(store_id) & 1023
    int shardId = com.jiaoyi.order.util.ShardUtil.calculateShardId(storeId);
    // 计算数据库索引：shard_id % dsCount
    int dsIndex = shardId % dsCount;
    String dsName = dsPrefix + dsIndex;
    return dsName;
}
```

### 2.2 表分片算法

**文件路径**：`order-service/src/main/java/com/jiaoyi/order/config/StoreIdTableShardingAlgorithm.java`

**关键方法**：
- `init(Properties props)` - 初始化（读取 table.count.per.db）
- `doSharding(Collection<String> availableTargetNames, PreciseShardingValue<Long> shardingValue)` - 精确分片
- `doSharding(Collection<String> availableTargetNames, RangeShardingValue<Long> shardingValue)` - 范围分片

**算法逻辑**：
```java
// 第30-57行
@Override
public String doSharding(Collection<String> availableTargetNames, 
                        PreciseShardingValue<Long> shardingValue) {
    Long storeId = shardingValue.getValue();
    // 计算 shard_id = hash(store_id) & 1023
    int shardId = com.jiaoyi.order.util.ShardUtil.calculateShardId(storeId);
    // 计算表索引：shard_id % 32
    int tableIndex = shardId % tableCountPerDb;
    String tableSuffix = String.format("%02d", tableIndex);
    String targetTableName = logicTableName + "_" + tableSuffix;
    return targetTableName;
}
```

---

## 三、分片工具类

### 3.1 ShardUtil（分片计算工具）

**文件路径**：`order-service/src/main/java/com/jiaoyi/order/util/ShardUtil.java`

**关键方法**：
- `calculateShardId(Long storeId)` - 计算 shard_id（基于 storeId）
- `calculateShardId(String storeId)` - 计算 shard_id（基于 storeId 字符串）
- `calculateTableIndex(int shardId, int tableCountPerDb)` - 计算表索引
- `formatTableIndex(int tableIndex)` - 格式化表索引为两位数字符串

**核心算法**：
```java
// 第55-71行
public static int calculateShardId(String storeId) {
    // 使用 Murmur3_32 哈希算法
    int hashCode = Hashing.murmur3_32()
        .hashString(storeId, StandardCharsets.UTF_8)
        .asInt();
    // 位运算取模：hashCode & 1023
    int shardId = hashCode & BUCKET_MASK;  // BUCKET_MASK = 1023
    return shardId;
}
```

---

## 四、实体类

### 4.1 Order 实体

**文件路径**：`order-service/src/main/java/com/jiaoyi/order/entity/Order.java`

**关键字段**：
```java
// 第31-37行
/**
 * 门店ID（用于分片，与商品服务保持一致）
 */
private Long storeId;

/**
 * 分片ID（0-1023，基于 storeId 计算，用于分库分表路由）
 */
private Integer shardId;
```

### 4.2 OrderItem 实体

**文件路径**：`order-service/src/main/java/com/jiaoyi/order/entity/OrderItem.java`

**关键字段**：
```java
// 第34-40行
/**
 * 门店ID（用于分片，与商品服务保持一致）
 */
private Long storeId;

/**
 * 分片ID（0-1023，基于 storeId 计算，用于分库分表路由）
 */
private Integer shardId;
```

### 4.3 Outbox 实体

**文件路径**：`outbox-starter/src/main/java/com/jiaoyi/outbox/entity/Outbox.java`

**关键字段**：
```java
// 第41-53行
/**
 * 分片键（通用字段，业务方可以存任何分片键值，如 merchant_id、store_id 等）
 */
private String shardingKey;

/**
 * 门店ID（用于分片，与订单和商品服务保持一致）
 */
private Long storeId;

/**
 * 分片ID（用于扫描优化，不再用于分库路由）
 */
private Integer shardId;
```

---

## 五、业务代码使用示例

### 5.1 OrderService（订单服务）

**文件路径**：`order-service/src/main/java/com/jiaoyi/order/service/OrderService.java`

**关键方法**：
- `createOrder(Order order, List<OrderItem> orderItems)` - 创建订单（第557行）
- `calculateOrderPrice(CalculatePriceRequest request)` - 计算订单价格

**使用示例**：
```java
// 第557-600行
@Transactional
public Order createOrder(Order order, List<OrderItem> orderItems) {
    // 从订单项中获取 storeId
    Long storeId = orderItems.get(0).getStoreId();
    
    // 设置 storeId 到订单和订单项
    order.setStoreId(storeId);
    for (OrderItem item : orderItems) {
        item.setStoreId(storeId);
    }
    
    // 计算 shard_id
    int shardId = ShardUtil.calculateShardId(storeId);
    order.setShardId(shardId);
    for (OrderItem item : orderItems) {
        item.setShardId(shardId);
    }
    
    // 插入订单（ShardingSphere 自动路由）
    orderMapper.insert(order);
    orderItemMapper.insertBatch(orderItems);
    
    return order;
}
```

### 5.2 OutboxHelper（Outbox 辅助类）

**文件路径**：`order-service/src/main/java/com/jiaoyi/order/service/OutboxHelper.java`

**关键方法**：
- `enqueueDeductStockTask(Long orderId, List<OrderItem> orderItems)` - 写入库存扣减任务

**使用示例**：
```java
// 第40-121行
public boolean enqueueDeductStockTask(Long orderId, List<OrderItem> orderItems) {
    // 从订单项中获取 storeId
    Long storeId = orderItems.stream()
        .filter(item -> item.getStoreId() != null)
        .map(OrderItem::getStoreId)
        .findFirst()
        .orElse(null);
    
    // 计算 shard_id
    int shardId = ShardUtil.calculateShardId(storeId);
    
    // 写入 outbox（ShardingSphere 自动路由）
    outboxService.enqueue(
        "DEDUCT_STOCK_HTTP",
        String.valueOf(orderId),
        payload,
        null, null, null,
        String.valueOf(storeId),  // shardingKey
        shardId                   // shardId
    );
    
    return true;
}
```

---

## 六、Mapper XML 配置

### 6.1 OrderMapper.xml

**文件路径**：`order-service/src/main/resources/mapper/OrderMapper.xml`

**关键配置**：
```xml
<!-- resultMap 包含 store_id 和 shard_id -->
<resultMap id="BaseResultMap" type="com.jiaoyi.order.entity.Order">
    <result column="store_id" property="storeId"/>
    <result column="shard_id" property="shardId"/>
</resultMap>

<!-- insert 语句包含 store_id 和 shard_id -->
<insert id="insert" parameterType="com.jiaoyi.order.entity.Order">
    INSERT INTO orders (
        merchant_id, store_id, shard_id, ...
    ) VALUES (
        #{merchantId}, #{storeId}, #{shardId}, ...
    )
</insert>
```

### 6.2 OrderItemMapper.xml

**文件路径**：`order-service/src/main/resources/mapper/OrderItemMapper.xml`

**关键配置**：
```xml
<!-- resultMap 包含 store_id 和 shard_id -->
<resultMap id="BaseResultMap" type="com.jiaoyi.order.entity.OrderItem">
    <result column="store_id" property="storeId"/>
    <result column="shard_id" property="shardId"/>
</resultMap>

<!-- insertBatch 语句包含 store_id 和 shard_id -->
<insert id="insertBatch" parameterType="java.util.List">
    INSERT INTO order_items (
        order_id, merchant_id, store_id, shard_id, ...
    ) VALUES
    <foreach collection="list" item="item" separator=",">
        (#{item.orderId}, #{item.merchantId}, #{item.storeId}, #{item.shardId}, ...)
    </foreach>
</insert>
```

---

## 七、数据库初始化

### 7.1 DatabaseInitializer

**文件路径**：`order-service/src/main/java/com/jiaoyi/order/config/DatabaseInitializer.java`

**关键方法**：
- `createOrdersTables(Statement stmt, int dbIndex)` - 创建订单表（第190行）
- `createOutboxTable(Statement stmt, int dbIndex)` - 创建 Outbox 表（第914行）

**表创建逻辑**：
```java
// 第190-250行：创建订单表
private void createOrdersTables(Statement stmt, int dbIndex) throws Exception {
    for (int tableIndex = 0; tableIndex < 32; tableIndex++) {
        String tableName = "orders_" + String.format("%02d", tableIndex);
        String createTableSql = "CREATE TABLE IF NOT EXISTS " + tableName + " (" +
            "id BIGINT PRIMARY KEY, " +
            "merchant_id VARCHAR(50) NOT NULL, " +
            "store_id BIGINT NOT NULL COMMENT '门店ID（用于分片）', " +
            "shard_id INT NOT NULL COMMENT '分片ID（0-1023）', " +
            ...
            ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
        stmt.executeUpdate(createTableSql);
    }
}

// 第914-955行：创建 Outbox 表
private void createOutboxTable(Statement stmt, int dbIndex) throws Exception {
    for (int tableIndex = 0; tableIndex < 32; tableIndex++) {
        String tableName = "outbox_" + String.format("%02d", tableIndex);
        String createTableSql = "CREATE TABLE IF NOT EXISTS " + tableName + " (" +
            "id BIGINT AUTO_INCREMENT PRIMARY KEY, " +
            "sharding_key VARCHAR(100), " +
            "store_id BIGINT NOT NULL COMMENT '门店ID（用于分片）', " +
            "shard_id INT COMMENT '分片ID（0-1023，用于扫描优化）', " +
            ...
            ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
        stmt.executeUpdate(createTableSql);
    }
}
```

---

## 八、配置文件

### 8.1 application.properties

**文件路径**：`order-service/src/main/resources/application.properties`

**关键配置**：
```properties
# 数据源配置（ShardingSphere 会自动管理）
spring.datasource.url=jdbc:mysql://localhost:3306/jiaoyi_order_0
spring.datasource.username=root
spring.datasource.password=root

# ShardingSphere 配置（通过 ShardingSphereConfig.java 配置）
# 分片规则在代码中配置，不在此文件中
```

---

## 九、代码文件清单

### 9.1 核心配置（必须查看）

| 文件路径 | 说明 | 关键行数 |
|---------|------|---------|
| `order-service/src/main/java/com/jiaoyi/order/config/ShardingSphereConfig.java` | ShardingSphere 主配置 | 164-176（订单表），383-396（Outbox表） |
| `order-service/src/main/java/com/jiaoyi/order/config/StoreIdDatabaseShardingAlgorithm.java` | 数据库分片算法 | 33-53 |
| `order-service/src/main/java/com/jiaoyi/order/config/StoreIdTableShardingAlgorithm.java` | 表分片算法 | 30-57 |
| `order-service/src/main/java/com/jiaoyi/order/util/ShardUtil.java` | 分片计算工具 | 55-71 |

### 9.2 实体类（必须查看）

| 文件路径 | 说明 | 关键行数 |
|---------|------|---------|
| `order-service/src/main/java/com/jiaoyi/order/entity/Order.java` | 订单实体 | 31-37 |
| `order-service/src/main/java/com/jiaoyi/order/entity/OrderItem.java` | 订单项实体 | 34-40 |
| `outbox-starter/src/main/java/com/jiaoyi/outbox/entity/Outbox.java` | Outbox 实体 | 41-53 |

### 9.3 业务代码（参考示例）

| 文件路径 | 说明 | 关键行数 |
|---------|------|---------|
| `order-service/src/main/java/com/jiaoyi/order/service/OrderService.java` | 订单服务 | 557-600 |
| `order-service/src/main/java/com/jiaoyi/order/service/OutboxHelper.java` | Outbox 辅助类 | 40-121 |

### 9.4 Mapper XML（参考示例）

| 文件路径 | 说明 |
|---------|------|
| `order-service/src/main/resources/mapper/OrderMapper.xml` | 订单 Mapper |
| `order-service/src/main/resources/mapper/OrderItemMapper.xml` | 订单项 Mapper |

### 9.5 数据库初始化（参考示例）

| 文件路径 | 说明 | 关键行数 |
|---------|------|---------|
| `order-service/src/main/java/com/jiaoyi/order/config/DatabaseInitializer.java` | 数据库初始化 | 190-250（订单表），914-955（Outbox表） |

---

## 十、快速定位

### 10.1 修改分片规则

**修改位置**：`order-service/src/main/java/com/jiaoyi/order/config/ShardingSphereConfig.java`

- 修改数据库数量：第141行 `ds-count`
- 修改表数量：第149行 `table.count.per.db`
- 修改分片键：第171行和第173行 `store_id`

### 10.2 修改分片算法

**修改位置**：
- 数据库分片算法：`order-service/src/main/java/com/jiaoyi/order/config/StoreIdDatabaseShardingAlgorithm.java`
- 表分片算法：`order-service/src/main/java/com/jiaoyi/order/config/StoreIdTableShardingAlgorithm.java`

### 10.3 修改分片计算逻辑

**修改位置**：`order-service/src/main/java/com/jiaoyi/order/util/ShardUtil.java`

- 修改虚拟桶数量：第22行 `BUCKET_COUNT`
- 修改哈希算法：第62行 `Hashing.murmur3_32()`

---

## 十一、总结

### 核心文件（必须了解）

1. ✅ **ShardingSphereConfig.java** - 分片规则配置
2. ✅ **StoreIdDatabaseShardingAlgorithm.java** - 数据库分片算法
3. ✅ **StoreIdTableShardingAlgorithm.java** - 表分片算法
4. ✅ **ShardUtil.java** - 分片计算工具

### 业务代码（参考使用）

5. ✅ **OrderService.java** - 订单服务（使用示例）
6. ✅ **OutboxHelper.java** - Outbox 辅助类（使用示例）

### 实体类（数据结构）

7. ✅ **Order.java** - 订单实体
8. ✅ **Outbox.java** - Outbox 实体

---

**所有代码都在 `order-service` 模块中，除了 Outbox 实体在 `outbox-starter` 模块。**



