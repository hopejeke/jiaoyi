# 渠道库存分配双模式设计文档

## 概述

本系统支持两种渠道库存分配模式，通过开关（`allocation_mode`）切换：

| 模式 | 字段值 | 说明 |
|------|--------|------|
| 方案一：加权配额分配 | `WEIGHTED_QUOTA` | 按权重预分配渠道专属额度 + 共享池兜底 |
| 方案二：安全线保护 | `SAFETY_STOCK` | 不预分配，总库存低于安全线时锁定低优先级渠道 |

---

## 方案一：加权配额分配（WEIGHTED_QUOTA）

### 核心思路

```
总库存 100 份
POS   权重 50 → 分得 50 份（专属额度）
外卖  权重 30 → 分得 30 份（专属额度）
自取  权重 20 → 分得 20 份（专属额度）
余数  → 进共享池（兜底用）
```

扣减时优先消耗本渠道专属额度，额度耗尽再从共享池借。

### 适用场景

- 各渠道业务相对独立，需要保证每个渠道都有"保底份额"
- 不希望某一渠道突发流量把其他渠道的货全吃掉
- 希望库存分配结果可预期、可配置

### 数据库字段（`poi_item_channel_stock` 表）

```sql
channel_weight       DECIMAL(10,2)   -- 渠道权重（如 50、30、20）
channel_quota        DECIMAL(10,1)   -- 本次分配给该渠道的专属额度
channel_sold         DECIMAL(10,1)   -- 该渠道已售数量
-- 渠道剩余 = channel_quota - channel_sold

-- 主表（poi_item_stock）
shared_pool_quantity DECIMAL(10,1)   -- 共享池剩余量（余数 + 各渠道溢出）
```

### 核心逻辑（已实现：`allocateChannelQuotas` + `deductByChannel`）

```
【分配阶段】triggerred by 库存更新 / 定时重分配
1. 取总库存 real_quantity
2. 按权重向下取整分配各渠道 channel_quota
3. 余数 → shared_pool_quantity
4. 重置 channel_sold = 0

【扣减阶段】每次下单
① 渠道已售罄？→ 拒绝
② 尝试原子扣渠道专属额度（channel_quota - channel_sold >= delta）→ 成功
③ 渠道额度不足 → 尝试原子扣共享池（shared_pool_quantity >= delta）→ 成功
④ 都不足 → 返回库存不足
```

### 优缺点

```
优点：
+ 渠道隔离性强，互不抢占
+ 分配规则透明，可运营配置
+ 共享池兜底，避免浪费

缺点：
- 分配时机复杂（何时重分配？库存变动后需触发）
- 渠道额度固定，流量倾斜时利用率低
- 实现较复杂
```

---

## 方案二：安全线保护（SAFETY_STOCK）

### 核心思路

```
总库存 100 份，POS 安全线 = 40

剩余 > 40   → POS + 外卖 + 自取 均可下单
剩余 ≤ 40   → 只有 POS 可以下单（外卖/自取被锁）
剩余 = 0    → 全部售罄
```

安全线是给高优先级渠道（POS）兜底保留的份额，其他渠道会被提前截断。

### 适用场景

- POS 渠道是最高优先级（线下堂食绝不能卖不出去）
- 外卖/自取属于线上渠道，可以提前关闭
- 不需要精细的渠道间分配，只需要"给 POS 留够"

### 数据库字段

新增到 `poi_item_channel_stock` 表（或独立配置表）：

```sql
-- 方案A：在渠道表加字段（推荐，简单）
ALTER TABLE poi_item_channel_stock ADD COLUMN (
    channel_priority   INT          DEFAULT 0,     -- 渠道优先级（越大越高）
    safety_stock       DECIMAL(10,1) DEFAULT 0     -- 该渠道的安全线（仅高优先级渠道配置）
);

-- 字段语义：
-- channel_priority：POS=100, 自取=50, 外卖=10（数值越大优先级越高）
-- safety_stock：当总库存 <= 该值时，优先级 < 本渠道的所有渠道被锁
--              只对高优先级渠道设置，其他渠道不设置（设为0）
```

### 数据示例

```
渠道    priority   safety_stock   含义
POS       100         40         总库存剩40份时，锁定所有低优先级渠道，保留给POS
自取       50          0          不设安全线（不保护）
外卖       10          0          不设安全线（不保护）
```

### 扣减逻辑（待实现）

```java
/**
 * 安全线模式下的库存扣减
 *
 * 逻辑：
 * 1. 查询当前渠道的 priority
 * 2. 查询所有比当前渠道 priority 更高的渠道的 safety_stock 总和
 * 3. 计算可用库存 = real_quantity - 高优先级渠道的 safety_stock 之和
 * 4. 可用库存 >= delta → 允许扣减
 * 5. 可用库存 < delta → 拒绝（"库存已为高优先级渠道保留"）
 */
public ChannelDeductResult deductBySafetyStock(ChannelDeductRequest request) {
    PoiItemStock stock = stockMapper.selectForUpdate(...);
    PoiItemChannelStock myChannel = channelStockMapper.selectByChannel(request.getChannelCode());

    // 计算比我优先级更高的渠道占用的安全线总量
    BigDecimal reservedByHigherPriority = channelStockMapper
        .sumSafetyStockForHigherPriority(stock.getId(), myChannel.getChannelPriority());

    // 我实际能用的库存
    BigDecimal availableForMe = stock.getRealQuantity().subtract(reservedByHigherPriority);

    if (availableForMe.compareTo(request.getQuantity()) < 0) {
        return ChannelDeductResult.outOfStock(availableForMe, BigDecimal.ZERO);
    }

    // 可以扣减
    stockMapper.atomicDeductWithFloor(
        stock.getId(),
        request.getQuantity(),
        reservedByHigherPriority  // 不能扣到安全线以下
    );

    return ChannelDeductResult.success(...);
}
```

### 关键 SQL

```sql
-- 查询比当前渠道优先级更高的渠道的 safety_stock 总和
SELECT COALESCE(SUM(safety_stock), 0)
FROM poi_item_channel_stock
WHERE stock_id = #{stockId}
  AND channel_priority > #{myPriority}
  AND safety_stock > 0;

-- 带安全线的原子扣减（不能扣到高优先级保留线以下）
UPDATE poi_item_stock
SET real_quantity = real_quantity - #{delta}
WHERE id = #{stockId}
  AND real_quantity - #{delta} >= #{safetyFloor}  -- safetyFloor = 高优先级安全线之和
  AND real_quantity >= #{delta};
```

### 多级安全线示例

```
场景：总库存 100
  POS   priority=100  safety_stock=40
  自取  priority=50   safety_stock=10
  外卖  priority=10   safety_stock=0

外卖来扣减时：
  高于外卖优先级的安全线 = POS(40) + 自取(10) = 50
  外卖可用 = 100 - 50 = 50
  → 剩余 > 50 时外卖可买，≤ 50 时外卖被锁

自取来扣减时：
  高于自取优先级的安全线 = POS(40)
  自取可用 = 100 - 40 = 60
  → 剩余 > 40 时自取可买，≤ 40 时自取被锁

POS 来扣减时：
  高于POS优先级的安全线 = 0（没有更高的）
  POS可用 = 100 - 0 = 100（一直能买）
```

### 优缺点

```
优点：
+ 逻辑简单直观，配置少
+ 不需要重分配，库存变动无需触发额外操作
+ 适合"POS优先"这种强优先级场景

缺点：
- 渠道间无法精细控制比例
- 安全线设置不当会导致库存利用率低
  （安全线设太高 → 外卖很早就被锁，但POS未必能卖完）
```

---

## 开关设计

### 在哪里配置

在 `poi_item_stock` 主表新增字段：

```sql
ALTER TABLE poi_item_stock ADD COLUMN (
    allocation_mode VARCHAR(32) DEFAULT 'WEIGHTED_QUOTA'
    -- 枚举值：WEIGHTED_QUOTA | SAFETY_STOCK
);
```

或者放在品牌/门店级别的配置表（一个门店统一用一种模式）：

```sql
-- 门店配置表（推荐）
ALTER TABLE poi_config ADD COLUMN (
    stock_allocation_mode VARCHAR(32) DEFAULT 'WEIGHTED_QUOTA'
);
```

### 扣减入口路由

```java
public ChannelDeductResult deductByChannel(ChannelDeductRequest request) {
    String mode = getStoreAllocationMode(request.getPoiId());

    switch (mode) {
        case "WEIGHTED_QUOTA":
            return deductByWeightedQuota(request);   // 方案一（已实现）
        case "SAFETY_STOCK":
            return deductBySafetyStock(request);     // 方案二（待实现）
        default:
            return deductByWeightedQuota(request);   // 默认走方案一
    }
}
```

---

## 两种方案对比

| 维度 | 方案一（加权配额） | 方案二（安全线） |
|------|----------------|----------------|
| 配置复杂度 | 中（需配置各渠道权重） | 低（只需配置高优先级渠道的安全线） |
| 实现复杂度 | 高（分配 + 扣减 + 重分配触发） | 低（扣减时动态计算） |
| 渠道隔离性 | 强（各渠道有专属额度） | 弱（共享总库存，按优先级保护） |
| 适合场景 | 多渠道并重，需精细分配 | 有明显主次渠道（POS >> 外卖） |
| 库存利用率 | 中（共享池兜底） | 高（没有预分配浪费） |
| 运营理解成本 | 中（权重概念） | 低（安全线概念直观） |

---

## 实施计划

### 已完成（方案一）
- [x] `allocateChannelQuotas()` - 按权重分配渠道额度
- [x] `deductByChannel()` - 先扣渠道额度，再借共享池
- [x] 相关 Mapper 方法（`atomicDeductChannelQuota`, `atomicDeductSharedPool`）

### 待实现（方案二）
- [ ] `poi_item_channel_stock` 新增 `channel_priority`、`safety_stock` 字段
- [ ] `poi_item_stock` 或门店配置表新增 `allocation_mode` 字段
- [ ] `PoiItemChannelStockMapper` 新增 `sumSafetyStockForHigherPriority()` 方法
- [ ] `PoiItemStockMapper` 新增 `atomicDeductWithFloor()` 方法（带安全线的原子扣减）
- [ ] `PoiItemStockService` 新增 `deductBySafetyStock()` 方法
- [ ] `deductByChannel()` 入口增加模式路由
- [ ] 安全线配置的 CRUD 接口（给运营后台用）
