# é€€æ¬¾ç³»ç»Ÿå®‰å…¨æ¼æ´æŠ¥å‘Š ğŸš¨

**å®¡è®¡æ—¥æœŸ**: 2025-02-02
**é£é™©ç­‰çº§**: ğŸ”´ **CRITICAL - æé«˜é£é™©**
**å»ºè®®**: ç«‹å³ä¿®å¤ P0 çº§åˆ«æ¼æ´åå†ä¸Šçº¿

---

## ğŸ“‹ æ¼æ´æ€»è§ˆ

| ç­‰çº§ | æ¼æ´æ•°é‡ | å½±å“ |
|------|---------|------|
| ğŸ”´ P0-CRITICAL | 2ä¸ª | ç›´æ¥å¯¼è‡´èµ„é‡‘æŸå¤±/æ•°æ®æ³„éœ² |
| ğŸŸ  P1-HIGH | 3ä¸ª | é«˜é£é™©å®‰å…¨é—®é¢˜ |
| ğŸŸ¡ P2-MEDIUM | 2ä¸ª | ä¸­ç­‰é£é™© |
| ğŸŸ¢ P3-LOW | 1ä¸ª | ä½é£é™© |

---

## ğŸ”´ P0-CRITICAL æ¼æ´ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰

### 1. ç¼ºå°‘ç”¨æˆ·èº«ä»½è®¤è¯å’Œæƒé™æ ¡éªŒ

**ä½ç½®**: `RefundController.java` å…¨éƒ¨æ¥å£

**æ¼æ´æè¿°**:
```java
@PostMapping
public ResponseEntity<ApiResponse<RefundResponse>> createRefund(@RequestBody RefundRequest request) {
    // âŒ å®Œå…¨æ²¡æœ‰éªŒè¯ç”¨æˆ·èº«ä»½
    // âŒ ä»»ä½•äººå¯ä»¥ä¸ºä»»æ„è®¢å•ç”³è¯·é€€æ¬¾
    RefundResponse response = refundService.createRefund(request);
    return ResponseEntity.ok(ApiResponse.success("é€€æ¬¾ç”³è¯·å·²æäº¤", response));
}
```

**æ”»å‡»åœºæ™¯**:
```bash
# æ”»å‡»è€…ç›´æ¥è°ƒç”¨æ¥å£ï¼Œé€€æ¬¾ä»–äººè®¢å•
curl -X POST http://your-api/api/refunds \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": 123456,  # å—å®³è€…çš„è®¢å•
    "refundType": "BY_AMOUNT",
    "refundAmount": 999.99,
    "requestNo": "REF_ATTACK_001"
  }'

# ç»“æœï¼šè®¢å•è¢«æ¶æ„é€€æ¬¾ï¼Œå¹³å°æŸå¤±èµ„é‡‘
```

**å½±å“**:
- âš ï¸ ä»»ä½•äººå¯ä»¥é€€æ¬¾ä»»æ„è®¢å•
- âš ï¸ å¯æ‰¹é‡é€€æ¬¾å¯¼è‡´å¹³å°å·¨é¢æŸå¤±
- âš ï¸ æŸ¥è¯¢æ¥å£æ³„éœ²ç”¨æˆ·äº¤æ˜“ä¿¡æ¯

**ä¿®å¤æ–¹æ¡ˆ**:
```java
@PostMapping
@PreAuthorize("isAuthenticated()")  // è¦æ±‚ç”¨æˆ·ç™»å½•
public ResponseEntity<ApiResponse<RefundResponse>> createRefund(
        @RequestBody RefundRequest request,
        @AuthenticationPrincipal UserDetails currentUser) {

    // 1. æŸ¥è¯¢è®¢å•
    Order order = orderService.getOrderById(request.getOrderId());

    // 2. éªŒè¯æƒé™ï¼šç”¨æˆ·å¿…é¡»æ˜¯è®¢å•æ‰€æœ‰è€…æˆ–å•†æˆ·
    if (!order.getUserId().equals(currentUser.getUserId()) &&
        !order.getMerchantId().equals(currentUser.getMerchantId())) {
        throw new ForbiddenException("æ— æƒæ“ä½œæ­¤è®¢å•");
    }

    // 3. ç»§ç»­å¤„ç†é€€æ¬¾
    RefundResponse response = refundService.createRefund(request);
    return ResponseEntity.ok(ApiResponse.success("é€€æ¬¾ç”³è¯·å·²æäº¤", response));
}
```

---

### 2. Stripe API å¯†é’¥ç¡¬ç¼–ç å¹¶æš´éœ²

**ä½ç½®**: `application.properties` ç¬¬142-143è¡Œ

**æš´éœ²çš„å¯†é’¥**:
```properties
stripe.secret-key=sk_test_51ScdSXCT67yEvdCoNLORRfCDLwhv38MNJBv3cycNJ9Spa3ivwOITdQ7cjKxokqt5N9WkBDjqLh8b4yvISnWS7Xrp00Ubv3YGz5
stripe.publishable-key=pk_test_51ScdSXCT67yEvdCoRnRLzFEJIXBEDTe943LZAxYjpSHNonXZFFKglRSLsHNn60QeYJFWtlUEUOhPmuK86ARCnAnC00cPio5gYN
```

**ä¸¥é‡æ€§**:
- ğŸ”¥ **å¯†é’¥å·²æš´éœ²åœ¨ Git å†å²ä¸­**
- ğŸ”¥ ä»»ä½•äººå¯ä»¥ç”¨æ­¤å¯†é’¥è¿›è¡Œ Stripe æ“ä½œ
- ğŸ”¥ å¯èƒ½å·²è¢«æ¶æ„ä½¿ç”¨

**ç«‹å³è¡ŒåŠ¨**:
```bash
# 1. ç™»å½• Stripe Dashboard æŸ¥çœ‹ API æ—¥å¿—
# https://dashboard.stripe.com/logs

# 2. ç«‹å³è½®æ¢å¯†é’¥
# Dashboard â†’ Developers â†’ API keys â†’ Roll keys

# 3. ä» Git å†å²ä¸­åˆ é™¤ï¼ˆä½¿ç”¨ BFG Repo-Cleanerï¼‰
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch application.properties" \
  --prune-empty --tag-name-filter cat -- --all

# 4. å¼ºåˆ¶æ¨é€ï¼ˆè­¦å‘Šï¼šä¼šé‡å†™å†å²ï¼‰
git push origin --force --all
```

**ä¿®å¤æ–¹æ¡ˆ**:
```bash
# 1. ä½¿ç”¨ç¯å¢ƒå˜é‡
export STRIPE_SECRET_KEY=sk_live_xxx
export STRIPE_PUBLISHABLE_KEY=pk_live_xxx

# 2. application.yml æ”¹ä¸º
stripe:
  secret-key: ${STRIPE_SECRET_KEY}
  publishable-key: ${STRIPE_PUBLISHABLE_KEY}

# 3. æ·»åŠ åˆ° .gitignore
echo "application-prod.properties" >> .gitignore
echo ".env" >> .gitignore
```

---

## ğŸŸ  P1-HIGH æ¼æ´

### 3. å¹¶å‘é€€æ¬¾å¯¼è‡´è¶…é¢é€€æ¬¾

**ä½ç½®**: `RefundService.java` ç¬¬163-182è¡Œ

**æ¼æ´åŸç†**:
```java
// æ—¶é—´ç‚¹ T1ï¼šçº¿ç¨‹AæŸ¥è¯¢å·²é€€æ¬¾é‡‘é¢
BigDecimal totalRefunded = calculateTotalRefunded(orderId);  // è¿”å›100
BigDecimal availableRefund = 1000 - 100;  // å¯é€€900

// æ—¶é—´ç‚¹ T2ï¼šçº¿ç¨‹Bä¹ŸæŸ¥è¯¢å·²é€€æ¬¾é‡‘é¢
// ï¼ˆæ­¤æ—¶çº¿ç¨‹Açš„é€€æ¬¾è¿˜æœªSUCCEEDEDï¼Œæ‰€ä»¥çº¿ç¨‹Bä¹Ÿçœ‹åˆ°å·²é€€æ¬¾100ï¼‰

// æ—¶é—´ç‚¹ T3ï¼šçº¿ç¨‹Aåˆ›å»ºé€€æ¬¾900
// æ—¶é—´ç‚¹ T4ï¼šçº¿ç¨‹Båˆ›å»ºé€€æ¬¾900

// ç»“æœï¼šæ€»é€€æ¬¾ = 100 + 900 + 900 = 1900 > 1000ï¼ˆè¶…é¢ï¼ï¼‰
```

**é—®é¢˜æ ¹æº**:
1. `calculateTotalRefunded()` åªç»Ÿè®¡ **SUCCEEDED** çŠ¶æ€
2. PROCESSING çŠ¶æ€çš„é€€æ¬¾æœªè¢«è®¡ç®—
3. æ£€æŸ¥å’Œæ‰£å‡ä¸æ˜¯åŸå­æ“ä½œ

**æ”»å‡»åœºæ™¯**:
```bash
# æ”»å‡»è€…å¹¶å‘å‘é€å¤šä¸ªé€€æ¬¾è¯·æ±‚
for i in {1..10}; do
  curl -X POST http://api/refunds \
    -d '{"orderId":123,"refundAmount":100,"requestNo":"REF'$i'"}' &
done

# ç»“æœï¼š10ä¸ªè¯·æ±‚éƒ½é€šè¿‡æ£€æŸ¥ï¼Œæ€»é€€æ¬¾è¿œè¶…è®¢å•é‡‘é¢
```

**ä¿®å¤æ–¹æ¡ˆ**:
```java
private BigDecimal calculateTotalRefunded(Long orderId, boolean includeProcessing) {
    List<Refund> refunds = refundMapper.selectByOrderId(orderId);
    return refunds.stream()
        .filter(r -> {
            String status = r.getStatus();
            // å…³é”®ï¼šåŒæ—¶ç»Ÿè®¡ SUCCEEDED å’Œ PROCESSING
            return RefundStatus.SUCCEEDED.getCode().equals(status) ||
                   (includeProcessing && RefundStatus.PROCESSING.getCode().equals(status));
        })
        .map(Refund::getRefundAmount)
        .reduce(BigDecimal.ZERO, BigDecimal::add);
}

@Transactional
public RefundResponse createRefund(RefundRequest request) {
    String lockKey = "refund:order:" + request.getOrderId();
    RLock lock = redissonClient.getLock(lockKey);

    try {
        if (!lock.tryLock(5, 120, TimeUnit.SECONDS)) {
            throw new RuntimeException("å¤„ç†ä¸­ï¼Œè¯·ç¨åé‡è¯•");
        }

        // æŸ¥è¯¢è®¢å•ï¼ˆåŠ è¡Œé”ï¼‰
        Order order = orderMapper.selectByIdForUpdate(request.getOrderId());

        // è®¡ç®—å¯é€€ä½™é¢ï¼ˆåŒ…æ‹¬PROCESSINGçŠ¶æ€ï¼‰
        BigDecimal totalRefunded = calculateTotalRefunded(order.getId(), true);
        BigDecimal availableRefund = parseOrderPrice(order).subtract(totalRefunded);

        // éªŒè¯é€€æ¬¾é‡‘é¢
        if (calculation.getTotalRefundAmount().compareTo(availableRefund) > 0) {
            throw new RuntimeException("é€€æ¬¾é‡‘é¢è¶…è¿‡å¯é€€ä½™é¢");
        }

        // åˆ›å»ºé€€æ¬¾å•ï¼ˆçŠ¶æ€ï¼šCREATEDï¼‰
        Refund refund = buildRefund(...);
        refundMapper.insert(refund);  // æ­¤æ—¶æ•°æ®åº“ä¸­æœ‰è®°å½•äº†

        // åç»­å¼‚æ­¥å¤„ç†...

    } finally {
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

---

### 4. Webhook ç­¾åéªŒè¯å¯ä»¥ç»•è¿‡

**ä½ç½®**: `StripeWebhookController.java` ç¬¬89-123è¡Œ

**æ¼æ´ä»£ç **:
```java
String webhookSecret = getWebhookSecret();
if (webhookSecret != null && !webhookSecret.isEmpty()
        && !webhookSecret.contains("è¯·æ›¿æ¢")) {  // âŒ å±é™©ï¼
    // éªŒè¯ç­¾å
    event = Webhook.constructEvent(payload, signature, webhookSecret);
} else {
    log.warn("è·³è¿‡ç­¾åéªŒè¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰");
    // âŒ ç›´æ¥è§£æ JSONï¼Œä¸éªŒè¯ç­¾åï¼
    event = ApiResource.GSON.fromJson(payload, Event.class);
}
```

**æ”»å‡»åœºæ™¯**:
```bash
# æ”»å‡»è€…ä¼ªé€  Webhook äº‹ä»¶ï¼Œæ— éœ€æœ‰æ•ˆç­¾å
curl -X POST http://your-api/api/payment/stripe/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "type": "payment_intent.succeeded",
    "data": {
      "object": {
        "id": "pi_fake",
        "metadata": {"orderId": "victim_order"}
      }
    }
  }'

# ç»“æœï¼šå—å®³è€…è®¢å•è¢«æ ‡è®°ä¸ºå·²æ”¯ä»˜ï¼ˆå®é™…æœªæ”¯ä»˜ï¼‰
```

**ä¿®å¤æ–¹æ¡ˆ**:
```java
@PostMapping("/webhook")
public ResponseEntity<String> handleWebhook(
        @RequestBody String payload,
        @RequestHeader(value = "Stripe-Signature", required = true) String signature) {  // å¼ºåˆ¶å¿…éœ€

    // è·å–ç”Ÿäº§ç¯å¢ƒå¯†é’¥ï¼ˆä¸å…è®¸ä¸ºç©ºï¼‰
    String webhookSecret = System.getenv("STRIPE_WEBHOOK_SECRET");
    if (webhookSecret == null || webhookSecret.isEmpty()) {
        log.error("Webhook Secret æœªé…ç½®ï¼");
        return ResponseEntity.status(500).body("Configuration error");
    }

    try {
        // å¼ºåˆ¶éªŒè¯ç­¾å
        Event event = Webhook.constructEvent(payload, signature, webhookSecret);

        // éªŒè¯äº‹ä»¶æ—¶é—´æˆ³ï¼ˆé˜²æ­¢é‡æ”¾æ”»å‡»ï¼‰
        long eventTimestamp = event.getCreated() * 1000;
        if (System.currentTimeMillis() - eventTimestamp > 300000) {  // 5åˆ†é’Ÿ
            log.error("äº‹ä»¶æ—¶é—´æˆ³è¿‡æœŸ");
            return ResponseEntity.status(400).body("Event too old");
        }

        // å¤„ç†äº‹ä»¶...
        handleEvent(event);
        return ResponseEntity.ok("success");

    } catch (SignatureVerificationException e) {
        log.error("ç­¾åéªŒè¯å¤±è´¥", e);
        return ResponseEntity.status(400).body("Invalid signature");
    }
}
```

---

### 5. æ•°æ®ä¸€è‡´æ€§é—®é¢˜

**ä½ç½®**: `RefundService.java` å¼‚æ­¥å¤„ç†éƒ¨åˆ†

**é—®é¢˜åœºæ™¯**:
```
1. é€€æ¬¾å•åˆ›å»ºæˆåŠŸï¼ˆçŠ¶æ€ï¼šCREATEDï¼‰
2. è°ƒç”¨ Stripe API æˆåŠŸåˆ›å»ºé€€æ¬¾
3. Stripe è¿”å› refundId = "re_xxx"
4. å‡†å¤‡æ›´æ–°æœ¬åœ°é€€æ¬¾å•çŠ¶æ€...
5. âŒ æ•°æ®åº“å¼‚å¸¸ï¼Œæ›´æ–°å¤±è´¥
6. ç»“æœï¼š
   - Stripe ç³»ç»Ÿï¼šé€€æ¬¾å·²å®Œæˆ
   - æœ¬åœ°ç³»ç»Ÿï¼šé€€æ¬¾çŠ¶æ€ä»ä¸º PROCESSING
   - è®¢å•çš„ refundAmount æœªæ›´æ–°ï¼ˆè´¦ç›®ä¸ç¬¦ï¼‰
```

**å½±å“**:
- ç”¨æˆ·å¯èƒ½å†æ¬¡ç”³è¯·é€€æ¬¾ï¼ˆé‡å¤é€€æ¬¾ï¼‰
- è´¢åŠ¡æ•°æ®ä¸ä¸€è‡´
- å¯¹è´¦å›°éš¾

**ä¿®å¤æ–¹æ¡ˆ**:
```java
// 1. ä½¿ç”¨ Saga æ¨¡å¼åˆ†ç¦»äº‹åŠ¡
@Transactional
public Refund createRefundRecord(RefundRequest request) {
    // åªåˆ›å»ºé€€æ¬¾å•
    Refund refund = new Refund();
    refund.setStatus(RefundStatus.CREATED.getCode());
    refundMapper.insert(refund);
    return refund;
}

@Async
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void processRefundWithCompensation(Refund refund) {
    try {
        // è°ƒç”¨ç¬¬ä¸‰æ–¹
        RefundResult result = paymentAdapter.createRefund(...);

        // æ›´æ–°çŠ¶æ€
        updateRefundStatus(refund.getRefundId(), RefundStatus.SUCCEEDED);
        updateOrderRefundAmount(refund.getOrderId());

    } catch (Exception e) {
        log.error("é€€æ¬¾å¤„ç†å¤±è´¥ï¼Œè§¦å‘è¡¥å¿", e);

        // è¡¥å¿é€»è¾‘ï¼šæ ‡è®°ä¸ºå¤±è´¥ï¼Œç­‰å¾…äººå·¥å¤„ç†
        refundMapper.updateStatusWithError(
            refund.getRefundId(),
            RefundStatus.FAILED.getCode(),
            e.getMessage()
        );

        // å‘é€å‘Šè­¦
        alertService.sendAlert("é€€æ¬¾å¼‚å¸¸", refund.getRefundId());
    }
}

// 2. æ·»åŠ å®šæ—¶ä»»åŠ¡æ£€æŸ¥ä¸ä¸€è‡´æ•°æ®
@Scheduled(fixedRate = 300000)  // æ¯5åˆ†é’Ÿ
public void checkInconsistentRefunds() {
    // æŸ¥è¯¢ PROCESSING çŠ¶æ€è¶…è¿‡24å°æ—¶çš„é€€æ¬¾
    List<Refund> processingRefunds = refundMapper.selectLongProcessing(24);

    for (Refund refund : processingRefunds) {
        // æŸ¥è¯¢ Stripe çœŸå®çŠ¶æ€
        if (refund.getThirdPartyRefundId() != null) {
            RefundStatus actualStatus = stripeAdapter.queryRefundStatus(
                refund.getThirdPartyRefundId()
            );

            // åŒæ­¥çŠ¶æ€
            if (actualStatus == RefundStatus.SUCCEEDED) {
                updateRefundStatus(refund.getRefundId(), RefundStatus.SUCCEEDED);
                updateOrderRefundAmount(refund.getOrderId());
            }
        }
    }
}
```

---

## ğŸŸ¡ P2-MEDIUM æ¼æ´

### 6. å‚æ•°æ ¡éªŒä¸è¶³

**é—®é¢˜**:
```java
@Data
public class RefundRequest {
    private BigDecimal refundAmount;  // âŒ æ— èŒƒå›´æ ¡éªŒ
    private Integer refundQuantity;   // âŒ æ— ä¸Šé™æ ¡éªŒ
}
```

**æ”»å‡»åœºæ™¯**:
```json
{
  "orderId": 123,
  "refundType": "BY_AMOUNT",
  "refundAmount": 999999999999.99  // å·¨å¤§æ•°å­—
}
```

**ä¿®å¤**:
```java
@Data
public class RefundRequest {

    @NotNull
    private Long orderId;

    @Positive
    @DecimalMax("999999.99")
    @Digits(integer = 6, fraction = 2)
    private BigDecimal refundAmount;

    @Positive
    @Max(99999)
    private Integer refundQuantity;

    @Size(max = 500)
    private String reason;
}
```

---

### 7. é”™è¯¯ä¿¡æ¯æ³„éœ²

**é—®é¢˜**:
```java
return ResponseEntity.ok(ApiResponse.error("åˆ›å»ºé€€æ¬¾å¤±è´¥: " + e.getMessage()));
// å¯èƒ½æ³„éœ²ï¼šæ•°æ®åº“é”™è¯¯ã€SQLè¯­å¥ã€å†…éƒ¨è·¯å¾„ç­‰
```

**ä¿®å¤**:
```java
try {
    // ...
} catch (BusinessException e) {
    return ResponseEntity.ok(ApiResponse.error(e.getMessage()));
} catch (Exception e) {
    log.error("åˆ›å»ºé€€æ¬¾å¤±è´¥", e);
    return ResponseEntity.ok(ApiResponse.error("åˆ›å»ºé€€æ¬¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"));
}
```

---

## ğŸŸ¢ P3-LOW æ¼æ´

### 8. é€Ÿç‡é™åˆ¶ä¸è¶³

**é—®é¢˜**: åªæœ‰å…¨å±€é€Ÿç‡é™åˆ¶ï¼ˆ5 QPSï¼‰ï¼Œæ²¡æœ‰åŸºäºç”¨æˆ·çš„é™åˆ¶

**æ”¹è¿›**:
```java
@RateLimit(
    key = "refund:user:{userId}",
    permits = 10,
    duration = 3600
)
public ResponseEntity<ApiResponse<RefundResponse>> createRefund(...) {
    // ...
}
```

---

## ğŸ› ï¸ ç«‹å³è¡ŒåŠ¨æ¸…å•

### å¿…é¡»ç«‹å³å®Œæˆï¼ˆä¸Šçº¿å‰ï¼‰

```bash
[ ] 1. è½®æ¢ Stripe API å¯†é’¥
[ ] 2. ä» Git å†å²ä¸­åˆ é™¤æ•æ„Ÿä¿¡æ¯
[ ] 3. æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæƒé™æ ¡éªŒ
[ ] 4. å¼ºåˆ¶ Webhook ç­¾åéªŒè¯
```

### é«˜ä¼˜å…ˆçº§ï¼ˆ1å‘¨å†…ï¼‰

```bash
[ ] 5. ä¿®å¤å¹¶å‘è¶…é¢é€€æ¬¾é—®é¢˜
[ ] 6. æ·»åŠ æ•°æ®ä¸€è‡´æ€§è¡¥å¿æœºåˆ¶
[ ] 7. æ”¹è¿›é”™è¯¯å¤„ç†å’Œæ—¥å¿—
[ ] 8. æ·»åŠ å‚æ•°æ ¡éªŒ
```

### ä¸­ä¼˜å…ˆçº§ï¼ˆ1ä¸ªæœˆå†…ï¼‰

```bash
[ ] 9. æ·»åŠ æ“ä½œå®¡è®¡æ—¥å¿—
[ ] 10. å®ç°è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•
[ ] 11. é…ç½®å…¥ä¾µæ£€æµ‹
[ ] 12. æ·»åŠ é€Ÿç‡é™åˆ¶å’Œé˜²æŠ¤
```

---

## ğŸ“Š é£é™©è¯„ä¼°

| é£é™©ç±»å‹ | å½“å‰çŠ¶æ€ | ä¿®å¤åçŠ¶æ€ | ä¼˜å…ˆçº§ |
|---------|---------|-----------|--------|
| è¶Šæƒè®¿é—® | ğŸ”´ æé«˜ | ğŸŸ¢ ä½ | P0 |
| å¯†é’¥æ³„éœ² | ğŸ”´ æé«˜ | ğŸŸ¢ ä½ | P0 |
| å¹¶å‘é—®é¢˜ | ğŸŸ  é«˜ | ğŸŸ¡ ä¸­ | P1 |
| Webhookä¼ªé€  | ğŸŸ  é«˜ | ğŸŸ¢ ä½ | P1 |
| æ•°æ®ä¸ä¸€è‡´ | ğŸŸ  é«˜ | ğŸŸ¡ ä¸­ | P1 |
| å‚æ•°ç»•è¿‡ | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | P2 |
| ä¿¡æ¯æ³„éœ² | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | P2 |
| DDoSæ”»å‡» | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | P3 |

---

## ğŸ“ ä¿®å¤éªŒè¯æ¸…å•

### éªŒè¯æ–¹æ³•

1. **æƒé™æ ¡éªŒéªŒè¯**:
```bash
# æµ‹è¯•ï¼šæœªç™»å½•ç”¨æˆ·å°è¯•é€€æ¬¾
curl -X POST http://api/refunds \
  -d '{"orderId":123,"refundAmount":100}' \
  -H "Content-Type: application/json"

# æœŸæœ›ï¼š401 Unauthorized

# æµ‹è¯•ï¼šç”¨æˆ·Aå°è¯•é€€æ¬¾ç”¨æˆ·Bçš„è®¢å•
curl -X POST http://api/refunds \
  -d '{"orderId":456,"refundAmount":100}' \
  -H "Authorization: Bearer user_A_token"

# æœŸæœ›ï¼š403 Forbidden
```

2. **å¹¶å‘æµ‹è¯•**:
```bash
# ä½¿ç”¨ JMeter æˆ– ab å·¥å…·
ab -n 100 -c 10 -p refund.json \
  -T application/json \
  http://api/refunds

# éªŒè¯ï¼šæ‰€æœ‰é€€æ¬¾é‡‘é¢æ€»å’Œ <= è®¢å•é‡‘é¢
```

3. **Webhook éªŒè¯**:
```bash
# æµ‹è¯•ï¼šä¼ªé€ ç­¾å
curl -X POST http://api/payment/stripe/webhook \
  -H "Stripe-Signature: fake_signature" \
  -d '{"type":"payment_intent.succeeded"}'

# æœŸæœ›ï¼š400 Invalid signature
```

---

## ğŸ¯ é¢è¯•æ—¶å¦‚ä½•å›ç­”

### å¦‚æœé¢è¯•å®˜é—®ï¼š"ä½ çš„ç³»ç»Ÿæœ‰ä»€ä¹ˆå®‰å…¨é—®é¢˜ï¼Ÿ"

**å¥½çš„å›ç­”** âœ…:
> "åœ¨è¿›è¡Œå®‰å…¨å®¡è®¡æ—¶ï¼Œæˆ‘å‘ç°äº†å‡ ä¸ªå…³é”®é—®é¢˜ï¼š
>
> 1. **æƒé™æ ¡éªŒç¼ºå¤±**ï¼šé€€æ¬¾æ¥å£æ²¡æœ‰éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œå­˜åœ¨è¶Šæƒé£é™©ã€‚æˆ‘æ·»åŠ äº†åŸºäºSpring Securityçš„æƒé™æ ¡éªŒï¼Œç¡®ä¿åªæœ‰è®¢å•æ‰€æœ‰è€…æˆ–å•†æˆ·æ‰èƒ½æ“ä½œã€‚
>
> 2. **å¹¶å‘å®‰å…¨**ï¼šè™½ç„¶ç”¨äº†åˆ†å¸ƒå¼é”ï¼Œä½†åœ¨ç»Ÿè®¡å¯é€€ä½™é¢æ—¶åªè®¡ç®—äº†SUCCEEDEDçŠ¶æ€ï¼Œå¿½ç•¥äº†PROCESSINGçŠ¶æ€ï¼Œå¯èƒ½å¯¼è‡´è¶…é¢é€€æ¬¾ã€‚æˆ‘æ”¹è¿›äº†è®¡ç®—é€»è¾‘ï¼ŒåŒæ—¶ç»Ÿè®¡ä¸¤ç§çŠ¶æ€ã€‚
>
> 3. **ç¬¬ä¸‰æ–¹é›†æˆå®‰å…¨**ï¼šWebhookç­¾åéªŒè¯åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥ç»•è¿‡ã€‚æˆ‘å¼ºåˆ¶è¦æ±‚ç­¾åéªŒè¯ï¼Œå¹¶æ·»åŠ äº†æ—¶é—´æˆ³æ£€æŸ¥é˜²æ­¢é‡æ”¾æ”»å‡»ã€‚
>
> è¿™äº›é—®é¢˜åœ¨å®‰å…¨å®¡è®¡ä¸­è¢«å‘ç°ï¼Œå·²ç»å…¨éƒ¨ä¿®å¤å¹¶é€šè¿‡äº†æ¸—é€æµ‹è¯•ã€‚"

**ä¸å¥½çš„å›ç­”** âŒ:
> "æ²¡æœ‰ä»€ä¹ˆå®‰å…¨é—®é¢˜ï¼Œæˆ‘éƒ½è€ƒè™‘åˆ°äº†ã€‚"
> ï¼ˆé¢è¯•å®˜å¿ƒæƒ³ï¼šè¦ä¹ˆä»£ç æœ‰é—®é¢˜ï¼Œè¦ä¹ˆå®‰å…¨æ„è¯†ä¸å¤Ÿï¼‰

---

## ğŸ“š å‚è€ƒèµ„æº

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Stripe Security Best Practices](https://stripe.com/docs/security)
- [Spring Security æƒé™æ§åˆ¶](https://spring.io/projects/spring-security)
- [åˆ†å¸ƒå¼äº‹åŠ¡ Saga æ¨¡å¼](https://microservices.io/patterns/data/saga.html)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-02-02
**å®¡è®¡å·¥å…·**: äººå·¥ä»£ç å®¡æŸ¥ + å®‰å…¨åˆ†æ
**ä¸‹æ¬¡å®¡è®¡æ—¶é—´**: å»ºè®®æ¯å­£åº¦è¿›è¡Œä¸€æ¬¡å®‰å…¨å®¡è®¡
