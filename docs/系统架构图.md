# 库存管理系统 - 详细架构图

## 一、整体系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  门店（局域网）                                   │
│                                                                                 │
│   ┌──────────┐   ┌──────────┐   ┌──────────┐                                   │
│   │  Kiosk   │   │  eMenu   │   │   KDS    │                                   │
│   │ (自助点餐) │   │ (电子菜单) │   │ (厨显)   │                                   │
│   └────┬─────┘   └────┬─────┘   └────┬─────┘                                   │
│        │  局域网       │  局域网       │  局域网                                   │
│        └───────────┬───┴──────────────┘                                         │
│                    ↓                                                             │
│   ┌─────────────────────────────────────────┐                                   │
│   │              POS（门店中枢）               │                                   │
│   │                                         │                                   │
│   │  ┌─────────┐  ┌──────────┐  ┌────────┐ │                                   │
│   │  │ 点餐模块 │  │ 库存管理  │  │ 接单模块│ │                                   │
│   │  └─────────┘  └──────────┘  └────────┘ │                                   │
│   │  ┌──────────────────────────────────┐   │                                   │
│   │  │       POS 本地数据库 (SQLite)      │   │                                   │
│   │  │  · 商品数据    · 库存数据          │   │                                   │
│   │  │  · 订单数据    · 离线事件队列       │   │                                   │
│   │  └──────────────────────────────────┘   │                                   │
│   └──────────────────┬──────────────────────┘                                   │
│                      │                                                           │
└──────────────────────┼───────────────────────────────────────────────────────────┘
                       │
                       │  互联网（可能断网）
                       │
┌──────────────────────┼───────────────────────────────────────────────────────────┐
│                      │               云端                                         │
│                      ↓                                                           │
│   ┌──────────────────────────────────────────────────────────┐                   │
│   │                    RocketMQ 消息总线                       │                   │
│   │                                                          │                   │
│   │  · product-cache-update-topic     (商品缓存更新)          │                   │
│   │  · inventory-cache-update-topic   (库存缓存更新)          │                   │
│   │  · poi-item-stock-sync-topic      (库存同步到POS)         │                   │
│   │  · order-stock-deduct-topic       (订单扣减库存)          │                   │
│   └────────┬───────────────┬──────────────────┬──────────────┘                   │
│            │               │                  │                                   │
│            ↓               ↓                  ↓                                   │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│   │   订单服务    │  │  商品中心     │  │  库存服务     │  │  OO 在线点餐  │         │
│   │ Order Service│  │Product Center│  │  Inventory   │  │ Online Order │         │
│   │              │  │              │  │   Service    │  │              │         │
│   │ · 创建订单   │  │ · 商品管理   │  │ · 库存锁定   │  │ · C端点餐页面 │         │
│   │ · 支付回调   │  │ · 渠道管理   │  │ · 库存扣减   │  │ · 购物车     │         │
│   │ · 取消订单   │  │ · 库存同步   │  │ · 库存解锁   │  │ · 下单       │         │
│   │              │  │ · POS对接    │  │ · 自动恢复   │  │              │         │
│   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────────────┘         │
│          │                 │                 │                                    │
│          ↓                 ↓                 ↓                                    │
│   ┌────────────────────────────────────────────────────────────┐                  │
│   │                    数据层                                   │                  │
│   │                                                            │                  │
│   │  ┌─────────────────────────────┐  ┌─────────────────────┐ │                  │
│   │  │    MySQL 分库分表集群         │  │      Redis 集群      │ │                  │
│   │  │                             │  │                     │ │                  │
│   │  │  jiaoyi_product_0           │  │ · 商品缓存          │ │                  │
│   │  │   ├ store_products_0~3      │  │ · 库存缓存          │ │                  │
│   │  │   ├ product_sku_0~3         │  │   (Cache-Aside)     │ │                  │
│   │  │   ├ inventory_0~3           │  │ · 分布式锁          │ │                  │
│   │  │   ├ inventory_transactions_0~3│ │ · 分片路由缓存      │ │                  │
│   │  │   ├ merchants_0~3           │  │                     │ │                  │
│   │  │   └ outbox                  │  └─────────────────────┘ │                  │
│   │  │                             │                          │                  │
│   │  │  jiaoyi_product_1           │  ┌─────────────────────┐ │                  │
│   │  │   ├ (同上)                  │  │   jiaoyi (主库)      │ │                  │
│   │  │   └ outbox                  │  │                     │ │                  │
│   │  │                             │  │ · poi_item_stock    │ │                  │
│   │  └─────────────────────────────┘  │ · poi_item_channel  │ │                  │
│   │                                   │ · poi_item_stock_log│ │                  │
│   │                                   │ · oversell_record   │ │                  │
│   │                                   └─────────────────────┘ │                  │
│   └────────────────────────────────────────────────────────────┘                  │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、库存同步核心链路

### 2.1 POS 设置售罄 → 全渠道同步

```
                        POS 操作售罄
                            │
                            ↓
               ┌────────────────────────┐
               │ POS 本地库存更新         │
               │ stock_status = 售罄     │
               │ Kiosk/eMenu 实时生效    │
               └────────────┬───────────┘
                            │ HTTP（有网时）
                            ↓
               ┌────────────────────────┐
               │ 商品中心 syncFromPos    │
               │                        │
               │ 1. 更新云端 DB          │
               │    poi_item_stock       │
               │    stock_status = 售罄  │
               │                        │
               │ 2. 更新渠道库存         │
               │    poi_item_channel_    │
               │    stock               │
               │                        │
               │ 3. 写变更日志           │
               │    poi_item_stock_log   │
               └────────────┬───────────┘
                            │
                            ↓
               ┌────────────────────────┐
               │ MQ 广播库存变更         │
               │ inventory-cache-update  │
               └─────┬───────────┬──────┘
                     │           │
                     ↓           ↓
            ┌──────────────┐  ┌──────────────┐
            │ Redis 缓存刷新 │  │ OO 页面感知   │
            │ 售罄状态写入   │  │ (轮询/推送)   │
            └──────────────┘  │ 展示"已售罄"  │
                              └──────────────┘
```

### 2.2 商品中心设置库存 → 同步到 POS

```
          商品中心后台操作
               │
               ↓
  ┌─────────────────────────┐
  │ updateStock()            │
  │                          │
  │ 1. 更新云端 DB (事务)     │
  │ 2. afterCommit 回调:     │
  │    写 Outbox 消息         │
  └────────────┬────────────┘
               │
               ↓
  ┌─────────────────────────┐
  │ Outbox 定时扫描          │
  │ → 发送 MQ 消息           │
  │                          │
  │ Topic: poi-item-stock-   │
  │        sync-topic        │
  └────────────┬────────────┘
               │
               ↓
  ┌─────────────────────────┐
  │ POS 消费 MQ 消息         │
  │                          │
  │ 1. 更新本地 SQLite 库存   │
  │ 2. Kiosk/eMenu 自动刷新  │
  │ 3. ACK 确认              │
  └─────────────────────────┘
```

### 2.3 OO 下单 → 库存扣减 → POS 同步

```
  OO 用户下单
       │
       ↓
  ┌───────────────┐     ┌──────────────────┐     ┌──────────────────┐
  │  订单服务      │     │   库存服务         │     │   商品中心        │
  │               │     │                  │     │                  │
  │ 1.创建订单    │────→│ 2.锁定库存       │     │                  │
  │   (PENDING)   │HTTP │   locked_stock+  │     │                  │
  │               │     │                  │     │                  │
  │ 3.支付成功    │────→│ 4.扣减库存       │────→│ 5.渠道扣减       │
  │   回调        │HTTP │   LOCK→OUT       │MQ   │   OO渠道额度-    │
  │               │     │   locked_stock-  │     │   或借共享池     │
  │               │     │   current_stock- │     │                  │
  └───────────────┘     └──────────────────┘     └────────┬─────────┘
                                                          │
                                                          │ Outbox+MQ
                                                          ↓
                                                 ┌──────────────────┐
                                                 │   POS 同步更新    │
                                                 │   本地库存-1      │
                                                 │   Kiosk/eMenu    │
                                                 │   下次刷新可见    │
                                                 └──────────────────┘
```

---

## 三、POS 离线场景

```
         ┌─────── 正常在线 ───────┐          ┌──── 断网离线 ────┐         ┌──── 恢复在线 ────┐
         │                       │          │                  │         │                  │
  Kiosk ─→ POS ─→ 云端商品中心    │   Kiosk ─→ POS 本地处理     │  POS ──→ 云端商品中心     │
  eMenu ─→      ↓               │   eMenu ─→   ↓             │    ↓                      │
         │  实时同步库存变更      │          │ 写入离线事件队列  │    │  回放离线事件         │
         │  云端 DB 和 POS 一致   │          │ 本地库存照常扣减  │    │  (replayOffline      │
         │                       │          │ 但云端不知道      │    │   Events)            │
         └───────────────────────┘          └──────────────────┘    │                      │
                                                                    │  冲突合并:            │
                                                                    │  · 相对变更: 直接累加  │
                                                                    │  · 绝对设置: 时间戳    │
                                                                    │    比较+delta补偿     │
                                                                    │                      │
                                                                    │  超卖检测:            │
                                                                    │  · real_qty < 0?     │
                                                                    │  · 记录oversell_record│
                                                                    │  · 人工处理           │
                                                                    └──────────────────────┘
```

---

## 四、分库分表架构

```
                         store_id
                            │
                    Murmur3 Hash
                            │
                            ↓
                   product_shard_id
                      (0 ~ 1023)
                     虚拟分片桶
                            │
               ┌────────────┴────────────┐
               │                         │
     product_shard_id % 2       product_shard_id / 2 % 4
       选择数据库                  选择表
               │                         │
        ┌──────┴──────┐           ┌──────┴──────┐
        │             │           │             │
    ds0 (偶数)    ds1 (奇数)   table_0~3     table_0~3
        │             │
        ↓             ↓
┌──────────────┐ ┌──────────────┐
│jiaoyi_product│ │jiaoyi_product│
│     _0       │ │     _1       │
│              │ │              │
│ store_       │ │ store_       │
│ products_0~3 │ │ products_0~3 │
│              │ │              │
│ product_     │ │ product_     │
│ sku_0~3      │ │ sku_0~3      │
│              │ │              │
│ inventory_   │ │ inventory_   │
│ 0~3          │ │ 0~3          │
│              │ │              │
│ inventory_   │ │ inventory_   │
│ transactions │ │ transactions │
│ _0~3         │ │ _0~3         │
│              │ │              │
│ merchants_   │ │ merchants_   │
│ 0~3          │ │ 0~3          │
│              │ │              │
│ outbox       │ │ outbox       │
│ (1张)        │ │ (1张)        │
└──────────────┘ └──────────────┘

分片策略：
  · 2 个数据库 × 4 张表/库 = 8 张物理表
  · 1024 个虚拟桶 → 未来扩容只需重新映射桶
  · 同一 store_id 的所有数据（商品/SKU/库存/交易记录）在同一分片
```

---

## 五、渠道库存隔离架构

```
                    门店总库存 (poi_item_stock)
                    real_quantity = 100杯
                            │
              ┌─────────────┼─────────────┐
              │             │             │
              ↓             ↓             ↓
     ┌──────────────┐ ┌──────────┐ ┌──────────────┐
     │ POS 渠道      │ │ OO 渠道  │ │ 共享池        │
     │ quota=40      │ │ quota=30 │ │ shared=30    │
     │ sold=15       │ │ sold=10  │ │              │
     │ 剩余=25       │ │ 剩余=20  │ │ 任何渠道     │
     │               │ │          │ │ 额度不够时    │
     │ weight=40%    │ │ weight=  │ │ 可以来借      │
     └──────────────┘ │  30%     │ └──────────────┘
                      └──────────┘

扣减流程（以OO下单为例）：
  ① OO 渠道额度够吗？(quota - sold >= 扣减数)
     → 够：扣 channel_sold += 扣减数
     → 不够：↓
  ② 共享池够吗？(shared_pool_quantity >= 扣减数)
     → 够：扣 shared_pool_quantity -= 扣减数
     → 不够：返回库存不足
  ③ 同步扣减总库存 real_quantity -= 扣减数
  ④ 写日志 + 判断是否售罄
```

---

## 六、Outbox 可靠消息投递

```
  业务操作（如更新库存）
       │
       │ 同一个数据库事务
       ↓
  ┌───────────────────────┐
  │ BEGIN TRANSACTION     │
  │                       │
  │ 1. UPDATE inventory   │     ← 业务操作
  │    SET stock = ...    │
  │                       │
  │ 2. INSERT INTO outbox │     ← 同事务写消息
  │    (type, biz_key,    │
  │     payload, status)  │
  │                       │
  │ COMMIT                │     ← 原子提交
  └───────────┬───────────┘
              │
              │  事务提交成功后
              ↓
  ┌───────────────────────┐
  │ Outbox 定时扫描任务    │     ← 每秒扫描
  │                       │
  │ SELECT * FROM outbox  │
  │ WHERE status = INIT   │
  │   AND next_retry_time │
  │       <= NOW()        │
  │ ORDER BY id ASC       │
  │ LIMIT 100             │
  └───────────┬───────────┘
              │
              ↓
  ┌───────────────────────┐
  │ 发送 RocketMQ 消息     │
  │                       │
  │ 成功 → status = DONE  │
  │ 失败 → 指数退避重试    │
  │        最多 10 次      │
  └───────────────────────┘

  保证：
  · DB 操作和消息"要么都成功，要么都回滚"
  · 消息不丢（持久化在 DB，定时重试）
  · 幂等（biz_key 唯一约束）
```

---

## 七、关键技术指标

```
┌─────────────────────────────────────────────────────────┐
│                      生产环境指标                         │
├──────────────────────┬──────────────────────────────────┤
│ 日订单量              │ 50-80 万单                       │
│ 门店数量              │ 1-2 万家                         │
│ SKU 数量             │ 10万+                            │
│ 并发峰值              │ 1000+ QPS                        │
│ 库存锁定 P99          │ < 200ms                          │
│ 自有渠道同步延迟       │ ≤ 3s                             │
│ 超卖率               │ < 0.1%                           │
│ 分库分表              │ 2库 × 4表 = 8张物理表             │
│ 虚拟桶数              │ 1024                             │
│ Redis 缓存命中率      │ > 95%                            │
│ Outbox 消息投递成功率  │ > 99.99%                         │
└──────────────────────┴──────────────────────────────────┘
```

---

## 八、技术难点一览

```
┌──────────────────────────────────────────────────────────────┐
│                     P7 级别技术难点                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 库存并发安全                                              │
│     · CAS 状态机 (LOCK → OUT/UNLOCK)                         │
│     · 唯一索引 (order_id, sku_id) 防重                       │
│     · WHERE locked_stock >= quantity 原子扣减                 │
│                                                              │
│  2. POS 离线事件回放                                          │
│     · 事件溯源 (Event Sourcing)                               │
│     · 相对变更累加 vs 绝对设置时间戳比较                        │
│     · SELECT ... FOR UPDATE + delta 补偿                     │
│                                                              │
│  3. 渠道库存隔离                                              │
│     · 三层扣减: 渠道额度 → 共享池 → 库存不足                    │
│     · 加权公平分配 (按渠道权重分配共享池)                        │
│                                                              │
│  4. 超卖检测与补偿                                            │
│     · 离线回放后 real_quantity < 0 → 标记超卖                  │
│     · oversell_record 记录 → 人工介入                         │
│                                                              │
│  5. Outbox 可靠消息                                           │
│     · DB 事务 + Outbox 原子写入                               │
│     · 定时扫描 + 指数退避重试                                  │
│     · 优于 RocketMQ 事务消息（无需 checkLocalTransaction）      │
│                                                              │
│  6. 分库分表设计                                              │
│     · 虚拟桶 (1024) → 物理分片 (2×4)                          │
│     · 同 store_id 数据共置 (co-location)                      │
│     · 未来扩容: 重新映射桶，不改 hash 逻辑                     │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```
