# é€€æ¬¾ç³»ç»Ÿè¯¦ç»†è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
3. [ä¸šåŠ¡æµç¨‹](#ä¸šåŠ¡æµç¨‹)
4. [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
5. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
6. [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
7. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
8. [é…ç½®éƒ¨ç½²](#é…ç½®éƒ¨ç½²)
9. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
10. [é¢è¯•è¦ç‚¹](#é¢è¯•è¦ç‚¹)

---

## ç³»ç»Ÿæ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

æœ¬é€€æ¬¾ç³»ç»Ÿæ˜¯ä¸ºé¤é¥®å¤–å–å¹³å°è®¾è®¡çš„è®¢å•é€€æ¬¾è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒåœ¨çº¿ç‚¹é¤ã€è‡ªå–ã€é…é€ç­‰å¤šç§è®¢å•ç±»å‹çš„éƒ¨åˆ†æˆ–å…¨é¢é€€æ¬¾ã€‚

### 1.2 ä¸šåŠ¡ç›®æ ‡

- âœ… **çµæ´»é€€æ¬¾**ï¼šæ”¯æŒæŒ‰å•†å“ã€æŒ‰é‡‘é¢ä¸¤ç§é€€æ¬¾æ¨¡å¼
- âœ… **éƒ¨åˆ†é€€æ¬¾**ï¼šæ”¯æŒå¤šæ¬¡éƒ¨åˆ†é€€æ¬¾ç›´è‡³å…¨é¢
- âœ… **ç²¾ç¡®è®¡ç®—**ï¼šè‡ªåŠ¨åˆ†é…ç¨è´¹ã€æŠ˜æ‰£ã€é¢å¤–è´¹ç”¨
- âœ… **å¹³å°æŠ½æˆ**ï¼šè‡ªåŠ¨è®¡ç®—å¹¶å›è¡¥å¹³å°æŠ½æˆç»™å•†æˆ·
- âœ… **é«˜å¯ç”¨æ€§**ï¼šåˆ†å¸ƒå¼é”ã€å¹‚ç­‰æ€§ã€ä¹è§‚é”ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… **ç¬¬ä¸‰æ–¹é›†æˆ**ï¼šæ”¯æŒStripeã€æ”¯ä»˜å®ç­‰å¤šç§æ”¯ä»˜æ¸ é“

### 1.3 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Java | 17+ | å¼€å‘è¯­è¨€ |
| Spring Boot | 3.x | åº”ç”¨æ¡†æ¶ |
| MyBatis | 3.5+ | ORMæ¡†æ¶ |
| MySQL | 8.0+ | æ•°æ®å­˜å‚¨ï¼ˆåˆ†åº“åˆ†è¡¨ï¼‰ |
| Redis | 7.0+ | åˆ†å¸ƒå¼é”ã€ç¼“å­˜ |
| Redisson | 3.x | åˆ†å¸ƒå¼é”å®ç° |
| Stripe Java SDK | 24.x | Stripeæ”¯ä»˜é›†æˆ |
| ShardingSphere | 5.x | åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶ |

---

## æ ¸å¿ƒç‰¹æ€§

### 2.1 ä¸¤ç§é€€æ¬¾æ¨¡å¼

#### æ¨¡å¼ä¸€ï¼šæŒ‰å•†å“é€€æ¬¾ï¼ˆBY_ITEMSï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å•†å“è´¨é‡é—®é¢˜ï¼ˆéƒ¨åˆ†å•†å“ä¸åˆæ ¼ï¼‰
- å•†å“ç¼ºå¤±ï¼ˆè®¢å•ä¸­éƒ¨åˆ†å•†å“æœªé€è¾¾ï¼‰
- å•†å“é”™è¯¯ï¼ˆä¸‹å•æ—¶é€‰é”™ï¼Œåªé€€éƒ¨åˆ†ï¼‰

**ä¼˜åŠ¿**ï¼š
- ç²¾ç¡®åˆ°å•†å“çº§åˆ«
- å¯æŒ‡å®šæ¯ä¸ªå•†å“çš„é€€æ¬¾æ•°é‡
- è‡ªåŠ¨æŒ‰æ¯”ä¾‹åˆ†é…ç¨è´¹å’ŒæŠ˜æ‰£

**ç¤ºä¾‹**ï¼š
```
è®¢å•ï¼šæ±‰å ¡5ä¸ªã€è–¯æ¡2ä»½
é€€æ¬¾ï¼šæ±‰å ¡2ä¸ªï¼ˆå…¶ä»–ä¿ç•™ï¼‰
```

#### æ¨¡å¼äºŒï¼šæŒ‰é‡‘é¢é€€æ¬¾ï¼ˆBY_AMOUNTï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- æœåŠ¡è¡¥å¿ï¼ˆå»¶è¿Ÿé€è¾¾ã€æœåŠ¡æ€åº¦é—®é¢˜ï¼‰
- æŠ˜æ‰£è°ƒæ•´ï¼ˆä»·æ ¼äº‰è®®åå•†ï¼‰
- çµæ´»é€€æ¬¾ï¼ˆä¸å…³å¿ƒå…·ä½“å•†å“ï¼Œåªé€€é‡‘é¢ï¼‰

**ä¼˜åŠ¿**ï¼š
- çµæ´»æ€§é«˜
- é€‚åˆè¡¥å¿åœºæ™¯
- è‡ªåŠ¨æŒ‰å•†å“æ¯”ä¾‹åˆ†é…

**ç¤ºä¾‹**ï¼š
```
è®¢å•æ€»é¢ï¼š$100
è¡¥å¿é€€æ¬¾ï¼š$20ï¼ˆä¸å…³å¿ƒå…·ä½“æ˜¯å“ªä¸ªå•†å“ï¼‰
```

---

### 2.2 å¤šæ¬¡éƒ¨åˆ†é€€æ¬¾

**æ ¸å¿ƒæœºåˆ¶ï¼šå¯é€€ä½™é¢æ§åˆ¶**

```
å¯é€€ä½™é¢ = è®¢å•å®ä»˜é‡‘é¢ - ç´¯è®¡å·²é€€æ¬¾é‡‘é¢

æ ¡éªŒè§„åˆ™ï¼š
1. å¯é€€ä½™é¢ > 0 æ‰èƒ½å‘èµ·é€€æ¬¾
2. å•æ¬¡é€€æ¬¾é‡‘é¢ <= å¯é€€ä½™é¢
3. ç´¯è®¡é€€æ¬¾ <= è®¢å•å®ä»˜é‡‘é¢
```

**ç¤ºä¾‹åœºæ™¯**ï¼š

```
è®¢å•æ€»é¢ï¼š$200
â”œâ”€ ç¬¬1æ¬¡é€€æ¬¾ï¼š$50 â†’ å‰©ä½™å¯é€€ $150
â”œâ”€ ç¬¬2æ¬¡é€€æ¬¾ï¼š$30 â†’ å‰©ä½™å¯é€€ $120
â”œâ”€ ç¬¬3æ¬¡é€€æ¬¾ï¼š$120 â†’ å‰©ä½™å¯é€€ $0ï¼ˆå…¨é¢é€€å®Œï¼‰
â””â”€ ç¬¬4æ¬¡é€€æ¬¾ï¼šâŒ æ‹’ç»ï¼ˆå¯é€€ä½™é¢ä¸º0ï¼‰
```

---

### 2.3 ç²¾ç¡®é‡‘é¢è®¡ç®—

#### ç¨è´¹åˆ†é…ç®—æ³•

```java
ç¨è´¹é€€æ¬¾ = (å•†å“é€€æ¬¾é‡‘é¢ / è®¢å•å•†å“å°è®¡) Ã— è®¢å•æ€»ç¨è´¹
```

**ç¤ºä¾‹**ï¼š
```
è®¢å•å•†å“å°è®¡ï¼š$100
è®¢å•æ€»ç¨è´¹ï¼š$8ï¼ˆ8%ç¨ç‡ï¼‰
é€€æ¬¾å•†å“é‡‘é¢ï¼š$30
ç¨è´¹é€€æ¬¾ï¼š($30 / $100) Ã— $8 = $2.40
```

#### æŠ˜æ‰£åˆ†é…ç®—æ³•

```java
æŠ˜æ‰£é€€æ¬¾ = (å•†å“é€€æ¬¾é‡‘é¢ / è®¢å•å•†å“å°è®¡) Ã— è®¢å•æ€»æŠ˜æ‰£
```

**ç¤ºä¾‹**ï¼š
```
è®¢å•å•†å“å°è®¡ï¼š$100
è®¢å•æ€»æŠ˜æ‰£ï¼š$15
é€€æ¬¾å•†å“é‡‘é¢ï¼š$30
æŠ˜æ‰£é€€æ¬¾ï¼š($30 / $100) Ã— $15 = $4.50
```

#### æœ€ç»ˆé€€æ¬¾è®¡ç®—

```java
æœ€ç»ˆé€€æ¬¾é‡‘é¢ = å•†å“é€€æ¬¾ + ç¨è´¹é€€æ¬¾ - æŠ˜æ‰£é€€æ¬¾
              + [é…é€è´¹é€€æ¬¾] + [å°è´¹é€€æ¬¾] + [æœåŠ¡è´¹é€€æ¬¾]
```

**å®Œæ•´ç¤ºä¾‹**ï¼š
```
å•†å“é€€æ¬¾ï¼š$30.00
ç¨è´¹é€€æ¬¾ï¼š$2.40
æŠ˜æ‰£é€€æ¬¾ï¼š-$4.50
é…é€è´¹é€€æ¬¾ï¼š$5.00ï¼ˆå¯é€‰ï¼‰
å°è´¹é€€æ¬¾ï¼š$3.00ï¼ˆå¯é€‰ï¼‰
æœåŠ¡è´¹é€€æ¬¾ï¼š$2.00ï¼ˆå¯é€‰ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æœ€ç»ˆé€€æ¬¾ï¼š$37.90
```

---

### 2.4 å¹³å°æŠ½æˆå›è¡¥

**ä¸šåŠ¡èƒŒæ™¯**ï¼š
- è®¢å•æ”¯ä»˜æ—¶ï¼Œå¹³å°ä»å•†æˆ·æ”¶å–æŠ½æˆï¼ˆå¦‚10%ï¼‰
- é€€æ¬¾æ—¶ï¼Œéœ€è¦æŒ‰æ¯”ä¾‹é€€è¿˜æŠ½æˆç»™å•†æˆ·

**è®¡ç®—å…¬å¼**ï¼š

```java
æŠ½æˆå›è¡¥é‡‘é¢ = åŸè®¢å•å¹³å°æŠ½æˆ Ã— (é€€æ¬¾é‡‘é¢ / è®¢å•æ€»é¢)
```

**ç¤ºä¾‹**ï¼š
```
è®¢å•æ€»é¢ï¼š$200
å¹³å°æŠ½æˆï¼š$20ï¼ˆ10%ï¼‰
é€€æ¬¾é‡‘é¢ï¼š$50ï¼ˆ25%ï¼‰
æŠ½æˆå›è¡¥ï¼š$20 Ã— 25% = $5

ç»“ç®—å½±å“ï¼š
- ç”¨æˆ·é€€æ¬¾ï¼š$50
- å•†æˆ·å®é™…å‡å°‘æ”¶å…¥ï¼š$50 - $5 = $45
- å¹³å°é€€è¿˜ç»™å•†æˆ·ï¼š$5
```

**Stripeé›†æˆ**ï¼š
```java
// Stripeè‡ªåŠ¨å¤„ç†æŠ½æˆå›è¡¥
Map<String, Object> params = new HashMap<>();
params.put("reverse_transfer", true);  // è‡ªåŠ¨å›è¡¥
```

---

### 2.5 å¹¶å‘æ§åˆ¶å’Œå¹‚ç­‰æ€§

#### ä¸‰å±‚é˜²æŠ¤æœºåˆ¶

##### ç¬¬ä¸€å±‚ï¼šåˆ†å¸ƒå¼é”ï¼ˆé˜²æ­¢å¹¶å‘é€€æ¬¾ï¼‰

```java
String lockKey = "refund:order:" + orderId;
RLock lock = redissonClient.getLock(lockKey);

if (!lock.tryLock(5, 30, TimeUnit.SECONDS)) {
    throw new RuntimeException("é€€æ¬¾å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
}
```

**ä½œç”¨**ï¼š
- é˜²æ­¢åŒä¸€è®¢å•å¹¶å‘å‘èµ·å¤šä¸ªé€€æ¬¾
- ä¿è¯é€€æ¬¾æµç¨‹çš„åŸå­æ€§
- é¿å…å¯é€€ä½™é¢è®¡ç®—é”™è¯¯

##### ç¬¬äºŒå±‚ï¼šå¹‚ç­‰æ€§æ—¥å¿—ï¼ˆé˜²æ­¢é‡å¤æäº¤ï¼‰

**æœºåˆ¶1ï¼šè¯·æ±‚å·ï¼ˆRequest Numberï¼‰**
```java
// å®¢æˆ·ç«¯ç”Ÿæˆå”¯ä¸€è¯·æ±‚å·
String requestNo = "REF" + System.currentTimeMillis() + UUID.randomUUID();

// æœåŠ¡ç«¯æ£€æŸ¥
RefundIdempotencyLog log = mapper.selectByRequestNo(orderId, requestNo);
if (log != null && log.getRefundId() != null) {
    return mapper.selectById(log.getRefundId());  // è¿”å›å·²å­˜åœ¨çš„é€€æ¬¾
}
```

**æœºåˆ¶2ï¼šä¸šåŠ¡æŒ‡çº¹ï¼ˆFingerprintï¼‰**
```java
// ç”Ÿæˆä¸šåŠ¡æŒ‡çº¹ï¼ˆé˜²æ­¢æ¶æ„ä¿®æ”¹requestNoï¼‰
String fingerprint = MD5(requestNo + "|" + orderId + "|" + refundAmount + "|" + timestamp);

// æ£€æŸ¥æŒ‡çº¹å†²çª
RefundIdempotencyLog log = mapper.selectByFingerprint(fingerprint);
```

**å¹‚ç­‰æ€§æ—¥å¿—è¡¨ç»“æ„**ï¼š
```sql
CREATE TABLE refund_idempotency_logs (
    id BIGINT PRIMARY KEY,
    order_id BIGINT NOT NULL,
    request_no VARCHAR(100) NOT NULL,
    refund_id BIGINT,
    fingerprint VARCHAR(100),
    request_params JSON,
    result VARCHAR(20),
    UNIQUE KEY uk_request_no (merchant_id, request_no),
    INDEX idx_fingerprint (fingerprint)
);
```

##### ç¬¬ä¸‰å±‚ï¼šä¹è§‚é”ï¼ˆé˜²æ­¢çŠ¶æ€å¹¶å‘ä¿®æ”¹ï¼‰

```java
// ä½¿ç”¨ç‰ˆæœ¬å·æ›´æ–°
int updated = refundMapper.updateStatusWithVersion(
    refundId,
    currentVersion,
    newStatus
);

if (updated == 0) {
    throw new RuntimeException("é€€æ¬¾çŠ¶æ€å·²è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹");
}
```

**æ•°æ®åº“å­—æ®µ**ï¼š
```sql
ALTER TABLE refunds_0 ADD COLUMN version BIGINT NOT NULL DEFAULT 1;
```

---

## ä¸šåŠ¡æµç¨‹

### 3.1 é€€æ¬¾åˆ›å»ºæµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant API as RefundController
    participant Service as RefundService
    participant Lock as Redisé”
    participant DB as æ•°æ®åº“
    participant Payment as æ”¯ä»˜æ¸ é“

    Client->>API: POST /api/refunds
    API->>Service: createRefund(request)

    Service->>Lock: è·å–åˆ†å¸ƒå¼é”
    Lock-->>Service: é”è·å–æˆåŠŸ

    Service->>DB: æŸ¥è¯¢å¹‚ç­‰æ€§æ—¥å¿—
    alt å·²å¤„ç†
        DB-->>Service: è¿”å›å·²å­˜åœ¨çš„é€€æ¬¾
        Service-->>API: è¿”å›é€€æ¬¾å•
    else æœªå¤„ç†
        Service->>DB: æŸ¥è¯¢è®¢å•ä¿¡æ¯
        Service->>Service: æ ¡éªŒè®¢å•çŠ¶æ€
        Service->>Service: è®¡ç®—å¯é€€ä½™é¢
        Service->>Service: è®¡ç®—é€€æ¬¾æ˜ç»†
        Service->>DB: åˆ›å»ºé€€æ¬¾å•ï¼ˆCREATEDï¼‰
        Service->>DB: åˆ›å»ºé€€æ¬¾æ˜ç»†
        Service->>DB: å†™å…¥å¹‚ç­‰æ€§æ—¥å¿—

        Service->>Payment: å¼‚æ­¥è°ƒç”¨é€€æ¬¾API
        Payment-->>Service: è¿”å›ç»“æœ

        alt æˆåŠŸ
            Service->>DB: æ›´æ–°çŠ¶æ€ï¼ˆSUCCEEDEDï¼‰
            Service->>DB: æ›´æ–°è®¢å•ç´¯è®¡é€€æ¬¾é¢
        else å¤±è´¥
            Service->>DB: æ›´æ–°çŠ¶æ€ï¼ˆFAILEDï¼‰
            Service->>DB: è®°å½•é”™è¯¯ä¿¡æ¯
        end

        Service-->>API: è¿”å›é€€æ¬¾å•
    end

    Service->>Lock: é‡Šæ”¾åˆ†å¸ƒå¼é”
    API-->>Client: è¿”å›å“åº”
```

---

### 3.2 çŠ¶æ€æœºè®¾è®¡

#### çŠ¶æ€å®šä¹‰

```java
public enum RefundStatus {
    CREATED("CREATED", "å·²åˆ›å»º"),           // åˆå§‹çŠ¶æ€
    PROCESSING("PROCESSING", "å¤„ç†ä¸­"),    // å·²å‘é€åˆ°æ”¯ä»˜æ¸ é“
    SUCCEEDED("SUCCEEDED", "æˆåŠŸ"),        // é€€æ¬¾æˆåŠŸï¼ˆç»ˆæ€ï¼‰
    FAILED("FAILED", "å¤±è´¥"),              // é€€æ¬¾å¤±è´¥ï¼ˆç»ˆæ€ï¼Œå¯é‡è¯•ï¼‰
    CANCELED("CANCELED", "å·²å–æ¶ˆ")         // äººå·¥å–æ¶ˆï¼ˆç»ˆæ€ï¼‰
}
```

#### çŠ¶æ€è½¬æ¢è§„åˆ™

```
CREATED
  â”œâ”€â”€â†’ PROCESSING (è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜API)
  â”‚      â”œâ”€â”€â†’ SUCCEEDED (APIè¿”å›æˆåŠŸ)
  â”‚      â””â”€â”€â†’ FAILED (APIè¿”å›å¤±è´¥/è¶…æ—¶)
  â””â”€â”€â†’ CANCELED (äººå·¥æ’¤é”€)

ç»ˆæ€ï¼šSUCCEEDED, FAILED, CANCELED
```

**çŠ¶æ€æœºä»£ç **ï¼š
```java
@Service
public class RefundStateMachine {

    public boolean canTransition(String from, String to) {
        return ALLOWED_TRANSITIONS.getOrDefault(from, Collections.emptySet())
                                   .contains(to);
    }

    private static final Map<String, Set<String>> ALLOWED_TRANSITIONS = Map.of(
        "CREATED", Set.of("PROCESSING", "CANCELED"),
        "PROCESSING", Set.of("SUCCEEDED", "FAILED")
    );
}
```

---

### 3.3 å¼‚æ­¥å¤„ç†æœºåˆ¶

#### CompletableFutureå¼‚æ­¥è°ƒç”¨

```java
CompletableFuture<RefundResult> future = CompletableFuture.supplyAsync(() -> {
    // è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜API
    return paymentAdapter.createRefund(refundRequest);
}, executorService).orTimeout(10, TimeUnit.SECONDS);

future.whenComplete((result, throwable) -> {
    if (throwable != null) {
        // è¶…æ—¶æˆ–å¼‚å¸¸å¤„ç†
        handleRefundFailure(refund, throwable.getMessage());
    } else if (result.isSuccess()) {
        // é€€æ¬¾æˆåŠŸ
        handleRefundSuccess(refund, result);
    } else {
        // é€€æ¬¾å¤±è´¥
        handleRefundFailure(refund, result.getErrorMessage());
    }
});
```

#### è¶…æ—¶é™çº§ç­–ç•¥

```java
// è¶…æ—¶æ—¶é—´ï¼š10ç§’
.orTimeout(10, TimeUnit.SECONDS)

// Fallbackå¤„ç†
private void handleFallback(Refund refund, String reason) {
    // æ›´æ–°çŠ¶æ€ä¸ºPROCESSINGï¼ˆç­‰å¾…å¼‚æ­¥é€šçŸ¥ï¼‰
    refund.setStatus(RefundStatus.PROCESSING.getCode());
    refund.setErrorMessage("å¤„ç†è¶…æ—¶ï¼Œç­‰å¾…å¼‚æ­¥å›è°ƒ: " + reason);
    refundMapper.updateById(refund);

    log.warn("é€€æ¬¾APIè¶…æ—¶ï¼Œè¿›å…¥Fallbackï¼ŒrefundId: {}", refund.getRefundId());
}
```

---

## APIæ¥å£æ–‡æ¡£

### 4.1 åˆ›å»ºé€€æ¬¾

**æ¥å£**: `POST /api/refunds`

**è¯·æ±‚å¤´**:
```
Content-Type: application/json
Authorization: Bearer {token}
```

**è¯·æ±‚ä½“ï¼ˆæŒ‰å•†å“é€€æ¬¾ï¼‰**:
```json
{
  "orderId": 123456,
  "requestNo": "REF20250202123456001",
  "refundType": "BY_ITEMS",
  "refundItems": [
    {
      "orderItemId": 1,
      "refundQuantity": 2
    },
    {
      "orderItemId": 2,
      "refundQuantity": 1
    }
  ],
  "refundDeliveryFee": false,
  "refundTips": false,
  "refundCharge": false,
  "reason": "å•†å“è´¨é‡é—®é¢˜"
}
```

**è¯·æ±‚ä½“ï¼ˆæŒ‰é‡‘é¢é€€æ¬¾ï¼‰**:
```json
{
  "orderId": 123456,
  "requestNo": "REF20250202123456002",
  "refundType": "BY_AMOUNT",
  "refundAmount": 50.00,
  "refundDeliveryFee": false,
  "reason": "æœåŠ¡å»¶è¿Ÿè¡¥å¿"
}
```

**å‚æ•°è¯´æ˜**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| orderId | Long | æ˜¯ | è®¢å•ID |
| requestNo | String | æ˜¯ | å¹‚ç­‰è¯·æ±‚å·ï¼ˆå…¨å±€å”¯ä¸€ï¼‰ï¼Œå»ºè®®æ ¼å¼ï¼š`REF + timestamp + random` |
| refundType | Enum | æ˜¯ | é€€æ¬¾ç±»å‹ï¼š`BY_ITEMS`ï¼ˆæŒ‰å•†å“ï¼‰æˆ– `BY_AMOUNT`ï¼ˆæŒ‰é‡‘é¢ï¼‰ |
| refundItems | Array | æ¡ä»¶ | `BY_ITEMS`æ¨¡å¼ä¸‹å¿…å¡« |
| refundItems[].orderItemId | Long | æ˜¯ | è®¢å•é¡¹ID |
| refundItems[].refundQuantity | Integer | æ˜¯ | é€€æ¬¾æ•°é‡ï¼Œå¿…é¡» > 0 ä¸” <= è®¢å•æ•°é‡ |
| refundAmount | BigDecimal | æ¡ä»¶ | `BY_AMOUNT`æ¨¡å¼ä¸‹å¿…å¡«ï¼Œå¿…é¡» > 0 |
| refundDeliveryFee | Boolean | å¦ | æ˜¯å¦é€€é…é€è´¹ï¼ˆé»˜è®¤falseï¼‰ |
| refundTips | Boolean | å¦ | æ˜¯å¦é€€å°è´¹ï¼ˆé»˜è®¤falseï¼‰ |
| refundCharge | Boolean | å¦ | æ˜¯å¦é€€æœåŠ¡è´¹ï¼ˆé»˜è®¤falseï¼‰ |
| reason | String | å¦ | é€€æ¬¾åŸå› ï¼ˆæœ€å¤§500å­—ç¬¦ï¼‰ |

**å“åº”æˆåŠŸï¼ˆ200ï¼‰**:
```json
{
  "success": true,
  "message": "é€€æ¬¾åˆ›å»ºæˆåŠŸ",
  "data": {
    "refundId": 78901,
    "orderId": 123456,
    "requestNo": "REF20250202123456001",
    "refundAmount": 43.20,
    "status": "PROCESSING",
    "reason": "å•†å“è´¨é‡é—®é¢˜",
    "thirdPartyRefundId": "re_1ABC123XYZ",
    "commissionReversal": 4.32,
    "createdAt": "2025-02-02T10:30:00",
    "processedAt": null,
    "refundItems": [
      {
        "refundItemId": 1001,
        "orderItemId": 1,
        "subject": "ITEM",
        "refundQty": 2,
        "refundAmount": 20.00,
        "taxRefund": 1.60,
        "discountRefund": 2.22
      },
      {
        "refundItemId": 1002,
        "orderItemId": 1,
        "subject": "TAX",
        "refundQty": null,
        "refundAmount": 1.60,
        "taxRefund": 0,
        "discountRefund": 0
      },
      {
        "refundItemId": 1003,
        "orderItemId": 1,
        "subject": "DISCOUNT",
        "refundQty": null,
        "refundAmount": -2.22,
        "taxRefund": 0,
        "discountRefund": 0
      }
    ]
  }
}
```

**å“åº”å¤±è´¥ï¼ˆ400/500ï¼‰**:
```json
{
  "success": false,
  "message": "é€€æ¬¾é‡‘é¢è¶…è¿‡å¯é€€ä½™é¢ï¼Œå¯é€€: 50.00, è¯·æ±‚: 80.00",
  "errorCode": "REFUND_AMOUNT_EXCEEDED",
  "data": null
}
```

**é”™è¯¯ç è¯´æ˜**:

| é”™è¯¯ç  | è¯´æ˜ | HTTPçŠ¶æ€ç  |
|--------|------|-----------|
| ORDER_NOT_FOUND | è®¢å•ä¸å­˜åœ¨ | 404 |
| ORDER_STATUS_INVALID | è®¢å•çŠ¶æ€ä¸å…è®¸é€€æ¬¾ | 400 |
| REFUND_AMOUNT_EXCEEDED | é€€æ¬¾é‡‘é¢è¶…è¿‡å¯é€€ä½™é¢ | 400 |
| REFUND_QTY_EXCEEDED | é€€æ¬¾æ•°é‡è¶…è¿‡è®¢å•æ•°é‡ | 400 |
| DUPLICATE_REQUEST | é‡å¤è¯·æ±‚ï¼ˆå¹‚ç­‰æ€§æ‹¦æˆªï¼‰ | 200 |
| LOCK_FAILED | è·å–åˆ†å¸ƒå¼é”å¤±è´¥ | 409 |
| PAYMENT_API_ERROR | ç¬¬ä¸‰æ–¹æ”¯ä»˜APIé”™è¯¯ | 500 |

---

### 4.2 æŸ¥è¯¢é€€æ¬¾è¯¦æƒ…

**æ¥å£**: `GET /api/refunds/{refundId}`

**å“åº”æˆåŠŸ**:
```json
{
  "success": true,
  "data": {
    "refundId": 78901,
    "orderId": 123456,
    "requestNo": "REF20250202123456001",
    "refundAmount": 43.20,
    "status": "SUCCEEDED",
    "thirdPartyRefundId": "re_1ABC123XYZ",
    "commissionReversal": 4.32,
    "createdAt": "2025-02-02T10:30:00",
    "processedAt": "2025-02-02T10:30:15",
    "refundItems": [...]
  }
}
```

---

### 4.3 æŸ¥è¯¢è®¢å•çš„æ‰€æœ‰é€€æ¬¾

**æ¥å£**: `GET /api/refunds/order/{orderId}`

**å“åº”æˆåŠŸ**:
```json
{
  "success": true,
  "data": {
    "orderId": 123456,
    "orderTotalAmount": 200.00,
    "totalRefunded": 93.20,
    "availableRefund": 106.80,
    "refunds": [
      {
        "refundId": 78901,
        "refundAmount": 43.20,
        "status": "SUCCEEDED",
        "createdAt": "2025-02-02T10:30:00"
      },
      {
        "refundId": 78902,
        "refundAmount": 50.00,
        "status": "SUCCEEDED",
        "createdAt": "2025-02-02T11:00:00"
      }
    ]
  }
}
```

---

## æ•°æ®æ¨¡å‹è®¾è®¡

### 5.1 é€€æ¬¾å•è¡¨ï¼ˆrefundsï¼‰

**åˆ†åº“åˆ†è¡¨è§„åˆ™**ï¼šåŸºäº `store_id` å“ˆå¸Œï¼Œ3åº“ Ã— 3è¡¨ = 9å¼ è¡¨

```sql
CREATE TABLE IF NOT EXISTS refunds_0 (
    refund_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'é€€æ¬¾ID',
    order_id BIGINT NOT NULL COMMENT 'è®¢å•ID',
    payment_id BIGINT COMMENT 'æ”¯ä»˜è®°å½•ID',
    merchant_id VARCHAR(50) NOT NULL COMMENT 'å•†æˆ·IDï¼ˆåˆ†ç‰‡é”®ï¼‰',
    store_id BIGINT NOT NULL COMMENT 'é—¨åº—IDï¼ˆç”¨äºåˆ†ç‰‡ï¼‰',
    shard_id INT NOT NULL COMMENT 'åˆ†ç‰‡ID',

    -- é‡‘é¢ç›¸å…³
    refund_amount DECIMAL(10,2) NOT NULL COMMENT 'é€€æ¬¾æ€»é‡‘é¢',
    commission_reversal DECIMAL(10,2) COMMENT 'æŠ½æˆå›è¡¥é‡‘é¢',

    -- é€€æ¬¾ä¿¡æ¯
    request_no VARCHAR(100) NOT NULL COMMENT 'å¹‚ç­‰è¯·æ±‚å·',
    refund_type VARCHAR(20) NOT NULL COMMENT 'é€€æ¬¾ç±»å‹ï¼šBY_ITEMS/BY_AMOUNT',
    reason VARCHAR(500) COMMENT 'é€€æ¬¾åŸå› ',

    -- çŠ¶æ€ç®¡ç†
    status VARCHAR(20) NOT NULL DEFAULT 'CREATED' COMMENT 'çŠ¶æ€ï¼šCREATED/PROCESSING/SUCCEEDED/FAILED/CANCELED',
    third_party_refund_id VARCHAR(100) COMMENT 'ç¬¬ä¸‰æ–¹é€€æ¬¾IDï¼ˆStripe/æ”¯ä»˜å®ï¼‰',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',

    -- å¹¶å‘æ§åˆ¶
    version BIGINT NOT NULL DEFAULT 1 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',

    -- æ—¶é—´æˆ³
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    processed_at DATETIME COMMENT 'å¤„ç†å®Œæˆæ—¶é—´',

    -- ç´¢å¼•
    UNIQUE KEY uk_request_no (merchant_id, request_no) COMMENT 'å¹‚ç­‰æ€§çº¦æŸ',
    INDEX idx_order_id (order_id) COMMENT 'è®¢å•æŸ¥è¯¢ç´¢å¼•',
    INDEX idx_status (status) COMMENT 'çŠ¶æ€æŸ¥è¯¢ç´¢å¼•',
    INDEX idx_created_at (created_at) COMMENT 'æ—¶é—´èŒƒå›´æŸ¥è¯¢ç´¢å¼•',
    INDEX idx_third_party_id (third_party_refund_id) COMMENT 'ç¬¬ä¸‰æ–¹é€€æ¬¾IDç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€€æ¬¾å•è¡¨';
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| refund_id | BIGINT | é€€æ¬¾IDï¼ˆä¸»é”®ï¼‰ | 78901 |
| order_id | BIGINT | å…³è”è®¢å•ID | 123456 |
| refund_amount | DECIMAL(10,2) | é€€æ¬¾æ€»é‡‘é¢ | 43.20 |
| commission_reversal | DECIMAL(10,2) | å¹³å°æŠ½æˆå›è¡¥é‡‘é¢ | 4.32 |
| request_no | VARCHAR(100) | å¹‚ç­‰è¯·æ±‚å· | REF20250202001 |
| status | VARCHAR(20) | é€€æ¬¾çŠ¶æ€ | SUCCEEDED |
| version | BIGINT | ä¹è§‚é”ç‰ˆæœ¬å· | 3 |

---

### 5.2 é€€æ¬¾æ˜ç»†è¡¨ï¼ˆrefund_itemsï¼‰

```sql
CREATE TABLE IF NOT EXISTS refund_items_0 (
    refund_item_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'æ˜ç»†ID',
    refund_id BIGINT NOT NULL COMMENT 'é€€æ¬¾ID',
    merchant_id VARCHAR(50) NOT NULL COMMENT 'å•†æˆ·IDï¼ˆåˆ†ç‰‡é”®ï¼‰',
    store_id BIGINT NOT NULL COMMENT 'é—¨åº—IDï¼ˆç”¨äºåˆ†ç‰‡ï¼‰',
    shard_id INT NOT NULL COMMENT 'åˆ†ç‰‡ID',

    -- å…³è”ä¿¡æ¯
    order_item_id BIGINT COMMENT 'è®¢å•é¡¹ID',
    subject VARCHAR(50) NOT NULL COMMENT 'ç§‘ç›®ï¼šITEM/TAX/DELIVERY_FEE/TIPS/CHARGE/DISCOUNT',

    -- é‡‘é¢æ˜ç»†
    refund_qty INT COMMENT 'é€€æ¬¾æ•°é‡ï¼ˆæŒ‰å•†å“é€€æ¬¾æ—¶ï¼‰',
    refund_amount DECIMAL(10,2) NOT NULL COMMENT 'è¯¥ç§‘ç›®çš„é€€æ¬¾é‡‘é¢',
    tax_refund DECIMAL(10,2) DEFAULT 0 COMMENT 'ç¨è´¹é€€æ¬¾ï¼ˆä»…ITEMç§‘ç›®ï¼‰',
    discount_refund DECIMAL(10,2) DEFAULT 0 COMMENT 'æŠ˜æ‰£é€€æ¬¾ï¼ˆä»…ITEMç§‘ç›®ï¼‰',

    -- æ—¶é—´æˆ³
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',

    -- ç´¢å¼•
    INDEX idx_refund_id (refund_id) COMMENT 'é€€æ¬¾å•æŸ¥è¯¢ç´¢å¼•',
    INDEX idx_order_item_id (order_item_id) COMMENT 'è®¢å•é¡¹æŸ¥è¯¢ç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€€æ¬¾æ˜ç»†è¡¨';
```

**ç§‘ç›®ï¼ˆSubjectï¼‰è¯´æ˜**ï¼š

| ç§‘ç›® | è¯´æ˜ | ç¤ºä¾‹é‡‘é¢ |
|------|------|---------|
| ITEM | å•†å“é€€æ¬¾ | $20.00 |
| TAX | ç¨è´¹é€€æ¬¾ | $1.60 |
| DELIVERY_FEE | é…é€è´¹é€€æ¬¾ | $5.00 |
| TIPS | å°è´¹é€€æ¬¾ | $3.00 |
| CHARGE | æœåŠ¡è´¹é€€æ¬¾ | $2.00 |
| DISCOUNT | æŠ˜æ‰£é€€æ¬¾ï¼ˆè´Ÿæ•°ï¼‰ | -$2.22 |

---

### 5.3 å¹‚ç­‰æ€§æ—¥å¿—è¡¨ï¼ˆrefund_idempotency_logsï¼‰

```sql
CREATE TABLE refund_idempotency_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'æ—¥å¿—ID',
    order_id BIGINT NOT NULL COMMENT 'è®¢å•ID',
    request_no VARCHAR(100) NOT NULL COMMENT 'å¹‚ç­‰è¯·æ±‚å·',
    refund_id BIGINT COMMENT 'é€€æ¬¾IDï¼ˆå¤„ç†åå›å¡«ï¼‰',
    merchant_id VARCHAR(50) COMMENT 'å•†æˆ·ID',

    -- å¹‚ç­‰æ€§æ§åˆ¶
    fingerprint VARCHAR(100) COMMENT 'ä¸šåŠ¡æŒ‡çº¹ï¼ˆMD5ï¼‰',
    request_params JSON COMMENT 'è¯·æ±‚å‚æ•°ï¼ˆç”¨äºè°ƒè¯•ï¼‰',

    -- å¤„ç†ç»“æœ
    result VARCHAR(20) COMMENT 'å¤„ç†ç»“æœï¼šSUCCESS/FAILED',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',

    -- æ—¶é—´æˆ³
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    -- ç´¢å¼•
    UNIQUE KEY uk_request_no (merchant_id, request_no) COMMENT 'è¯·æ±‚å·å”¯ä¸€çº¦æŸ',
    INDEX idx_fingerprint (fingerprint) COMMENT 'æŒ‡çº¹æŸ¥è¯¢ç´¢å¼•',
    INDEX idx_refund_id (refund_id) COMMENT 'é€€æ¬¾IDç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€€æ¬¾å¹‚ç­‰æ€§æ—¥å¿—è¡¨';
```

---

### 5.4 å®ä½“ç±»ï¼ˆEntityï¼‰

#### Refund.java

```java
@Data
@TableName("refunds")
public class Refund {
    @TableId(type = IdType.AUTO)
    private Long refundId;

    private Long orderId;
    private Long paymentId;
    private String merchantId;
    private Long storeId;
    private Integer shardId;

    private BigDecimal refundAmount;
    private BigDecimal commissionReversal;

    private String requestNo;
    private String refundType;
    private String reason;

    private String status;
    private String thirdPartyRefundId;
    private String errorMessage;

    @Version
    private Long version;

    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private LocalDateTime processedAt;
}
```

#### RefundItem.java

```java
@Data
@TableName("refund_items")
public class RefundItem {
    @TableId(type = IdType.AUTO)
    private Long refundItemId;

    private Long refundId;
    private String merchantId;
    private Long storeId;
    private Integer shardId;

    private Long orderItemId;
    private String subject;

    private Integer refundQty;
    private BigDecimal refundAmount;
    private BigDecimal taxRefund;
    private BigDecimal discountRefund;

    private LocalDateTime createdAt;
}
```

---

## æŠ€æœ¯å®ç°

### 6.1 æ ¸å¿ƒServiceç±»

#### RefundService.javaï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class RefundService {

    private final RefundMapper refundMapper;
    private final RefundItemMapper refundItemMapper;
    private final OrderMapper orderMapper;
    private final PaymentMapper paymentMapper;
    private final RefundIdempotencyLogMapper idempotencyLogMapper;
    private final RefundCalculator refundCalculator;
    private final PaymentAdapterFactory paymentAdapterFactory;
    private final RedissonClient redissonClient;

    /**
     * åˆ›å»ºé€€æ¬¾ï¼ˆä¸»å…¥å£ï¼‰
     */
    @Transactional(rollbackFor = Exception.class)
    public RefundResponse createRefund(RefundRequest request) {
        // 1. å‚æ•°æ ¡éªŒ
        validateRequest(request);

        // 2. è·å–åˆ†å¸ƒå¼é”
        String lockKey = "refund:order:" + request.getOrderId();
        RLock lock = redissonClient.getLock(lockKey);

        try {
            if (!lock.tryLock(5, 30, TimeUnit.SECONDS)) {
                throw new RuntimeException("é€€æ¬¾å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
            }

            // 3. å¹‚ç­‰æ€§æ£€æŸ¥
            RefundIdempotencyLog existingLog = checkIdempotency(request);
            if (existingLog != null && existingLog.getRefundId() != null) {
                log.info("å¹‚ç­‰æ€§æ‹¦æˆªï¼šè¿”å›å·²å­˜åœ¨çš„é€€æ¬¾ï¼ŒrequestNo={}", request.getRequestNo());
                Refund existingRefund = refundMapper.selectById(existingLog.getRefundId());
                return buildResponse(existingRefund);
            }

            // 4. æŸ¥è¯¢è®¢å•ä¿¡æ¯ï¼ˆåŠ é”ï¼‰
            Order order = orderMapper.selectByIdForUpdate(request.getOrderId());
            if (order == null) {
                throw new RuntimeException("è®¢å•ä¸å­˜åœ¨");
            }

            // 5. æ ¡éªŒè®¢å•çŠ¶æ€
            validateOrderStatus(order);

            // 6. æŸ¥è¯¢æ”¯ä»˜è®°å½•
            Payment payment = paymentMapper.selectByOrderId(request.getOrderId());
            if (payment == null) {
                throw new RuntimeException("æ”¯ä»˜è®°å½•ä¸å­˜åœ¨");
            }

            // 7. è®¡ç®—å¯é€€ä½™é¢
            BigDecimal totalRefunded = calculateTotalRefunded(request.getOrderId());
            BigDecimal totalPaid = parseOrderPrice(order);
            BigDecimal availableRefund = totalPaid.subtract(totalRefunded);

            if (availableRefund.compareTo(BigDecimal.ZERO) <= 0) {
                throw new RuntimeException("è®¢å•å·²å…¨é¢é€€æ¬¾ï¼Œæ— æ³•ç»§ç»­é€€æ¬¾");
            }

            // 8. è®¡ç®—é€€æ¬¾æ˜ç»†
            RefundCalculationResult calculation = refundCalculator.calculate(request, order);

            // 9. æ ¡éªŒé€€æ¬¾é‡‘é¢
            if (calculation.getTotalRefundAmount().compareTo(availableRefund) > 0) {
                throw new RuntimeException(
                    String.format("é€€æ¬¾é‡‘é¢è¶…è¿‡å¯é€€ä½™é¢ï¼Œå¯é€€: %.2f, è¯·æ±‚: %.2f",
                        availableRefund, calculation.getTotalRefundAmount())
                );
            }

            // 10. è®¡ç®—æŠ½æˆå›è¡¥
            BigDecimal commissionReversal = calculateCommissionReversal(
                order, calculation.getTotalRefundAmount()
            );

            // 11. åˆ›å»ºé€€æ¬¾å•
            Refund refund = buildRefund(request, order, calculation, commissionReversal);
            refundMapper.insert(refund);

            // 12. åˆ›å»ºé€€æ¬¾æ˜ç»†
            List<RefundItem> items = buildRefundItems(refund.getRefundId(), calculation);
            items.forEach(refundItemMapper::insert);

            // 13. å†™å…¥å¹‚ç­‰æ€§æ—¥å¿—
            saveIdempotencyLog(request, refund.getRefundId(), "SUCCESS");

            // 14. å¼‚æ­¥è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜API
            processRefundAsync(refund, payment);

            return buildResponse(refund, items);

        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new RuntimeException("è·å–é”è¢«ä¸­æ–­", e);
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }

    /**
     * å¼‚æ­¥è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜API
     */
    private void processRefundAsync(Refund refund, Payment payment) {
        PaymentAdapter adapter = paymentAdapterFactory.getAdapter(payment.getPaymentService());

        PaymentAdapter.RefundRequest apiRequest = PaymentAdapter.RefundRequest.builder()
            .paymentService(payment.getPaymentService())
            .paymentIntentId(payment.getThirdPartyPaymentId())
            .refundAmount(refund.getRefundAmount())
            .reason(refund.getReason())
            .requestNo(refund.getRequestNo())
            .build();

        CompletableFuture<PaymentAdapter.RefundResult> future =
            CompletableFuture.supplyAsync(() -> adapter.createRefund(apiRequest))
                             .orTimeout(10, TimeUnit.SECONDS);

        future.whenComplete((result, throwable) -> {
            if (throwable != null) {
                handleRefundFailure(refund, throwable.getMessage());
            } else if (result.isSuccess()) {
                handleRefundSuccess(refund, result);
            } else {
                handleRefundFailure(refund, result.getErrorMessage());
            }
        });
    }

    /**
     * å¤„ç†é€€æ¬¾æˆåŠŸ
     */
    private void handleRefundSuccess(Refund refund, PaymentAdapter.RefundResult result) {
        refund.setStatus(RefundStatus.SUCCEEDED.getCode());
        refund.setThirdPartyRefundId(result.getThirdPartyRefundId());
        refund.setProcessedAt(LocalDateTime.now());

        int updated = refundMapper.updateStatusWithVersion(
            refund.getRefundId(),
            refund.getVersion(),
            refund.getStatus(),
            result.getThirdPartyRefundId()
        );

        if (updated > 0) {
            // æ›´æ–°è®¢å•çš„ç´¯è®¡é€€æ¬¾é‡‘é¢
            orderMapper.incrementTotalRefunded(refund.getOrderId(), refund.getRefundAmount());
            log.info("é€€æ¬¾æˆåŠŸï¼šrefundId={}, amount={}", refund.getRefundId(), refund.getRefundAmount());
        }
    }
}
```

---

#### RefundCalculator.javaï¼ˆé€€æ¬¾é‡‘é¢è®¡ç®—å™¨ï¼‰

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class RefundCalculator {

    private final OrderItemMapper orderItemMapper;

    /**
     * è®¡ç®—é€€æ¬¾æ˜ç»†ï¼ˆä¸»å…¥å£ï¼‰
     */
    public RefundCalculationResult calculate(RefundRequest request, Order order) {
        if (RefundType.BY_ITEMS.name().equals(request.getRefundType())) {
            return calculateByItems(request, order);
        } else if (RefundType.BY_AMOUNT.name().equals(request.getRefundType())) {
            return calculateByAmount(request, order);
        } else {
            throw new RuntimeException("ä¸æ”¯æŒçš„é€€æ¬¾ç±»å‹: " + request.getRefundType());
        }
    }

    /**
     * æŒ‰å•†å“è®¡ç®—é€€æ¬¾
     */
    private RefundCalculationResult calculateByItems(RefundRequest request, Order order) {
        RefundCalculationResult result = new RefundCalculationResult();

        // è·å–è®¢å•ä»·æ ¼ä¿¡æ¯
        BigDecimal orderSubtotal = parseOrderSubtotal(order);
        BigDecimal orderTaxTotal = parseOrderTaxTotal(order);
        BigDecimal orderDiscount = parseOrderDiscount(order);

        BigDecimal totalRefund = BigDecimal.ZERO;
        List<RefundItemCalculation> itemCalculations = new ArrayList<>();

        // éå†æ¯ä¸ªé€€æ¬¾å•†å“
        for (RefundItemRequest itemRequest : request.getRefundItems()) {
            // æŸ¥è¯¢è®¢å•é¡¹
            OrderItem orderItem = orderItemMapper.selectById(itemRequest.getOrderItemId());
            if (orderItem == null) {
                throw new RuntimeException("è®¢å•é¡¹ä¸å­˜åœ¨: " + itemRequest.getOrderItemId());
            }

            // æ ¡éªŒé€€æ¬¾æ•°é‡
            if (itemRequest.getRefundQuantity() > orderItem.getQuantity()) {
                throw new RuntimeException(
                    String.format("é€€æ¬¾æ•°é‡(%d)è¶…è¿‡è®¢å•æ•°é‡(%d)",
                        itemRequest.getRefundQuantity(), orderItem.getQuantity())
                );
            }

            // è®¡ç®—å•†å“é€€æ¬¾
            ItemRefundAmount itemRefund = calculateItemRefund(
                orderItem,
                itemRequest.getRefundQuantity(),
                orderSubtotal,
                orderTaxTotal,
                orderDiscount
            );

            totalRefund = totalRefund.add(itemRefund.getTotalRefund());
            itemCalculations.add(itemRefund.toCalculation());
        }

        // å¤„ç†é¢å¤–è´¹ç”¨
        if (Boolean.TRUE.equals(request.getRefundDeliveryFee())) {
            BigDecimal deliveryFee = parseDeliveryFee(order);
            totalRefund = totalRefund.add(deliveryFee);
            itemCalculations.add(buildExtraFeeCalculation("DELIVERY_FEE", deliveryFee));
        }

        if (Boolean.TRUE.equals(request.getRefundTips())) {
            BigDecimal tips = parseTips(order);
            totalRefund = totalRefund.add(tips);
            itemCalculations.add(buildExtraFeeCalculation("TIPS", tips));
        }

        if (Boolean.TRUE.equals(request.getRefundCharge())) {
            BigDecimal charge = parseCharge(order);
            totalRefund = totalRefund.add(charge);
            itemCalculations.add(buildExtraFeeCalculation("CHARGE", charge));
        }

        result.setTotalRefundAmount(totalRefund);
        result.setItemCalculations(itemCalculations);
        return result;
    }

    /**
     * è®¡ç®—å•ä¸ªå•†å“çš„é€€æ¬¾
     */
    private ItemRefundAmount calculateItemRefund(
            OrderItem orderItem,
            Integer refundQty,
            BigDecimal orderSubtotal,
            BigDecimal orderTaxTotal,
            BigDecimal orderDiscount) {

        // 1. è®¡ç®—å•†å“å•ä»·
        BigDecimal itemUnitPrice = orderItem.getItemPriceTotal()
            .divide(BigDecimal.valueOf(orderItem.getQuantity()), 2, RoundingMode.HALF_UP);

        // 2. è®¡ç®—å•†å“é€€æ¬¾é‡‘é¢
        BigDecimal itemRefundAmount = itemUnitPrice.multiply(BigDecimal.valueOf(refundQty));

        // 3. æŒ‰æ¯”ä¾‹åˆ†é…ç¨è´¹
        BigDecimal taxRefund = itemRefundAmount
            .divide(orderSubtotal, 4, RoundingMode.HALF_UP)
            .multiply(orderTaxTotal)
            .setScale(2, RoundingMode.HALF_UP);

        // 4. æŒ‰æ¯”ä¾‹åˆ†é…æŠ˜æ‰£
        BigDecimal discountRefund = itemRefundAmount
            .divide(orderSubtotal, 4, RoundingMode.HALF_UP)
            .multiply(orderDiscount)
            .setScale(2, RoundingMode.HALF_UP);

        // 5. è®¡ç®—æ€»é€€æ¬¾
        BigDecimal totalRefund = itemRefundAmount.add(taxRefund).subtract(discountRefund);

        return ItemRefundAmount.builder()
            .orderItemId(orderItem.getId())
            .refundQty(refundQty)
            .itemRefundAmount(itemRefundAmount)
            .taxRefund(taxRefund)
            .discountRefund(discountRefund)
            .totalRefund(totalRefund)
            .build();
    }
}
```

---

### 6.2 ç¬¬ä¸‰æ–¹æ”¯ä»˜é€‚é…å™¨

#### PaymentAdapteræ¥å£

```java
public interface PaymentAdapter {

    /**
     * åˆ›å»ºé€€æ¬¾
     */
    RefundResult createRefund(RefundRequest request);

    /**
     * æŸ¥è¯¢é€€æ¬¾çŠ¶æ€
     */
    RefundStatusResult queryRefundStatus(String thirdPartyRefundId);

    @Data
    @Builder
    class RefundRequest {
        private PaymentServiceEnum paymentService;
        private String paymentIntentId;        // Stripe Payment Intent ID
        private String thirdPartyTradeNo;      // æ”¯ä»˜å®äº¤æ˜“å·
        private BigDecimal refundAmount;       // é€€æ¬¾é‡‘é¢
        private String reason;                 // é€€æ¬¾åŸå› 
        private String requestNo;              // å¹‚ç­‰é”®
    }

    @Data
    class RefundResult {
        private boolean success;
        private String thirdPartyRefundId;     // ç¬¬ä¸‰æ–¹é€€æ¬¾ID
        private RefundStatus status;           // é€€æ¬¾çŠ¶æ€
        private String errorMessage;
    }

    enum RefundStatus {
        PENDING, PROCESSING, SUCCEEDED, FAILED
    }
}
```

---

#### StripePaymentAdapterå®ç°

```java
@Service
@Slf4j
public class StripePaymentAdapter implements PaymentAdapter {

    @Value("${stripe.api.key}")
    private String stripeApiKey;

    @PostConstruct
    public void init() {
        Stripe.apiKey = stripeApiKey;
    }

    @Override
    public RefundResult createRefund(RefundRequest request) {
        try {
            // é‡‘é¢è½¬æ¢ï¼ˆStripeä½¿ç”¨åˆ†ä¸ºå•ä½ï¼‰
            long amountInCents = request.getRefundAmount()
                .multiply(BigDecimal.valueOf(100))
                .longValue();

            // æ„å»ºé€€æ¬¾å‚æ•°
            Map<String, Object> params = new HashMap<>();
            params.put("payment_intent", request.getPaymentIntentId());
            params.put("amount", amountInCents);
            params.put("reason", "requested_by_customer");
            params.put("reverse_transfer", true);  // è‡ªåŠ¨å›è¡¥æŠ½æˆ

            // å¹‚ç­‰æ€§é”®
            RequestOptions requestOptions = RequestOptions.builder()
                .setIdempotencyKey(request.getRequestNo())
                .build();

            // è°ƒç”¨Stripe API
            Refund stripeRefund = Refund.create(params, requestOptions);

            log.info("Stripeé€€æ¬¾åˆ›å»ºæˆåŠŸ: refundId={}, status={}",
                stripeRefund.getId(), stripeRefund.getStatus());

            // æ„å»ºè¿”å›ç»“æœ
            RefundResult result = new RefundResult();
            result.setSuccess(true);
            result.setThirdPartyRefundId(stripeRefund.getId());
            result.setStatus(mapStripeStatus(stripeRefund.getStatus()));
            return result;

        } catch (StripeException e) {
            log.error("Stripeé€€æ¬¾å¤±è´¥", e);

            RefundResult result = new RefundResult();
            result.setSuccess(false);
            result.setErrorMessage(e.getMessage());
            result.setStatus(RefundStatus.FAILED);
            return result;
        }
    }

    private RefundStatus mapStripeStatus(String stripeStatus) {
        return switch (stripeStatus) {
            case "succeeded" -> RefundStatus.SUCCEEDED;
            case "pending" -> RefundStatus.PROCESSING;
            case "failed" -> RefundStatus.FAILED;
            default -> RefundStatus.PENDING;
        };
    }
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### 7.1 ç¤ºä¾‹1ï¼šé€€2ä¸ªå•†å“

**ä¸šåŠ¡åœºæ™¯**ï¼šç”¨æˆ·è®¢è´­äº†5ä¸ªæ±‰å ¡å’Œ2ä»½è–¯æ¡ï¼Œå…¶ä¸­2ä¸ªæ±‰å ¡æœ‰è´¨é‡é—®é¢˜ï¼Œéœ€è¦é€€æ¬¾ã€‚

**è®¢å•ä¿¡æ¯**ï¼š
```json
{
  "orderId": 123456,
  "items": [
    {
      "orderItemId": 1,
      "productName": "æ±‰å ¡",
      "quantity": 5,
      "unitPrice": 10.00,
      "totalPrice": 50.00
    },
    {
      "orderItemId": 2,
      "productName": "è–¯æ¡",
      "quantity": 2,
      "unitPrice": 5.00,
      "totalPrice": 10.00
    }
  ],
  "subtotal": 60.00,
  "taxTotal": 4.80,    // 8%ç¨ç‡
  "discount": 10.00,
  "deliveryFee": 5.00,
  "tips": 3.00,
  "charge": 2.00,
  "totalAmount": 64.80
}
```

**é€€æ¬¾è¯·æ±‚**ï¼š
```bash
curl -X POST http://localhost:8080/api/refunds \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "orderId": 123456,
    "requestNo": "REF20250202120001",
    "refundType": "BY_ITEMS",
    "refundItems": [
      {
        "orderItemId": 1,
        "refundQuantity": 2
      }
    ],
    "refundDeliveryFee": false,
    "reason": "å•†å“è´¨é‡é—®é¢˜"
  }'
```

**è®¡ç®—è¿‡ç¨‹**ï¼š
```
1. æ±‰å ¡å•ä»· = $50 / 5 = $10
2. é€€æ¬¾æ±‰å ¡é‡‘é¢ = $10 Ã— 2 = $20.00
3. ç¨è´¹é€€æ¬¾ = ($20 / $60) Ã— $4.80 = $1.60
4. æŠ˜æ‰£é€€æ¬¾ = ($20 / $60) Ã— $10 = $3.33
5. æ€»é€€æ¬¾ = $20.00 + $1.60 - $3.33 = $18.27
```

**å“åº”ç»“æœ**ï¼š
```json
{
  "success": true,
  "data": {
    "refundId": 78901,
    "refundAmount": 18.27,
    "status": "PROCESSING",
    "commissionReversal": 1.83,
    "refundItems": [
      {
        "subject": "ITEM",
        "refundQty": 2,
        "refundAmount": 20.00
      },
      {
        "subject": "TAX",
        "refundAmount": 1.60
      },
      {
        "subject": "DISCOUNT",
        "refundAmount": -3.33
      }
    ]
  }
}
```

---

### 7.2 ç¤ºä¾‹2ï¼šæŒ‰é‡‘é¢é€€æ¬¾ï¼ˆè¡¥å¿ï¼‰

**ä¸šåŠ¡åœºæ™¯**ï¼šé…é€å»¶è¿Ÿ1å°æ—¶ï¼Œå®¢æœç»™ç”¨æˆ·$10è¡¥å¿é€€æ¬¾ã€‚

**é€€æ¬¾è¯·æ±‚**ï¼š
```bash
curl -X POST http://localhost:8080/api/refunds \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": 123456,
    "requestNo": "REF20250202120002",
    "refundType": "BY_AMOUNT",
    "refundAmount": 10.00,
    "reason": "é…é€å»¶è¿Ÿè¡¥å¿"
  }'
```

**è®¡ç®—è¿‡ç¨‹**ï¼š
```
1. æ±‰å ¡æ¯”ä¾‹ = $50 / $60 = 83.33%
   æ±‰å ¡åˆ†é…é€€æ¬¾ = $10 Ã— 83.33% = $8.33

2. è–¯æ¡æ¯”ä¾‹ = $10 / $60 = 16.67%
   è–¯æ¡åˆ†é…é€€æ¬¾ = $10 Ã— 16.67% = $1.67

3. ç¨è´¹é€€æ¬¾ = ($10 / $60) Ã— $4.80 = $0.80
4. æŠ˜æ‰£é€€æ¬¾ = ($10 / $60) Ã— $10 = $1.67
5. æ€»é€€æ¬¾ = $10.00 + $0.80 - $1.67 = $9.13
```

**å“åº”ç»“æœ**ï¼š
```json
{
  "success": true,
  "data": {
    "refundId": 78902,
    "refundAmount": 9.13,
    "status": "SUCCEEDED",
    "refundItems": [
      {
        "orderItemId": 1,
        "subject": "ITEM",
        "refundAmount": 8.33
      },
      {
        "orderItemId": 2,
        "subject": "ITEM",
        "refundAmount": 1.67
      },
      {
        "subject": "TAX",
        "refundAmount": 0.80
      },
      {
        "subject": "DISCOUNT",
        "refundAmount": -1.67
      }
    ]
  }
}
```

---

### 7.3 ç¤ºä¾‹3ï¼šå¤šæ¬¡éƒ¨åˆ†é€€æ¬¾

**åœºæ™¯**ï¼šè®¢å•æ€»é¢$200ï¼Œåˆ†3æ¬¡é€€æ¬¾ã€‚

**ç¬¬1æ¬¡é€€æ¬¾**ï¼ˆ$50ï¼‰ï¼š
```json
{
  "orderId": 123456,
  "requestNo": "REF20250202001",
  "refundType": "BY_AMOUNT",
  "refundAmount": 50.00
}
```
**ç»“æœ**ï¼šé€€æ¬¾æˆåŠŸï¼Œå‰©ä½™å¯é€€$150

---

**ç¬¬2æ¬¡é€€æ¬¾**ï¼ˆ$30ï¼‰ï¼š
```json
{
  "orderId": 123456,
  "requestNo": "REF20250202002",
  "refundType": "BY_AMOUNT",
  "refundAmount": 30.00
}
```
**ç»“æœ**ï¼šé€€æ¬¾æˆåŠŸï¼Œå‰©ä½™å¯é€€$120

---

**ç¬¬3æ¬¡é€€æ¬¾**ï¼ˆ$120ï¼Œå…¨é¢ï¼‰ï¼š
```json
{
  "orderId": 123456,
  "requestNo": "REF20250202003",
  "refundType": "BY_AMOUNT",
  "refundAmount": 120.00
}
```
**ç»“æœ**ï¼šé€€æ¬¾æˆåŠŸï¼Œå‰©ä½™å¯é€€$0ï¼ˆå…¨é¢é€€å®Œï¼‰

---

**ç¬¬4æ¬¡é€€æ¬¾**ï¼ˆå°è¯•å†é€€$10ï¼‰ï¼š
```json
{
  "orderId": 123456,
  "requestNo": "REF20250202004",
  "refundType": "BY_AMOUNT",
  "refundAmount": 10.00
}
```
**ç»“æœ**ï¼š
```json
{
  "success": false,
  "message": "è®¢å•å·²å…¨é¢é€€æ¬¾ï¼Œæ— æ³•ç»§ç»­é€€æ¬¾",
  "errorCode": "NO_AVAILABLE_REFUND"
}
```

---

## é…ç½®éƒ¨ç½²

### 8.1 application.ymlé…ç½®

```yaml
spring:
  # æ•°æ®æºé…ç½®ï¼ˆShardingSphereï¼‰
  shardingsphere:
    datasource:
      names: ds0,ds1,ds2
      ds0:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/order_db_0
        username: root
        password: ******
      ds1:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/order_db_1
        username: root
        password: ******
      ds2:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/order_db_2
        username: root
        password: ******

    # åˆ†ç‰‡è§„åˆ™
    rules:
      sharding:
        tables:
          refunds:
            actual-data-nodes: ds$->{0..2}.refunds_$->{0..2}
            database-strategy:
              standard:
                sharding-column: store_id
                sharding-algorithm-name: db-hash-mod
            table-strategy:
              standard:
                sharding-column: store_id
                sharding-algorithm-name: table-hash-mod

          refund_items:
            actual-data-nodes: ds$->{0..2}.refund_items_$->{0..2}
            database-strategy:
              standard:
                sharding-column: store_id
                sharding-algorithm-name: db-hash-mod
            table-strategy:
              standard:
                sharding-column: store_id
                sharding-algorithm-name: table-hash-mod

        sharding-algorithms:
          db-hash-mod:
            type: HASH_MOD
            props:
              sharding-count: 3
          table-hash-mod:
            type: HASH_MOD
            props:
              sharding-count: 3

  # Redisé…ç½®
  redis:
    host: localhost
    port: 6379
    password: ******
    database: 0
    timeout: 5000
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5

# Stripeé…ç½®
stripe:
  api:
    key: sk_test_51***  # Stripe Secret Key
    webhook-secret: whsec_***  # Webhookç­¾åå¯†é’¥

# æ”¯ä»˜å®é…ç½®
alipay:
  app-id: 2021***
  private-key: MIIEvQ***
  alipay-public-key: MIIBIj***
  gateway-url: https://openapi.alipay.com/gateway.do

# é€€æ¬¾é…ç½®
refund:
  async:
    thread-pool-size: 10  # å¼‚æ­¥çº¿ç¨‹æ± å¤§å°
    timeout-seconds: 10   # APIè°ƒç”¨è¶…æ—¶æ—¶é—´
  retry:
    max-attempts: 3       # å¤±è´¥é‡è¯•æ¬¡æ•°
    backoff-seconds: 5    # é‡è¯•é—´éš”
```

---

### 8.2 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

**æ‰§è¡Œé¡ºåº**ï¼š

```bash
# 1. åˆ›å»ºæ•°æ®åº“
mysql -u root -p < sql/create_databases.sql

# 2. åˆ›å»ºé€€æ¬¾è¡¨
mysql -u root -p order_db_0 < sql/create_refund_tables.sql
mysql -u root -p order_db_1 < sql/create_refund_tables.sql
mysql -u root -p order_db_2 < sql/create_refund_tables.sql

# 3. åˆ›å»ºå¹‚ç­‰æ€§æ—¥å¿—è¡¨ï¼ˆå•åº“ï¼‰
mysql -u root -p order_db_0 < sql/create_idempotency_logs.sql
```

---

### 8.3 Dockeréƒ¨ç½²

**docker-compose.yml**ï¼š

```yaml
version: '3.8'

services:
  # MySQLä¸»åº“
  mysql-master:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: order_db_0
    volumes:
      - ./sql:/docker-entrypoint-initdb.d
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"

  # Redis
  redis:
    image: redis:7.0-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  # è®¢å•æœåŠ¡
  order-service:
    build: .
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-master:3306/order_db_0
      SPRING_REDIS_HOST: redis
      STRIPE_API_KEY: ${STRIPE_API_KEY}
    depends_on:
      - mysql-master
      - redis

volumes:
  mysql-data:
  redis-data:
```

**å¯åŠ¨å‘½ä»¤**ï¼š
```bash
docker-compose up -d
```

---

## å¸¸è§é—®é¢˜

### 9.1 é€€æ¬¾å¤±è´¥å¦‚ä½•é‡è¯•ï¼Ÿ

**è‡ªåŠ¨é‡è¯•æœºåˆ¶**ï¼š

```java
@Scheduled(fixedDelay = 300000)  // æ¯5åˆ†é’Ÿ
public void retryFailedRefunds() {
    // æŸ¥è¯¢FAILEDçŠ¶æ€çš„é€€æ¬¾ï¼ˆåˆ›å»ºæ—¶é—´<30åˆ†é’Ÿï¼‰
    List<Refund> failedRefunds = refundMapper.selectFailedRefunds(
        LocalDateTime.now().minusMinutes(30)
    );

    for (Refund refund : failedRefunds) {
        try {
            // é‡æ–°è°ƒç”¨æ”¯ä»˜API
            processRefundAsync(refund, payment);
        } catch (Exception e) {
            log.error("é‡è¯•é€€æ¬¾å¤±è´¥: refundId={}", refund.getRefundId(), e);
        }
    }
}
```

**æ‰‹åŠ¨é‡è¯•æ¥å£**ï¼š
```bash
POST /api/refunds/{refundId}/retry
```

---

### 9.2 å¦‚ä½•å¤„ç†é‡å¤è¯·æ±‚ï¼Ÿ

**åŒå±‚å¹‚ç­‰æ€§ä¿è¯**ï¼š

1. **è¯·æ±‚å·å”¯ä¸€çº¦æŸ**ï¼ˆæ•°æ®åº“çº§åˆ«ï¼‰
```sql
UNIQUE KEY uk_request_no (merchant_id, request_no)
```

2. **ä¸šåŠ¡æŒ‡çº¹æ ¡éªŒ**ï¼ˆåº”ç”¨çº§åˆ«ï¼‰
```java
String fingerprint = MD5(requestNo + "|" + orderId + "|" + amount);
```

3. **Stripeå¹‚ç­‰é”®**ï¼ˆç¬¬ä¸‰æ–¹çº§åˆ«ï¼‰
```java
RequestOptions.builder()
    .setIdempotencyKey(requestNo)
    .build()
```

---

### 9.3 é€€æ¬¾ååº“å­˜å¦‚ä½•å¤„ç†ï¼Ÿ

**ä¸è‡ªåŠ¨æ¢å¤åº“å­˜**ï¼ŒåŸå› ï¼š
- é¤é¥®å•†å“ç‰¹æ®Šæ€§ï¼ˆé£Ÿç‰©å·²åˆ¶ä½œï¼‰
- åº“å­˜æ¢å¤éœ€è¦äººå·¥å®¡æ ¸
- é¿å…è‡ªåŠ¨æ¢å¤å¯¼è‡´çš„åº“å­˜é”™è¯¯

**æ¨èæµç¨‹**ï¼š
1. é€€æ¬¾æˆåŠŸåå‘é€é€šçŸ¥ç»™å•†æˆ·
2. å•†æˆ·ç¡®è®¤å•†å“å¯å›æ”¶ï¼ˆæœªä½¿ç”¨ï¼‰
3. å•†æˆ·æ‰‹åŠ¨æ“ä½œåº“å­˜æ¢å¤

---

### 9.4 å¦‚ä½•ç›‘æ§é€€æ¬¾ç³»ç»Ÿï¼Ÿ

**å…³é”®MetricsæŒ‡æ ‡**ï¼š

```java
@Component
public class RefundMetrics {

    @Autowired
    private MeterRegistry meterRegistry;

    // é€€æ¬¾æˆåŠŸç‡
    public void recordSuccess(String paymentService) {
        meterRegistry.counter("refund.success",
            "service", paymentService).increment();
    }

    // é€€æ¬¾å¤±è´¥ç‡
    public void recordFailure(String paymentService, String reason) {
        meterRegistry.counter("refund.failure",
            "service", paymentService,
            "reason", reason).increment();
    }

    // é€€æ¬¾é‡‘é¢
    public void recordAmount(BigDecimal amount) {
        meterRegistry.summary("refund.amount")
            .record(amount.doubleValue());
    }

    // é€€æ¬¾å¤„ç†æ—¶é•¿
    public void recordDuration(long millis) {
        meterRegistry.timer("refund.duration")
            .record(millis, TimeUnit.MILLISECONDS);
    }
}
```

**Grafanaç›‘æ§å¤§ç›˜**ï¼š
- æ¯æ—¥é€€æ¬¾ç¬”æ•°
- é€€æ¬¾æˆåŠŸç‡ï¼ˆç›®æ ‡>99%ï¼‰
- å¹³å‡é€€æ¬¾é‡‘é¢
- é€€æ¬¾å¤„ç†æ—¶é•¿ï¼ˆP50/P95/P99ï¼‰
- å¤±è´¥åŸå› åˆ†å¸ƒ

---

### 9.5 éƒ¨åˆ†é€€æ¬¾åè®¢å•çŠ¶æ€å¦‚ä½•å˜åŒ–ï¼Ÿ

**è®¢å•çŠ¶æ€ä¸å˜åŒ–**ï¼Œåªæ›´æ–° `total_refunded` å­—æ®µï¼š

```sql
-- è®¢å•è¡¨å¢åŠ å­—æ®µ
ALTER TABLE orders_0 ADD COLUMN total_refunded DECIMAL(10,2) DEFAULT 0 COMMENT 'ç´¯è®¡é€€æ¬¾é‡‘é¢';

-- é€€æ¬¾æˆåŠŸåæ›´æ–°
UPDATE orders_0
SET total_refunded = total_refunded + 50.00
WHERE order_id = 123456;
```

**è®¢å•çŠ¶æ€è§„åˆ™**ï¼š
- éƒ¨åˆ†é€€æ¬¾ï¼šè®¢å•çŠ¶æ€ä¿æŒ `COMPLETED`
- å…¨é¢é€€æ¬¾ï¼šå¯é€‰æ›´æ–°ä¸º `REFUNDED`

---

## é¢è¯•è¦ç‚¹

### 10.1 é«˜é¢‘é¢è¯•é—®é¢˜

#### Q1: å¦‚ä½•ä¿è¯é€€æ¬¾çš„å¹‚ç­‰æ€§ï¼Ÿ

**ç­”ï¼šä¸‰å±‚å¹‚ç­‰æ€§ä¿è¯**

1. **åº”ç”¨å±‚**ï¼šè¯·æ±‚å· + ä¸šåŠ¡æŒ‡çº¹åŒé‡æ£€æŸ¥
2. **æ•°æ®åº“å±‚**ï¼šå”¯ä¸€ç´¢å¼•çº¦æŸ
3. **ç¬¬ä¸‰æ–¹å±‚**ï¼šStripeå¹‚ç­‰é”®

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// æ£€æŸ¥è¯·æ±‚å·
RefundIdempotencyLog log = mapper.selectByRequestNo(requestNo);
if (log != null) return existingRefund;

// æ£€æŸ¥æŒ‡çº¹
String fingerprint = MD5(requestNo + orderId + amount);
RefundIdempotencyLog fingerprintLog = mapper.selectByFingerprint(fingerprint);
```

**æ—¶åºå›¾**ï¼š
```
è¯·æ±‚1 (requestNo=REF001)
  â†“
åº”ç”¨å±‚æ£€æŸ¥ â†’ æœªæ‰¾åˆ° â†’ ç»§ç»­
  â†“
åˆ›å»ºé€€æ¬¾ + å†™å…¥æ—¥å¿—
  â†“
è¿”å›é€€æ¬¾å•

è¯·æ±‚2 (requestNo=REF001, é‡å¤)
  â†“
åº”ç”¨å±‚æ£€æŸ¥ â†’ æ‰¾åˆ°è®°å½• â†’ ç›´æ¥è¿”å›å·²å­˜åœ¨çš„é€€æ¬¾å•
```

---

#### Q2: å¦‚ä½•é˜²æ­¢å¹¶å‘é€€æ¬¾å¯¼è‡´çš„å¯é€€ä½™é¢è®¡ç®—é”™è¯¯ï¼Ÿ

**ç­”ï¼šåˆ†å¸ƒå¼é” + ä¹è§‚é”**

```java
// 1. åˆ†å¸ƒå¼é”ï¼ˆç²—ç²’åº¦ï¼‰
RLock lock = redissonClient.getLock("refund:order:" + orderId);
lock.tryLock(5, 30, TimeUnit.SECONDS);

// 2. æŸ¥è¯¢è®¢å•ï¼ˆåŠ è¡Œé”ï¼‰
Order order = orderMapper.selectByIdForUpdate(orderId);

// 3. ä¹è§‚é”æ›´æ–°é€€æ¬¾çŠ¶æ€
int updated = refundMapper.updateStatusWithVersion(
    refundId, version, newStatus
);
if (updated == 0) {
    throw new ConcurrentModificationException();
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ä¸¤å±‚é”ï¼Ÿ**
- **åˆ†å¸ƒå¼é”**ï¼šé˜²æ­¢å¤šä¸ªé€€æ¬¾è¯·æ±‚å¹¶å‘åˆ›å»º
- **ä¹è§‚é”**ï¼šé˜²æ­¢é€€æ¬¾çŠ¶æ€å¹¶å‘ä¿®æ”¹

---

#### Q3: ç¨è´¹å’ŒæŠ˜æ‰£å¦‚ä½•æŒ‰æ¯”ä¾‹åˆ†é…ï¼Ÿ

**ç­”ï¼šæŒ‰å•†å“é‡‘é¢æ¯”ä¾‹åˆ†é…**

**å…¬å¼**ï¼š
```
ç¨è´¹é€€æ¬¾ = (é€€æ¬¾å•†å“é‡‘é¢ / è®¢å•å•†å“å°è®¡) Ã— è®¢å•æ€»ç¨è´¹
æŠ˜æ‰£é€€æ¬¾ = (é€€æ¬¾å•†å“é‡‘é¢ / è®¢å•å•†å“å°è®¡) Ã— è®¢å•æ€»æŠ˜æ‰£
```

**ä¸ºä»€ä¹ˆä¸æŒ‰æ•°é‡æ¯”ä¾‹ï¼Ÿ**
- å•†å“å•ä»·ä¸åŒï¼ŒæŒ‰æ•°é‡ä¸å…¬å¹³
- ä¾‹å¦‚ï¼šæ±‰å ¡$10ï¼Œè–¯æ¡$5ï¼Œé€€1ä¸ªæ±‰å ¡å’Œ1ä»½è–¯æ¡ï¼Œç¨è´¹åº”è¯¥ä¸åŒ

**ä»£ç **ï¼š
```java
BigDecimal taxRefund = itemRefundAmount
    .divide(orderSubtotal, 4, RoundingMode.HALF_UP)  // 4ä½ç²¾åº¦
    .multiply(orderTaxTotal)
    .setScale(2, RoundingMode.HALF_UP);  // æœ€ç»ˆ2ä½å°æ•°
```

---

#### Q4: å¦‚ä½•å¤„ç†é€€æ¬¾APIè¶…æ—¶ï¼Ÿ

**ç­”ï¼šå¼‚æ­¥å¤„ç† + Fallbacké™çº§**

```java
// 1. è®¾ç½®è¶…æ—¶æ—¶é—´
CompletableFuture<RefundResult> future =
    CompletableFuture.supplyAsync(() -> callPaymentAPI())
                     .orTimeout(10, TimeUnit.SECONDS);

// 2. è¶…æ—¶å¤„ç†
future.whenComplete((result, throwable) -> {
    if (throwable instanceof TimeoutException) {
        // æ›´æ–°çŠ¶æ€ä¸ºPROCESSINGï¼ˆç­‰å¾…å¼‚æ­¥é€šçŸ¥ï¼‰
        refund.setStatus("PROCESSING");
        refundMapper.updateById(refund);
    }
});
```

**ä¸ºä»€ä¹ˆä¸ç›´æ¥å¤±è´¥ï¼Ÿ**
- Stripeç­‰æ”¯ä»˜æ¸ é“æœ‰Webhookå¼‚æ­¥é€šçŸ¥
- è¶…æ—¶ä¸ä»£è¡¨å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œå»¶è¿Ÿ
- è®¾ç½®ä¸ºPROCESSINGçŠ¶æ€ï¼Œç­‰å¾…Webhookå›è°ƒ

---

#### Q5: åˆ†åº“åˆ†è¡¨å¦‚ä½•è®¾è®¡ï¼Ÿ

**ç­”ï¼šåŸºäº `store_id` å“ˆå¸Œåˆ†ç‰‡**

**åˆ†ç‰‡è§„åˆ™**ï¼š
```yaml
database-strategy:
  sharding-column: store_id
  sharding-algorithm: hash_mod(store_id) % 3

table-strategy:
  sharding-column: store_id
  sharding-algorithm: hash_mod(store_id) % 3
```

**ä¸ºä»€ä¹ˆé€‰ `store_id`ï¼Ÿ**
- é€€æ¬¾æŸ¥è¯¢é€šå¸¸æŒ‰è®¢å•æŸ¥è¯¢ï¼Œè®¢å•æŒ‰é—¨åº—åˆ†ç‰‡
- ä¿è¯é€€æ¬¾å’Œè®¢å•åœ¨åŒä¸€ä¸ªåˆ†ç‰‡ï¼ˆé¿å…è·¨åº“JOINï¼‰
- è´Ÿè½½å‡è¡¡ï¼ˆå¤§å‹å•†æˆ·æœ‰å¤šä¸ªé—¨åº—ï¼‰

**åˆ†ç‰‡ç»“æœ**ï¼š
```
store_id=1 â†’ hash(1) % 3 = 1 â†’ ds1.refunds_1
store_id=5 â†’ hash(5) % 3 = 2 â†’ ds2.refunds_2
store_id=9 â†’ hash(9) % 3 = 0 â†’ ds0.refunds_0
```

---

### 10.2 æ¶æ„è®¾è®¡äº®ç‚¹

| äº®ç‚¹ | è¯´æ˜ | æŠ€æœ¯ä»·å€¼ |
|------|------|---------|
| **ä¸¤ç§é€€æ¬¾æ¨¡å¼** | BY_ITEMS + BY_AMOUNT | çµæ´»æ€§ + ä¸šåŠ¡è¦†ç›–åº¦ |
| **ç²¾ç¡®é‡‘é¢è®¡ç®—** | ç¨è´¹/æŠ˜æ‰£æŒ‰æ¯”ä¾‹åˆ†é… | è´¢åŠ¡å‡†ç¡®æ€§ |
| **ä¸‰å±‚å¹‚ç­‰æ€§** | è¯·æ±‚å· + æŒ‡çº¹ + å”¯ä¸€ç´¢å¼• | æ•°æ®ä¸€è‡´æ€§ |
| **åŒé”æœºåˆ¶** | åˆ†å¸ƒå¼é” + ä¹è§‚é” | å¹¶å‘æ§åˆ¶ |
| **å¼‚æ­¥å¤„ç†** | CompletableFuture + è¶…æ—¶é™çº§ | é«˜å¯ç”¨æ€§ |
| **çŠ¶æ€æœºè®¾è®¡** | ä¸¥æ ¼çš„çŠ¶æ€è½¬æ¢è§„åˆ™ | æµç¨‹å¯æ§æ€§ |
| **åˆ†åº“åˆ†è¡¨** | åŸºäºstore_idå“ˆå¸Œ | é«˜å¹¶å‘æ”¯æŒ |
| **å¤šæ”¯ä»˜æ¸ é“** | é€‚é…å™¨æ¨¡å¼ | å¯æ‰©å±•æ€§ |

---

### 10.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### ä¼˜åŒ–1ï¼šé€€æ¬¾æ˜ç»†å¼‚æ­¥å†™å…¥

**å½“å‰**ï¼šé€€æ¬¾å•å’Œæ˜ç»†åœ¨åŒä¸€äº‹åŠ¡ä¸­å†™å…¥
**ä¼˜åŒ–**ï¼šé€€æ¬¾å•åŒæ­¥ï¼Œæ˜ç»†å¼‚æ­¥

```java
// åŒæ­¥ï¼šåˆ›å»ºé€€æ¬¾å•
refundMapper.insert(refund);

// å¼‚æ­¥ï¼šåˆ›å»ºé€€æ¬¾æ˜ç»†
CompletableFuture.runAsync(() -> {
    items.forEach(refundItemMapper::insert);
});
```

**æ”¶ç›Š**ï¼šå“åº”æ—¶é—´é™ä½30%

---

#### ä¼˜åŒ–2ï¼šå¯é€€ä½™é¢ç¼“å­˜

**å½“å‰**ï¼šæ¯æ¬¡é€€æ¬¾éƒ½æŸ¥è¯¢æ•°æ®åº“ç»Ÿè®¡
**ä¼˜åŒ–**ï¼šRedisç¼“å­˜å¯é€€ä½™é¢

```java
// è®¢å•æ”¯ä»˜æˆåŠŸåå†™å…¥ç¼“å­˜
redisTemplate.opsForValue().set(
    "order:available_refund:" + orderId,
    totalPaid,
    1, TimeUnit.HOURS
);

// é€€æ¬¾æˆåŠŸåæ‰£å‡ç¼“å­˜
redisTemplate.opsForValue().decrement(
    "order:available_refund:" + orderId,
    refundAmount
);
```

**æ”¶ç›Š**ï¼šQPSæå‡50%

---

#### ä¼˜åŒ–3ï¼šæ‰¹é‡é€€æ¬¾

**åœºæ™¯**ï¼šå®¢æœæ‰¹é‡å¤„ç†é€€æ¬¾ç”³è¯·

```java
POST /api/refunds/batch

{
  "refunds": [
    {"orderId": 1, "requestNo": "REF001", ...},
    {"orderId": 2, "requestNo": "REF002", ...}
  ]
}
```

**å®ç°**ï¼š
```java
@Transactional
public List<RefundResponse> batchCreateRefund(List<RefundRequest> requests) {
    return requests.parallelStream()
        .map(this::createRefund)
        .collect(Collectors.toList());
}
```

---

## æ€»ç»“

### ç³»ç»Ÿç‰¹è‰²

1. âœ… **å®Œæ•´çš„é€€æ¬¾åŠŸèƒ½**ï¼šæ”¯æŒéƒ¨åˆ†é€€æ¬¾ã€å¤šæ¬¡é€€æ¬¾ã€ç²¾ç¡®é‡‘é¢è®¡ç®—
2. âœ… **é«˜å¹¶å‘ä¿è¯**ï¼šåˆ†å¸ƒå¼é” + ä¹è§‚é” + å¹‚ç­‰æ€§ä¸‰é‡ä¿éšœ
3. âœ… **é«˜å¯ç”¨è®¾è®¡**ï¼šå¼‚æ­¥å¤„ç† + è¶…æ—¶é™çº§ + å¤±è´¥é‡è¯•
4. âœ… **ç²¾ç¡®è´¢åŠ¡è®¡ç®—**ï¼šç¨è´¹/æŠ˜æ‰£æŒ‰æ¯”ä¾‹åˆ†é…ï¼Œæ”¯æŒå¹³å°æŠ½æˆå›è¡¥
5. âœ… **æ˜“äºæ‰©å±•**ï¼šé€‚é…å™¨æ¨¡å¼æ”¯æŒå¤šæ”¯ä»˜æ¸ é“
6. âœ… **åˆ†åº“åˆ†è¡¨æ”¯æŒ**ï¼šåŸºäºstore_idå“ˆå¸Œï¼Œæ”¯æŒæ¨ªå‘æ‰©å±•

### æŠ€æœ¯æ ˆä»·å€¼

| æŠ€æœ¯ | è§£å†³çš„é—®é¢˜ | é¢è¯•ä»·å€¼ |
|------|-----------|---------|
| Redisåˆ†å¸ƒå¼é” | å¹¶å‘æ§åˆ¶ | â­â­â­â­â­ |
| ä¹è§‚é” | çŠ¶æ€å¹¶å‘ä¿®æ”¹ | â­â­â­â­ |
| å¹‚ç­‰æ€§è®¾è®¡ | é‡å¤è¯·æ±‚ | â­â­â­â­â­ |
| CompletableFuture | å¼‚æ­¥å¤„ç† | â­â­â­â­ |
| ShardingSphere | åˆ†åº“åˆ†è¡¨ | â­â­â­â­â­ |
| çŠ¶æ€æœºæ¨¡å¼ | æµç¨‹ç®¡ç† | â­â­â­ |
| é€‚é…å™¨æ¨¡å¼ | å¤šæ”¯ä»˜æ¸ é“ | â­â­â­â­ |

**è¿™æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„å®Œæ•´é€€æ¬¾ç³»ç»Ÿï¼Œéå¸¸é€‚åˆP7é¢è¯•å±•ç¤ºï¼** ğŸš€

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

```
order-service/
â”œâ”€â”€ src/main/java/com/jiaoyi/order/
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â””â”€â”€ RefundController.java
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ RefundService.java
â”‚   â”‚   â”œâ”€â”€ RefundCalculator.java
â”‚   â”‚   â””â”€â”€ RefundStateMachine.java
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ Refund.java
â”‚   â”‚   â”œâ”€â”€ RefundItem.java
â”‚   â”‚   â””â”€â”€ RefundIdempotencyLog.java
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ RefundRequest.java
â”‚   â”‚   â””â”€â”€ RefundResponse.java
â”‚   â”œâ”€â”€ mapper/
â”‚   â”‚   â”œâ”€â”€ RefundMapper.java
â”‚   â”‚   â”œâ”€â”€ RefundItemMapper.java
â”‚   â”‚   â””â”€â”€ RefundIdempotencyLogMapper.java
â”‚   â”œâ”€â”€ adapter/
â”‚   â”‚   â”œâ”€â”€ PaymentAdapter.java
â”‚   â”‚   â”œâ”€â”€ StripePaymentAdapter.java
â”‚   â”‚   â””â”€â”€ AlipayPaymentAdapter.java
â”‚   â””â”€â”€ enums/
â”‚       â”œâ”€â”€ RefundStatus.java
â”‚       â””â”€â”€ RefundType.java
â””â”€â”€ src/main/resources/
    â”œâ”€â”€ mapper/
    â”‚   â”œâ”€â”€ RefundMapper.xml
    â”‚   â”œâ”€â”€ RefundItemMapper.xml
    â”‚   â””â”€â”€ RefundIdempotencyLogMapper.xml
    â””â”€â”€ sql/
        â”œâ”€â”€ create_refund_tables.sql
        â””â”€â”€ create_idempotency_logs.sql
```

### B. å¿«é€Ÿéƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# deploy_refund_system.sh

echo "éƒ¨ç½²é€€æ¬¾ç³»ç»Ÿ..."

# 1. åˆå§‹åŒ–æ•°æ®åº“
mysql -u root -p < sql/create_databases.sql
mysql -u root -p order_db_0 < sql/create_refund_tables.sql
mysql -u root -p order_db_1 < sql/create_refund_tables.sql
mysql -u root -p order_db_2 < sql/create_refund_tables.sql

# 2. å¯åŠ¨Redis
docker run -d --name redis -p 6379:6379 redis:7.0-alpine

# 3. ç¼–è¯‘é¡¹ç›®
mvn clean package -DskipTests

# 4. å¯åŠ¨æœåŠ¡
java -jar target/order-service.jar \
  --spring.profiles.active=prod \
  --stripe.api.key=$STRIPE_API_KEY

echo "éƒ¨ç½²å®Œæˆï¼"
echo "APIåœ°å€: http://localhost:8080/api/refunds"
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-02-02
**ç»´æŠ¤è€…**: Claude Code Team
