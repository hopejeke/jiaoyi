<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿è®¢é¤ - ä¸‹å•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .content-wrapper {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        
        .merchant-section, .menu-section, .cart-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #667eea;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }
        
        .merchant-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .merchant-item {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .merchant-item:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .merchant-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .merchant-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .merchant-info {
            color: #666;
            font-size: 0.9rem;
        }
        
        .menu-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .menu-item {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .menu-item-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .menu-item-price {
            color: #667eea;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .menu-item-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        .quantity-btn:hover {
            background: #764ba2;
        }
        
        .quantity-display {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        .cart-section {
            position: sticky;
            top: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .cart-items {
            margin-bottom: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .cart-item-price {
            color: #666;
            font-size: 0.9rem;
        }
        
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cart-summary {
            border-top: 2px solid #e1e5e9;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .summary-total {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            border-top: 2px solid #e1e5e9;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .order-form {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ½ï¸ åœ¨çº¿è®¢é¤</h1>
            <div class="nav-buttons">
                <a href="index.html" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
            </div>
        </div>
        
        <div id="alertContainer"></div>
        
        <div class="content-wrapper">
            <!-- å·¦ä¾§ï¼šé¤é¦†é€‰æ‹©å’Œèœå• -->
            <div style="display: flex; flex-direction: column; gap: 30px;">
                <!-- é¤é¦†é€‰æ‹© -->
                <div class="merchant-section">
                    <h2 class="section-title">é€‰æ‹©é¤é¦†</h2>
                    <div id="merchantList" class="merchant-list">
                        <div style="text-align: center; padding: 40px; color: #999;">æ­£åœ¨åŠ è½½é¤é¦†åˆ—è¡¨...</div>
                    </div>
                </div>
                
                <!-- èœå• -->
                <div class="menu-section hidden" id="menuSection">
                    <h2 class="section-title">èœå•</h2>
                    <div id="menuList" class="menu-list">
                        <div style="text-align: center; padding: 40px; color: #999;">è¯·å…ˆé€‰æ‹©é¤é¦†</div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šè´­ç‰©è½¦å’Œä¸‹å• -->
            <div class="cart-section">
                <h2 class="section-title">è´­ç‰©è½¦</h2>
                <div id="cartItems" class="cart-items">
                    <div style="text-align: center; padding: 40px; color: #999;">è´­ç‰©è½¦ä¸ºç©º</div>
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>å°è®¡ï¼š</span>
                        <span id="subtotal">Â¥0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>é…é€è´¹ï¼š</span>
                        <span id="deliveryFee">Â¥0.00</span>
                    </div>
                    <div class="summary-row" id="taxTotalItem" style="display: none;">
                        <span>ç¨è´¹ï¼š</span>
                        <span id="taxTotal">Â¥0.00</span>
                    </div>
                    <div class="summary-row" id="chargeItem" style="display: none;">
                        <span>æœåŠ¡è´¹ï¼š</span>
                        <span id="charge">Â¥0.00</span>
                    </div>
                    <div class="summary-row" id="discountItem" style="display: none;">
                        <span>ä¼˜æƒ ï¼š</span>
                        <span id="discount" style="color: #e74c3c;">-Â¥0.00</span>
                    </div>
                    <div class="summary-total">
                        <div class="summary-row">
                            <span>æ€»è®¡ï¼š</span>
                            <span id="total">Â¥0.00</span>
                        </div>
                    </div>
                    <div id="priceLoading" style="display: none; text-align: center; padding: 10px; color: #666; font-size: 0.9rem;">
                        æ­£åœ¨è®¡ç®—ä»·æ ¼...
                    </div>
                    <div id="priceError" style="display: none; text-align: center; padding: 10px; color: #e74c3c; font-size: 0.9rem;">
                    </div>
                </div>
                
                <div class="order-form">
                    <div class="form-group">
                        <label>è®¢å•ç±»å‹ *</label>
                        <select id="orderType" onchange="calculatePrice()">
                            <option value="PICKUP">è‡ªå–</option>
                            <option value="DELIVERY">é…é€</option>
                            <option value="SELF_DINE_IN">å ‚é£Ÿ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ç”¨æˆ·ID *</label>
                        <input type="number" id="userId" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID" value="1" onchange="calculatePrice()">
                    </div>
                    
                    <div class="form-group">
                        <label>æ”¶è´§äººå§“å</label>
                        <input type="text" id="receiverName" placeholder="è¯·è¾“å…¥æ”¶è´§äººå§“å">
                    </div>
                    
                    <div class="form-group">
                        <label>æ”¶è´§äººç”µè¯</label>
                        <input type="text" id="receiverPhone" placeholder="è¯·è¾“å…¥æ”¶è´§äººç”µè¯">
                    </div>
                    
                    <div class="form-group">
                        <label>æ”¶è´§åœ°å€</label>
                        <input type="text" id="receiverAddress" placeholder="è¯·è¾“å…¥æ”¶è´§åœ°å€ï¼ˆåŒ…å«é‚®ç¼–ï¼‰" onblur="calculatePrice()">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                            æç¤ºï¼šå¡«å†™å®Œæ•´åœ°å€ï¼ˆåŒ…å«é‚®ç¼–ï¼‰å¯å‡†ç¡®è®¡ç®—é…é€è´¹
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>æ”¯ä»˜æ–¹å¼ *</label>
                        <select id="paymentMethod">
                            <option value="CREDIT_CARD">ğŸ’³ ä¿¡ç”¨å¡æ”¯ä»˜</option>
                            <option value="ALIPAY">ğŸ’° æ”¯ä»˜å®</option>
                            <option value="WECHAT_PAY">ğŸ’š å¾®ä¿¡æ”¯ä»˜</option>
                            <option value="CASH">ğŸ’µ ç°é‡‘æ”¯ä»˜</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <textarea id="notes" rows="3" placeholder="è®¢å•å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                    
                    <button class="btn-submit" id="submitOrderBtn" onclick="submitOrder()" disabled>æäº¤è®¢å•</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8080/api';
        let selectedMerchant = null;
        let cart = {}; // {itemId: {name, price, quantity}}
        let menuItems = []; // èœå•é¡¹åˆ—è¡¨ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥ä»POSç³»ç»Ÿè·å–ï¼‰
        
        // é¡µé¢åŠ è½½æ—¶è·å–é¤é¦†åˆ—è¡¨
        window.onload = function() {
            loadMerchants();
        };
        
        // åŠ è½½é¤é¦†åˆ—è¡¨
        async function loadMerchants() {
            console.log('loadMerchants called');
            try {
                const response = await fetch(`${API_BASE}/merchants`);
                const result = await response.json();
                console.log('Merchants API response:', result);
                
                if (result.code === 200 && result.data) {
                    const merchantList = document.getElementById('merchantList');
                    if (!merchantList) {
                        console.error('merchantList element not found!');
                        return;
                    }
                    
                    if (result.data.length === 0) {
                        merchantList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— é¤é¦†</div>';
                    } else {
                        console.log('Rendering merchants, count:', result.data.length);
                        merchantList.innerHTML = result.data.map((merchant, index) => {
                            const itemId = `merchant-item-${index}`;
                            return `
                            <div class="merchant-item" id="${itemId}" data-merchant-id="${merchant.merchantId}" 
                                 style="cursor: pointer;">
                                <div class="merchant-name">${merchant.name}</div>
                                <div class="merchant-info">
                                    ${merchant.isPickup ? 'âœ“ æ”¯æŒè‡ªå–' : ''} 
                                    ${merchant.isDelivery ? 'âœ“ æ”¯æŒé…é€' : ''}
                                </div>
                            </div>
                        `;
                        }).join('');
                        
                        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼ˆæ›´å¯é ï¼‰
                        merchantList.addEventListener('click', function(e) {
                            const merchantItem = e.target.closest('.merchant-item');
                            if (merchantItem) {
                                const merchantId = merchantItem.getAttribute('data-merchant-id');
                                const merchantName = merchantItem.querySelector('.merchant-name').textContent;
                                console.log('Event delegation triggered:', merchantId, merchantName);
                                selectMerchant(merchantId, merchantName, merchantItem);
                            }
                        });
                        console.log('Event listener attached to merchantList');
                    }
                } else {
                    showAlert('error', 'åŠ è½½é¤é¦†åˆ—è¡¨å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('loadMerchants error:', error);
                showAlert('error', 'åŠ è½½é¤é¦†åˆ—è¡¨å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // é€‰æ‹©é¤é¦†
        function selectMerchant(merchantId, merchantName, element) {
            console.log('selectMerchant called:', merchantId, merchantName, element);
            
            selectedMerchant = {merchantId, name: merchantName};
            
            // æ›´æ–°UI
            document.querySelectorAll('.merchant-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            if (element) {
                element.classList.add('selected');
            } else {
                // å¦‚æœ element æ²¡æœ‰ä¼ é€’ï¼Œå°è¯•é€šè¿‡ merchantId æ‰¾åˆ°å…ƒç´ 
                const items = document.querySelectorAll('.merchant-item');
                items.forEach(item => {
                    if (item.getAttribute('data-merchant-id') === merchantId) {
                        item.classList.add('selected');
                    }
                });
            }
            
            // æ˜¾ç¤ºèœå•åŒºåŸŸ
            const menuSection = document.getElementById('menuSection');
            if (menuSection) {
                console.log('Removing hidden class from menuSection');
                menuSection.classList.remove('hidden');
                console.log('menuSection classes:', menuSection.className);
                console.log('menuSection display style:', window.getComputedStyle(menuSection).display);
                console.log('menuSection offsetHeight:', menuSection.offsetHeight);
                
                // æ»šåŠ¨åˆ°èœå•åŒºåŸŸ
                setTimeout(() => {
                    menuSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else {
                console.error('menuSection element not found!');
            }
            
            // åŠ è½½èœå•ï¼ˆè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥ä»POSç³»ç»Ÿè·å–ï¼‰
            loadMenu(merchantId);
        }
        
        // åŠ è½½èœå•ï¼ˆä»åç«¯APIè·å–çœŸå®æ•°æ®ï¼‰
        async function loadMenu(merchantId) {
            console.log('loadMenu called for merchantId:', merchantId);
            
            const menuList = document.getElementById('menuList');
            if (!menuList) {
                console.error('menuList element not found!');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            menuList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æ­£åœ¨åŠ è½½èœå•...</div>';
            
            try {
                // ä»åç«¯APIè·å–å•†å“åˆ—è¡¨
                const response = await fetch(`${API_BASE}/store-products/merchant/${merchantId}`);
                const result = await response.json();
                
                if (result.code === 200 && result.data && Array.isArray(result.data)) {
                    // å°†åç«¯è¿”å›çš„å•†å“æ•°æ®è½¬æ¢ä¸ºå‰ç«¯æ ¼å¼
                    // æ³¨æ„ï¼šå°† id è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œé¿å… JavaScript å¤§æ•´æ•°ç²¾åº¦ä¸¢å¤±
                    menuItems = result.data.map(product => {
                        // è·å–ç¬¬ä¸€ä¸ª SKU çš„ IDï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        let defaultSkuId = null;
                        if (product.skus && Array.isArray(product.skus) && product.skus.length > 0) {
                            defaultSkuId = String(product.skus[0].id);
                        }
                        
                        return {
                            itemId: String(product.id), // ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹ï¼Œé¿å…ç²¾åº¦ä¸¢å¤±
                            name: product.productName || 'å•†å“',
                            price: parseFloat(product.unitPrice || 0),
                            description: product.description || '',
                            skuId: defaultSkuId, // ä¿å­˜ç¬¬ä¸€ä¸ª SKU çš„ ID
                            skus: product.skus || [] // ä¿å­˜æ‰€æœ‰ SKU ä¿¡æ¯ï¼ˆç”¨äºåç»­æ‰©å±•ï¼‰
                        };
                    });
                    
                    console.log('ä»åç«¯è·å–åˆ°å•†å“åˆ—è¡¨ï¼Œæ•°é‡:', menuItems.length);
                    
                    if (menuItems.length === 0) {
                        menuList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è¯¥å•†æˆ·æš‚æ— å•†å“</div>';
                        return;
                    }
                    
                    // æ¸²æŸ“èœå•
                    menuList.innerHTML = menuItems.map(item => {
                        // ç”Ÿæˆ SKU é€‰æ‹©å™¨
                        let skuSelector = '';
                        if (item.skus && item.skus.length > 0) {
                            if (item.skus.length === 1) {
                                // åªæœ‰ä¸€ä¸ª SKUï¼Œæ˜¾ç¤º SKU åç§°
                                const sku = item.skus[0];
                                skuSelector = `<div style="margin: 8px 0; font-size: 0.9rem; color: #666;">
                                    <span style="font-weight: bold;">è§„æ ¼ï¼š</span>${sku.skuName || sku.skuCode || 'é»˜è®¤'}
                                    ${sku.skuPrice ? ` (Â¥${parseFloat(sku.skuPrice).toFixed(2)})` : ''}
                                </div>`;
                            } else {
                                // å¤šä¸ª SKUï¼Œæ˜¾ç¤ºä¸‹æ‹‰é€‰æ‹©å™¨
                                const defaultSkuId = String(item.skus[0].id);
                                const skuOptions = item.skus.map((sku, index) => {
                                    const skuPrice = sku.skuPrice ? ` (Â¥${parseFloat(sku.skuPrice).toFixed(2)})` : '';
                                    const selected = index === 0 ? ' selected' : '';
                                    return `<option value="${sku.id}"${selected}>${sku.skuName || sku.skuCode || 'é»˜è®¤'}${skuPrice}</option>`;
                                }).join('');
                                skuSelector = `<div style="margin: 8px 0;">
                                    <label style="display: block; font-size: 0.9rem; color: #666; margin-bottom: 4px;">é€‰æ‹©è§„æ ¼ï¼š</label>
                                    <select id="sku-select-${item.itemId}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;" onchange="updateSkuForItem('${item.itemId}', this.value)">
                                        ${skuOptions}
                                    </select>
                                </div>`;
                            }
                        }
                        
                        return `
                        <div class="menu-item">
                            <div class="menu-item-name">${item.name}</div>
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">${item.description || ''}</div>
                            ${skuSelector}
                            <div class="menu-item-price">Â¥${item.price.toFixed(2)}</div>
                            <div class="menu-item-actions">
                                <div class="quantity-control">
                                    <button class="quantity-btn" onclick="decreaseQuantity('${item.itemId}')">-</button>
                                    <span class="quantity-display" id="qty-${item.itemId}">${getCartQuantityForItem(item.itemId)}</span>
                                    <button class="quantity-btn" onclick="increaseQuantity('${item.itemId}')">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('');
                    
                    console.log('Menu rendered successfully');
                    updateCart();
                } else {
                    console.error('è·å–å•†å“åˆ—è¡¨å¤±è´¥:', result);
                    menuList.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">åŠ è½½èœå•å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (error) {
                console.error('åŠ è½½èœå•å¤±è´¥:', error);
                menuList.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">åŠ è½½èœå•å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        // è·å–å•†å“å½“å‰é€‰ä¸­çš„ SKU ID
        function getSelectedSkuId(itemId) {
            itemId = String(itemId);
            const skuSelect = document.getElementById(`sku-select-${itemId}`);
            if (skuSelect) {
                return String(skuSelect.value);
            }
            // å¦‚æœæ²¡æœ‰é€‰æ‹©å™¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª SKU
            const item = menuItems.find(m => String(m.itemId) === itemId);
            if (item && item.skus && item.skus.length > 0) {
                return String(item.skus[0].id);
            }
            return null;
        }
        
        // æ›´æ–°å•†å“çš„ SKU
        function updateSkuForItem(itemId, skuId) {
            itemId = String(itemId);
            skuId = String(skuId);
            
            // å¦‚æœè´­ç‰©è½¦ä¸­å·²æœ‰è¯¥å•†å“ï¼Œéœ€è¦æ›´æ–° SKU
            const cartKey = getCartKey(itemId, skuId);
            const oldCartKey = Object.keys(cart).find(key => {
                const parts = key.split('|');
                return parts[0] === itemId;
            });
            
            if (oldCartKey && oldCartKey !== cartKey) {
                // å¦‚æœä¹‹å‰æœ‰ä¸åŒ SKU çš„å•†å“ï¼Œéœ€è¦æ›´æ–°
                const oldItem = cart[oldCartKey];
                if (oldItem) {
                    delete cart[oldCartKey];
                    cart[cartKey] = oldItem;
                    cart[cartKey].skuId = skuId;
                    // æ›´æ–° SKU åç§°å’Œä»·æ ¼
                    const item = menuItems.find(m => String(m.itemId) === itemId);
                    if (item && item.skus) {
                        const sku = item.skus.find(s => String(s.id) === skuId);
                        if (sku) {
                            cart[cartKey].skuName = sku.skuName || sku.skuCode || '';
                            cart[cartKey].price = sku.skuPrice ? parseFloat(sku.skuPrice) : cart[cartKey].price;
                        }
                    }
                }
            }
            
            updateCart();
            updateQuantityDisplay(itemId);
        }
        
        // è·å–è´­ç‰©è½¦çš„ keyï¼ˆproductId|skuIdï¼‰
        function getCartKey(itemId, skuId) {
            return `${String(itemId)}|${String(skuId || 'default')}`;
        }
        
        // è·å–å•†å“åœ¨è´­ç‰©è½¦ä¸­çš„æ€»æ•°é‡ï¼ˆæ‰€æœ‰ SKU çš„æ€»å’Œï¼‰
        function getCartQuantityForItem(itemId) {
            itemId = String(itemId);
            let total = 0;
            Object.keys(cart).forEach(key => {
                const parts = key.split('|');
                if (parts[0] === itemId) {
                    total += cart[key].quantity || 0;
                }
            });
            return total;
        }
        
        // å¢åŠ æ•°é‡
        function increaseQuantity(itemId) {
            // ç¡®ä¿ itemId æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œé¿å…ç²¾åº¦ä¸¢å¤±
            itemId = String(itemId);
            console.log('increaseQuantity called with itemId:', itemId, 'type:', typeof itemId);
            
            const item = menuItems.find(m => String(m.itemId) === itemId);
            if (!item) {
                console.error('Item not found for itemId:', itemId, 'available items:', menuItems.map(m => m.itemId));
                return;
            }
            
            // è·å–é€‰ä¸­çš„ SKU ID
            const skuId = getSelectedSkuId(itemId);
            if (!skuId && item.skus && item.skus.length > 0) {
                alert('è¯·å…ˆé€‰æ‹©è§„æ ¼');
                return;
            }
            
            const cartKey = getCartKey(itemId, skuId);
            
            if (!cart[cartKey]) {
                // è·å– SKU ä¿¡æ¯
                let skuName = '';
                let price = item.price;
                
                if (item.skus && item.skus.length > 0) {
                    const sku = item.skus.find(s => String(s.id) === skuId);
                    if (sku) {
                        skuName = sku.skuName || sku.skuCode || '';
                        price = sku.skuPrice ? parseFloat(sku.skuPrice) : price;
                    }
                }
                
                cart[cartKey] = {
                    name: item.name,
                    skuName: skuName,
                    price: price,
                    quantity: 0,
                    skuId: skuId,
                    productId: itemId
                };
            }
            
            cart[cartKey].quantity++;
            console.log('Quantity increased, new quantity:', cart[cartKey].quantity);
            updateCart();
            updateQuantityDisplay(itemId);
        }
        
        // å‡å°‘æ•°é‡
        function decreaseQuantity(itemId) {
            // ç¡®ä¿ itemId æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œé¿å…ç²¾åº¦ä¸¢å¤±
            itemId = String(itemId);
            console.log('decreaseQuantity called with itemId:', itemId);
            
            // æ‰¾åˆ°è¯¥å•†å“åœ¨è´­ç‰©è½¦ä¸­çš„ç¬¬ä¸€ä¸ª SKUï¼ˆé€šå¸¸æ˜¯æœ€æ–°æ·»åŠ çš„ï¼‰
            const cartKey = Object.keys(cart).find(key => {
                const parts = key.split('|');
                return parts[0] === itemId && cart[key].quantity > 0;
            });
            
            if (!cartKey || !cart[cartKey] || cart[cartKey].quantity <= 0) return;
            
            cart[cartKey].quantity--;
            if (cart[cartKey].quantity === 0) {
                delete cart[cartKey];
            }
            
            updateCart();
            updateQuantityDisplay(itemId);
        }
        
        // æ›´æ–°æ•°é‡æ˜¾ç¤º
        function updateQuantityDisplay(itemId) {
            // ç¡®ä¿ itemId æ˜¯å­—ç¬¦ä¸²ç±»å‹
            itemId = String(itemId);
            const qtyDisplay = document.getElementById(`qty-${itemId}`);
            if (qtyDisplay) {
                qtyDisplay.textContent = getCartQuantityForItem(itemId);
            }
        }
        
        // åœ¨è´­ç‰©è½¦ä¸­å¢åŠ æ•°é‡
        function increaseCartItem(cartKey) {
            if (!cart[cartKey]) return;
            cart[cartKey].quantity++;
            updateCart();
            calculatePrice();
        }
        
        // åœ¨è´­ç‰©è½¦ä¸­å‡å°‘æ•°é‡
        function decreaseCartItem(cartKey) {
            if (!cart[cartKey] || cart[cartKey].quantity <= 0) return;
            cart[cartKey].quantity--;
            if (cart[cartKey].quantity === 0) {
                delete cart[cartKey];
            }
            updateCart();
            calculatePrice();
            
            // æ›´æ–°èœå•ä¸­çš„æ•°é‡æ˜¾ç¤º
            if (cart[cartKey]) {
                const parts = cartKey.split('|');
                updateQuantityDisplay(parts[0]);
            } else {
                const parts = cartKey.split('|');
                updateQuantityDisplay(parts[0]);
            }
        }
        
        // æ›´æ–°è´­ç‰©è½¦
        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const cartItemIds = Object.keys(cart).filter(id => cart[id].quantity > 0);
            
            if (cartItemIds.length === 0) {
                cartItems.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è´­ç‰©è½¦ä¸ºç©º</div>';
                document.getElementById('submitOrderBtn').disabled = true;
                // é‡ç½®ä»·æ ¼æ˜¾ç¤º
                document.getElementById('subtotal').textContent = 'Â¥0.00';
                document.getElementById('deliveryFee').textContent = 'Â¥0.00';
                document.getElementById('taxTotal').textContent = 'Â¥0.00';
                document.getElementById('charge').textContent = 'Â¥0.00';
                document.getElementById('discount').textContent = '-Â¥0.00';
                document.getElementById('total').textContent = 'Â¥0.00';
                document.getElementById('taxTotalItem').style.display = 'none';
                document.getElementById('chargeItem').style.display = 'none';
                document.getElementById('discountItem').style.display = 'none';
            } else {
                cartItems.innerHTML = cartItemIds.map(cartKey => {
                    const item = cart[cartKey];
                    const parts = cartKey.split('|');
                    const itemId = parts[0];
                    const skuName = item.skuName ? ` (${item.skuName})` : '';
                    return `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}${skuName}</div>
                                <div class="cart-item-price">Â¥${item.price.toFixed(2)} Ã— ${item.quantity}</div>
                            </div>
                            <div class="cart-item-actions">
                                <button class="quantity-btn" onclick="decreaseCartItem('${cartKey}')">-</button>
                                <span class="quantity-display">${item.quantity}</span>
                                <button class="quantity-btn" onclick="increaseCartItem('${cartKey}')">+</button>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('submitOrderBtn').disabled = false;
                
                // è°ƒç”¨åç«¯è®¡ç®—ä»·æ ¼
                calculatePrice();
            }
        }
        
        // è®¡ç®—ä»·æ ¼ï¼ˆè°ƒç”¨åç«¯æ¥å£ï¼‰
        async function calculatePrice() {
            if (!selectedMerchant) {
                return;
            }
            
            const cartItemIds = Object.keys(cart).filter(id => cart[id].quantity > 0);
            if (cartItemIds.length === 0) {
                return;
            }
            
            const userId = document.getElementById('userId')?.value;
            if (!userId) {
                return; // ç”¨æˆ·IDæœªå¡«å†™ï¼Œä¸è®¡ç®—ä»·æ ¼
            }
            
            const orderType = document.getElementById('orderType')?.value || 'DELIVERY';
            const receiverAddress = document.getElementById('receiverAddress')?.value || '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('priceLoading').style.display = 'block';
            document.getElementById('priceError').style.display = 'none';
            
            try {
                // æ„å»ºè®¢å•é¡¹ï¼ˆåŒ…å« productIdã€skuId å’Œ quantityï¼‰
                // æ³¨æ„ï¼šproductId å’Œ skuId å¿…é¡»ä½œä¸ºå­—ç¬¦ä¸²ä¼ é€’ï¼Œé¿å… JavaScript å¤§æ•´æ•°ç²¾åº¦ä¸¢å¤±
                const orderItems = cartItemIds.map(cartKey => {
                    const item = cart[cartKey];
                    const parts = cartKey.split('|');
                    const productId = parts[0];
                    const skuId = item.skuId || parts[1];
                    
                    // ä¿æŒ productId å’Œ skuId ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œä¸è¦ä½¿ç”¨ parseInt
                    const orderItem = {
                        productId: String(productId), // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²ç±»å‹
                        quantity: item.quantity
                    };
                    
                    // å¦‚æœè´­ç‰©è½¦ä¸­æœ‰ skuIdï¼Œåˆ™æ·»åŠ åˆ°è®¢å•é¡¹ä¸­
                    if (skuId && skuId !== 'default') {
                        orderItem.skuId = String(skuId); // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²ç±»å‹
                    }
                    
                    return orderItem;
                });
                
                // è°ƒç”¨ä»·æ ¼è®¡ç®—æ¥å£
                const response = await fetch(`${API_BASE}/orders/calculate-price`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        merchantId: selectedMerchant.merchantId,
                        userId: userId, // ä¿æŒå­—ç¬¦ä¸²ç±»å‹ï¼Œåç«¯ä¼šè‡ªåŠ¨è½¬æ¢
                        orderType: orderType,
                        orderItems: orderItems,
                        receiverAddress: receiverAddress,
                        zipCode: null, // TODO: ä»åœ°å€ä¸­æå–æˆ–å•ç‹¬è¾“å…¥
                        latitude: null, // TODO: ä»åœ°å€ä¸­è·å–æˆ–ä½¿ç”¨åœ°å›¾API
                        longitude: null, // TODO: ä»åœ°å€ä¸­è·å–æˆ–ä½¿ç”¨åœ°å›¾API
                        couponIds: null, // TODO: æ”¯æŒä¼˜æƒ åˆ¸
                        couponCodes: null,
                        tips: null
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    const price = result.data;
                    
                    // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
                    document.getElementById('subtotal').textContent = `Â¥${parseFloat(price.subtotal || 0).toFixed(2)}`;
                    document.getElementById('deliveryFee').textContent = `Â¥${parseFloat(price.deliveryFee || 0).toFixed(2)}`;
                    document.getElementById('taxTotal').textContent = `Â¥${parseFloat(price.taxTotal || 0).toFixed(2)}`;
                    document.getElementById('charge').textContent = `Â¥${parseFloat(price.charge || 0).toFixed(2)}`;
                    document.getElementById('discount').textContent = `-Â¥${parseFloat(price.discount || 0).toFixed(2)}`;
                    document.getElementById('total').textContent = `Â¥${parseFloat(price.total || 0).toFixed(2)}`;
                    
                    // æ˜¾ç¤º/éšè—ä»·æ ¼é¡¹
                    document.getElementById('taxTotalItem').style.display = parseFloat(price.taxTotal || 0) > 0 ? 'flex' : 'none';
                    document.getElementById('chargeItem').style.display = parseFloat(price.charge || 0) > 0 ? 'flex' : 'none';
                    document.getElementById('discountItem').style.display = parseFloat(price.discount || 0) > 0 ? 'flex' : 'none';
                    
                    console.log('ä»·æ ¼è®¡ç®—æˆåŠŸ:', price);
                } else {
                    throw new Error(result.message || 'ä»·æ ¼è®¡ç®—å¤±è´¥');
                }
            } catch (error) {
                console.error('è®¡ç®—ä»·æ ¼å¤±è´¥:', error);
                document.getElementById('priceError').textContent = 'ä»·æ ¼è®¡ç®—å¤±è´¥: ' + error.message;
                document.getElementById('priceError').style.display = 'block';
                
                    // æ˜¾ç¤ºå‰ç«¯è®¡ç®—çš„é¢„ä¼°ä»·æ ¼ï¼ˆä½œä¸ºåå¤‡ï¼‰
                    let subtotal = 0;
                    cartItemIds.forEach(cartKey => {
                        const item = cart[cartKey];
                        subtotal += item.price * item.quantity;
                    });
                document.getElementById('subtotal').textContent = `Â¥${subtotal.toFixed(2)}`;
                document.getElementById('deliveryFee').textContent = 'Â¥0.00';
                document.getElementById('total').textContent = `Â¥${subtotal.toFixed(2)}`;
            } finally {
                document.getElementById('priceLoading').style.display = 'none';
            }
        }
        
        // æäº¤è®¢å•
        async function submitOrder() {
            if (!selectedMerchant) {
                showAlert('error', 'è¯·å…ˆé€‰æ‹©é¤é¦†');
                return;
            }
            
            const cartItemIds = Object.keys(cart).filter(id => cart[id].quantity > 0);
            if (cartItemIds.length === 0) {
                showAlert('error', 'è´­ç‰©è½¦ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å•†å“');
                return;
            }
            
            const userId = document.getElementById('userId').value;
            if (!userId) {
                showAlert('error', 'è¯·è¾“å…¥ç”¨æˆ·ID');
                return;
            }
            
            const orderType = document.getElementById('orderType').value;
            const notes = document.getElementById('notes').value;
            
            // æ„å»ºè®¢å•é¡¹
            // æ³¨æ„ï¼šproductId å¿…é¡»ä½œä¸ºå­—ç¬¦ä¸²ä¼ é€’ï¼Œé¿å… JavaScript å¤§æ•´æ•°ç²¾åº¦ä¸¢å¤±
            const orderItems = cartItemIds.map((cartKey, index) => {
                const item = cart[cartKey];
                const parts = cartKey.split('|');
                const productId = parts[0];
                const skuId = item.skuId || parts[1];
                
                // ä¿æŒ productId ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œä¸è¦ä½¿ç”¨ parseInt
                const orderItem = {
                    saleItemId: String(productId), // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²ç±»å‹
                    orderItemId: index + 1,
                    quantity: item.quantity,
                    itemName: item.name + (item.skuName ? ` (${item.skuName})` : ''),
                    itemPrice: item.price,
                    itemPriceTotal: item.price * item.quantity,
                    displayPrice: item.price
                };
                
                // å¦‚æœè´­ç‰©è½¦ä¸­æœ‰ skuIdï¼Œåˆ™æ·»åŠ åˆ°è®¢å•é¡¹ä¸­
                if (skuId && skuId !== 'default') {
                    orderItem.skuId = String(skuId); // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²ç±»å‹
                }
                
                return orderItem;
            });
            
            // è®¡ç®—è®¢å•ä»·æ ¼
            const subtotal = cartItemIds.reduce((sum, cartKey) => {
                const item = cart[cartKey];
                return sum + item.price * item.quantity;
            }, 0);
            
            const orderPrice = {
                subtotal: subtotal,
                discount: 0,
                charge: 0,
                deliveryFee: 0,
                taxTotal: 0,
                tips: 0,
                total: subtotal
            };
            
            // æ„å»ºè®¢å•
            const order = {
                merchantId: selectedMerchant.merchantId,
                        userId: userId, // ä¿æŒå­—ç¬¦ä¸²ç±»å‹ï¼Œåç«¯ä¼šè‡ªåŠ¨è½¬æ¢
                orderType: orderType,
                status: 1, // å·²ä¸‹å•
                localStatus: 1, // å·²ä¸‹å•
                orderPrice: JSON.stringify(orderPrice),
                notes: notes
            };
            
            try {
                const response = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        merchantId: selectedMerchant.merchantId,
                        userId: userId, // ä¿æŒå­—ç¬¦ä¸²ç±»å‹ï¼Œåç«¯ä¼šè‡ªåŠ¨è½¬æ¢
                        orderType: orderType,
                        receiverName: document.getElementById('receiverName')?.value || 'æœªå¡«å†™',
                        receiverPhone: document.getElementById('receiverPhone')?.value || 'æœªå¡«å†™',
                        receiverAddress: document.getElementById('receiverAddress')?.value || 'æœªå¡«å†™',
                        remark: notes,
                        orderItems: orderItems.map(item => {
                            const orderItem = {
                                productId: String(item.saleItemId), // ç¡®ä¿ productId æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œé¿å…ç²¾åº¦ä¸¢å¤±
                                productName: item.itemName, // å¯é€‰ï¼Œåç«¯ä¼šä»æ•°æ®åº“æŸ¥è¯¢
                                productImage: null, // å¯é€‰ï¼Œåç«¯ä¼šä»æ•°æ®åº“æŸ¥è¯¢
                                // unitPrice: item.itemPrice, // å·²ç§»é™¤ï¼šä¸ºäº†å®‰å…¨ï¼Œä»·æ ¼ç”±åç«¯ä»æ•°æ®åº“æŸ¥è¯¢
                                quantity: item.quantity
                            };
                            
                            // å¦‚æœè®¢å•é¡¹ä¸­æœ‰ skuIdï¼Œåˆ™æ·»åŠ åˆ°è¯·æ±‚ä¸­
                            if (item.skuId) {
                                orderItem.skuId = String(item.skuId); // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²ç±»å‹
                            }
                            
                            return orderItem;
                        }),
                        paymentMethod: document.getElementById('paymentMethod').value || "CREDIT_CARD", // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ”¯ä»˜æ–¹å¼
                        payOnline: true // åœ¨çº¿æ”¯ä»˜
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // åç«¯è¿”å›çš„æ˜¯ CreateOrderResponseï¼ŒåŒ…å« order å’Œ payment å­—æ®µ
                    const responseData = result.data;
                    const order = responseData.order || responseData; // å…¼å®¹æ–°æ—§æ ¼å¼
                    
                    if (order && order.id) {
                        // ç¡®ä¿orderIdä½œä¸ºå­—ç¬¦ä¸²ä¼ é€’ï¼Œé¿å…JavaScriptå¤§æ•´æ•°ç²¾åº¦ä¸¢å¤±
                        const orderId = String(order.id);
                        const merchantId = order.merchantId || selectedMerchant.merchantId;
                        
                        // æ£€æŸ¥è®¢å•çŠ¶æ€ï¼šå¦‚æœè®¢å•çŠ¶æ€æ˜¯"å·²ä¸‹å•"ï¼ˆstatus=1ï¼‰ï¼Œè¯´æ˜éœ€è¦æ”¯ä»˜
                        const orderStatus = order.status;
                        const needsPayment = orderStatus === 1 || orderStatus === '1';
                        
                        // è·å–ç”¨æˆ·é€‰æ‹©çš„æ”¯ä»˜æ–¹å¼ï¼ˆä»è¡¨å•æˆ–è®¢å•ä¸­è·å–ï¼‰
                        let selectedPaymentMethod = document.getElementById('paymentMethod')?.value;
                        if (!selectedPaymentMethod) {
                            // å¦‚æœè¡¨å•ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»è®¢å•ä¸­è·å–
                            selectedPaymentMethod = order.paymentMethod || 'CREDIT_CARD';
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ”¯ä»˜ä¿¡æ¯
                        const payment = responseData.payment;
                        const clientSecret = responseData.clientSecret;
                        const paymentIntentId = responseData.paymentIntentId;
                        const paymentUrl = responseData.paymentUrl;
                        
                        // å¦‚æœæœ‰æ”¯ä»˜ä¿¡æ¯ï¼Œæˆ–è€…è®¢å•çŠ¶æ€æ˜¯éœ€è¦æ”¯ä»˜ï¼Œè·³è½¬åˆ°æ”¯ä»˜é¡µé¢
                        if (payment || clientSecret || paymentIntentId || paymentUrl || needsPayment) {
                            // åˆ¤æ–­æ”¯ä»˜æ–¹å¼ï¼šä¼˜å…ˆä½¿ç”¨è¿”å›çš„æ”¯ä»˜æ–¹å¼ï¼Œå¦åˆ™ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ”¯ä»˜æ–¹å¼
                            let paymentMethod = payment?.paymentMethod || 
                                                 (clientSecret ? 'CREDIT_CARD' : null) ||
                                                 (paymentIntentId ? 'CREDIT_CARD' : null) ||
                                                 (paymentUrl ? 'ALIPAY' : null) ||
                                                 selectedPaymentMethod; // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ”¯ä»˜æ–¹å¼
                            
                            // ç¡®ä¿æ”¯ä»˜æ–¹å¼æ˜¯å¤§å†™
                            if (paymentMethod) {
                                paymentMethod = paymentMethod.toUpperCase();
                            }
                            
                            console.log('è·³è½¬æ”¯ä»˜é¡µé¢ï¼Œæ”¯ä»˜æ–¹å¼:', paymentMethod, 'è®¢å•ID:', orderId);
                            
                            if (paymentMethod === 'CREDIT_CARD' || paymentMethod === 'CARD' || paymentMethod === 'STRIPE') {
                                // ä¿¡ç”¨å¡æ”¯ä»˜ï¼Œè·³è½¬åˆ°ä¿¡ç”¨å¡æ”¯ä»˜é¡µé¢
                                console.log('è·³è½¬åˆ°ä¿¡ç”¨å¡æ”¯ä»˜é¡µé¢');
                                window.location.href = `credit-card-payment.html?orderId=${orderId}`;
                            } else if (paymentMethod === 'ALIPAY') {
                                // æ”¯ä»˜å®æ”¯ä»˜ï¼Œè·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢
                                console.log('è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢');
                                window.location.href = `payment.html?orderId=${orderId}`;
                            } else {
                                // å…¶ä»–æ”¯ä»˜æ–¹å¼ï¼Œä¹Ÿè·³è½¬åˆ°æ”¯ä»˜é¡µé¢
                                console.log('è·³è½¬åˆ°é»˜è®¤æ”¯ä»˜é¡µé¢');
                                window.location.href = `payment.html?orderId=${orderId}`;
                            }
                        } else {
                            // ä¸éœ€è¦åœ¨çº¿æ”¯ä»˜ï¼ˆè´§åˆ°ä»˜æ¬¾ï¼‰ï¼Œè·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µ
                            window.location.href = `orders.html?merchantId=${merchantId}&orderId=${orderId}`;
                        }
                    } else {
                        showAlert('error', 'è®¢å•åˆ›å»ºæˆåŠŸï¼Œä½†æ— æ³•è·å–è®¢å•ID');
                    }
                } else {
                    showAlert('error', 'è®¢å•åˆ›å»ºå¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showAlert('error', 'è®¢å•åˆ›å»ºå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            alertContainer.innerHTML = `<div class="alert ${alertClass}" style="display: block;">${message}</div>`;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>

