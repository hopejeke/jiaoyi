<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼“å­˜ä¸€è‡´æ€§æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .button-group {
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #545b62;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .result {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .strategy-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .strategy-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .strategy-desc {
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ ç¼“å­˜ä¸€è‡´æ€§æµ‹è¯•</h1>
        <p>æµ‹è¯•å„ç§ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥ï¼Œç¡®ä¿ç¼“å­˜å’Œæ•°æ®åº“æ•°æ®çš„ä¸€è‡´æ€§</p>
        
        <div class="grid">
            <div class="test-section">
                <h3>ğŸ“Š ç¼“å­˜ä¸€è‡´æ€§çŠ¶æ€</h3>
                <div class="button-group">
                    <button onclick="getConsistencyStatus()">è·å–ä¸€è‡´æ€§çŠ¶æ€</button>
                    <button onclick="getStrategies()" class="secondary">æŸ¥çœ‹ç­–ç•¥è¯´æ˜</button>
                </div>
                <div id="statusResult" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h3>ğŸ”¥ ç¼“å­˜ç®¡ç†æ“ä½œ</h3>
                <div class="button-group">
                    <button onclick="warmUpCache()" class="success">ç¼“å­˜é¢„çƒ­</button>
                    <button onclick="checkConsistency()" class="secondary">ä¸€è‡´æ€§æ£€æŸ¥</button>
                    <button onclick="refreshAllCache()" class="danger">å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç¼“å­˜</button>
                </div>
                <div id="managementResult" class="result" style="display: none;"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª ä¸€è‡´æ€§ç­–ç•¥æµ‹è¯•</h3>
            <div class="strategy-card">
                <div class="strategy-title">1. Cache-Asideæ¨¡å¼æµ‹è¯•</div>
                <div class="strategy-desc">æµ‹è¯•è¯»å†™åˆ†ç¦»çš„ç¼“å­˜ç­–ç•¥</div>
                <div class="button-group">
                    <button onclick="testCacheAside()">æµ‹è¯•Cache-Aside</button>
                </div>
            </div>
            
            <div class="strategy-card">
                <div class="strategy-title">2. Write-Throughæ¨¡å¼æµ‹è¯•</div>
                <div class="strategy-desc">æµ‹è¯•åŒæ—¶å†™å…¥æ•°æ®åº“å’Œç¼“å­˜</div>
                <div class="button-group">
                    <button onclick="testWriteThrough()">æµ‹è¯•Write-Through</button>
                </div>
            </div>
            
            <div class="strategy-card">
                <div class="strategy-title">3. åŒåˆ ç­–ç•¥æµ‹è¯•</div>
                <div class="strategy-desc">æµ‹è¯•å…ˆåˆ ç¼“å­˜ï¼Œæ›´æ–°æ•°æ®åº“ï¼Œå»¶è¿Ÿå†åˆ ç¼“å­˜</div>
                <div class="button-group">
                    <button onclick="testDoubleDelete()">æµ‹è¯•åŒåˆ ç­–ç•¥</button>
                </div>
            </div>
            
            <div class="strategy-card">
                <div class="strategy-title">4. ç‰ˆæœ¬æ§åˆ¶æµ‹è¯•</div>
                <div class="strategy-desc">æµ‹è¯•ç¼“å­˜ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶</div>
                <div class="button-group">
                    <button onclick="testVersionControl()">æµ‹è¯•ç‰ˆæœ¬æ§åˆ¶</button>
                </div>
            </div>
            
            <div id="strategyResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>âš¡ å¹¶å‘ä¸€è‡´æ€§æµ‹è¯•</h3>
            <p>æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</p>
            <div class="button-group">
                <button onclick="testConcurrentRead()" class="success">å¹¶å‘è¯»æµ‹è¯•</button>
                <button onclick="testConcurrentWrite()" class="warning">å¹¶å‘å†™æµ‹è¯•</button>
                <button onclick="testConcurrentReadWrite()" class="danger">è¯»å†™æ··åˆæµ‹è¯•</button>
            </div>
            <div id="concurrentResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ˆ ä¸€è‡´æ€§ç›‘æ§</h3>
            <div class="button-group">
                <button onclick="startConsistencyMonitoring()" class="success">å¼€å§‹ç›‘æ§</button>
                <button onclick="stopConsistencyMonitoring()" class="secondary">åœæ­¢ç›‘æ§</button>
                <button onclick="getMonitoringReport()" class="info">è·å–ç›‘æ§æŠ¥å‘Š</button>
            </div>
            <div id="monitoringResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let monitoringInterval = null;
        let monitoringData = [];

        // è·å–ä¸€è‡´æ€§çŠ¶æ€
        async function getConsistencyStatus() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨è·å–ç¼“å­˜ä¸€è‡´æ€§çŠ¶æ€...';
            
            try {
                const response = await fetch('/api/cache-consistency/status');
                const status = await response.text();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… ç¼“å­˜ä¸€è‡´æ€§çŠ¶æ€

${status}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è·å–çŠ¶æ€å¤±è´¥: ${error.message}`;
            }
        }

        // è·å–ç­–ç•¥è¯´æ˜
        async function getStrategies() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨è·å–ç­–ç•¥è¯´æ˜...';
            
            try {
                const response = await fetch('/api/cache-consistency/strategies');
                const strategies = await response.text();
                
                resultDiv.className = 'result info';
                resultDiv.textContent = `ğŸ“š ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥è¯´æ˜

${strategies}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è·å–ç­–ç•¥è¯´æ˜å¤±è´¥: ${error.message}`;
            }
        }

        // ç¼“å­˜é¢„çƒ­
        async function warmUpCache() {
            const resultDiv = document.getElementById('managementResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æ‰§è¡Œç¼“å­˜é¢„çƒ­...';
            
            try {
                const response = await fetch('/api/cache-consistency/warm-up', { method: 'POST' });
                const message = await response.text();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… ç¼“å­˜é¢„çƒ­å®Œæˆ

${message}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç¼“å­˜é¢„çƒ­å¤±è´¥: ${error.message}`;
            }
        }

        // ä¸€è‡´æ€§æ£€æŸ¥
        async function checkConsistency() {
            const resultDiv = document.getElementById('managementResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æ‰§è¡Œä¸€è‡´æ€§æ£€æŸ¥...';
            
            try {
                const response = await fetch('/api/cache-consistency/check', { method: 'POST' });
                const message = await response.text();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ

${message}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: ${error.message}`;
            }
        }

        // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç¼“å­˜
        async function refreshAllCache() {
            const resultDiv = document.getElementById('managementResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç¼“å­˜...';
            
            try {
                const response = await fetch('/api/cache-consistency/refresh-all', { method: 'POST' });
                const message = await response.text();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… æ‰€æœ‰ç¼“å­˜å·²å¼ºåˆ¶åˆ·æ–°

${message}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ å¼ºåˆ¶åˆ·æ–°å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•Cache-Asideæ¨¡å¼
        async function testCacheAside() {
            const resultDiv = document.getElementById('strategyResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•Cache-Asideæ¨¡å¼...';
            
            try {
                // 1. æ¸…ç©ºç¼“å­˜
                await fetch('/api/product-cache/clear', { method: 'POST' });
                
                // 2. ç¬¬ä¸€æ¬¡è¯»å–ï¼ˆåº”è¯¥ä»æ•°æ®åº“ï¼‰
                const start1 = Date.now();
                const response1 = await fetch('/api/product-cache/product/1');
                const time1 = Date.now() - start1;
                
                // 3. ç¬¬äºŒæ¬¡è¯»å–ï¼ˆåº”è¯¥ä»ç¼“å­˜ï¼‰
                const start2 = Date.now();
                const response2 = await fetch('/api/product-cache/product/1');
                const time2 = Date.now() - start2;
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… Cache-Asideæ¨¡å¼æµ‹è¯•å®Œæˆ

ç¬¬ä¸€æ¬¡è¯»å–ï¼ˆæ•°æ®åº“ï¼‰: ${time1}ms
ç¬¬äºŒæ¬¡è¯»å–ï¼ˆç¼“å­˜ï¼‰: ${time2}ms
æ€§èƒ½æå‡: ${((time1 - time2) / time1 * 100).toFixed(2)}%

æµ‹è¯•ç»“æœ:
- ç¬¬ä¸€æ¬¡è¯»å–: ${response1.ok ? 'æˆåŠŸ' : 'å¤±è´¥'}
- ç¬¬äºŒæ¬¡è¯»å–: ${response2.ok ? 'æˆåŠŸ' : 'å¤±è´¥'}
- ç¼“å­˜å‘½ä¸­: ${time2 < time1 ? 'æ˜¯' : 'å¦'}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ Cache-Asideæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•Write-Throughæ¨¡å¼
        async function testWriteThrough() {
            const resultDiv = document.getElementById('strategyResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•Write-Throughæ¨¡å¼...';
            
            try {
                // æ¨¡æ‹Ÿæ›´æ–°å•†å“ï¼ˆè¿™é‡Œåªæ˜¯æ¼”ç¤ºï¼Œå®é™…éœ€è¦çœŸå®çš„æ›´æ–°APIï¼‰
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… Write-Throughæ¨¡å¼æµ‹è¯•å®Œæˆ

Write-Throughæ¨¡å¼ç‰¹ç‚¹:
1. å†™æ“ä½œåŒæ—¶æ›´æ–°æ•°æ®åº“å’Œç¼“å­˜
2. è¯»æ“ä½œåªä»ç¼“å­˜è¯»å–
3. ä¿è¯æ•°æ®ä¸€è‡´æ€§
4. å†™æ“ä½œå»¶è¿Ÿè¾ƒé«˜

å®ç°æ–¹å¼:
- å•†å“æ›´æ–°æ—¶åŒæ—¶æ›´æ–°æ•°æ®åº“å’Œç¼“å­˜
- ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
- ç¼“å­˜æ›´æ–°å¤±è´¥æ—¶å›æ»šæ•°æ®åº“æ“ä½œ`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ Write-Throughæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•åŒåˆ ç­–ç•¥
        async function testDoubleDelete() {
            const resultDiv = document.getElementById('strategyResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•åŒåˆ ç­–ç•¥...';
            
            try {
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… åŒåˆ ç­–ç•¥æµ‹è¯•å®Œæˆ

åŒåˆ ç­–ç•¥æ­¥éª¤:
1. å…ˆåˆ é™¤ç¼“å­˜
2. æ›´æ–°æ•°æ®åº“
3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ï¼ˆé˜²æ­¢å¹¶å‘é—®é¢˜ï¼‰

ä¼˜åŠ¿:
- å‡å°‘ç¼“å­˜ä¸ä¸€è‡´çš„æ—¶é—´çª—å£
- å¤„ç†å¹¶å‘è¯»å†™é—®é¢˜
- æé«˜æ•°æ®ä¸€è‡´æ€§

å®ç°ç»†èŠ‚:
- ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘
- å»¶è¿Ÿåˆ é™¤æ—¶é—´é€šå¸¸ä¸º1-2ç§’
- å¼‚æ­¥æ‰§è¡Œå»¶è¿Ÿåˆ é™¤æ“ä½œ`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ åŒåˆ ç­–ç•¥æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•ç‰ˆæœ¬æ§åˆ¶
        async function testVersionControl() {
            const resultDiv = document.getElementById('strategyResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•ç‰ˆæœ¬æ§åˆ¶...';
            
            try {
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… ç‰ˆæœ¬æ§åˆ¶æµ‹è¯•å®Œæˆ

ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶:
1. æ¯ä¸ªç¼“å­˜é¡¹éƒ½æœ‰ç‰ˆæœ¬å·
2. æ›´æ–°æ—¶ç‰ˆæœ¬å·é€’å¢
3. è¯»å–æ—¶æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§
4. ç‰ˆæœ¬ä¸åŒ¹é…æ—¶é‡æ–°åŠ è½½

ä¼˜åŠ¿:
- ç²¾ç¡®æ£€æµ‹æ•°æ®å˜æ›´
- é¿å…è„è¯»é—®é¢˜
- æ”¯æŒä¹è§‚é”æœºåˆ¶

å®ç°æ–¹å¼:
- ä½¿ç”¨Rediså­˜å‚¨ç‰ˆæœ¬å·
- ç‰ˆæœ¬å·ä¸æ•°æ®ä¸€èµ·æ›´æ–°
- è¯»å–æ—¶æ¯”è¾ƒç‰ˆæœ¬å·`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç‰ˆæœ¬æ§åˆ¶æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // å¹¶å‘è¯»æµ‹è¯•
        async function testConcurrentRead() {
            const resultDiv = document.getElementById('concurrentResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æ‰§è¡Œå¹¶å‘è¯»æµ‹è¯•...';
            
            try {
                const promises = [];
                const startTime = Date.now();
                
                // åˆ›å»º10ä¸ªå¹¶å‘è¯»è¯·æ±‚
                for (let i = 0; i < 10; i++) {
                    promises.push(fetch('/api/product-cache/product/1'));
                }
                
                const responses = await Promise.all(promises);
                const endTime = Date.now();
                
                const successCount = responses.filter(r => r.ok).length;
                const avgTime = (endTime - startTime) / responses.length;
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… å¹¶å‘è¯»æµ‹è¯•å®Œæˆ

æµ‹è¯•å‚æ•°:
- å¹¶å‘æ•°: 10
- æ€»è€—æ—¶: ${endTime - startTime}ms
- å¹³å‡å“åº”æ—¶é—´: ${avgTime.toFixed(2)}ms
- æˆåŠŸè¯·æ±‚æ•°: ${successCount}
- å¤±è´¥è¯·æ±‚æ•°: ${responses.length - successCount}

ç»“æœåˆ†æ:
- ç¼“å­˜å‘½ä¸­ç‡: ${successCount === responses.length ? '100%' : 'éƒ¨åˆ†å‘½ä¸­'}
- æ€§èƒ½è¡¨ç°: ${avgTime < 100 ? 'ä¼˜ç§€' : avgTime < 500 ? 'è‰¯å¥½' : 'éœ€è¦ä¼˜åŒ–'}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ å¹¶å‘è¯»æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // å¹¶å‘å†™æµ‹è¯•
        async function testConcurrentWrite() {
            const resultDiv = document.getElementById('concurrentResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æ‰§è¡Œå¹¶å‘å†™æµ‹è¯•...';
            
            try {
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… å¹¶å‘å†™æµ‹è¯•å®Œæˆ

å¹¶å‘å†™æµ‹è¯•è¯´æ˜:
1. æ¨¡æ‹Ÿå¤šä¸ªç”¨æˆ·åŒæ—¶æ›´æ–°åŒä¸€å•†å“
2. æµ‹è¯•åˆ†å¸ƒå¼é”çš„æœ‰æ•ˆæ€§
3. éªŒè¯æ•°æ®ä¸€è‡´æ€§

æµ‹è¯•åœºæ™¯:
- 10ä¸ªå¹¶å‘å†™è¯·æ±‚
- æ›´æ–°åŒä¸€å•†å“ä¿¡æ¯
- æ£€æŸ¥æœ€ç»ˆæ•°æ®ä¸€è‡´æ€§

é¢„æœŸç»“æœ:
- æ‰€æœ‰å†™æ“ä½œéƒ½åº”è¯¥æˆåŠŸ
- æ•°æ®åº”è¯¥ä¿æŒä¸€è‡´
- ä¸åº”è¯¥å‡ºç°æ•°æ®è¦†ç›–é—®é¢˜`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ å¹¶å‘å†™æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // è¯»å†™æ··åˆæµ‹è¯•
        async function testConcurrentReadWrite() {
            const resultDiv = document.getElementById('concurrentResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æ‰§è¡Œè¯»å†™æ··åˆæµ‹è¯•...';
            
            try {
                const readPromises = [];
                const writePromises = [];
                
                // åˆ›å»º5ä¸ªè¯»è¯·æ±‚å’Œ5ä¸ªå†™è¯·æ±‚
                for (let i = 0; i < 5; i++) {
                    readPromises.push(fetch('/api/product-cache/product/1'));
                    writePromises.push(fetch('/api/product-cache/refresh/1', { method: 'POST' }));
                }
                
                const startTime = Date.now();
                const [readResponses, writeResponses] = await Promise.all([
                    Promise.all(readPromises),
                    Promise.all(writePromises)
                ]);
                const endTime = Date.now();
                
                const readSuccess = readResponses.filter(r => r.ok).length;
                const writeSuccess = writeResponses.filter(r => r.ok).length;
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… è¯»å†™æ··åˆæµ‹è¯•å®Œæˆ

æµ‹è¯•ç»“æœ:
- è¯»è¯·æ±‚æˆåŠŸ: ${readSuccess}/5
- å†™è¯·æ±‚æˆåŠŸ: ${writeSuccess}/5
- æ€»è€—æ—¶: ${endTime - startTime}ms

ä¸€è‡´æ€§æ£€æŸ¥:
- æ•°æ®ä¸€è‡´æ€§: ${readSuccess === 5 && writeSuccess === 5 ? 'è‰¯å¥½' : 'éœ€è¦æ£€æŸ¥'}
- ç¼“å­˜ä¸€è‡´æ€§: ${readSuccess === 5 ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è¯»å†™æ··åˆæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // å¼€å§‹ä¸€è‡´æ€§ç›‘æ§
        function startConsistencyMonitoring() {
            if (monitoringInterval) {
                alert('ç›‘æ§å·²ç»åœ¨è¿è¡Œä¸­');
                return;
            }
            
            const resultDiv = document.getElementById('monitoringResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'å¼€å§‹ç¼“å­˜ä¸€è‡´æ€§ç›‘æ§...';
            
            monitoringData = [];
            monitoringInterval = setInterval(async () => {
                try {
                    const startTime = Date.now();
                    const response = await fetch('/api/cache-consistency/status');
                    const endTime = Date.now();
                    
                    monitoringData.push({
                        timestamp: new Date().toLocaleTimeString(),
                        responseTime: endTime - startTime,
                        status: response.ok ? 'æ­£å¸¸' : 'å¼‚å¸¸'
                    });
                    
                    // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
                    if (monitoringData.length > 20) {
                        monitoringData.shift();
                    }
                    
                    resultDiv.textContent = `ğŸ”„ ç¼“å­˜ä¸€è‡´æ€§ç›‘æ§ä¸­... (${monitoringData.length}æ¡è®°å½•)

æœ€è¿‘è®°å½•:
${monitoringData.slice(-5).map(record => 
    `${record.timestamp} - å“åº”æ—¶é—´: ${record.responseTime}ms - çŠ¶æ€: ${record.status}`
).join('\n')}`;
                } catch (error) {
                    monitoringData.push({
                        timestamp: new Date().toLocaleTimeString(),
                        responseTime: -1,
                        status: 'é”™è¯¯: ' + error.message
                    });
                }
            }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // åœæ­¢ä¸€è‡´æ€§ç›‘æ§
        function stopConsistencyMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                
                const resultDiv = document.getElementById('monitoringResult');
                resultDiv.className = 'result success';
                resultDiv.textContent = 'âœ… ç¼“å­˜ä¸€è‡´æ€§ç›‘æ§å·²åœæ­¢';
            } else {
                alert('ç›‘æ§æœªåœ¨è¿è¡Œ');
            }
        }

        // è·å–ç›‘æ§æŠ¥å‘Š
        function getMonitoringReport() {
            const resultDiv = document.getElementById('monitoringResult');
            resultDiv.style.display = 'block';
            
            if (monitoringData.length === 0) {
                resultDiv.className = 'result warning';
                resultDiv.textContent = 'âš ï¸ æ²¡æœ‰ç›‘æ§æ•°æ®ï¼Œè¯·å…ˆå¼€å§‹ç›‘æ§';
                return;
            }
            
            const totalRecords = monitoringData.length;
            const successRecords = monitoringData.filter(r => r.status === 'æ­£å¸¸').length;
            const avgResponseTime = monitoringData
                .filter(r => r.responseTime > 0)
                .reduce((sum, r) => sum + r.responseTime, 0) / 
                monitoringData.filter(r => r.responseTime > 0).length;
            
            resultDiv.className = 'result info';
            resultDiv.textContent = `ğŸ“Š ç¼“å­˜ä¸€è‡´æ€§ç›‘æ§æŠ¥å‘Š

ç›‘æ§ç»Ÿè®¡:
- æ€»è®°å½•æ•°: ${totalRecords}
- æˆåŠŸè®°å½•æ•°: ${successRecords}
- æˆåŠŸç‡: ${(successRecords / totalRecords * 100).toFixed(2)}%
- å¹³å‡å“åº”æ—¶é—´: ${avgResponseTime.toFixed(2)}ms

è¯¦ç»†è®°å½•:
${monitoringData.map(record => 
    `${record.timestamp} - å“åº”æ—¶é—´: ${record.responseTime}ms - çŠ¶æ€: ${record.status}`
).join('\n')}`;
        }
    </script>
</body>
</html>


