<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿¡ç”¨å¡æ”¯ä»˜</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .order-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
        }
        
        .order-info h3 {
            margin-top: 0;
            color: #333;
        }
        
        .order-info p {
            margin: 8px 0;
            color: #666;
        }
        
        .amount {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
        
        .payment-section {
            margin-top: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        #card-element {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            transition: border-color 0.3s;
        }
        
        #card-element:focus {
            border-color: #007bff;
            outline: none;
        }
        
        #card-errors {
            color: #dc3545;
            font-size: 14px;
            margin-top: 8px;
            min-height: 20px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .test-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0066cc;
        }
        
        .test-info code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 20px;
        }
        
        button:hover:not(:disabled) {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
            text-align: center;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’³ ä¿¡ç”¨å¡æ”¯ä»˜</h1>
        
        <!-- è®¢å•ä¿¡æ¯ -->
        <div class="order-info" id="orderInfo">
            <h3>è®¢å•ä¿¡æ¯</h3>
            <p><strong>è®¢å•ID:</strong> <span id="orderId">-</span></p>
            <p><strong>è®¢å•å·:</strong> <span id="orderNumber">-</span></p>
            <p><strong>æ”¯ä»˜é‡‘é¢:</strong> <span class="amount" id="orderAmount">Â¥0.00</span></p>
        </div>
        
        <!-- æ”¯ä»˜è¡¨å• -->
        <div class="payment-section">
            <div class="test-info">
                <strong>ğŸ’¡ æµ‹è¯•æç¤ºï¼š</strong><br>
                ä½¿ç”¨ Stripe æµ‹è¯•å¡å·ï¼š<code>4242 4242 4242 4242</code><br>
                è¿‡æœŸæ—¥æœŸï¼šä»»æ„æœªæ¥æ—¥æœŸï¼ˆå¦‚ 12/25ï¼‰<br>
                CVCï¼šä»»æ„ 3 ä½æ•°å­—ï¼ˆå¦‚ 123ï¼‰<br>
                ZIP ç ï¼šä»»æ„ 5 ä½æ•°å­—ï¼ˆå¦‚ 12345ï¼‰
            </div>
            
            <form id="payment-form">
                <div class="form-group">
                    <label for="card-element">å¡ç‰‡ä¿¡æ¯</label>
                    <div id="card-element">
                        <!-- Stripe Elements å°†åœ¨è¿™é‡Œåˆ›å»ºå¡ç‰‡è¾“å…¥æ¡† -->
                    </div>
                    <div id="card-errors" role="alert"></div>
                </div>
                
                <div class="form-group">
                    <label for="cardholder-name">æŒå¡äººå§“å</label>
                    <input type="text" id="cardholder-name" placeholder="è¯·è¾“å…¥æŒå¡äººå§“å" value="Test User" required>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="save-card" checked>
                    <label for="save-card">ä¿å­˜æ­¤å¡ç‰‡ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨</label>
                </div>
                
                <button type="submit" id="submit-button">
                    <span id="button-text">æ”¯ä»˜</span>
                </button>
            </form>
        </div>
        
        <!-- æ”¯ä»˜ç»“æœ -->
        <div class="result" id="paymentResult"></div>
    </div>
    
    <script>
        // ä» URL è·å–è®¢å•ä¿¡æ¯
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        
        // Stripe é…ç½®
        let stripe = null;
        let elements = null;
        let cardElement = null;
        
        // å½“å‰è®¢å•ä¿¡æ¯
        let currentOrder = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            if (!orderId) {
                showError('ç¼ºå°‘è®¢å•IDï¼Œè¯·ä»è®¢å•é¡µé¢è·³è½¬');
                return;
            }
            
            // åŠ è½½è®¢å•ä¿¡æ¯
            await loadOrderInfo();
            
            // åˆå§‹åŒ– Stripe
            await initializeStripe();
        });
        
        // åŠ è½½è®¢å•ä¿¡æ¯
        async function loadOrderInfo() {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                const result = await response.json();
                
                if (result.code === 200) {
                    currentOrder = result.data;
                    
                    // è§£æè®¢å•ä»·æ ¼
                    let totalAmount = 0;
                    if (currentOrder.orderPrice) {
                        try {
                            const orderPrice = JSON.parse(currentOrder.orderPrice);
                            totalAmount = orderPrice.total || 0;
                        } catch (e) {
                            console.error('è§£æè®¢å•ä»·æ ¼å¤±è´¥:', e);
                        }
                    }
                    
                    // æ˜¾ç¤ºè®¢å•ä¿¡æ¯
                    document.getElementById('orderId').textContent = currentOrder.id;
                    document.getElementById('orderNumber').textContent = currentOrder.orderNumber || currentOrder.id;
                    document.getElementById('orderAmount').textContent = `Â¥${totalAmount.toFixed(2)}`;
                } else {
                    showError('åŠ è½½è®¢å•ä¿¡æ¯å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showError('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆå§‹åŒ– Stripe
        async function initializeStripe() {
            try {
                // ä»åç«¯è·å– Stripe publishable key
                const response = await fetch('/api/payment/stripe/config');
                let publishableKey = null;
                let enabled = false;
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.code === 200 && result.data) {
                        publishableKey = result.data.publishableKey;
                        enabled = result.data.enabled === 'true' || result.data.enabled === true;
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦å¯ç”¨å’Œæ˜¯å¦æœ‰æœ‰æ•ˆçš„ key
                if (!enabled) {
                    throw new Error('Stripe æ”¯ä»˜æœªå¯ç”¨ï¼Œè¯·åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨');
                }
                
                if (!publishableKey || publishableKey.trim() === '' || publishableKey.includes('...')) {
                    throw new Error('Stripe Publishable Key æœªé…ç½®æˆ–æ— æ•ˆï¼Œè¯·åœ¨ application.properties ä¸­é…ç½® stripe.publishableKey');
                }
                
                console.log('åˆå§‹åŒ– Stripeï¼Œä½¿ç”¨ publishable key:', publishableKey.substring(0, 20) + '...');
                stripe = Stripe(publishableKey);
                elements = stripe.elements();
                
                // åˆ›å»ºå¡ç‰‡å…ƒç´ 
                const style = {
                    base: {
                        fontSize: '16px',
                        color: '#32325d',
                        '::placeholder': {
                            color: '#aab7c4',
                        },
                    },
                    invalid: {
                        color: '#fa755a',
                        iconColor: '#fa755a',
                    },
                };
                
                cardElement = elements.create('card', { style: style });
                cardElement.mount('#card-element');
                
                // ç›‘å¬å¡ç‰‡è¾“å…¥é”™è¯¯
                cardElement.on('change', function(event) {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
                
            } catch (error) {
                console.error('åˆå§‹åŒ– Stripe å¤±è´¥:', error);
                showError('åˆå§‹åŒ–æ”¯ä»˜ç³»ç»Ÿå¤±è´¥: ' + error.message);
            }
        }
        
        // å¤„ç†æ”¯ä»˜è¡¨å•æäº¤
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            
            // ç¦ç”¨æŒ‰é’®
            submitButton.disabled = true;
            buttonText.innerHTML = 'å¤„ç†ä¸­...';
            
            try {
                // 1. åˆ›å»º Payment Method
                const cardholderName = document.getElementById('cardholder-name').value;
                const saveCard = document.getElementById('save-card').checked;
                
                const { paymentMethod, error: createError } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: cardholderName,
                    },
                });
                
                if (createError) {
                    throw new Error(createError.message);
                }
                
                // 2. è§£æè®¢å•ä»·æ ¼
                let totalAmount = 0;
                if (currentOrder && currentOrder.orderPrice) {
                    try {
                        const orderPrice = JSON.parse(currentOrder.orderPrice);
                        totalAmount = orderPrice.total || 0;
                    } catch (e) {
                        console.error('è§£æè®¢å•ä»·æ ¼å¤±è´¥:', e);
                    }
                }
                
                // 3. è°ƒç”¨åç«¯åˆ›å»º Payment Intent
                const paymentData = {
                    paymentMethod: "CREDIT_CARD",
                    amount: totalAmount,
                    paymentInfo: JSON.stringify({
                        cardInfo: {
                            paymentMethodId: paymentMethod.id,
                            saveCard: saveCard
                        }
                    })
                };
                
                showInfo('æ­£åœ¨åˆ›å»ºæ”¯ä»˜...');
                
                const response = await fetch(`/api/orders/${orderId}/pay`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const paymentResponse = result.data;
                    
                    // 4. æ£€æŸ¥æ˜¯å¦æœ‰ clientSecretï¼ˆå¼‚æ­¥æ”¯ä»˜ï¼‰
                    if (paymentResponse.clientSecret) {
                        showInfo('æ­£åœ¨ç¡®è®¤æ”¯ä»˜...');
                        
                        // 5. ç¡®è®¤æ”¯ä»˜
                        const { paymentIntent, error: confirmError } = await stripe.confirmCardPayment(
                            paymentResponse.clientSecret,
                            {
                                payment_method: paymentMethod.id
                            }
                        );
                        
                        if (confirmError) {
                            throw new Error(confirmError.message);
                        }
                        
                        // 6. æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                        if (paymentIntent.status === 'succeeded') {
                            // Stripe æ”¯ä»˜æˆåŠŸï¼Œä½†éœ€è¦ç­‰å¾…åç«¯ Webhook å›è°ƒæ›´æ–°è®¢å•çŠ¶æ€
                            // ä¸è¦ç«‹å³æ˜¾ç¤ºæˆåŠŸï¼Œè€Œæ˜¯å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€
                            showInfo('æ”¯ä»˜å·²ç¡®è®¤ï¼Œç­‰å¾…è®¢å•çŠ¶æ€æ›´æ–°...');
                            
                            // å¦‚æœç”¨æˆ·é€‰æ‹©ä¿å­˜å¡ç‰‡ï¼Œä¿å­˜åˆ°åç«¯
                            if (saveCard) {
                                await saveCardToBackend(paymentMethod.id);
                            }
                            
                            // ç­‰å¾… 2 ç§’åå¼€å§‹è½®è¯¢ï¼ˆç»™ Webhook ä¸€äº›æ—¶é—´ï¼‰
                            setTimeout(() => {
                                startPaymentStatusPolling(orderId);
                            }, 2000);
                        } else {
                            throw new Error('æ”¯ä»˜çŠ¶æ€å¼‚å¸¸: ' + paymentIntent.status);
                        }
                    } else {
                        // åŒæ­¥æ”¯ä»˜ï¼šç­‰å¾… Webhook é€šçŸ¥
                        showInfo('æ”¯ä»˜è¯·æ±‚å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­...');
                        startPaymentStatusPolling(orderId);
                    }
                } else {
                    throw new Error(result.message || 'æ”¯ä»˜å¤±è´¥');
                }
            } catch (error) {
                console.error('æ”¯ä»˜å¤±è´¥:', error);
                showError('æ”¯ä»˜å¤±è´¥: ' + error.message);
                submitButton.disabled = false;
                buttonText.textContent = 'æ”¯ä»˜';
            }
        });
        
        // ä¿å­˜å¡ç‰‡åˆ°åç«¯
        async function saveCardToBackend(paymentMethodId) {
            try {
                const userId = currentOrder?.userId || getUserIdFromSession();
                if (!userId) {
                    console.log('æœªç™»å½•ï¼Œæ— æ³•ä¿å­˜å¡ç‰‡');
                    return;
                }
                
                // æ³¨æ„ï¼šå¦‚æœ wallet æœåŠ¡æœªéƒ¨ç½²ï¼Œæ­¤æ¥å£å¯èƒ½è¿”å› 404ï¼Œä½†ä¸å½±å“æ”¯ä»˜æµç¨‹
                const response = await fetch('/api/wallet/payment-card', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        paymentMethod: 1, // CREDIT_CARD
                        stripePaymentMethodId: paymentMethodId
                    })
                });
                
                if (!response.ok && response.status !== 404) {
                    // 404 è¡¨ç¤ºæ¥å£ä¸å­˜åœ¨ï¼ˆwallet æœåŠ¡æœªéƒ¨ç½²ï¼‰ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œä¸è®°å½•é”™è¯¯
                    console.warn('ä¿å­˜å¡ç‰‡å¤±è´¥:', response.status, response.statusText);
                }
            } catch (error) {
                // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–é”™è¯¯ï¼Œä½†ä¸å½±å“æ”¯ä»˜æµç¨‹
                console.warn('ä¿å­˜å¡ç‰‡å¤±è´¥ï¼ˆä¸å½±å“æ”¯ä»˜ï¼‰:', error.message);
            }
        }
        
        // è·å–ç”¨æˆ·IDï¼ˆä» session æˆ–å…¶ä»–æ–¹å¼ï¼‰
        function getUserIdFromSession() {
            // è¿™é‡Œå¯ä»¥ä» cookieã€localStorage æˆ–å…¶ä»–æ–¹å¼è·å–ç”¨æˆ·ID
            return null;
        }
        
        // å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
        let pollingInterval = null;
        
        function startPaymentStatusPolling(orderId) {
            // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ”¯ä»˜çŠ¶æ€
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/orders/${orderId}`);
                    const result = await response.json();
                    
                    if (result.code === 200) {
                        const order = result.data;
                        // æ£€æŸ¥è®¢å•çŠ¶æ€ï¼š
                        // 2 = å·²æ”¯ä»˜
                        // 3 = åˆ¶ä½œä¸­ï¼ˆè‡ªåŠ¨æ¥å•åï¼‰
                        // 9 = å¾…æ¥å•ï¼ˆéè‡ªåŠ¨æ¥å•ï¼‰
                        // 8 = é…é€ä¸­
                        // 4 = å·²å®Œæˆ
                        // è¿™äº›çŠ¶æ€éƒ½è¡¨ç¤ºæ”¯ä»˜å·²æˆåŠŸ
                        if (order.status === 2 || order.status === 3 || order.status === 9 || 
                            order.status === 8 || order.status === 4) {
                            clearInterval(pollingInterval);
                            showSuccess('æ”¯ä»˜æˆåŠŸï¼è®¢å•å·²å¤„ç†å®Œæˆã€‚');
                            
                            // 3ç§’åè·³è½¬åˆ°è®¢å•è¯¦æƒ…
                            setTimeout(() => {
                                window.location.href = `orders.html?merchantId=${order.merchantId}&orderId=${orderId}`;
                            }, 3000);
                        } else if (order.status === 5) {
                            // è®¢å•å·²å–æ¶ˆ
                            clearInterval(pollingInterval);
                            showError('è®¢å•å·²å–æ¶ˆ');
                        } else if (order.status === 7) {
                            // æ”¯ä»˜å¤±è´¥
                            clearInterval(pollingInterval);
                            showError('æ”¯ä»˜å¤±è´¥');
                        }
                    }
                } catch (error) {
                    console.error('è½®è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error);
                }
            }, 3000);
            
            // 60ç§’ååœæ­¢è½®è¯¢ï¼ˆå¢åŠ è¶…æ—¶æ—¶é—´ï¼Œå› ä¸º Webhook å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
            setTimeout(() => {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    // å¦‚æœè¶…æ—¶åè¿˜æ²¡æœ‰æ£€æµ‹åˆ°æ”¯ä»˜æˆåŠŸï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°
                    const result = document.getElementById('paymentResult');
                    if (result && result.textContent.includes('ç­‰å¾…è®¢å•çŠ¶æ€æ›´æ–°')) {
                        result.className = 'result warning';
                        result.textContent = 'æ”¯ä»˜å¤„ç†ä¸­ï¼Œå¦‚æœé•¿æ—¶é—´æœªæ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–è”ç³»å®¢æœ';
                        result.style.display = 'block';
                    }
                }
            }, 60000);
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const result = document.getElementById('paymentResult');
            result.className = 'result success';
            result.textContent = message;
            result.style.display = 'block';
        }
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const result = document.getElementById('paymentResult');
            result.className = 'result error';
            result.textContent = message;
            result.style.display = 'block';
        }
        
        // æ˜¾ç¤ºä¿¡æ¯æ¶ˆæ¯
        function showInfo(message) {
            const result = document.getElementById('paymentResult');
            result.className = 'result info';
            result.textContent = message;
            result.style.display = 'block';
        }
    </script>
</body>
</html>
