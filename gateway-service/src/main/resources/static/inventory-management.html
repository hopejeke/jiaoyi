<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº“å­˜ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        tbody tr:hover {
            background: #f5f5f5;
        }
        
        .stock-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .stock-low {
            background: #fee;
            color: #c00;
        }
        
        .stock-normal {
            background: #efe;
            color: #060;
        }
        
        .stock-high {
            background: #eef;
            color: #006;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #667eea;
            font-size: 1.5rem;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ åº“å­˜ç®¡ç†</h1>
            <div class="nav-buttons">
                <a href="index.html" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
                <button class="btn btn-success" onclick="refreshInventory()">åˆ·æ–°æ•°æ®</button>
            </div>
        </div>
        
        <!-- ç­›é€‰æ  -->
        <div class="section">
            <h2>ç­›é€‰æ¡ä»¶</h2>
            <div class="filter-bar">
                <div class="filter-group">
                    <label>åº—é“ºID</label>
                    <input type="number" id="filterStoreId" placeholder="è¾“å…¥åº—é“ºID">
                </div>
                <div class="filter-group">
                    <label>å•†å“ID</label>
                    <input type="number" id="filterProductId" placeholder="è¾“å…¥å•†å“ID">
                </div>
                <div class="filter-group">
                    <label>SKU ID</label>
                    <input type="number" id="filterSkuId" placeholder="è¾“å…¥SKU ID">
                </div>
                <div class="filter-group">
                    <label>åº“å­˜çŠ¶æ€</label>
                    <select id="filterStockStatus">
                        <option value="">å…¨éƒ¨</option>
                        <option value="low">åº“å­˜ä¸è¶³</option>
                        <option value="normal">æ­£å¸¸</option>
                        <option value="high">å……è¶³</option>
                    </select>
                </div>
                <div class="filter-group" style="justify-content: flex-end;">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="applyFilters()">æŸ¥è¯¢</button>
                </div>
            </div>
        </div>
        
        <!-- åº“å­˜åˆ—è¡¨ -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>åº“å­˜åˆ—è¡¨</h2>
                <button class="btn btn-success" onclick="queryLowStockItems()">æŸ¥çœ‹åº“å­˜ä¸è¶³å•†å“</button>
            </div>
            <div id="alertContainer"></div>
            <div class="table-container">
                <div id="loadingIndicator" class="loading" style="display: none;">
                    æ­£åœ¨åŠ è½½æ•°æ®...
                </div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <p>æš‚æ— åº“å­˜æ•°æ®</p>
                </div>
                <table id="inventoryTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>åº“å­˜ID</th>
                            <th>åº—é“ºID</th>
                            <th>å•†å“ID</th>
                            <th>SKU ID</th>
                            <th>å•†å“åç§°</th>
                            <th>SKUåç§°</th>
                            <th>å½“å‰åº“å­˜</th>
                            <th>é”å®šåº“å­˜</th>
                            <th>å¯ç”¨åº“å­˜</th>
                            <th>æœ€ä½åº“å­˜</th>
                            <th>æœ€å¤§åº“å­˜</th>
                            <th>åº“å­˜çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘åº“å­˜æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘åº“å­˜</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div id="editModalAlert"></div>
            <form id="editForm" onsubmit="saveInventory(event)">
                <input type="hidden" id="editInventoryId">
                <div class="form-group">
                    <label>å•†å“åç§°</label>
                    <input type="text" id="editProductName" readonly>
                </div>
                <div class="form-group">
                    <label>SKUåç§°</label>
                    <input type="text" id="editSkuName" readonly>
                </div>
                <div class="form-group">
                    <label>å½“å‰åº“å­˜ *</label>
                    <input type="number" id="editCurrentStock" min="0" required>
                </div>
                <div class="form-group">
                    <label>æœ€ä½åº“å­˜é¢„è­¦çº¿</label>
                    <input type="number" id="editMinStock" min="0">
                </div>
                <div class="form-group">
                    <label>æœ€å¤§åº“å­˜å®¹é‡</label>
                    <input type="number" id="editMaxStock" min="0">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/inventory';
        let currentFilters = {};
        
        // é¡µé¢åŠ è½½æ—¶è·å–åº“å­˜åˆ—è¡¨
        window.onload = function() {
            loadInventoryList();
        };
        
        // åŠ è½½åº“å­˜åˆ—è¡¨
        async function loadInventoryList(filters = {}) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const emptyState = document.getElementById('emptyState');
            const inventoryTable = document.getElementById('inventoryTable');
            const inventoryTableBody = document.getElementById('inventoryTableBody');
            
            loadingIndicator.style.display = 'block';
            emptyState.style.display = 'none';
            inventoryTable.style.display = 'none';
            
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const params = new URLSearchParams();
                if (filters.storeId) params.append('storeId', filters.storeId);
                if (filters.productId) params.append('productId', filters.productId);
                if (filters.skuId) params.append('skuId', filters.skuId);
                
                const url = params.toString() ? `${API_BASE}?${params.toString()}` : API_BASE;
                const response = await fetch(url);
                const result = await response.json();
                
                loadingIndicator.style.display = 'none';
                
                if (result.code === 200 && result.data && result.data.length > 0) {
                    inventoryTable.style.display = 'table';
                    renderInventoryTable(result.data);
                } else {
                    emptyState.style.display = 'block';
                }
            } catch (error) {
                loadingIndicator.style.display = 'none';
                showAlert('error', 'åŠ è½½åº“å­˜åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¸²æŸ“åº“å­˜è¡¨æ ¼
        function renderInventoryTable(inventoryList) {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            inventoryList.forEach(inventory => {
                const availableStock = (inventory.currentStock || 0) - (inventory.lockedStock || 0);
                const minStock = inventory.minStock || 0;
                const stockStatus = getStockStatus(availableStock, minStock);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${inventory.id}</td>
                    <td>${inventory.storeId || '-'}</td>
                    <td>${inventory.productId || '-'}</td>
                    <td>${inventory.skuId || '-'}</td>
                    <td>${inventory.productName || '-'}</td>
                    <td>${inventory.skuName || '-'}</td>
                    <td>${inventory.currentStock || 0}</td>
                    <td>${inventory.lockedStock || 0}</td>
                    <td><strong>${availableStock}</strong></td>
                    <td>${minStock}</td>
                    <td>${inventory.maxStock || '-'}</td>
                    <td><span class="stock-status ${stockStatus.class}">${stockStatus.text}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-success" onclick="openEditModal(${inventory.id})">ç¼–è¾‘</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // è·å–åº“å­˜çŠ¶æ€
        function getStockStatus(availableStock, minStock) {
            if (availableStock < minStock) {
                return { class: 'stock-low', text: 'åº“å­˜ä¸è¶³' };
            } else if (availableStock < minStock * 2) {
                return { class: 'stock-normal', text: 'æ­£å¸¸' };
            } else {
                return { class: 'stock-high', text: 'å……è¶³' };
            }
        }
        
        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const filters = {
                storeId: document.getElementById('filterStoreId').value || null,
                productId: document.getElementById('filterProductId').value || null,
                skuId: document.getElementById('filterSkuId').value || null
            };
            
            currentFilters = filters;
            loadInventoryList(filters);
        }
        
        // åˆ·æ–°åº“å­˜åˆ—è¡¨
        function refreshInventory() {
            loadInventoryList(currentFilters);
            showAlert('success', 'åº“å­˜åˆ—è¡¨å·²åˆ·æ–°');
        }
        
        // æŸ¥è¯¢åº“å­˜ä¸è¶³å•†å“
        async function queryLowStockItems() {
            try {
                const response = await fetch(`${API_BASE}/low-stock`);
                const result = await response.json();
                
                if (result.code === 200 && result.data && result.data.length > 0) {
                    renderInventoryTable(result.data);
                    showAlert('success', `æ‰¾åˆ° ${result.data.length} ä¸ªåº“å­˜ä¸è¶³çš„å•†å“`);
                } else {
                    showAlert('success', 'æš‚æ— åº“å­˜ä¸è¶³çš„å•†å“');
                }
            } catch (error) {
                showAlert('error', 'æŸ¥è¯¢åº“å­˜ä¸è¶³å•†å“å¤±è´¥: ' + error.message);
            }
        }
        
        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        async function openEditModal(inventoryId) {
            try {
                // å…ˆæ‰¾åˆ°å¯¹åº”çš„åº“å­˜è®°å½•ï¼ˆä»è¡¨æ ¼ä¸­è·å–ï¼‰
                const rows = document.querySelectorAll('#inventoryTableBody tr');
                let inventory = null;
                
                for (let row of rows) {
                    const id = row.cells[0].textContent;
                    if (id == inventoryId) {
                        inventory = {
                            id: id,
                            productName: row.cells[4].textContent,
                            skuName: row.cells[5].textContent,
                            currentStock: parseInt(row.cells[6].textContent),
                            minStock: parseInt(row.cells[9].textContent),
                            maxStock: row.cells[10].textContent === '-' ? null : parseInt(row.cells[10].textContent)
                        };
                        break;
                    }
                }
                
                if (!inventory) {
                    // å¦‚æœè¡¨æ ¼ä¸­æ²¡æœ‰ï¼Œä»APIè·å–
                    const response = await fetch(`${API_BASE}/${inventoryId}`);
                    const result = await response.json();
                    if (result.code === 200) {
                        inventory = result.data;
                    } else {
                        throw new Error('è·å–åº“å­˜ä¿¡æ¯å¤±è´¥');
                    }
                }
                
                document.getElementById('editInventoryId').value = inventory.id;
                document.getElementById('editProductName').value = inventory.productName || '-';
                document.getElementById('editSkuName').value = inventory.skuName || '-';
                document.getElementById('editCurrentStock').value = inventory.currentStock || 0;
                document.getElementById('editMinStock').value = inventory.minStock || 0;
                document.getElementById('editMaxStock').value = inventory.maxStock || '';
                
                document.getElementById('editModal').style.display = 'block';
            } catch (error) {
                showAlert('error', 'æ‰“å¼€ç¼–è¾‘çª—å£å¤±è´¥: ' + error.message);
            }
        }
        
        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editModalAlert').innerHTML = '';
        }
        
        // ä¿å­˜åº“å­˜
        async function saveInventory(event) {
            event.preventDefault();
            
            const inventoryId = document.getElementById('editInventoryId').value;
            const currentStock = parseInt(document.getElementById('editCurrentStock').value);
            const minStock = parseInt(document.getElementById('editMinStock').value) || null;
            const maxStock = parseInt(document.getElementById('editMaxStock').value) || null;
            
            try {
                const response = await fetch(`${API_BASE}/update/${inventoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentStock: currentStock,
                        minStock: minStock,
                        maxStock: maxStock
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    showAlertInModal('success', 'åº“å­˜æ›´æ–°æˆåŠŸ');
                    setTimeout(() => {
                        closeEditModal();
                        refreshInventory();
                    }, 1000);
                } else {
                    showAlertInModal('error', result.message || 'åº“å­˜æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                showAlertInModal('error', 'åº“å­˜æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 3000);
        }
        
        // åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlertInModal(type, message) {
            const alertContainer = document.getElementById('editModalAlert');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        };
    </script>
</body>
</html>

