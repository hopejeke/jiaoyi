<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Connect é…ç½®ç®¡ç†</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status-card {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .status-card.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-card.warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        .status-card.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .status-card.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .info-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-item .value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .link-button {
            display: inline-block;
            padding: 8px 16px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .link-button:hover {
            background: #218838;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge.success {
            background: #28a745;
            color: white;
        }
        
        .badge.warning {
            background: #ffc107;
            color: #333;
        }
        
        .badge.danger {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Stripe Connect é…ç½®ç®¡ç†</h1>
        
        <!-- Stripe Connect å¯ç”¨æç¤º -->
        <div class="status-card info" style="margin-bottom: 20px;">
            <h3>ğŸ“‹ ä½¿ç”¨å‰å‡†å¤‡</h3>
            <p><strong>é‡è¦ï¼š</strong>åœ¨ä½¿ç”¨ Stripe Connect åŠŸèƒ½ä¹‹å‰ï¼Œéœ€è¦å…ˆåœ¨ Stripe Dashboard ä¸­å¯ç”¨ Connectã€‚</p>
            <p><strong>å¯ç”¨æ­¥éª¤ï¼š</strong></p>
            <ol style="margin-left: 20px; margin-top: 10px;">
                <li>è®¿é—® <a href="https://dashboard.stripe.com/" target="_blank">Stripe Dashboard</a>ï¼ˆç¡®ä¿åœ¨æµ‹è¯•æ¨¡å¼ï¼‰</li>
                <li>è¿›å…¥ <strong>Settings â†’ Connect</strong></li>
                <li>ç‚¹å‡» <strong>"Get started"</strong> æˆ– <strong>"Enable Connect"</strong></li>
                <li>å®Œæˆ Connect æ³¨å†Œæµç¨‹ï¼ˆå¡«å†™åŸºæœ¬ä¿¡æ¯ï¼‰</li>
                <li>å®Œæˆåå³å¯åœ¨æ­¤é¡µé¢åˆ›å»º Connected Account</li>
            </ol>
            <p style="margin-top: 10px;">
                <a href="https://stripe.com/docs/connect" target="_blank" class="link-button">æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£</a>
            </p>
        </div>
        
        <!-- æŸ¥è¯¢å•†æˆ·é…ç½® -->
        <div class="section">
            <h2>æŸ¥è¯¢å•†æˆ·é…ç½®</h2>
            <div class="form-group">
                <label for="merchantId">å•†æˆ·IDï¼š</label>
                <input type="text" id="merchantId" placeholder="ä¾‹å¦‚: merchant_012" value="merchant_012">
            </div>
            <button onclick="queryMerchantConfig()">æŸ¥è¯¢é…ç½®</button>
            <button onclick="queryFeeStatus()">æŸ¥è¯¢æŠ½æˆçŠ¶æ€</button>
            <button onclick="queryBalance()">æŸ¥è¯¢ä½™é¢</button>
        </div>
        
        <!-- é…ç½®ç»“æœæ˜¾ç¤º -->
        <div id="configResult" style="display: none;"></div>
        
        <!-- åˆ›å»º Connected Account -->
        <div class="section">
            <h2>åˆ›å»º Connected Account</h2>
            <div class="form-group">
                <label for="createMerchantId">å•†æˆ·IDï¼š</label>
                <input type="text" id="createMerchantId" placeholder="ä¾‹å¦‚: merchant_012" value="merchant_012">
            </div>
            <div class="form-group">
                <label for="merchantEmail">å•†æˆ·é‚®ç®±ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                <input type="text" id="merchantEmail" placeholder="merchant@example.com">
            </div>
            <div class="form-group">
                <label for="merchantCountry">å›½å®¶ä»£ç ï¼š</label>
                <select id="merchantCountry">
                    <option value="US">US - ç¾å›½</option>
                    <option value="CA">CA - åŠ æ‹¿å¤§</option>
                    <option value="GB">GB - è‹±å›½</option>
                    <option value="AU">AU - æ¾³å¤§åˆ©äºš</option>
                    <option value="HK">HK - ä¸­å›½é¦™æ¸¯</option>
                </select>
            </div>
            <button onclick="createConnectedAccount()">åˆ›å»º Connected Account</button>
        </div>
        
        <!-- ä½¿ç”¨å·²åˆ›å»ºçš„ Account ID -->
        <div class="section">
            <h2>ä½¿ç”¨å·²åˆ›å»ºçš„ Account ID</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                å¦‚æœä½ å·²ç»åœ¨ Stripe Dashboard ä¸­åˆ›å»ºäº† Connected Accountï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Account ID è¿›è¡Œé…ç½®ã€‚
            </p>
            <div class="form-group">
                <label for="existingMerchantId">å•†æˆ·IDï¼š</label>
                <input type="text" id="existingMerchantId" placeholder="ä¾‹å¦‚: merchant_012" value="merchant_012">
            </div>
            <div class="form-group">
                <label for="existingAccountId">Stripe Account IDï¼š</label>
                <input type="text" id="existingAccountId" placeholder="ä¾‹å¦‚: acct_1SdLVMCT67czzSmE">
            </div>
            <button onclick="useExistingAccount()">ä½¿ç”¨æ­¤ Account ID</button>
        </div>
        
        <!-- æ›´æ–°é…ç½® -->
        <div class="section">
            <h2>æ›´æ–°é…ç½®ï¼ˆå¯ç”¨/ç¦ç”¨æŠ½æˆï¼‰</h2>
            <div class="form-group">
                <label for="updateMerchantId">å•†æˆ·IDï¼š</label>
                <input type="text" id="updateMerchantId" placeholder="ä¾‹å¦‚: merchant_012" value="merchant_012">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="enableConnect" checked>
                    å¯ç”¨ Stripe Connectï¼ˆå¯ç”¨åä¼šæŠ½æˆï¼‰
                </label>
            </div>
            <div class="form-group">
                <label for="feePercentage">æ‰‹ç»­è´¹ç‡ï¼ˆ%ï¼‰ï¼š</label>
                <input type="number" id="feePercentage" step="0.01" value="2.5" min="0" max="100">
            </div>
            <div class="form-group">
                <label for="feeFixed">å›ºå®šæ‰‹ç»­è´¹ï¼ˆ$ï¼‰ï¼š</label>
                <input type="number" id="feeFixed" step="0.01" value="0.30" min="0">
            </div>
            <div class="form-group">
                <label for="currency">è´§å¸ï¼š</label>
                <select id="currency">
                    <option value="USD">USD - ç¾å…ƒ</option>
                    <option value="CAD">CAD - åŠ å…ƒ</option>
                    <option value="GBP">GBP - è‹±é•‘</option>
                    <option value="AUD">AUD - æ¾³å…ƒ</option>
                </select>
            </div>
            <button onclick="updateConfig()">æ›´æ–°é…ç½®</button>
        </div>
        
        <!-- å¹³å°ä½™é¢ -->
        <div class="section">
            <h2>å¹³å°è´¦æˆ·ä½™é¢</h2>
            <button onclick="queryPlatformBalance()">æŸ¥è¯¢å¹³å°ä½™é¢</button>
            <div id="platformBalanceResult" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <script>
        // æŸ¥è¯¢å•†æˆ·é…ç½®
        async function queryMerchantConfig() {
            const merchantId = document.getElementById('merchantId').value;
            if (!merchantId) {
                alert('è¯·è¾“å…¥å•†æˆ·ID');
                return;
            }
            
            try {
                const response = await fetch(`/api/merchant/stripe/config/${merchantId}`);
                const result = await response.json();
                
                const resultDiv = document.getElementById('configResult');
                resultDiv.style.display = 'block';
                
                if (result.code === 200) {
                    const config = result.data;
                    resultDiv.innerHTML = `
                        <div class="status-card ${config.enabled ? 'success' : 'warning'}">
                            <h3>å•†æˆ·é…ç½®ä¿¡æ¯</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>å•†æˆ·ID</label>
                                    <div class="value">${config.merchantId || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <label>Connected Account ID</label>
                                    <div class="value">${config.stripeAccountId || 'æœªåˆ›å»º'}</div>
                                </div>
                                <div class="info-item">
                                    <label>æ˜¯å¦å¯ç”¨</label>
                                    <div class="value">
                                        <span class="badge ${config.enabled ? 'success' : 'danger'}">
                                            ${config.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}
                                        </span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <label>è´§å¸</label>
                                    <div class="value">${config.currency || 'USD'}</div>
                                </div>
                                <div class="info-item">
                                    <label>æ‰‹ç»­è´¹ç‡</label>
                                    <div class="value">${config.applicationFeePercentage || 2.5}%</div>
                                </div>
                                <div class="info-item">
                                    <label>å›ºå®šæ‰‹ç»­è´¹</label>
                                    <div class="value">$${config.applicationFeeFixed || 0.30}</div>
                                </div>
                            </div>
                            ${config.stripeAccountId ? `
                                <a href="https://dashboard.stripe.com/test/connect/accounts/${config.stripeAccountId}" 
                                   target="_blank" class="link-button">
                                    æŸ¥çœ‹å•†æˆ·è´¦æˆ· Dashboard
                                </a>
                            ` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status-card error">
                            <p>${result.message || 'æŸ¥è¯¢å¤±è´¥'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                alert('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            }
        }
        
        // æŸ¥è¯¢æŠ½æˆçŠ¶æ€
        async function queryFeeStatus() {
            const merchantId = document.getElementById('merchantId').value;
            if (!merchantId) {
                alert('è¯·è¾“å…¥å•†æˆ·ID');
                return;
            }
            
            try {
                const response = await fetch(`/api/merchant/stripe/fee-status/${merchantId}`);
                const result = await response.json();
                
                const resultDiv = document.getElementById('configResult');
                resultDiv.style.display = 'block';
                
                if (result.code === 200) {
                    const status = result.data;
                    const cardClass = status.enabled ? 'success' : (status.hasConfig ? 'warning' : 'info');
                    
                    resultDiv.innerHTML = `
                        <div class="status-card ${cardClass}">
                            <h3>æŠ½æˆçŠ¶æ€</h3>
                            <p><strong>${status.message}</strong></p>
                            ${status.enabled ? `
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>æ‰‹ç»­è´¹ç‡</label>
                                        <div class="value">${status.feePercentage}%</div>
                                    </div>
                                    <div class="info-item">
                                        <label>å›ºå®šæ‰‹ç»­è´¹</label>
                                        <div class="value">$${status.feeFixed}</div>
                                    </div>
                                    <div class="info-item">
                                        <label>ç¾å›½è¿é€šè´¹ç‡</label>
                                        <div class="value">${status.amexFeePercentage}%</div>
                                    </div>
                                    <div class="info-item">
                                        <label>ç¾å›½è¿é€šå›ºå®š</label>
                                        <div class="value">$${status.amexFeeFixed}</div>
                                    </div>
                                </div>
                                ${status.merchantDashboardUrl ? `
                                    <a href="${status.merchantDashboardUrl}" target="_blank" class="link-button">
                                        æŸ¥çœ‹å•†æˆ·è´¦æˆ·ä½™é¢
                                    </a>
                                ` : ''}
                            ` : `
                                ${status.reason ? `<p>åŸå› ï¼š${status.reason}</p>` : ''}
                            `}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status-card error">
                            <p>${result.message || 'æŸ¥è¯¢å¤±è´¥'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                alert('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            }
        }
        
        // æŸ¥è¯¢å•†æˆ·ä½™é¢
        async function queryBalance() {
            const merchantId = document.getElementById('merchantId').value;
            if (!merchantId) {
                alert('è¯·è¾“å…¥å•†æˆ·ID');
                return;
            }
            
            try {
                const response = await fetch(`/api/merchant/stripe/balance/${merchantId}`);
                const result = await response.json();
                
                const resultDiv = document.getElementById('configResult');
                resultDiv.style.display = 'block';
                
                if (result.code === 200) {
                    const balance = result.data;
                    resultDiv.innerHTML = `
                        <div class="status-card info">
                            <h3>å•†æˆ· Connected Account ä¿¡æ¯</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Account ID</label>
                                    <div class="value">${balance.accountId}</div>
                                </div>
                                <div class="info-item">
                                    <label>è´¦æˆ·ç±»å‹</label>
                                    <div class="value">${balance.accountType}</div>
                                </div>
                                <div class="info-item">
                                    <label>å¯æ”¶æ¬¾</label>
                                    <div class="value">
                                        <span class="badge ${balance.chargesEnabled ? 'success' : 'danger'}">
                                            ${balance.chargesEnabled ? 'æ˜¯' : 'å¦'}
                                        </span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <label>å¯æç°</label>
                                    <div class="value">
                                        <span class="badge ${balance.payoutsEnabled ? 'success' : 'danger'}">
                                            ${balance.payoutsEnabled ? 'æ˜¯' : 'å¦'}
                                        </span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <label>å›½å®¶</label>
                                    <div class="value">${balance.country || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <label>é‚®ç®±</label>
                                    <div class="value">${balance.email || '-'}</div>
                                </div>
                            </div>
                            <p><strong>${balance.message}</strong></p>
                            ${balance.dashboardUrl ? `
                                <a href="${balance.dashboardUrl}" target="_blank" class="link-button">
                                    æŸ¥çœ‹å•†æˆ·è´¦æˆ· Dashboard
                                </a>
                            ` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status-card error">
                            <p>${result.message || 'æŸ¥è¯¢å¤±è´¥'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                alert('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            }
        }
        
        // ä½¿ç”¨å·²åˆ›å»ºçš„ Account ID
        async function useExistingAccount() {
            const merchantId = document.getElementById('existingMerchantId').value;
            const accountId = document.getElementById('existingAccountId').value;
            
            if (!merchantId) {
                alert('è¯·è¾“å…¥å•†æˆ·ID');
                return;
            }
            
            if (!accountId) {
                alert('è¯·è¾“å…¥ Stripe Account ID');
                return;
            }
            
            // éªŒè¯ Account ID æ ¼å¼
            if (!accountId.startsWith('acct_')) {
                alert('Account ID æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”è¯¥ä»¥ acct_ å¼€å¤´');
                return;
            }
            
            try {
                // æ›´æ–°é…ç½®ï¼Œä½¿ç”¨å·²å­˜åœ¨çš„ Account ID
                const config = {
                    stripeAccountId: accountId,
                    enabled: false, // åˆå§‹ä¸ºæœªå¯ç”¨ï¼Œéœ€è¦å®ŒæˆéªŒè¯åæ‰èƒ½å¯ç”¨
                    currency: "USD"
                };
                
                const response = await fetch(`/api/merchant/stripe/config/${merchantId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    alert('é…ç½®æˆåŠŸï¼\n\næ³¨æ„ï¼šè´¦æˆ·éœ€è¦å®ŒæˆéªŒè¯åæ‰èƒ½å¯ç”¨ã€‚\nè¯·åœ¨ Stripe Dashboard ä¸­å®ŒæˆéªŒè¯åï¼Œå†å¯ç”¨æ­¤é…ç½®ã€‚');
                    // åˆ·æ–°é…ç½®æ˜¾ç¤º
                    document.getElementById('merchantId').value = merchantId;
                    queryMerchantConfig();
                } else {
                    alert('é…ç½®å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('é…ç½®å¤±è´¥:', error);
                alert('é…ç½®å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ›å»º Connected Account
        async function createConnectedAccount() {
            const merchantId = document.getElementById('createMerchantId').value;
            const email = document.getElementById('merchantEmail').value;
            const country = document.getElementById('merchantCountry').value;
            
            if (!merchantId) {
                alert('è¯·è¾“å…¥å•†æˆ·ID');
                return;
            }
            
            try {
                let url = `/api/merchant/stripe/create-account/${merchantId}?country=${country}`;
                if (email) {
                    url += `&email=${encodeURIComponent(email)}`;
                }
                
                const response = await fetch(url, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    const data = result.data;
                    alert(`åˆ›å»ºæˆåŠŸï¼\nAccount ID: ${data.accountId}\n\nè¯·è®¿é—® onboardingUrl å®ŒæˆéªŒè¯ï¼š\n${data.onboardingUrl}`);
                    
                    // åœ¨æ–°çª—å£æ‰“å¼€éªŒè¯é“¾æ¥
                    if (data.onboardingUrl) {
                        window.open(data.onboardingUrl, '_blank');
                    }
                } else {
                    // æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    let errorMsg = result.message || 'åˆ›å»ºå¤±è´¥';
                    
                    // å¦‚æœæ˜¯ Stripe Connect æœªå¯ç”¨çš„é”™è¯¯ï¼Œæ˜¾ç¤ºæ›´è¯¦ç»†çš„è¯´æ˜
                    if (errorMsg.includes('signed up for Connect') || errorMsg.includes('Connect åŠŸèƒ½æœªå¯ç”¨')) {
                        errorMsg = 'âŒ Stripe Connect åŠŸèƒ½æœªå¯ç”¨\n\n' +
                            'è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å¯ç”¨ï¼š\n\n' +
                            '1. ç™»å½• Stripe Dashboard:\n   https://dashboard.stripe.com/\n\n' +
                            '2. è¿›å…¥ Settings â†’ Connect\n\n' +
                            '3. ç‚¹å‡» "Get started" æˆ– "Enable Connect"\n\n' +
                            '4. å®Œæˆ Connect æ³¨å†Œæµç¨‹\n\n' +
                            '5. å®Œæˆåé‡æ–°å°è¯•åˆ›å»º Connected Account\n\n' +
                            'è¯¦ç»†æ–‡æ¡£: https://stripe.com/docs/connect';
                    }
                    
                    alert(errorMsg);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }
        
        // æ›´æ–°é…ç½®
        async function updateConfig() {
            const merchantId = document.getElementById('updateMerchantId').value;
            const enabled = document.getElementById('enableConnect').checked;
            const feePercentage = parseFloat(document.getElementById('feePercentage').value);
            const feeFixed = parseFloat(document.getElementById('feeFixed').value);
            const currency = document.getElementById('currency').value;
            
            if (!merchantId) {
                alert('è¯·è¾“å…¥å•†æˆ·ID');
                return;
            }
            
            try {
                const config = {
                    enabled: enabled,
                    applicationFeePercentage: feePercentage,
                    applicationFeeFixed: feeFixed,
                    currency: currency
                };
                
                const response = await fetch(`/api/merchant/stripe/config/${merchantId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    alert('æ›´æ–°æˆåŠŸï¼');
                    // åˆ·æ–°é…ç½®æ˜¾ç¤º
                    document.getElementById('merchantId').value = merchantId;
                    queryMerchantConfig();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }
        
        // æŸ¥è¯¢å¹³å°ä½™é¢
        async function queryPlatformBalance() {
            try {
                const response = await fetch('/api/merchant/stripe/platform/balance');
                const result = await response.json();
                
                const resultDiv = document.getElementById('platformBalanceResult');
                
                if (result.code === 200) {
                    const balance = result.data;
                    resultDiv.innerHTML = `
                        <div class="status-card info">
                            <h3>å¹³å°è´¦æˆ·ä½™é¢ï¼ˆApplication Feeï¼‰</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>å¯ç”¨ä½™é¢</label>
                                    <div class="value">${formatBalance(balance.available)}</div>
                                </div>
                                <div class="info-item">
                                    <label>å¾…ç»“ç®—</label>
                                    <div class="value">${formatBalance(balance.pending)}</div>
                                </div>
                                <div class="info-item">
                                    <label>Connect é¢„ç•™</label>
                                    <div class="value">${formatBalance(balance.connectReserved)}</div>
                                </div>
                                <div class="info-item">
                                    <label>å³æ—¶å¯ç”¨</label>
                                    <div class="value">${formatBalance(balance.instantAvailable)}</div>
                                </div>
                            </div>
                            <p><strong>${balance.message}</strong></p>
                            <a href="${balance.dashboardUrl}" target="_blank" class="link-button">
                                æŸ¥çœ‹å¹³å°è´¦æˆ· Dashboard
                            </a>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status-card error">
                            <p>${result.message || 'æŸ¥è¯¢å¤±è´¥'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                alert('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            }
        }
        
        // æ ¼å¼åŒ–ä½™é¢æ˜¾ç¤º
        function formatBalance(balanceArray) {
            if (!balanceArray || balanceArray.length === 0) {
                return '$0.00';
            }
            
            // Stripe Balance è¿”å›çš„æ˜¯æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å« amount å’Œ currency
            return balanceArray.map(b => {
                const amount = (b.amount / 100).toFixed(2);
                const currency = b.currency ? b.currency.toUpperCase() : 'USD';
                return `${currency} $${amount}`;
            }).join(', ') || '$0.00';
        }
    </script>
</body>
</html>

