<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºè®¢å•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>ğŸ›’ åˆ›å»ºè®¢å•</h1>
    
    <div class="form-group">
        <h2>1. åˆ›å»ºè®¢å•</h2>
        <form id="orderForm">
            <div class="form-group">
                <label for="userId">ç”¨æˆ·ID:</label>
                <input type="number" id="userId" value="94" required>
            </div>
            
            <div class="form-group">
                <label for="receiverName">æ”¶è´§äººå§“å:</label>
                <input type="text" id="receiverName" value="å¼ ä¸‰" required>
            </div>
            
            <div class="form-group">
                <label for="receiverPhone">æ”¶è´§äººç”µè¯:</label>
                <input type="tel" id="receiverPhone" value="13800138000" required>
            </div>
            
            <div class="form-group">
                <label for="receiverAddress">æ”¶è´§åœ°å€:</label>
                <textarea id="receiverAddress" rows="3" required>åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“</textarea>
            </div>
            
            <div class="form-group">
                <label for="remark">å¤‡æ³¨:</label>
                <input type="text" id="remark" value="è¯·å°½å¿«å‘è´§">
            </div>
            
            <div class="form-group">
                <label for="productId">å•†å“ID:</label>
                <input type="number" id="productId" value="2002" required>
            </div>
            
            <div class="form-group">
                <label for="productName">å•†å“åç§°:</label>
                <input type="text" id="productName" value="è´¨æœ´çš„é’¢é‹å­" required>
            </div>
            
            <div class="form-group">
                <label for="unitPrice">å•ä»·:</label>
                <input type="number" id="unitPrice" value="600" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="quantity">æ•°é‡:</label>
                <input type="number" id="quantity" value="10" required>
            </div>
            
            <!-- ä¼˜æƒ åˆ¸éƒ¨åˆ† -->
            <div class="form-group">
                <label for="couponCode">ä¼˜æƒ åˆ¸ä»£ç :</label>
                <input type="text" id="couponCode" placeholder="è¯·è¾“å…¥ä¼˜æƒ åˆ¸ä»£ç ï¼ˆå¯é€‰ï¼‰" value="DISCOUNT10">
            </div>
            
            <div id="couponResult" class="result" style="display: none;">
                <h4>ä¼˜æƒ åˆ¸éªŒè¯ç»“æœ</h4>
                <div id="couponInfo"></div>
            </div>
            
            <button type="submit">åˆ›å»ºè®¢å•</button>
        </form>
    </div>
    
    <div id="orderResult" class="result" style="display: none;">
        <h3>è®¢å•åˆ›å»ºç»“æœ</h3>
        <div id="orderInfo"></div>
        <div style="margin-top: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ”¯ä»˜æ–¹å¼ï¼š</label>
            <select id="paymentMethodSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                <option value="CREDIT_CARD">ğŸ’³ ä¿¡ç”¨å¡æ”¯ä»˜</option>
                <option value="ALIPAY">ğŸ’° æ”¯ä»˜å®</option>
                <option value="WECHAT_PAY">ğŸ’š å¾®ä¿¡æ”¯ä»˜</option>
            </select>
        </div>
        <button onclick="payOrder()" id="payButton" style="display: none;">æ”¯ä»˜è®¢å•</button>
    </div>
    
    <div id="paymentResult" class="result" style="display: none;">
        <h3>æ”¯ä»˜ç»“æœ</h3>
        <div id="paymentInfo"></div>
    </div>
    
    <!-- æ”¯ä»˜æˆåŠŸå¯¹è¯æ¡† -->
    <div id="paymentSuccessModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ğŸ‰ æ”¯ä»˜æˆåŠŸï¼</h3>
            </div>
            <div style="padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 20px;">âœ…</div>
                <p style="font-size: 18px; margin-bottom: 20px; color: #28a745;">
                    è®¢å•æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·²å¤„ç†å®Œæˆï¼
                </p>
                <p style="color: #666; margin-bottom: 30px;">
                    è®¢å•å·ï¼š<span id="successOrderNo"></span>
                </p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="goToOrderDetail()">
                        ğŸ“‹ æŸ¥çœ‹è®¢å•è¯¦æƒ…
                    </button>
                    <button class="btn btn-success" onclick="goToMyOrders()">
                        ğŸ“¦ æˆ‘çš„è®¢å•
                    </button>
                    <button class="btn btn-secondary" onclick="goToOrderList()">
                        ğŸ“Š è®¢å•ç®¡ç†
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        ğŸ”„ ç»§ç»­è´­ç‰©
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentOrder = null;
        
        // é¡µé¢åŠ è½½æ—¶è§£æURLå‚æ•°å¹¶å¡«å……è¡¨å•
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // å¦‚æœURLä¸­æœ‰orderIdï¼Œè¯´æ˜æ˜¯æ”¯ä»˜å·²æœ‰è®¢å•ï¼Œç›´æ¥åŠ è½½è®¢å•ä¿¡æ¯
            if (urlParams.has('orderId')) {
                const orderId = urlParams.get('orderId');
                await loadOrderForPayment(orderId);
                return;
            }
            
            // å¦‚æœURLä¸­æœ‰å•†å“å‚æ•°ï¼Œè‡ªåŠ¨å¡«å……è¡¨å•
            if (urlParams.has('productId')) {
                document.getElementById('productId').value = urlParams.get('productId');
            }
            if (urlParams.has('productName')) {
                document.getElementById('productName').value = urlParams.get('productName');
            }
            if (urlParams.has('unitPrice')) {
                document.getElementById('unitPrice').value = urlParams.get('unitPrice');
            }
            if (urlParams.has('quantity')) {
                document.getElementById('quantity').value = urlParams.get('quantity');
            }
            
            // å¦‚æœæœ‰å•†å“ä¿¡æ¯ï¼Œæ˜¾ç¤ºå•†å“é¢„è§ˆ
            if (urlParams.has('productName') && urlParams.has('unitPrice')) {
                showProductPreview(urlParams);
            }
        });
        
        // åŠ è½½å·²æœ‰è®¢å•ç”¨äºæ”¯ä»˜
        async function loadOrderForPayment(orderId) {
            try {
                // éšè—åˆ›å»ºè®¢å•è¡¨å•ï¼Œæ˜¾ç¤ºåŠ è½½æç¤º
                document.getElementById('orderForm').style.display = 'none';
                document.getElementById('orderResult').style.display = 'block';
                document.getElementById('orderInfo').innerHTML = '<p>æ­£åœ¨åŠ è½½è®¢å•ä¿¡æ¯...</p>';
                
                // è·å–è®¢å•ä¿¡æ¯
                const response = await fetch(`/api/orders/${orderId}`);
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    const order = result.data;
                    currentOrder = order;
                    
                    // æ£€æŸ¥è®¢å•çš„æ”¯ä»˜æ–¹å¼ï¼Œå¦‚æœæ˜¯ä¿¡ç”¨å¡æ”¯ä»˜ï¼Œè·³è½¬åˆ°ä¿¡ç”¨å¡æ”¯ä»˜é¡µé¢
                    const orderPaymentMethod = order.paymentMethod;
                    if (orderPaymentMethod === 'CREDIT_CARD' || orderPaymentMethod === 'CARD' || orderPaymentMethod === 'STRIPE') {
                        // è·³è½¬åˆ°ä¿¡ç”¨å¡æ”¯ä»˜é¡µé¢
                        window.location.href = `credit-card-payment.html?orderId=${orderId}`;
                        return;
                    }
                    
                    // æ˜¾ç¤ºè®¢å•ä¿¡æ¯å¹¶æ˜¾ç¤ºæ”¯ä»˜æŒ‰é’®
                    showOrderResult(order);
                    
                    // è®¾ç½®æ”¯ä»˜æ–¹å¼é€‰æ‹©å™¨çš„é»˜è®¤å€¼ï¼ˆæ ¹æ®è®¢å•çš„æ”¯ä»˜æ–¹å¼ï¼‰
                    const paymentMethodSelect = document.getElementById('paymentMethodSelect');
                    if (paymentMethodSelect) {
                        // å¦‚æœè®¢å•æ˜¯ä¿¡ç”¨å¡æ”¯ä»˜ï¼Œç›´æ¥è·³è½¬
                        if (orderPaymentMethod === 'CREDIT_CARD' || orderPaymentMethod === 'CARD' || orderPaymentMethod === 'STRIPE') {
                            console.log('è®¢å•æ”¯ä»˜æ–¹å¼ä¸ºä¿¡ç”¨å¡ï¼Œè·³è½¬åˆ°ä¿¡ç”¨å¡æ”¯ä»˜é¡µé¢');
                            window.location.href = `credit-card-payment.html?orderId=${orderId}`;
                            return;
                        }
                        // å¦åˆ™è®¾ç½®é€‰æ‹©å™¨çš„å€¼ä¸ºè®¢å•çš„æ”¯ä»˜æ–¹å¼
                        paymentMethodSelect.value = orderPaymentMethod || 'ALIPAY';
                    }
                    
                    // è‡ªåŠ¨æ˜¾ç¤ºæ”¯ä»˜æŒ‰é’®åŒºåŸŸ
                    document.getElementById('payButton').style.display = 'inline-block';
                } else {
                    showError('åŠ è½½è®¢å•å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showError('åŠ è½½è®¢å•å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºå•†å“é¢„è§ˆ
        function showProductPreview(params) {
            const productName = params.get('productName');
            const unitPrice = params.get('unitPrice');
            const quantity = params.get('quantity') || '1';
            
            const previewHtml = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                    <h3 style="margin-top: 0; color: #333;">ğŸ“¦ å•†å“ä¿¡æ¯</h3>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${productName}</div>
                            <div style="color: #666; font-size: 14px;">å•ä»·: Â¥${unitPrice}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #e74c3c;">Â¥${(parseFloat(unitPrice) * parseInt(quantity)).toFixed(2)}</div>
                            <div style="color: #666; font-size: 14px;">æ•°é‡: ${quantity} ä»¶</div>
                        </div>
                    </div>
                </div>
            `;
            
            // åœ¨è¡¨å•å‰æ’å…¥å•†å“é¢„è§ˆ
            const form = document.getElementById('orderForm');
            form.insertAdjacentHTML('beforebegin', previewHtml);
        }
        
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const couponCode = document.getElementById('couponCode').value.trim();
            
            const orderData = {
                userId: document.getElementById('userId').value, // ä¿æŒå­—ç¬¦ä¸²ç±»å‹ï¼Œåç«¯ä¼šè‡ªåŠ¨è½¬æ¢
                receiverName: document.getElementById('receiverName').value,
                receiverPhone: document.getElementById('receiverPhone').value,
                receiverAddress: document.getElementById('receiverAddress').value,
                remark: document.getElementById('remark').value,
                couponCode: couponCode || null,
                orderItems: [
                    {
                        productId: document.getElementById('productId').value, // ä¿æŒå­—ç¬¦ä¸²ç±»å‹ï¼Œé¿å…ç²¾åº¦ä¸¢å¤±
                        productName: document.getElementById('productName').value,
                        productImage: "https://example.com/shoe.jpg",
                        unitPrice: parseFloat(document.getElementById('unitPrice').value),
                        quantity: parseInt(document.getElementById('quantity').value)
                    }
                ]
            };
            
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    // åç«¯è¿”å›çš„æ˜¯ CreateOrderResponseï¼ŒåŒ…å« order å­—æ®µ
                    const order = result.data.order || result.data; // å…¼å®¹æ–°æ—§æ ¼å¼
                    currentOrder = order;
                    showOrderResult(order);
                } else {
                    showError('è®¢å•åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showError('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        });
        
        function showOrderResult(order) {
            console.log('showOrderResult called with order:', order);
            currentOrder = order; // è®¾ç½®å½“å‰è®¢å•
            
            const orderResult = document.getElementById('orderResult');
            let orderInfo = document.getElementById('orderInfo');
            let payButton = document.getElementById('payButton');
            
            console.log('orderInfo element:', orderInfo);
            console.log('payButton element:', payButton);
            
            // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º
            if (!orderInfo || !payButton) {
                orderResult.innerHTML = `
                    <h3>è®¢å•åˆ›å»ºç»“æœ</h3>
                    <div id="orderInfo"></div>
                    <button onclick="payOrder()" id="payButton" style="display: none;">æ”¯ä»˜è®¢å•</button>
                `;
                orderInfo = document.getElementById('orderInfo');
                payButton = document.getElementById('payButton');
                console.log('Recreated elements - orderInfo:', orderInfo, 'payButton:', payButton);
            }
            
            // è§£æè®¢å•ä»·æ ¼ï¼ˆä» orderPrice JSON ä¸­ï¼‰
            let totalAmount = 0;
            let subtotal = 0;
            let discount = 0;
            if (order.orderPrice) {
                try {
                    const orderPrice = typeof order.orderPrice === 'string' 
                        ? JSON.parse(order.orderPrice) 
                        : order.orderPrice;
                    totalAmount = orderPrice.total || 0;
                    subtotal = orderPrice.subtotal || 0;
                    discount = orderPrice.discount || 0;
                } catch (e) {
                    console.error('è§£æè®¢å•ä»·æ ¼å¤±è´¥:', e);
                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–å­—æ®µ
                    totalAmount = order.totalAmount || order.actualAmount || 0;
                }
            } else {
                totalAmount = order.totalAmount || order.actualAmount || 0;
            }
            
            // è§£æå®¢æˆ·ä¿¡æ¯ï¼ˆä» customerInfo JSON ä¸­ï¼‰
            let receiverName = order.receiverName;
            let receiverPhone = order.receiverPhone;
            let receiverAddress = order.receiverAddress;
            if (order.customerInfo) {
                try {
                    const customerInfo = typeof order.customerInfo === 'string' 
                        ? JSON.parse(order.customerInfo) 
                        : order.customerInfo;
                    receiverName = receiverName || customerInfo.name;
                    receiverPhone = receiverPhone || customerInfo.phone;
                    receiverAddress = receiverAddress || customerInfo.address;
                } catch (e) {
                    console.error('è§£æå®¢æˆ·ä¿¡æ¯å¤±è´¥:', e);
                }
            }
            
            // æ„å»ºä¼˜æƒ åˆ¸ä¿¡æ¯æ˜¾ç¤º
            let couponInfo = '';
            if (order.couponCode) {
                couponInfo = `
                    <p><strong>ä¼˜æƒ åˆ¸ä»£ç :</strong> ${order.couponCode}</p>
                    <p><strong>ä¼˜æƒ é‡‘é¢:</strong> ${discount}å…ƒ</p>
                    <p><strong>å®é™…æ”¯ä»˜:</strong> ${totalAmount}å…ƒ</p>
                `;
            }
            
            orderInfo.innerHTML = `
                <p><strong>è®¢å•ID:</strong> ${order.id}</p>
                <p><strong>è®¢å•å·:</strong> ${order.orderNumber || order.orderNo || order.id}</p>
                <p><strong>å°è®¡:</strong> ${subtotal}å…ƒ</p>
                ${discount > 0 ? `<p><strong>ä¼˜æƒ :</strong> -${discount}å…ƒ</p>` : ''}
                <p><strong>æ€»é‡‘é¢:</strong> ${totalAmount}å…ƒ</p>
                ${couponInfo}
                <p><strong>çŠ¶æ€:</strong> ${getOrderStatusText(order.status)}</p>
                <p><strong>æ”¶è´§äºº:</strong> ${receiverName || 'æœªå¡«å†™'}</p>
                <p><strong>æ”¶è´§ç”µè¯:</strong> ${receiverPhone || 'æœªå¡«å†™'}</p>
                <p><strong>æ”¶è´§åœ°å€:</strong> ${receiverAddress || 'æœªå¡«å†™'}</p>
            `;
            
            orderResult.style.display = 'block';
            orderResult.className = 'result success';
            payButton.style.display = 'inline-block';
        }
        
        function getOrderStatusText(status) {
            const statusMap = {
                1: 'å·²ä¸‹å•',
                2: 'å·²æ”¯ä»˜',
                3: 'åˆ¶ä½œä¸­',
                4: 'å·²å®Œæˆ',
                5: 'å·²å–æ¶ˆ',
                6: 'å·²é€€æ¬¾',
                7: 'æ”¯ä»˜å¤±è´¥',
                8: 'é…é€ä¸­',
                9: 'å¾…æ¥å•'
            };
            return statusMap[status] || status || 'æœªçŸ¥';
        }
        
        // é˜²æŠ–æ ‡å¿—
        let isProcessing = false;
        
        async function payOrder() {
            if (!currentOrder) {
                showError('è¯·å…ˆåˆ›å»ºè®¢å•');
                return;
            }
            
            // é˜²é‡å¤æäº¤
            if (isProcessing) {
                alert('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤');
                return;
            }
            
            isProcessing = true;
            
            // è§£æè®¢å•ä»·æ ¼
            let totalAmount = 0;
            if (currentOrder.orderPrice) {
                try {
                    const orderPrice = typeof currentOrder.orderPrice === 'string' 
                        ? JSON.parse(currentOrder.orderPrice) 
                        : currentOrder.orderPrice;
                    totalAmount = orderPrice.total || 0;
                } catch (e) {
                    console.error('è§£æè®¢å•ä»·æ ¼å¤±è´¥:', e);
                    totalAmount = currentOrder.totalAmount || currentOrder.actualAmount || 0;
                }
            } else {
                totalAmount = currentOrder.totalAmount || currentOrder.actualAmount || 0;
            }
            
            // è·å–ç”¨æˆ·é€‰æ‹©çš„æ”¯ä»˜æ–¹å¼ï¼ˆå¦‚æœæœ‰é€‰æ‹©å™¨ï¼‰æˆ–ä½¿ç”¨è®¢å•çš„æ”¯ä»˜æ–¹å¼
            let paymentMethod = "ALIPAY";
            const paymentMethodSelect = document.getElementById('paymentMethodSelect');
            if (paymentMethodSelect) {
                paymentMethod = paymentMethodSelect.value || currentOrder.paymentMethod || "ALIPAY";
            } else {
                paymentMethod = currentOrder.paymentMethod || "ALIPAY";
            }
            
            // å¦‚æœæ˜¯ä¿¡ç”¨å¡æ”¯ä»˜ï¼Œè·³è½¬åˆ°ä¿¡ç”¨å¡æ”¯ä»˜é¡µé¢
            if (paymentMethod === 'CREDIT_CARD' || paymentMethod === 'CARD' || paymentMethod === 'STRIPE') {
                console.log('ç”¨æˆ·é€‰æ‹©ä¿¡ç”¨å¡æ”¯ä»˜ï¼Œè·³è½¬åˆ°ä¿¡ç”¨å¡æ”¯ä»˜é¡µé¢');
                window.location.href = `credit-card-payment.html?orderId=${currentOrder.id}`;
                return;
            }
            
            const paymentData = {
                paymentMethod: paymentMethod,
                amount: totalAmount,
                channel: "WEB",
                clientIp: "192.168.1.100",
                userAgent: navigator.userAgent,
                remark: (paymentMethod === 'CREDIT_CARD' ? 'ä¿¡ç”¨å¡æ”¯ä»˜' : paymentMethod === 'WECHAT_PAY' ? 'å¾®ä¿¡æ”¯ä»˜' : 'æ”¯ä»˜å®æ”¯ä»˜') + (currentOrder.couponCode ? ` (ä½¿ç”¨ä¼˜æƒ åˆ¸: ${currentOrder.couponCode})` : "")
            };
            
            try {
                const response = await fetch(`/api/payment/pay/${currentOrder.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    showPaymentResult(result.data);
                } else {
                    showError('æ”¯ä»˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showError('æ”¯ä»˜è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                // é‡ç½®é˜²æŠ–æ ‡å¿—
                isProcessing = false;
            }
        }
        
        function showPaymentResult(payment) {
            const paymentResult = document.getElementById('paymentResult');
            const paymentInfo = document.getElementById('paymentInfo');
            
            if (payment.payUrl) {
                // æ˜¾ç¤ºæ”¯ä»˜å®äºŒç»´ç æ”¯ä»˜
                paymentInfo.innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 15px;">æ”¯ä»˜ä¿¡æ¯</h3>
                        <p><strong>æ”¯ä»˜æµæ°´å·:</strong> ${payment.paymentNo}</p>
                        <p><strong>æ”¯ä»˜æ–¹å¼:</strong> ${payment.paymentMethod}</p>
                        <p><strong>æ”¯ä»˜é‡‘é¢:</strong> Â¥${payment.amount.toFixed(2)}</p>
                        <p><strong>æ”¯ä»˜çŠ¶æ€:</strong> <span style="color: ${payment.status === 'PENDING' ? '#ff9500' : payment.status === 'SUCCESS' ? '#28a745' : '#dc3545'}">${getStatusText(payment.status)}</span></p>
                        <p><strong>å¤‡æ³¨:</strong> ${payment.remark}</p>
                    </div>
                    <div style="text-align: center; margin: 20px 0;">
                        <h3 style="color: #333; margin-bottom: 20px;">è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</h3>
                        <div style="display: flex; justify-content: center; gap: 30px; align-items: center; flex-wrap: wrap;">
                            <div>
                                <div id="qrcode" style="margin: 0 auto; width: 200px; height: 200px; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white;">
                                    <div style="text-align: center; color: #666;">
                                        <div style="font-size: 14px; margin-bottom: 10px;">æ­£åœ¨ç”ŸæˆäºŒç»´ç ...</div>
                                        <div style="font-size: 12px;">è¯·ç¨å€™</div>
                                    </div>
                                </div>
                                <p style="margin-top: 10px; color: #666; font-size: 14px;">ä½¿ç”¨æ”¯ä»˜å®æ‰«æä¸Šæ–¹äºŒç»´ç </p>
                            </div>
                            <div style="text-align: left;">
                                <h4 style="color: #333; margin-bottom: 15px;">æ”¯ä»˜æ­¥éª¤ï¼š</h4>
                                <ol style="color: #666; line-height: 1.8; padding-left: 20px;">
                                    <li>æ‰“å¼€æ”¯ä»˜å®APP</li>
                                    <li>ç‚¹å‡»"æ‰«ä¸€æ‰«"</li>
                                    <li>æ‰«æä¸Šæ–¹äºŒç»´ç </li>
                                    <li>ç¡®è®¤æ”¯ä»˜é‡‘é¢</li>
                                    <li>å®Œæˆæ”¯ä»˜</li>
                                </ol>
                                <div style="margin-top: 20px;">
                                    <button onclick="checkPaymentStatus('${currentOrder.orderNumber || currentOrder.orderNo || currentOrder.id}')" 
                                            style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                        æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                                    </button>
                                    <button onclick="simulatePaymentSuccess('${currentOrder.orderNumber || currentOrder.orderNo || currentOrder.id}', '${payment.paymentNo}', '${payment.amount}')" 
                                            style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-left: 10px;">
                                        æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
                                    </button>
                                    <button onclick="simulatePaymentFail('${currentOrder.orderNumber || currentOrder.orderNo || currentOrder.id}', '${payment.paymentNo}', '${payment.amount}')" 
                                            style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-left: 10px;">
                                        æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ç”ŸæˆäºŒç»´ç 
                generateQRCode(payment.payUrl);
                
                // å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
                startPaymentStatusPolling(currentOrder.orderNumber || currentOrder.orderNo || currentOrder.id);
                
            } else {
                // æ²¡æœ‰æ”¯ä»˜é“¾æ¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                paymentInfo.innerHTML = `
                    <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <h3 style="color: #721c24; margin-bottom: 15px;">æ”¯ä»˜å¤±è´¥</h3>
                        <p style="color: #721c24;">æ— æ³•ç”Ÿæˆæ”¯ä»˜é“¾æ¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ</p>
                    </div>
                `;
            }
            
            paymentResult.style.display = 'block';
            paymentResult.className = 'result success';
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'PENDING': return 'å¾…æ”¯ä»˜';
                case 'SUCCESS': return 'æ”¯ä»˜æˆåŠŸ';
                case 'FAILED': return 'æ”¯ä»˜å¤±è´¥';
                default: return status;
            }
        }
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode(url) {
            // ä½¿ç”¨åœ¨çº¿äºŒç»´ç ç”ŸæˆæœåŠ¡
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            const qrCodeImg = document.createElement('img');
            qrCodeImg.src = qrCodeUrl;
            qrCodeImg.style.width = '200px';
            qrCodeImg.style.height = '200px';
            qrCodeImg.style.borderRadius = '8px';
            qrCodeImg.onerror = function() {
                // å¦‚æœåœ¨çº¿æœåŠ¡å¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
                document.getElementById('qrcode').innerHTML = `
                    <div style="text-align: center; color: #666;">
                        <div style="font-size: 14px; margin-bottom: 10px;">äºŒç»´ç ç”Ÿæˆå¤±è´¥</div>
                        <div style="font-size: 12px;">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€æ”¯ä»˜é¡µé¢</div>
                    </div>
                `;
            };
            document.getElementById('qrcode').innerHTML = '';
            document.getElementById('qrcode').appendChild(qrCodeImg);
        }
        
        // æ‰“å¼€æ”¯ä»˜å®æ”¯ä»˜é¡µé¢
        function openAlipayUrl(url) {
            window.open(url, '_blank');
        }
        
        // æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
        async function checkPaymentStatus(orderNo) {
            try {
                if (!currentOrder || !currentOrder.id) {
                    alert('âŒ æ— æ³•è·å–è®¢å•ä¿¡æ¯');
                    return;
                }
                
                // æŸ¥è¯¢è®¢å•çŠ¶æ€
                const response = await fetch(`/api/orders/${currentOrder.id}`);
                const result = await response.json();
                
                if (result.code === 200) {
                    const order = result.data;
                    // è®¢å•çŠ¶æ€ï¼š2 = å·²æ”¯ä»˜
                    if (order.status === 2) {
                        showPaymentSuccessDialog();
                    } else if (order.status === 5) {
                        alert('âŒ è®¢å•å·²å–æ¶ˆã€‚');
                    } else {
                        alert('â³ æ”¯ä»˜å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
                    }
                } else {
                    alert('âŒ æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸå¯¹è¯æ¡†
        function showPaymentSuccessDialog() {
            if (currentOrder) {
                document.getElementById('successOrderNo').textContent = currentOrder.orderNumber || currentOrder.orderNo || currentOrder.id;
                document.getElementById('paymentSuccessModal').style.display = 'block';
            } else {
                alert('âœ… æ”¯ä»˜æˆåŠŸï¼è®¢å•å·²å¤„ç†å®Œæˆã€‚');
                location.reload();
            }
        }
        
        // å…³é—­æ”¯ä»˜æˆåŠŸå¯¹è¯æ¡†
        function closePaymentSuccessModal() {
            document.getElementById('paymentSuccessModal').style.display = 'none';
            // é»˜è®¤è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µ
            goToOrderDetail();
        }
        
        // è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µ
        function goToOrderDetail() {
            if (currentOrder) {
                // ç¡®ä¿orderIdä½œä¸ºå­—ç¬¦ä¸²ä¼ é€’ï¼Œé¿å…JavaScriptå¤§æ•´æ•°ç²¾åº¦ä¸¢å¤±
                const orderIdStr = String(currentOrder.id);
                window.location.href = `order-detail.html?orderId=${orderIdStr}`;
            } else {
                window.location.href = 'order-detail.html';
            }
        }
        
        // è·³è½¬åˆ°æˆ‘çš„è®¢å•é¡µ
        function goToMyOrders() {
            if (currentOrder) {
                window.location.href = `my-orders.html?userId=${currentOrder.userId}`;
            } else {
                window.location.href = 'my-orders.html';
            }
        }
        
        // è·³è½¬åˆ°è®¢å•ç®¡ç†é¡µ
        function goToOrderList() {
            window.location.href = 'order-list.html';
        }
        
        // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
        async function simulatePaymentSuccess(orderNo, paymentNo, amount) {
            console.log('æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸå›è°ƒ:', { orderNo, paymentNo, amount });
            try {
                const response = await fetch('/api/payment/alipay/notify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        out_trade_no: orderNo,
                        trade_status: 'TRADE_SUCCESS',
                        total_amount: amount,
                        trade_no: 'MOCK_ALIPAY_TRADE_NO_' + Date.now()
                    }).toString()
                });
                const text = await response.text();
                if (text === 'success') {
                    showPaymentSuccessDialog();
                } else {
                    alert('âŒ æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸå›è°ƒå¤„ç†å¤±è´¥ï¼');
                }
            } catch (error) {
                console.error('æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸå›è°ƒè¯·æ±‚å¤±è´¥:', error);
                alert('âŒ æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸå›è°ƒè¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥
        async function simulatePaymentFail(orderNo, paymentNo, amount) {
            console.log('æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥å›è°ƒ:', { orderNo, paymentNo, amount });
            try {
                const response = await fetch('/api/payment/alipay/notify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        out_trade_no: orderNo,
                        trade_status: 'TRADE_CLOSED',
                        total_amount: amount,
                        trade_no: 'MOCK_ALIPAY_TRADE_NO_FAILED_' + Date.now()
                    }).toString()
                });
                const text = await response.text();
                if (text === 'success') {
                    alert('âœ… æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥å›è°ƒå·²å‘é€ï¼');
                    location.reload();
                } else {
                    alert('âŒ æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥å›è°ƒå¤„ç†å¤±è´¥ï¼');
                }
            } catch (error) {
                console.error('æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥å›è°ƒè¯·æ±‚å¤±è´¥:', error);
                alert('âŒ æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥å›è°ƒè¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
        let pollingInterval = null;
        
        function startPaymentStatusPolling(orderNo) {
            // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ”¯ä»˜çŠ¶æ€ï¼ˆé€šè¿‡è®¢å•IDæŸ¥è¯¢è®¢å•çŠ¶æ€ï¼‰
            pollingInterval = setInterval(async () => {
                try {
                    if (!currentOrder || !currentOrder.id) {
                        clearInterval(pollingInterval);
                        return;
                    }
                    
                    // æŸ¥è¯¢è®¢å•çŠ¶æ€
                    const response = await fetch(`/api/orders/${currentOrder.id}`);
                    const result = await response.json();
                    
                    if (result.code === 200) {
                        const order = result.data;
                        // è®¢å•çŠ¶æ€ï¼š2 = å·²æ”¯ä»˜
                        if (order.status === 2) {
                            clearInterval(pollingInterval);
                            showPaymentSuccessDialog();
                        } else if (order.status === 5) {
                            // è®¢å•å·²å–æ¶ˆ
                            clearInterval(pollingInterval);
                            alert('âŒ è®¢å•å·²å–æ¶ˆã€‚');
                        }
                    }
                } catch (error) {
                    console.error('è½®è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error);
                }
            }, 5000);
            
            // 30ç§’ååœæ­¢è½®è¯¢
            setTimeout(() => {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
            }, 30000);
        }
        
        
        function showError(message) {
            const result = document.getElementById('orderResult');
            const orderInfo = document.getElementById('orderInfo');
            const payButton = document.getElementById('payButton');
            
            // åªæ›´æ–°å†…å®¹ï¼Œä¸åˆ é™¤å­å…ƒç´ 
            if (orderInfo) {
                orderInfo.innerHTML = `<p style="color: #721c24;">${message}</p>`;
            } else {
                result.innerHTML = `
                    <h3>é”™è¯¯</h3>
                    <div id="orderInfo"><p style="color: #721c24;">${message}</p></div>
                    <button onclick="payOrder()" id="payButton" style="display: none;">æ”¯ä»˜è®¢å•</button>
                `;
            }
            
            // éšè—æ”¯ä»˜æŒ‰é’®
            if (payButton) {
                payButton.style.display = 'none';
            }
            
            result.style.display = 'block';
            result.className = 'result error';
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('æ”¯ä»˜é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }, function(err) {
                console.error('å¤åˆ¶å¤±è´¥: ', err);
                // å¤‡ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('æ”¯ä»˜é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const paymentSuccessModal = document.getElementById('paymentSuccessModal');
            if (event.target === paymentSuccessModal) {
                closePaymentSuccessModal();
            }
        }
    </script>
</body>
</html>