# 🕐 订单30分钟超时自动取消功能

## ✨ 功能概述

实现了订单创建后30分钟未支付自动取消的功能，包括：
- 定时任务检查超时订单
- 自动解锁库存
- 自动退还优惠券
- 分布式锁防止重复处理

## 🔧 技术实现

### 1. 依赖配置
- **Spring Boot Quartz**: 定时任务支持
- **Spring Async**: 异步处理
- **Redisson**: 分布式锁

### 2. 核心组件

#### OrderTimeoutService
- `@Scheduled(fixedRate = 60000)`: 每分钟检查一次超时订单
- `processTimeoutOrder()`: 处理单个超时订单
- `cancelTimeoutOrder()`: 取消订单并释放资源

#### OrderMapper
- `selectTimeoutOrders()`: 查询30分钟前创建的待支付订单

#### OrderTimeoutController
- 提供手动测试接口
- 支持手动取消订单
- 支持手动触发超时检查

## 🚀 使用方法

### 1. 自动超时取消
- 订单创建后，系统自动开始30分钟倒计时
- 每分钟检查一次是否有超时订单
- 超时订单自动取消，释放库存和优惠券

### 2. 测试页面
访问 `http://localhost:8080/order-timeout-test.html` 进行测试：

#### 创建测试订单
1. 填写订单信息
2. 点击"创建测试订单"
3. 订单创建成功，开始30分钟倒计时

#### 订单操作
- **支付订单**: 模拟支付，避免超时取消
- **手动取消**: 立即取消订单
- **刷新列表**: 查看最新订单状态

#### 超时检查
- **自动检查**: 系统每分钟自动检查
- **手动触发**: 点击"手动触发超时检查"

## 📊 测试步骤

### 1. 正常流程测试
1. 创建订单 → 等待30分钟 → 订单自动取消
2. 创建订单 → 立即支付 → 订单不会取消

### 2. 手动测试
1. 创建订单 → 点击"手动取消订单" → 立即取消
2. 创建订单 → 点击"手动触发超时检查" → 立即检查

### 3. 批量测试
1. 创建多个订单
2. 等待30分钟
3. 查看所有超时订单是否被正确取消

## 🔍 监控和日志

### 关键日志
```
订单创建完成，订单ID: 123, 订单号: ORD123456789
订单将在30分钟后自动取消（如果未支付），订单ID: 123, 订单号: ORD123456789

开始检查超时订单
发现 2 个超时订单，开始处理
订单超时取消成功，订单ID: 123, 订单号: ORD123456789
```

### 数据库变化
- 订单状态: `PENDING` → `CANCELLED`
- 库存: 解锁已锁定的库存
- 优惠券: 退还已使用的优惠券

## ⚙️ 配置说明

### 超时时间配置
在 `OrderTimeoutService.java` 中修改：
```java
LocalDateTime timeoutThreshold = LocalDateTime.now().minusMinutes(30); // 30分钟
```

### 检查频率配置
在 `OrderTimeoutService.java` 中修改：
```java
@Scheduled(fixedRate = 60000) // 每60秒检查一次
```

## 🛡️ 安全机制

### 1. 分布式锁
- 使用Redisson分布式锁防止重复处理
- 锁超时时间: 30秒
- 等待时间: 3秒

### 2. 状态检查
- 处理前重新查询订单状态
- 确保订单仍然是待支付状态
- 避免处理已支付或已取消的订单

### 3. 异常处理
- 完整的异常捕获和日志记录
- 确保锁能够正确释放
- 事务回滚保证数据一致性

## 📈 性能优化

### 1. 异步处理
- 使用 `@Async` 异步处理超时订单
- 避免阻塞定时任务线程

### 2. 批量处理
- 一次查询所有超时订单
- 批量处理提高效率

### 3. 索引优化
- 建议在 `orders` 表上创建复合索引：
```sql
CREATE INDEX idx_orders_status_createtime ON orders(status, create_time);
```

## 🎯 业务价值

- ✅ 自动释放超时订单占用的库存
- ✅ 提高库存周转率
- ✅ 改善用户体验
- ✅ 减少人工干预
- ✅ 保证数据一致性

现在你的订单系统具备了完整的超时自动取消功能！🎉
