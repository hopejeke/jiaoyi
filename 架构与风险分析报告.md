# ç”µå•†äº¤æ˜“ç³»ç»Ÿæ¶æ„ä¸é£é™©åˆ†ææŠ¥å‘Š

> ç”Ÿæˆæ—¶é—´ï¼š2026-01-28
> åˆ†æèŒƒå›´ï¼šå®Œæ•´ä»£ç ä»“åº“æ‰«æï¼ˆ259ä¸ªJavaæ–‡ä»¶ï¼‰

---

## ğŸ“Š ä¸€ã€æ¨¡å—è¾¹ç•Œå’ŒèŒè´£

```
ç”µå•†äº¤æ˜“ç³»ç»Ÿ (å¤šæ¨¡å—å¾®æœåŠ¡æ¶æ„)
â”œâ”€â”€ common/                     # é€šç”¨ç»„ä»¶åº“
â”‚   â””â”€â”€ å…¨å±€å¼‚å¸¸ã€APIå“åº”ã€é˜²é‡å¤æäº¤AOP
â”‚
â”œâ”€â”€ outbox-starter/             # Outbox Patternæ¡†æ¶ï¼ˆç‹¬ç«‹åº“ï¼‰
â”‚   â””â”€â”€ æ¶ˆæ¯å¯é æŠ•é€’ï¼ˆæ”¯æŒMQ+HTTPï¼‰
â”‚
â”œâ”€â”€ product-service/            # å•†å“æœåŠ¡
â”‚   â””â”€â”€ åº“å­˜ç®¡ç†ï¼ˆé”å®š/æ‰£å‡ï¼‰+ å•†å“ä¿¡æ¯ + åˆ†ç‰‡ç­–ç•¥
â”‚
â”œâ”€â”€ order-service/              # è®¢å•æœåŠ¡ â˜…æ ¸å¿ƒâ˜…
â”‚   â””â”€â”€ è®¢å•å…¨ç”Ÿå‘½å‘¨æœŸ + æ”¯ä»˜å¤„ç† + é…é€é›†æˆ + é€€æ¬¾ç®¡ç†
â”‚
â”œâ”€â”€ coupon-service/             # ä¼˜æƒ åˆ¸æœåŠ¡
â”‚   â””â”€â”€ ä¼˜æƒ åˆ¸å‘æ”¾/ä½¿ç”¨/æŠ˜æ‰£è®¡ç®—
â”‚
â””â”€â”€ gateway-service/            # APIç½‘å…³
    â””â”€â”€ è·¯ç”±ç®¡ç†
```

### æ ¸å¿ƒèŒè´£è¾¹ç•Œ

| æ¨¡å— | æ ¸å¿ƒèŒè´£ | å…³é”®è¾¹ç•Œ |
|-----|--------|--------|
| **Order Service** | è®¢å•å…¨ç”Ÿå‘½å‘¨æœŸ | é€šè¿‡RPCè°ƒç”¨Product/Couponï¼Œè‡ªå·±å¤„ç†æ”¯ä»˜ã€é…é€ã€é€€æ¬¾ |
| **Product Service** | å•†å“+åº“å­˜ | åº“å­˜æ“ä½œéœ€æ”¯æŒä¹è§‚é”ï¼Œæä¾›æ‰¹é‡æ“ä½œæ¥å£ |
| **Coupon Service** | ä¼˜æƒ åˆ¸å‘æ”¾ä½¿ç”¨ | éœ€æ”¯æŒéªŒè¯ã€è®¡ç®—æŠ˜æ‰£ã€æ¶ˆè´¹è·Ÿè¸ª |
| **Outbox Starter** | æ¶ˆæ¯å¯é æŠ•é€’ | æ¡†æ¶å±‚ï¼Œæ”¯æŒMQ+HTTPä¸¤ç§æŠ•é€’æ–¹å¼ |

---

## ğŸ”— äºŒã€å…³é”®é“¾è·¯åˆ†æ

### 2.1 ä¸‹å•é“¾è·¯ï¼šä»ç”¨æˆ·ä¸‹å•åˆ°è®¢å•åˆ›å»º

**å…¥å£ç‚¹ï¼š**
- æ–‡ä»¶è·¯å¾„: `order-service/src/main/java/com/jiaoyi/order/controller/OrderController.java:68`
- æ–¹æ³•: `createOrder(CreateOrderRequest)`

**å®Œæ•´æµç¨‹é“¾è·¯ï¼š**

```
OrderController.createOrder()
  â†“ @PreventDuplicateSubmission (é˜²é‡å¤æäº¤)
  â†“ buildOrderFromRequest() â†’ æ„å»ºOrderå¯¹è±¡ (status=1 å¾…æ”¯ä»˜)
  â†“ buildOrderItemsFromRequest() â†’ ä»ProductServiceæŸ¥è¯¢çœŸå®ä»·æ ¼
  â†“
OrderService.createOrder() (è¡Œ356, @Transactional)
  â”œâ”€ 1ï¸âƒ£ è·å–ç”¨æˆ·çº§åˆ†å¸ƒå¼é” (é˜²å¹¶å‘ä¸‹å•)
  â”‚   â””â”€ RLock userLock = redissonClient.getLock("order:create:user:"+userId)
  â”œâ”€ 2ï¸âƒ£ è·å–è®¢å•å†…å®¹çº§é” (é˜²é‡å¤æäº¤ç›¸åŒè®¢å•)
  â”‚   â””â”€ åŸºäº merchantId+userId+orderItemså“ˆå¸Œç”Ÿæˆkey
  â”œâ”€ 3ï¸âƒ£ é«˜å³°æ‹’å•æ£€æŸ¥ (peakHourRejectionService)
  â”œâ”€ 4ï¸âƒ£ åº“å­˜é”å®š (SKUçº§åˆ«ï¼Œå¹‚ç­‰)
  â”‚   â””â”€ ProductServiceClient.lockStockBatch(productIds, skuIds, quantities)
  â”œâ”€ 5ï¸âƒ£ è®¡ç®—è®¢å•æ€»é‡‘é¢ (calculateOrderSubtotal)
  â”œâ”€ 6ï¸âƒ£ å¤„ç†ä¼˜æƒ åˆ¸
  â”‚   â”œâ”€ éªŒè¯ä¼˜æƒ åˆ¸æœ‰æ•ˆæ€§ (couponServiceClient.validateCoupon)
  â”‚   â”œâ”€ è®¡ç®—ä¼˜æƒ é‡‘é¢ (couponServiceClient.calculateDiscountAmount)
  â”‚   â””â”€ ä¿å­˜è®¢å•ä¼˜æƒ åˆ¸å…³è” (orderCouponMapper.batchInsert)
  â”œâ”€ 7ï¸âƒ£ ä¿å­˜è®¢å•åˆ°æ•°æ®åº“ (orderMapper.insert)
  â”œâ”€ 8ï¸âƒ£ æ‰¹é‡ä¿å­˜è®¢å•é¡¹ (orderItemMapper.insertBatch)
  â”œâ”€ 9ï¸âƒ£ è°ƒç”¨ä¼˜æƒ åˆ¸æœåŠ¡ä½¿ç”¨ä¼˜æƒ åˆ¸ (couponServiceClient.useCoupon)
  â””â”€ ğŸ”Ÿ å‘é€è®¢å•è¶…æ—¶æ¶ˆæ¯ï¼ˆ30åˆ†é’Ÿåè‡ªåŠ¨å–æ¶ˆï¼‰
      â””â”€ OrderTimeoutMessageService.sendOrderTimeoutMessage()
  â†“
PaymentService.processPayment() (è¡Œ104)
  â”œâ”€ è·å–åˆ†å¸ƒå¼é”ï¼ˆé˜²å¹¶å‘åˆ›å»ºæ”¯ä»˜è®°å½•ï¼‰
  â”œâ”€ åŒé‡æ£€æŸ¥ï¼šæ˜¯å¦å·²æœ‰å¾…æ”¯ä»˜è®°å½•
  â”œâ”€ åˆ›å»ºPaymentè®°å½• (paymentMapper.insert)
  â””â”€ è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°
      â”œâ”€ ALIPAY â†’ AlipayService
      â”œâ”€ WECHAT_PAY â†’ (å¾…å¼€å‘)
      â”œâ”€ STRIPE â†’ StripeService.createPaymentIntent
      â””â”€ CASH â†’ ç›´æ¥æ›´æ–°è®¢å•çŠ¶æ€ä¸ºPAID
```

**å…³é”®æ•°æ®åº“æ“ä½œæ–‡ä»¶ï¼š**
- OrderMapper: `order-service/src/main/java/com/jiaoyi/order/mapper/OrderMapper.java`
- OrderItemMapper: `order-service/src/main/java/com/jiaoyi/order/mapper/OrderItemMapper.java`
- PaymentMapper: `order-service/src/main/java/com/jiaoyi/order/mapper/PaymentMapper.java`

---

### 2.2 æ”¯ä»˜å›è°ƒé“¾è·¯ï¼šä»æ”¯ä»˜ç½‘å…³å›è°ƒåˆ°è®¢å•çŠ¶æ€æ›´æ–°

**å…¥å£ç‚¹ï¼š**
- æ–‡ä»¶è·¯å¾„: `order-service/src/main/java/com/jiaoyi/order/controller/StripeWebhookController.java:69`
- æ–¹æ³•: `handleWebhook(String payload, String sigHeader)`

**å®Œæ•´å›è°ƒæµç¨‹ï¼š**

```
Stripe/æ”¯ä»˜å® Webhook HTTP POST â†’ StripeWebhookController.handleWebhook()
  â”œâ”€ éªŒè¯è¯·æ±‚ä½“éç©º
  â”œâ”€ éªŒè¯Webhookç­¾å (Webhook.constructEvent)
  â””â”€ è§£æEventäº‹ä»¶
      â†“
äº‹ä»¶åˆ†å‘ (æ ¹æ®event.getType())
  â”œâ”€ "payment_intent.succeeded" â†’ handlePaymentIntentSucceeded()
  â”œâ”€ "payment_intent.payment_failed" â†’ handlePaymentIntentFailed()
  â”œâ”€ "charge.succeeded" â†’ handleChargeSucceeded()
  â””â”€ "charge.failed" â†’ handleChargeFailed()
      â†“
handlePaymentIntentSucceeded() (@Transactional, è¡Œ181)
  â”œâ”€ 1ï¸âƒ£ äº‹ä»¶å¹‚ç­‰æ€§ä¿è¯
  â”‚   â””â”€ webhookEventLogService.tryInsert(eventId, eventType)
  â”‚       â””â”€ æ•°æ®åº“å”¯ä¸€çº¦æŸ uk_webhook_event_id
  â”œâ”€ 2ï¸âƒ£ è§£æPaymentIntent â†’ æå–orderId, paymentIntentId, latestChargeId
  â”œâ”€ 3ï¸âƒ£ è·å–åˆ†å¸ƒå¼é” (redissonClient.getLock)
  â”‚   â””â”€ lockKey = "payment:callback:orderId"
  â”œâ”€ 4ï¸âƒ£ æŸ¥è¯¢è®¢å• (orderMapper.selectById)
  â”œâ”€ 5ï¸âƒ£ æ£€æŸ¥è®¢å•çŠ¶æ€
  â”‚   â””â”€ åªæœ‰PENDINGçŠ¶æ€æ‰èƒ½è½¬åˆ°PAID
  â”œâ”€ 6ï¸âƒ£ æ›´æ–°æ”¯ä»˜è®°å½•ä¸ºSUCCESS
  â”‚   â””â”€ paymentMapper.updateStatus()
  â”œâ”€ 7ï¸âƒ£ ã€å…³é”®ã€‘æ›´æ–°è®¢å•çŠ¶æ€ä¸ºPAID
  â”‚   â””â”€ orderMapper.updateStatusIfPending(orderId, PENDING=1, PAID=2)
  â”‚       â””â”€ SQL: UPDATE orders SET status=2 WHERE id=? AND status=1
  â”‚           (ä¹è§‚é”ç¡®ä¿åªæœ‰PENDINGæ‰èƒ½è½¬åˆ°PAID)
  â”œâ”€ 8ï¸âƒ£ ã€å…³é”®ã€‘å†™Outboxä»»åŠ¡ï¼ˆåº“å­˜æ‰£å‡ï¼‰
  â”‚   â””â”€ outboxHelper.enqueueDeductStockTask(orderId, orderItems)
  â”‚       â””â”€ ç”ŸæˆOutboxè®°å½• (type=DEDUCT_STOCK_HTTP)
  â”‚       â””â”€ å¼‚æ­¥Handlerå¤„ç†ï¼šè°ƒç”¨ProductService.deductStockBatch()
  â”œâ”€ 9ï¸âƒ£ è®°å½•æ”¯ä»˜å›è°ƒæ—¥å¿— (paymentCallbackLogMapper.insert)
  â””â”€ ç«‹å³è¿”å› 200 OK
      â†“
OutboxServiceåå°å¼‚æ­¥å¤„ç†ï¼ˆäº‹åŠ¡æäº¤åè§¦å‘ï¼‰
  â”œâ”€ è‡ªåŠ¨claimä¸ºPROCESSING
  â”œâ”€ æ‰§è¡Œhandler (DeductStockHttpOutboxHandler)
  â”‚   â””â”€ ProductServiceClient.deductStockBatch(productIds, skuIds, quantities)
  â””â”€ æ ‡è®°ä¸ºSUCCESSæˆ–FAILEDï¼ˆå¤±è´¥åˆ™é‡è¯•ï¼‰
```

**å…³é”®æ–‡ä»¶ï¼š**
- StripeWebhookController: `order-service/src/main/java/com/jiaoyi/order/controller/StripeWebhookController.java`
- PaymentCallbackLogMapper: `order-service/src/main/java/com/jiaoyi/order/mapper/PaymentCallbackLogMapper.java`
- WebhookEventLogService: `order-service/src/main/java/com/jiaoyi/order/service/WebhookEventLogService.java`

---

### 2.3 OutboxæŠ•é€’é“¾è·¯ï¼šä»äº‹ä»¶ç”Ÿæˆåˆ°æ¶ˆæ¯æŠ•é€’

**å…³é”®ç±»æ–‡ä»¶ï¼š**
- OutboxService: `outbox-starter/src/main/java/com/jiaoyi/outbox/OutboxService.java`
- OutboxDispatcher: `outbox-starter/src/main/java/com/jiaoyi/outbox/OutboxDispatcher.java`
- OutboxCleanupTask: `outbox-starter/src/main/java/com/jiaoyi/outbox/OutboxCleanupTask.java`

**å®Œæ•´æµç¨‹ï¼š**

```
1. åœ¨ä¸šåŠ¡äº‹åŠ¡ä¸­å†™å…¥Outboxï¼ˆåŒåº“åŒäº‹åŠ¡ï¼‰
   outboxService.enqueue(
       type="DEDUCT_STOCK_HTTP",
       bizKey=orderId,
       payload={productIds, skuIds, quantities, ...},
       shardingKey=storeId  // ç”¨äºShardingSphereåˆ†åº“è·¯ç”±
   )
   â”œâ”€ OutboxServiceCore.enqueue()
   â”‚   â””â”€ å†™å…¥outboxè¡¨ (INSERT INTO outbox VALUES ...)
   â”‚       â””â”€ çŠ¶æ€=NEW
   â”œâ”€ æ³¨å†Œäº‹åŠ¡åŒæ­¥å›è°ƒ
   â”‚   â””â”€ TransactionSynchronizationManager.registerSynchronization()
   â””â”€ ä¸šåŠ¡äº‹åŠ¡æäº¤åè§¦å‘afterCommit()
      â†“
2. åå°å¼‚æ­¥å¤„ç†ï¼ˆTaskExecutorå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»äº‹åŠ¡ï¼‰
   processTask(outboxId)
   â”œâ”€ 1ï¸âƒ£ å°è¯•Claimä»»åŠ¡
   â”‚   â””â”€ outboxRepository.claim(outboxId, instanceId, lockUntil)
   â”‚       â””â”€ UPDATE outbox
   â”‚           SET status=PROCESSING, lock_owner=?, lock_until=?
   â”‚           WHERE id=? AND (status=NEW OR lock_until<NOW)
   â”œâ”€ 2ï¸âƒ£ è·å–å¯¹åº”Handler
   â”‚   â””â”€ applicationContext.getBean(type+"Handler")
   â”‚       â””â”€ å¯¹äºDEDUCT_STOCK_HTTP â†’ DeductStockHttpOutboxHandler
   â”œâ”€ 3ï¸âƒ£ æ‰§è¡ŒHandler.handle(outbox)
   â”‚   â””â”€ DeductStockHttpOutboxHandler.handle()
   â”‚       â””â”€ ProductServiceClient.deductStockBatch(productIds, skuIds, quantities)
   â”‚           â””â”€ è¿œç¨‹è°ƒç”¨ï¼ˆHTTP RESTæˆ–FeignClientï¼‰
   â”œâ”€ 4ï¸âƒ£ æ›´æ–°OutboxçŠ¶æ€
   â”‚   â”œâ”€ æˆåŠŸ â†’ status=SENT
   â”‚   â””â”€ å¤±è´¥ â†’ status=FAILED, nextRetryTime=NOW+å»¶è¿Ÿ
   â””â”€ æœ€åè¿”å›
      â†“
3. å®šæ—¶é‡è¯•ä»»åŠ¡ï¼ˆOutboxCleanupTaskï¼Œåå°çº¿ç¨‹å®šæ—¶æ‰«è¡¨ï¼‰
   â”œâ”€ æ¯åˆ†é’Ÿæ‰«ä¸€æ¬¡
   â”œâ”€ æŸ¥è¯¢ status=FAILED AND nextRetryTime<=NOW
   â”œâ”€ Claimå¹¶é‡æ–°æ‰§è¡ŒHandler
   â”œâ”€ é‡è¯•æ¬¡æ•°<=MAX_RETRY_COUNT (20æ¬¡)
   â”œâ”€ è¶…è¿‡é‡è¯•æ¬¡æ•° â†’ status=DEADï¼ˆæ­»ä¿¡ï¼Œäººå·¥å¤„ç†ï¼‰
   â””â”€ æˆåŠŸ â†’ status=SENT, completedAt=NOW
```

**å…³é”®äº‹åŠ¡éš”ç¦»ï¼š**
- Outboxå†™å…¥ä¸ä¸šåŠ¡æ•°æ®åœ¨åŒä¸€æ•°æ®åº“äº‹åŠ¡ä¸­ï¼ˆåˆ†åº“åˆ†è¡¨ï¼Œä½¿ç”¨storeIdè·¯ç”±ï¼‰
- Handleræ‰§è¡Œå¼‚æ­¥ï¼ˆäº‹åŠ¡æäº¤åè§¦å‘ï¼‰ï¼Œå¤±è´¥è‡ªåŠ¨é‡è¯•
- æ”¯æŒMQå’ŒHTTPä¸¤ç§æŠ•é€’æ–¹å¼

---

## ğŸ”„ ä¸‰ã€çŠ¶æ€æœºè¿ç§»è¡¨

### 3.1 è®¢å•çŠ¶æ€æœº

**æ–‡ä»¶ï¼š** `order-service/src/main/java/com/jiaoyi/order/enums/OrderStatusEnum.java`

| çŠ¶æ€ä»£ç  | çŠ¶æ€å | æè¿° | è§¦å‘æ¡ä»¶ |
|---------|------|------|--------|
| 1 | PENDING | å·²ä¸‹å•å¾…æ”¯ä»˜ | åˆ›å»ºè®¢å•æ—¶åˆå§‹åŒ– |
| 2 | PAID | å·²æ”¯ä»˜ | æ”¯ä»˜æˆåŠŸå›è°ƒ (updateStatusIfPending) |
| 9 | WAITING_ACCEPT | å¾…æ¥å• | æ”¯ä»˜åï¼Œç­‰å¾…å•†å®¶æ¥å• |
| 3 | PREPARING | åˆ¶ä½œä¸­ | å•†å®¶æ¥å•å |
| 8 | DELIVERING | é…é€ä¸­ | åˆ¶ä½œå®Œæˆï¼Œéª‘æ‰‹å–å• |
| 4 | COMPLETED | å·²å®Œæˆ | é…é€å®Œæˆæˆ–è‡ªæå®Œæˆ |
| 5 | CANCELLED | å·²å–æ¶ˆ | ç”¨æˆ·/å•†å®¶ä¸»åŠ¨å–æ¶ˆ |
| 6 | REFUNDED | å·²é€€æ¬¾ | é€€æ¬¾æˆåŠŸ |
| 7 | PAY_FAILED | æ”¯ä»˜å¤±è´¥ | æ”¯ä»˜å¤±è´¥å›è°ƒ |

**çŠ¶æ€è½¬æ¢çŸ©é˜µï¼š**

```
PENDING (1)
  â†“ (æ”¯ä»˜æˆåŠŸ)
PAID (2)
  â”œâ”€ (å•†å®¶æ¥å•) â†’ WAITING_ACCEPT (9) â†’ PREPARING (3)
  â”œâ”€ (è¶…æ—¶å–æ¶ˆ) â†’ CANCELLED (5)
  â””â”€ (é€€æ¬¾æˆåŠŸ) â†’ REFUNDED (6)

PREPARING (3)
  â”œâ”€ (åˆ¶ä½œå®Œæˆ) â†’ DELIVERING (8)
  â””â”€ (å–æ¶ˆ) â†’ CANCELLED (5)

DELIVERING (8)
  â”œâ”€ (é…é€å®Œæˆ) â†’ COMPLETED (4)
  â””â”€ (å–æ¶ˆ) â†’ CANCELLED (5)

COMPLETED (4), CANCELLED (5), REFUNDED (6), PAY_FAILED (7)
  â””â”€ (ç»ˆæ€ï¼Œä¸å…è®¸è½¬æ¢)

æ”¯ä»˜è¶…æ—¶: PENDING â†’ PAY_FAILED (30åˆ†é’Ÿæœªæ”¯ä»˜)
```

**é£é™©ç‚¹ï¼š** çŠ¶æ€è½¬æ¢æ²¡æœ‰æ˜¾å¼çš„çŠ¶æ€æœºå®ç°ï¼Œè€Œæ˜¯é€šè¿‡å„ä¸ªserviceæ–¹æ³•éšå¼å¤„ç†ï¼Œæ˜“å¯¼è‡´éæ³•è½¬æ¢ã€‚

---

### 3.2 æ”¯ä»˜çŠ¶æ€æœº

**æ–‡ä»¶ï¼š** `order-service/src/main/java/com/jiaoyi/order/enums/PaymentStatusEnum.java`

| çŠ¶æ€ä»£ç  | çŠ¶æ€å | æè¿° | è§¦å‘äº‹ä»¶ |
|---------|------|------|---------|
| 0 | PENDING | å¾…æ”¯ä»˜ | åˆ›å»ºPaymentè®°å½• |
| 100 | SUCCESS | æ”¯ä»˜æˆåŠŸ | æ”¯ä»˜æˆåŠŸå›è°ƒ |
| 200 | FAILED | æ”¯ä»˜å¤±è´¥ | æ”¯ä»˜å¤±è´¥å›è°ƒ |

**çŠ¶æ€è½¬æ¢ï¼š**

```
PENDING (0)
  â”œâ”€ (æ”¯ä»˜æˆåŠŸå›è°ƒ) â†’ SUCCESS (100)
  â””â”€ (æ”¯ä»˜å¤±è´¥å›è°ƒ) â†’ FAILED (200)

SUCCESS (100), FAILED (200)
  â””â”€ (ç»ˆæ€)
```

**å…³é”®æ–¹æ³•ï¼š** `PaymentService.processPayment()` (è¡Œ104)
- åˆ›å»ºPaymentè®°å½•æ—¶åˆå§‹ä¸ºPENDING
- Webhookå›è°ƒæ—¶æ›´æ–°ä¸ºSUCCESS/FAILED

---

### 3.3 é€€æ¬¾çŠ¶æ€æœº

**æ–‡ä»¶ï¼š**
- `order-service/src/main/java/com/jiaoyi/order/enums/RefundStatus.java`
- `order-service/src/main/java/com/jiaoyi/order/service/RefundStateMachine.java:21`

| çŠ¶æ€ä»£ç  | çŠ¶æ€å | æè¿° | è§¦å‘äº‹ä»¶ |
|---------|------|------|---------|
| CREATED | å·²åˆ›å»º | é€€æ¬¾å•åˆ›å»º | ç”¨æˆ·/å•†å®¶å‘èµ·é€€æ¬¾ |
| PROCESSING | å¤„ç†ä¸­ | å·²å‘èµ·åˆ°æ”¯ä»˜æ¸ é“ | è°ƒç”¨æ”¯ä»˜ç½‘å…³API |
| SUCCEEDED | æˆåŠŸ | é€€æ¬¾æˆåŠŸ | æ”¯ä»˜ç½‘å…³å›è°ƒæˆåŠŸ |
| FAILED | å¤±è´¥ | é€€æ¬¾å¤±è´¥ | æ”¯ä»˜ç½‘å…³å›è°ƒå¤±è´¥ |
| CANCELED | å·²å–æ¶ˆ | äººå·¥æ’¤é”€ | ä»…CREATEDçŠ¶æ€å¯å–æ¶ˆ |

**çŠ¶æ€è½¬æ¢è§„åˆ™ï¼ˆRefundStateMachine.canTransitionï¼‰ï¼š**

```
CREATED
  â”œâ”€ â†’ PROCESSING (å‘èµ·é€€æ¬¾)
  â””â”€ â†’ CANCELED (äººå·¥å–æ¶ˆï¼Œä»…CREATEDå¯å–æ¶ˆ)

PROCESSING
  â”œâ”€ â†’ SUCCEEDED (é€€æ¬¾æˆåŠŸ)
  â””â”€ â†’ FAILED (é€€æ¬¾å¤±è´¥)

SUCCEEDED, FAILED, CANCELED
  â””â”€ (ç»ˆæ€)

å¹‚ç­‰æ”¯æŒ: ç›¸åŒçŠ¶æ€è½¬æ¢è¿”å›true
é‡è¯•æ”¯æŒ: FAILEDçŠ¶æ€å¯ä»¥é‡æ–°å‘èµ·PROCESSING
```

**ç»ˆæ€æ£€æŸ¥ï¼š** `RefundStateMachine.isTerminalStatus()` (è¡Œ115)

---

## âš ï¸ å››ã€é¢è¯•é£é™©TOP5 + æœ€å°ä¿®è¡¥æ–¹æ¡ˆ

### é£é™©ç‚¹1ï¼šæ”¯ä»˜å›è°ƒå¹¶å‘å¤„ç†ç¼ºé™· â­â­â­â­â­

**é—®é¢˜ä½ç½®ï¼š**
- `StripeWebhookController.handlePaymentIntentSucceeded()` (è¡Œ181)
- `PaymentService.processPayment()` (è¡Œ104)

**é£é™©æè¿°ï¼š**

åŒä¸€è®¢å•çš„æ”¯ä»˜å›è°ƒå¹¶å‘åˆ°è¾¾æ—¶ï¼ˆä¾‹å¦‚Stripeé‡è¯•ï¼‰ï¼Œå¯èƒ½å‡ºç°ï¼š
1. ç¬¬ä¸€ä¸ªå›è°ƒclaimæˆåŠŸï¼Œå¤„ç†ä¸­
2. ç¬¬äºŒä¸ªå›è°ƒclaimå¤±è´¥ï¼ˆlock_untilæœªè¿‡æœŸï¼‰ï¼Œç›´æ¥è¿”å›200
3. å¦‚æœç¬¬ä¸€ä¸ªå›è°ƒå¤„ç†å¤±è´¥ï¼ˆå¼‚å¸¸ï¼‰ï¼Œç¬¬äºŒä¸ªå›è°ƒæ— æ³•é‡æ–°å¤„ç†

**å½“å‰ä»£ç é—®é¢˜ï¼š**
```java
// åªæœ‰PENDINGçŠ¶æ€æ‰èƒ½è½¬åˆ°PAID
int orderUpdated = orderMapper.updateStatusIfPending(
    orderId,
    OrderStatusEnum.PENDING.getCode(),  // oldStatus=1
    OrderStatusEnum.PAID.getCode()       // newStatus=2
);
```

**æœ€å°ä¿®è¡¥æ–¹æ¡ˆï¼š**
```java
// åœ¨handlePaymentIntentSucceeded()ä¸­æ·»åŠ å¹‚ç­‰æ€§é‡è¯•é€»è¾‘
private void handlePaymentIntentSucceeded(Event event) {
    String eventId = event.getId();

    // å¹‚ç­‰æ€§æ£€æŸ¥
    if (webhookEventLogService.isProcessed(eventId)) {
        log.info("äº‹ä»¶å·²å¤„ç†ï¼Œè·³è¿‡: {}", eventId);
        return;
    }

    // è§£æorderId
    String orderId = extractOrderId(event);

    // ä½¿ç”¨åˆ†å¸ƒå¼é”+é‡è¯•æœºåˆ¶
    String lockKey = "payment:callback:" + orderId;
    RLock lock = redissonClient.getLock(lockKey);

    int maxRetries = 3;
    for (int i = 0; i < maxRetries; i++) {
        try {
            if (lock.tryLock(5, 30, TimeUnit.SECONDS)) {
                // æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆä¹è§‚é”ï¼‰
                int updated = orderMapper.updateStatusIfPending(
                    orderId, PENDING, PAID);

                if (updated > 0) {
                    // æˆåŠŸåå†™Outbox
                    outboxHelper.enqueueDeductStockTask(orderId, orderItems);
                    webhookEventLogService.markProcessed(eventId);
                    return;
                } else {
                    // è®¢å•çŠ¶æ€å·²å˜ï¼Œå¯èƒ½å·²è¢«å¤„ç†
                    log.warn("è®¢å•çŠ¶æ€è½¬æ¢å¤±è´¥ï¼Œå¯èƒ½å·²è¢«å¤„ç†: {}", orderId);
                    return;
                }
            }
        } catch (Exception e) {
            log.error("å¤„ç†æ”¯ä»˜å›è°ƒå¤±è´¥ï¼Œé‡è¯• {}/{}", i+1, maxRetries, e);
            if (i < maxRetries - 1) {
                try {
                    Thread.sleep(1000 * (i + 1));  // æŒ‡æ•°é€€é¿
                } catch (InterruptedException ex) {
                    Thread.currentThread().interrupt();
                }
            }
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }

    // æ‰€æœ‰é‡è¯•å¤±è´¥ï¼Œè®°å½•å‘Šè­¦
    log.error("æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°: eventId={}, orderId={}",
        eventId, orderId);
    alertService.sendAlert("æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥", orderId);
}
```

---

### é£é™©ç‚¹2ï¼šä»·æ ¼è®¡ç®—ç²¾åº¦æŸå¤± â­â­â­â­

**é—®é¢˜ä½ç½®ï¼š**
- `OrderController.buildOrderItemsFromRequest()` (è¡Œ200)
- `OrderService.calculateOrderSubtotal()`

**é£é™©æè¿°ï¼š**

ä½¿ç”¨BigDecimalä½†å¯èƒ½å­˜åœ¨èˆå…¥é—®é¢˜ï¼š
```java
// ä½¿ç”¨BigDecimalä½†å¯èƒ½å­˜åœ¨èˆå…¥é—®é¢˜
BigDecimal unitPrice = new BigDecimal(skuPriceObj.toString());
BigDecimal itemTotal = unitPrice.multiply(BigDecimal.valueOf(itemRequest.getQuantity()));
```

é—®é¢˜ï¼š
1. å¦‚æœå•†å“ä»·æ ¼æ˜¯3ä½å°æ•°ï¼ˆå¦‚99.999å…ƒï¼‰ï¼Œä¹˜ä»¥æ•°é‡å¯èƒ½äº§ç”Ÿèˆå…¥è¯¯å·®
2. ä¼˜æƒ ã€ç¨è´¹ã€é…é€è´¹çš„ç´¯åŠ å¯èƒ½äº§ç”Ÿç´¯ç§¯è¯¯å·®
3. å®é™…æ”¯ä»˜é‡‘é¢ä¸é¢„è§ˆä»·æ ¼å¯èƒ½ä¸ä¸€è‡´ï¼ˆé¢è¯•å®˜å®¹æ˜“è´¨ç–‘ï¼‰

**æœ€å°ä¿®è¡¥æ–¹æ¡ˆï¼š**
```java
// 1. ç»Ÿä¸€ä½¿ç”¨å›ºå®šå°æ•°ä½ï¼ˆ2ä½ï¼‰
private static final int DECIMAL_SCALE = 2;
private static final RoundingMode ROUNDING_MODE = RoundingMode.HALF_UP;

private BigDecimal roundPrice(BigDecimal price) {
    return price.setScale(DECIMAL_SCALE, ROUNDING_MODE);
}

// 2. ä»·æ ¼è®¡ç®—æ—¶æ˜¾å¼å››èˆäº”å…¥
BigDecimal itemTotal = unitPrice.multiply(BigDecimal.valueOf(itemRequest.getQuantity()))
    .setScale(DECIMAL_SCALE, RoundingMode.HALF_UP);

// 3. å»ºç«‹ä»·æ ¼ç­¾åéªŒè¯æœºåˆ¶ï¼ˆé˜²ç¯¡æ”¹ï¼‰
public String generatePriceSignature(Order order) {
    String priceStr = order.getSubtotal() + "|" +
                     order.getDiscount() + "|" +
                     order.getDeliveryFee() + "|" +
                     order.getTotal();
    return DigestUtils.md5Hex(priceStr + SECRET_SALT);
}

// 4. åœ¨æ”¯ä»˜å‰éªŒè¯ä»·æ ¼ä¸€è‡´æ€§
public void validateOrderPrice(Order order, String priceSignature) {
    if (!priceSignature.equals(generatePriceSignature(order))) {
        throw new BusinessException("ä»·æ ¼å·²è¢«ç¯¡æ”¹ï¼Œè¯·é‡æ–°ä¸‹å•");
    }
}

// 5. åœ¨OrderService.createOrderä¸­æ·»åŠ éªŒè¯
@Transactional
public Order createOrder(Order order, List<OrderItem> orderItems, String priceSignature) {
    // éªŒè¯ä»·æ ¼ç­¾å
    validateOrderPrice(order, priceSignature);

    // åŸæœ‰é€»è¾‘...
}
```

---

### é£é™©ç‚¹3ï¼šåº“å­˜é”å®šä¸å›æ»šæœºåˆ¶ä¸å®Œå–„ â­â­â­â­

**é—®é¢˜ä½ç½®ï¼š**
- `OrderService.createOrder()` (è¡Œ521-556)

**é£é™©æè¿°ï¼š**

å½“å‰åº“å­˜é”å®šåï¼Œå¦‚æœè®¢å•åˆ›å»ºå¤±è´¥ï¼Œéœ€è¦è§£é”ï¼š
```java
// åº“å­˜é”å®šåï¼Œå¦‚æœè®¢å•åˆ›å»ºå¤±è´¥ï¼Œéœ€è¦è§£é”
try {
    productServiceClient.lockStockBatch(lockRequest);
} catch (Exception e) {
    throw new BusinessException("åº“å­˜ä¸è¶³æˆ–é”å®šå¤±è´¥: " + e.getMessage());
}

// ... åç»­æ“ä½œï¼Œå¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ ...

// åªåœ¨catchå—ä¸­è§£é”ï¼ˆä½†ä¸æ˜¯æ‰€æœ‰å¼‚å¸¸éƒ½è¢«caughtï¼‰
} catch (Exception e) {
    if (productIds != null && !productIds.isEmpty()) {
        productServiceClient.unlockStockBatch(unlockRequest);
    }
    throw e;
}
```

é—®é¢˜ï¼š
1. å¦‚æœå¼‚å¸¸å‘ç”Ÿåœ¨tryå—å†…ï¼Œä½†ä¸æ˜¯åœ¨åº“å­˜é”å®šä¹‹åï¼Œä¸éœ€è¦è§£é”
2. å¦‚æœunlockè°ƒç”¨å¤±è´¥ï¼Œåº“å­˜æ°¸ä¹…è¢«é”å®šï¼ˆ**åº“å­˜æ³„æ¼**ï¼‰
3. æ²¡æœ‰è¶…æ—¶æœºåˆ¶ï¼Œå­¤ç«‹çš„é”æ°¸è¿œå­˜åœ¨

**æœ€å°ä¿®è¡¥æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆAï¼šä½¿ç”¨try-finallyç¡®ä¿è§£é”**
```java
@Transactional
public Order createOrder(Order order, List<OrderItem> orderItems, ...) {
    List<Long> lockedStockIds = new ArrayList<>();
    List<Long> lockedSkuIds = new ArrayList<>();

    try {
        // æ­¥éª¤1ï¼šåº“å­˜é”å®š
        ProductServiceClient.LockStockBatchRequest lockRequest = buildLockRequest(orderItems);
        productServiceClient.lockStockBatch(lockRequest);

        // è®°å½•å·²é”å®šçš„åº“å­˜ID
        lockedStockIds.addAll(lockRequest.getProductIds());
        lockedSkuIds.addAll(lockRequest.getSkuIds());

        // æ­¥éª¤2-Nï¼šè®¢å•åˆ›å»ºé€»è¾‘
        orderMapper.insert(order);
        orderItemMapper.insertBatch(orderItems);

        // æˆåŠŸæ—¶æ¸…ç©ºå·²é”å®šåˆ—è¡¨ï¼ˆä¸éœ€è¦è§£é”ï¼‰
        lockedStockIds.clear();
        lockedSkuIds.clear();

        return order;

    } catch (Exception e) {
        // å¼‚å¸¸æ—¶è§£é”å·²é”å®šçš„åº“å­˜
        if (!lockedStockIds.isEmpty()) {
            try {
                ProductServiceClient.UnlockStockBatchRequest unlockRequest =
                    new ProductServiceClient.UnlockStockBatchRequest();
                unlockRequest.setProductIds(lockedStockIds);
                unlockRequest.setSkuIds(lockedSkuIds);
                unlockRequest.setQuantities(extractQuantities(orderItems));

                productServiceClient.unlockStockBatch(unlockRequest);
                log.info("åº“å­˜è§£é”æˆåŠŸï¼Œå…±è§£é” {} ä¸ªå•†å“", lockedStockIds.size());

            } catch (Exception unlockException) {
                // è®°å½•åº“å­˜æ³„æ¼å‘Šè­¦ï¼ˆéœ€è¦äººå·¥å¤„ç†ï¼‰
                log.error("ã€åº“å­˜æ³„æ¼è­¦å‘Šã€‘è§£é”åº“å­˜å¤±è´¥ï¼Œéœ€è¦äººå·¥å¤„ç†: productIds={}, skuIds={}",
                    lockedStockIds, lockedSkuIds, unlockException);

                // å‘é€å‘Šè­¦ï¼Œè§¦å‘äººå·¥ä»‹å…¥
                alertService.sendAlert("åº“å­˜æ³„æ¼",
                    "è®¢å•åˆ›å»ºå¤±è´¥ä½†åº“å­˜è§£é”å¤±è´¥ï¼ŒproductIds=" + lockedStockIds);

                // å†™å…¥è¡¥å¿ä»»åŠ¡è¡¨ï¼ˆå®šæ—¶ä»»åŠ¡æ‰«æå¤„ç†ï¼‰
                compensationTaskService.createUnlockStockTask(
                    lockedStockIds, lockedSkuIds, order.getId());
            }
        }
        throw e;
    }
}
```

**æ–¹æ¡ˆBï¼šä½¿ç”¨Sagaæ¨¡å¼å¤„ç†è¡¥å¿**
```java
@Transactional
public Order createOrderWithCompensation(Order order, List<OrderItem> orderItems) {
    String compensationId = UUID.randomUUID().toString();

    // Step 1: åº“å­˜é”å®šï¼ˆè®°å½•è¡¥å¿IDï¼‰
    lockStock(productIds, skuIds, quantities, compensationId);

    try {
        // Step 2-N: è®¢å•åˆ›å»ºç›¸å…³æ­¥éª¤
        orderMapper.insert(order);
        orderItemMapper.insertBatch(orderItems);
        // ...

        return order;
    } catch (Exception e) {
        // è§¦å‘è¡¥å¿ï¼šè§£é”åº“å­˜
        unlockStock(compensationId);
        throw e;
    }
}

private void lockStock(List<Long> productIds, List<Long> skuIds,
                      List<Integer> quantities, String compensationId) {
    // è°ƒç”¨åº“å­˜æœåŠ¡ï¼Œä¼ å…¥compensationIdç”¨äºå¹‚ç­‰å’Œè¡¥å¿
    productServiceClient.lockStockWithCompensation(
        productIds, skuIds, quantities, compensationId);
}

private void unlockStock(String compensationId) {
    // é€šè¿‡compensationIdè§£é”ï¼ˆå¹‚ç­‰ï¼‰
    productServiceClient.unlockStockByCompensationId(compensationId);
}
```

---

### é£é™©ç‚¹4ï¼šOutboxäº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜ â­â­â­

**é—®é¢˜ä½ç½®ï¼š**
- `OutboxService.enqueue()` (è¡Œ113)
- `OrderService.createOrder()` (è¡Œ607, orderMapper.insert)

**é£é™©æè¿°ï¼š**

å½“å‰å®ç°ï¼š
```java
@Transactional(transactionManager = "shardingTransactionManager")
public Outbox enqueue(String type, String bizKey, String payload, ...) {
    // å†™outboxè¡¨ï¼ˆä¸ä¸šåŠ¡è¡¨åœ¨åŒä¸€åº“ï¼‰
    Outbox outbox = outboxServiceCore.enqueue(...);

    // äº‹åŠ¡æäº¤åå¼‚æ­¥å¤„ç†
    TransactionSynchronizationManager.registerSynchronization(
        new TransactionSynchronization() {
            public void afterCommit() {
                taskExecutor.execute(() -> processTask(outboxId));
            }
        }
    );
}
```

é—®é¢˜ï¼š
1. å¦‚æœä¸šåŠ¡äº‹åŠ¡å›æ»šï¼ŒOutboxä¹Ÿä¼šå›æ»šï¼Œä½†afterCommitå·²æ³¨å†Œæ— æ³•å–æ¶ˆ
2. afterCommitæ‰§è¡Œæ—¶ï¼Œå¦ä¸€ä¸ªè¯·æ±‚å¯èƒ½å·²ç»claimäº†è¯¥outbox
3. æ²¡æœ‰å¤„ç†TaskExecutoræ‹’ç»å¼‚å¸¸çš„æƒ…å†µï¼ˆ**é˜Ÿåˆ—æ»¡æ—¶**ï¼‰

**æœ€å°ä¿®è¡¥æ–¹æ¡ˆï¼š**
```java
@Transactional(transactionManager = "shardingTransactionManager")
public Outbox enqueue(String type, String bizKey, String payload, String shardingKey) {
    // Step 1: éªŒè¯å‚æ•°
    validatePayload(payload, maxPayloadSize);

    // Step 2: å†™å…¥Outboxï¼ˆä¸ä¸šåŠ¡æ•°æ®åŒåº“åŒäº‹åŠ¡ï¼‰
    Outbox outbox = outboxServiceCore.enqueue(type, bizKey, payload, shardingKey);

    // Step 3: æ³¨å†Œäº‹åŠ¡å›è°ƒï¼Œä½†ä¸ç›´æ¥å¼‚æ­¥æ‰§è¡Œ
    if (TransactionSynchronizationManager.isActualTransactionActive()) {
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    try {
                        // å»¶è¿Ÿå¤„ç†ï¼Œç»™å…¶ä»–claimæœºåˆ¶æ—¶é—´ï¼ˆé¿å…å¹¶å‘å†²çªï¼‰
                        scheduleTask(outbox.getId(), delayMillis=100);

                    } catch (RejectedExecutionException e) {
                        // é˜Ÿåˆ—æ»¡ï¼Œè®°å½•æ—¥å¿—ï¼Œç”±å®šæ—¶æ‰«è¡¨å¤„ç†
                        log.warn("Outboxå¼‚æ­¥å¤„ç†é˜Ÿåˆ—æ»¡ï¼Œå°†ç”±æ‰«è¡¨ä»»åŠ¡å¤„ç†: outboxId={}",
                            outbox.getId());
                        metricsService.incrementCounter("outbox.queue.rejected");

                    } catch (Exception e) {
                        // å…¶ä»–å¼‚å¸¸ä¹Ÿè®°å½•ï¼Œä¸å½±å“ä¸»æµç¨‹
                        log.error("Outboxå¼‚æ­¥å¤„ç†å¤±è´¥ï¼Œå°†ç”±æ‰«è¡¨ä»»åŠ¡å¤„ç†: outboxId={}",
                            outbox.getId(), e);
                    }
                }

                @Override
                public void afterCompletion(int status) {
                    if (status == STATUS_ROLLED_BACK) {
                        // äº‹åŠ¡å›æ»šï¼Œè®°å½•æ—¥å¿—ï¼ˆOutboxä¹Ÿä¼šå›æ»šï¼‰
                        log.info("ä¸šåŠ¡äº‹åŠ¡å›æ»šï¼ŒOutboxè®°å½•å·²å›æ»š: outboxId={}",
                            outbox.getId());
                    }
                }
            }
        );
    }

    return outbox;
}

// å®šæ—¶æ‰«è¡¨ä½œä¸ºå…œåº•ï¼ˆå¤„ç†æœªè¢«å¼‚æ­¥æ‰§è¡Œçš„Outboxï¼‰
@Scheduled(fixedDelay = 5000)  // æ¯5ç§’æ‰«ä¸€æ¬¡
public void scanAndProcessOutbox() {
    try {
        // æŸ¥è¯¢NEWçŠ¶æ€çš„Outboxï¼ˆæœªè¢«claimçš„ï¼‰
        List<Outbox> pendingTasks = outboxRepository.findByStatusAndCreatedAtBefore(
            OutboxStatus.NEW,
            LocalDateTime.now().minusSeconds(10)  // åˆ›å»ºè¶…è¿‡10ç§’çš„
        );

        pendingTasks.forEach(task -> {
            try {
                processTask(task.getId());
            } catch (Exception e) {
                log.error("å®šæ—¶ä»»åŠ¡å¤„ç†Outboxå¤±è´¥: outboxId={}", task.getId(), e);
            }
        });

    } catch (Exception e) {
        log.error("Outboxæ‰«è¡¨ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
    }
}

// ç›‘æ§å‘Šè­¦ï¼šå¦‚æœNEWçŠ¶æ€çš„Outboxå †ç§¯è¶…è¿‡é˜ˆå€¼
@Scheduled(fixedDelay = 60000)  // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
public void monitorOutboxBacklog() {
    long backlogCount = outboxRepository.countByStatus(OutboxStatus.NEW);
    if (backlogCount > 1000) {
        log.error("ã€å‘Šè­¦ã€‘Outboxå †ç§¯è¿‡å¤š: count={}", backlogCount);
        alertService.sendAlert("Outboxå †ç§¯å‘Šè­¦", "NEWçŠ¶æ€å †ç§¯: " + backlogCount);
    }
}
```

---

### é£é™©ç‚¹5ï¼šåˆ†å¸ƒå¼é”æŒæœ‰æ—¶é—´è¿‡é•¿ â­â­â­

**é—®é¢˜ä½ç½®ï¼š**
- `OrderService.createOrder()` (è¡Œ475, 479)

**é£é™©æè¿°ï¼š**

å½“å‰é”æŒæœ‰æ—¶é—´è¿‡é•¿ï¼š
```java
// ç”¨æˆ·çº§åˆ«çš„é”ï¼ŒæŒæœ‰60ç§’
boolean userLockAcquired = userLock.tryLock(5, 60, TimeUnit.SECONDS);

// è®¢å•å†…å®¹çº§åˆ«çš„é”ï¼ŒæŒæœ‰30ç§’
boolean contentLockAcquired = contentLock.tryLock(3, 30, TimeUnit.SECONDS);
```

é—®é¢˜ï¼š
1. **60ç§’å¤ªé•¿**ï¼ŒæœŸé—´ç”¨æˆ·æ— æ³•è¿›è¡Œå…¶ä»–æ“ä½œ
2. å¦‚æœçº¿ç¨‹GCæˆ–IOæ…¢ï¼Œå¯èƒ½å¯¼è‡´é”è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾ï¼Œä½†çº¿ç¨‹ä»åœ¨æ‰§è¡Œï¼ˆ**å¹½çµé”**ï¼‰
3. åˆ†å¸ƒå¼é”æŒæœ‰æœŸé—´ï¼Œå…¶ä»–å®ä¾‹æ— æ³•å¤„ç†è¯¥ç”¨æˆ·çš„è¯·æ±‚

**æœ€å°ä¿®è¡¥æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆAï¼šä½¿ç”¨æ›´çŸ­çš„é”æŒæœ‰æ—¶é—´ + é”ç»­æœŸ**
```java
public Order createOrder(Order order, List<OrderItem> orderItems, ...) {
    String userLockKey = "order:create:user:" + order.getUserId();
    RLock userLock = redissonClient.getLock(userLockKey);

    // ç­‰å¾…5ç§’ï¼ŒæŒæœ‰15ç§’ï¼ˆæ›´çŸ­ï¼‰
    boolean lockAcquired = userLock.tryLock(5, 15, TimeUnit.SECONDS);
    if (!lockAcquired) {
        throw new BusinessException("æ‚¨çš„è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
    }

    // åˆ›å»ºé”ç»­æœŸä»»åŠ¡
    ScheduledExecutorService renewExecutor = Executors.newScheduledThreadPool(1);
    ScheduledFuture<?> renewTask = null;

    try {
        // å¯åŠ¨è‡ªåŠ¨ç»­æœŸï¼ˆæ¯10ç§’ç»­æœŸä¸€æ¬¡ï¼Œç»­æœŸåˆ°å†+10ç§’ï¼‰
        renewTask = renewExecutor.scheduleAtFixedRate(() -> {
            try {
                if (userLock.isHeldByCurrentThread()) {
                    userLock.expireAsync(10, TimeUnit.SECONDS);
                    log.debug("é”ç»­æœŸæˆåŠŸ: {}", userLockKey);
                }
            } catch (Exception e) {
                log.error("é”ç»­æœŸå¤±è´¥: {}", userLockKey, e);
            }
        }, 10, 10, TimeUnit.SECONDS);

        // ä¸šåŠ¡é€»è¾‘
        return doCreateOrder(order, orderItems);

    } finally {
        // å–æ¶ˆç»­æœŸä»»åŠ¡
        if (renewTask != null) {
            renewTask.cancel(true);
        }
        renewExecutor.shutdown();

        // é‡Šæ”¾é”
        if (userLock.isHeldByCurrentThread()) {
            userLock.unlock();
        }
    }
}
```

**æ–¹æ¡ˆBï¼šä½¿ç”¨ä¿¡å·é‡é™åˆ¶å¹¶å‘ï¼ˆæ›´é«˜ååé‡ï¼‰**
```java
// å…¨å±€ä¿¡å·é‡ï¼Œé™åˆ¶åŒæ—¶åˆ›å»ºè®¢å•çš„æ•°é‡
private final Semaphore orderCreationSemaphore = new Semaphore(100);

public Order createOrder(Order order, List<OrderItem> orderItems, ...) {
    // å°è¯•è·å–ä¿¡å·é‡ï¼ˆç­‰å¾…5ç§’ï¼‰
    if (!orderCreationSemaphore.tryAcquire(5, TimeUnit.SECONDS)) {
        throw new BusinessException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }

    try {
        // ä½¿ç”¨æ›´ç»†ç²’åº¦çš„é”ï¼ˆåªé”è®¢å•å†…å®¹ï¼Œä¸é”ç”¨æˆ·ï¼‰
        String contentLockKey = generateContentLockKey(order, orderItems);
        RLock contentLock = redissonClient.getLock(contentLockKey);

        if (!contentLock.tryLock(3, 10, TimeUnit.SECONDS)) {
            throw new BusinessException("è®¢å•æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
        }

        try {
            return doCreateOrder(order, orderItems);
        } finally {
            if (contentLock.isHeldByCurrentThread()) {
                contentLock.unlock();
            }
        }

    } finally {
        orderCreationSemaphore.release();
    }
}

// ç”Ÿæˆè®¢å•å†…å®¹é”Keyï¼ˆåŸºäºè®¢å•å†…å®¹å“ˆå¸Œï¼‰
private String generateContentLockKey(Order order, List<OrderItem> orderItems) {
    String content = order.getMerchantId() + "|" +
                    order.getUserId() + "|" +
                    orderItems.stream()
                        .map(item -> item.getProductId() + ":" + item.getQuantity())
                        .sorted()
                        .collect(Collectors.joining(","));
    return "order:create:content:" + DigestUtils.md5Hex(content);
}
```

**æ–¹æ¡ˆCï¼šä½¿ç”¨Redissonçš„WatchDogæœºåˆ¶ï¼ˆè‡ªåŠ¨ç»­æœŸï¼‰**
```java
public Order createOrder(Order order, List<OrderItem> orderItems, ...) {
    String userLockKey = "order:create:user:" + order.getUserId();
    RLock userLock = redissonClient.getLock(userLockKey);

    // ä½¿ç”¨lock()è€Œä¸æ˜¯tryLockï¼ŒRedissonä¼šè‡ªåŠ¨å¯åŠ¨WatchDogç»­æœŸ
    // WatchDogé»˜è®¤æ¯10ç§’ç»­æœŸåˆ°30ç§’
    boolean lockAcquired = userLock.tryLock(5, TimeUnit.SECONDS);  // ç­‰å¾…5ç§’
    if (!lockAcquired) {
        throw new BusinessException("æ‚¨çš„è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
    }

    try {
        // ä¸šåŠ¡é€»è¾‘
        return doCreateOrder(order, orderItems);
    } finally {
        if (userLock.isHeldByCurrentThread()) {
            userLock.unlock();
        }
    }
}
```

---

## ğŸ“‹ æ€»ç»“è¡¨æ ¼

### é£é™©ç‚¹ä¼˜å…ˆçº§çŸ©é˜µ

| é£é™©ç‚¹ | ä¸¥é‡æ€§ | å½±å“èŒƒå›´ | ä¿®è¡¥æ—¶é—´ | é¢è¯•å…³æ³¨åº¦ | å»ºè®®ä¼˜å…ˆçº§ |
|------|--------|---------|---------|----------|----------|
| 1. æ”¯ä»˜å›è°ƒå¹¶å‘å¤„ç† | â­â­â­â­â­ | æ”¯ä»˜æˆåŠŸç‡ | 2h | æé«˜ï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰ | P0 |
| 2. ä»·æ ¼è®¡ç®—ç²¾åº¦ | â­â­â­â­ | è®¢å•é‡‘é¢å‡†ç¡®æ€§ | 1.5h | é«˜ï¼ˆé‡‘é’±æ•æ„Ÿï¼‰ | P0 |
| 3. åº“å­˜é”å®šå›æ»š | â­â­â­â­ | åº“å­˜æ³„æ¼ | 1.5h | é«˜ï¼ˆåº“å­˜ç®¡ç†ï¼‰ | P1 |
| 4. Outboxäº‹åŠ¡ä¸€è‡´æ€§ | â­â­â­ | æ¶ˆæ¯æŠ•é€’å¯é æ€§ | 2h | ä¸­ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ | P1 |
| 5. åˆ†å¸ƒå¼é”æŒæœ‰æ—¶é—´ | â­â­â­ | ç³»ç»Ÿååé‡ | 1h | ä¸­ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ | P2 |

### é¢è¯•åº”å¯¹ç­–ç•¥

**å¯¹äºP0é£é™©ï¼ˆå¿…é¡»å‡†å¤‡ï¼‰ï¼š**
1. **æ”¯ä»˜å›è°ƒå¹¶å‘**ï¼šå¼ºè°ƒå¹‚ç­‰æ€§è®¾è®¡ã€é‡è¯•æœºåˆ¶ã€äº‹ä»¶å»é‡
2. **ä»·æ ¼è®¡ç®—ç²¾åº¦**ï¼šå¼ºè°ƒé‡‘èçº§ç²¾åº¦æ§åˆ¶ã€é˜²ç¯¡æ”¹æœºåˆ¶ã€å®¡è®¡æ—¥å¿—

**å¯¹äºP1é£é™©ï¼ˆé‡ç‚¹å…³æ³¨ï¼‰ï¼š**
3. **åº“å­˜é”å®šå›æ»š**ï¼šå¼ºè°ƒè¡¥å¿æœºåˆ¶ã€Sagaæ¨¡å¼ã€å‘Šè­¦ç›‘æ§
4. **Outboxäº‹åŠ¡ä¸€è‡´æ€§**ï¼šå¼ºè°ƒæœ€ç»ˆä¸€è‡´æ€§ä¿è¯ã€å…œåº•æœºåˆ¶ã€ç›‘æ§å‘Šè­¦

**å¯¹äºP2é£é™©ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰ï¼š**
5. **åˆ†å¸ƒå¼é”ä¼˜åŒ–**ï¼šå¼ºè°ƒæ€§èƒ½æƒè¡¡ã€WatchDogæœºåˆ¶ã€ä¿¡å·é‡æ›¿ä»£

### å…³é”®æŠ€æœ¯äº®ç‚¹ï¼ˆé¢è¯•åŠ åˆ†é¡¹ï¼‰

1. **Outbox Patternå®ç°**ï¼šç¡®ä¿æ¶ˆæ¯æŠ•é€’ä¸ä¸šåŠ¡æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§
2. **åˆ†åº“åˆ†è¡¨ç­–ç•¥**ï¼šåŸºäºstoreId/merchantIdçš„ShardingSphereåˆ†ç‰‡
3. **é˜²é‡å¤æäº¤**ï¼šå¤šå±‚é˜²æŠ¤ï¼ˆAOP + åˆ†å¸ƒå¼é” + å†…å®¹å“ˆå¸Œï¼‰
4. **æ”¯ä»˜å›è°ƒå¹‚ç­‰**ï¼šwebhook_event_logè¡¨ + æ•°æ®åº“å”¯ä¸€çº¦æŸ
5. **çŠ¶æ€æœºè®¾è®¡**ï¼šè®¢å•/æ”¯ä»˜/é€€æ¬¾çš„çŠ¶æ€æµè½¬ï¼ˆå¯æ”¹è¿›ä¸ºæ˜¾å¼çŠ¶æ€æœºï¼‰

---

## ğŸ“ é¢è¯•å‡†å¤‡å»ºè®®

### 1. æŠ€æœ¯æ·±åº¦é—®é¢˜å‡†å¤‡

**Q1: å¦‚ä½•ä¿è¯æ”¯ä»˜å›è°ƒçš„å¹‚ç­‰æ€§ï¼Ÿ**
```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. webhook_event_logè¡¨è®°å½•å·²å¤„ç†äº‹ä»¶ï¼ˆå”¯ä¸€çº¦æŸuk_webhook_event_idï¼‰
2. åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘å¤„ç†åŒä¸€è®¢å•
3. è®¢å•çŠ¶æ€ä¹è§‚é”ï¼ˆUPDATE WHERE status=PENDINGï¼‰
4. é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ï¼‰
```

**Q2: Outbox Patternå¦‚ä½•ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Ÿ**
```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. Outboxä¸ä¸šåŠ¡æ•°æ®åŒåº“åŒäº‹åŠ¡ï¼ˆåˆ†åº“åˆ†è¡¨ï¼Œä½¿ç”¨storeIdè·¯ç”±ï¼‰
2. äº‹åŠ¡æäº¤åå¼‚æ­¥å¤„ç†ï¼ˆafterCommitå›è°ƒï¼‰
3. å®šæ—¶æ‰«è¡¨å…œåº•ï¼ˆæ¯åˆ†é’Ÿæ‰«æNEW/FAILEDçŠ¶æ€ï¼‰
4. é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š20æ¬¡ï¼Œè¶…è¿‡åˆ™æ ‡è®°ä¸ºDEADäººå·¥å¤„ç†ï¼‰
5. Handlerå¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ŒæˆåŠŸåˆ™æ ‡è®°SENT
```

**Q3: åˆ†åº“åˆ†è¡¨ä¸‹å¦‚ä½•ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ï¼Ÿ**
```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. ä½¿ç”¨ShardingSphereçš„åˆ†ç‰‡ç­–ç•¥ï¼ˆstoreId/merchantIdï¼‰
2. åŒä¸€è®¢å•çš„æ‰€æœ‰æ•°æ®åœ¨åŒä¸€åˆ†ç‰‡ï¼ˆOrder, OrderItem, Payment, Outboxï¼‰
3. è·¨åº“æ“ä½œä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeata/XAï¼‰æˆ–æœ€ç»ˆä¸€è‡´æ€§ï¼ˆOutboxï¼‰
4. é¿å…è·¨åº“JOINæŸ¥è¯¢
```

### 2. ç³»ç»Ÿè®¾è®¡é—®é¢˜å‡†å¤‡

**Q1: å¦‚æœè®¢å•é‡æš´å¢10å€ï¼Œå¦‚ä½•ä¼˜åŒ–ï¼Ÿ**
```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. æ°´å¹³æ‰©å±•ï¼šå¢åŠ order-serviceå®ä¾‹ï¼ŒåŸºäºuserId/storeIdè´Ÿè½½å‡è¡¡
2. ç¼“å­˜ä¼˜åŒ–ï¼šå•†å“ä»·æ ¼ã€åº“å­˜æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆRedisï¼‰
3. å¼‚æ­¥åŒ–ï¼šåº“å­˜æ‰£å‡ã€ä¼˜æƒ åˆ¸ä½¿ç”¨æ”¹ä¸ºå¼‚æ­¥ï¼ˆOutboxæŠ•é€’ï¼‰
4. æ•°æ®åº“ä¼˜åŒ–ï¼šå¢åŠ åˆ†ç‰‡æ•°é‡ã€è¯»å†™åˆ†ç¦»
5. é™æµé™çº§ï¼šé«˜å³°æœŸæ‹’å•ã€ç†”æ–­é™çº§
```

**Q2: å¦‚ä½•è®¾è®¡è®¢å•çŠ¶æ€æœºï¼Ÿ**
```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. ä½¿ç”¨æ˜¾å¼çŠ¶æ€æœºï¼ˆSpring State Machineï¼‰
2. å®šä¹‰çŠ¶æ€ã€äº‹ä»¶ã€è½¬æ¢è§„åˆ™ï¼ˆcanTransitionæ–¹æ³•ï¼‰
3. çŠ¶æ€è½¬æ¢å‰ç½®/åç½®å¤„ç†ï¼ˆStateChangeInterceptorï¼‰
4. æŒä¹…åŒ–çŠ¶æ€æœºçŠ¶æ€ï¼ˆstate_machineè¡¨ï¼‰
5. æ”¯æŒçŠ¶æ€å›æ»šã€è¡¥å¿æ“ä½œ
```

### 3. æ•…éšœæ’æŸ¥é—®é¢˜å‡†å¤‡

**Q1: æ”¯ä»˜æˆåŠŸä½†è®¢å•çŠ¶æ€æœªæ›´æ–°ï¼Œå¦‚ä½•æ’æŸ¥ï¼Ÿ**
```
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥webhook_event_logè¡¨æ˜¯å¦æœ‰è®°å½•ï¼ˆå¹‚ç­‰æ€§æ£€æŸ¥ï¼‰
2. æ£€æŸ¥payment_callback_logè¡¨çš„å›è°ƒæ—¥å¿—
3. æ£€æŸ¥outboxè¡¨æ˜¯å¦æœ‰DEDUCT_STOCKä»»åŠ¡ï¼ˆæœªSENTï¼‰
4. æ£€æŸ¥åˆ†å¸ƒå¼é”æ˜¯å¦è¢«é•¿æ—¶é—´æŒæœ‰ï¼ˆRedisæŸ¥è¯¢ï¼‰
5. æ£€æŸ¥åº”ç”¨æ—¥å¿—ï¼ŒæŸ¥æ‰¾å¼‚å¸¸å †æ ˆ
6. æ£€æŸ¥æ•°æ®åº“äº‹åŠ¡æ˜¯å¦å›æ»š
```

**Q2: åº“å­˜æ³„æ¼å¦‚ä½•å‘ç°å’Œå¤„ç†ï¼Ÿ**
```
ç­”æ¡ˆè¦ç‚¹ï¼š
å‘ç°ï¼š
1. ç›‘æ§locked_stockè¡¨ï¼Œå¯¹æ¯”è®¢å•çŠ¶æ€
2. å®šæ—¶ä»»åŠ¡æ‰«æè¶…æ—¶æœªé‡Šæ”¾çš„é”ï¼ˆ>1å°æ—¶ï¼‰
3. å‘Šè­¦ç³»ç»Ÿç›‘æ§åº“å­˜å·®å¼‚

å¤„ç†ï¼š
1. æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼Œå¦‚æœå¤±è´¥åˆ™æ‰‹åŠ¨è§£é”
2. è¡¥å¿ä»»åŠ¡è¡¨è®°å½•ï¼Œå®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤„ç†
3. äººå·¥ä»‹å…¥ï¼Œé€šè¿‡ç®¡ç†åå°è§£é”
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

### ç«‹å³ä¿®å¤ï¼ˆé¢è¯•å‰å¿…åšï¼‰
1. âœ… ä¿®å¤æ”¯ä»˜å›è°ƒå¹¶å‘é—®é¢˜ï¼ˆé£é™©1ï¼‰
2. âœ… å¢åŠ ä»·æ ¼ç­¾åéªŒè¯ï¼ˆé£é™©2ï¼‰
3. âœ… å®Œå–„åº“å­˜è§£é”å¼‚å¸¸å¤„ç†ï¼ˆé£é™©3ï¼‰

### ä¼˜åŒ–æ”¹è¿›ï¼ˆæ—¶é—´å…è®¸ï¼‰
4. å¢åŠ Outboxé˜Ÿåˆ—æ»¡å¤„ç†ï¼ˆé£é™©4ï¼‰
5. ä¼˜åŒ–åˆ†å¸ƒå¼é”æŒæœ‰æ—¶é—´ï¼ˆé£é™©5ï¼‰
6. å®ç°æ˜¾å¼çŠ¶æ€æœºï¼ˆè®¢å•/æ”¯ä»˜/é€€æ¬¾ï¼‰
7. å¢åŠ ç›‘æ§å‘Šè­¦ï¼ˆåº“å­˜æ³„æ¼ã€Outboxå †ç§¯ã€æ”¯ä»˜å›è°ƒå¤±è´¥ï¼‰

### æ–‡æ¡£å‡†å¤‡
8. å‡†å¤‡æ¶æ„å›¾ï¼ˆæ¨¡å—å…³ç³»ã€æ•°æ®æµï¼‰
9. å‡†å¤‡æ ¸å¿ƒæµç¨‹æ—¶åºå›¾ï¼ˆä¸‹å•ã€æ”¯ä»˜ã€é€€æ¬¾ï¼‰
10. å‡†å¤‡æŠ€æœ¯é€‰å‹è¯´æ˜ï¼ˆä¸ºä»€ä¹ˆç”¨Outboxã€ShardingSphereï¼‰

---

**æŠ¥å‘Šç»“æŸ**

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥åˆ†æï¼Œè¯·éšæ—¶è”ç³»ã€‚
