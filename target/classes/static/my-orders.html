<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è®¢å•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .user-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .user-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .user-input {
            display: flex;
            gap: 15px;
            align-items: end;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .filter-tabs {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .filter-tabs ul {
            list-style: none;
            display: flex;
            margin: 0;
            padding: 0;
        }
        
        .filter-tabs li {
            flex: 1;
        }
        
        .filter-tabs a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: #666;
            text-align: center;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .filter-tabs a:hover,
        .filter-tabs a.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background-color: #f8f9ff;
        }
        
        .orders-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .order-card {
            border-bottom: 1px solid #eee;
            padding: 20px;
            transition: background-color 0.3s;
        }
        
        .order-card:hover {
            background-color: #f8f9fa;
        }
        
        .order-card:last-child {
            border-bottom: none;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .order-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .order-no {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .order-time {
            color: #666;
            font-size: 14px;
        }
        
        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-shipped {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-delivered {
            background-color: #d4edda;
            color: #155724;
        }
        
        .order-items {
            margin-bottom: 15px;
        }
        
        .order-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .item-image {
            width: 60px;
            height: 60px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .item-specs {
            color: #666;
            font-size: 14px;
        }
        
        .item-price {
            font-weight: 600;
            color: #e74c3c;
        }
        
        .order-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .order-total {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #999;
        }
        
        .message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 10px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background-color: #f8f9fa;
            border-color: #667eea;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .active {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .user-input {
                flex-direction: column;
                align-items: stretch;
            }
            
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .order-summary {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .order-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ æˆ‘çš„è®¢å•</h1>
            <p>æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„è®¢å•ä¿¡æ¯</p>
        </div>
        
        <!-- ç”¨æˆ·ä¿¡æ¯è¾“å…¥ -->
        <div class="user-info">
            <h3>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h3>
            <div class="user-input">
                <div class="form-group">
                    <label for="userId">ç”¨æˆ·ID</label>
                    <input type="number" id="userId" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·ID" value="1001">
                </div>
                <button class="btn btn-primary" onclick="loadMyOrders()">ğŸ” æŸ¥çœ‹æˆ‘çš„è®¢å•</button>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æç¤ºåŒºåŸŸ -->
        <div id="messageArea"></div>
        
        <!-- è®¢å•çŠ¶æ€ç­›é€‰ -->
        <div class="filter-tabs">
            <ul>
                <li><a href="#" class="active" onclick="filterOrders('ALL')">å…¨éƒ¨è®¢å•</a></li>
                <li><a href="#" onclick="filterOrders('PENDING')">å¾…æ”¯ä»˜</a></li>
                <li><a href="#" onclick="filterOrders('PAID')">å·²æ”¯ä»˜</a></li>
                <li><a href="#" onclick="filterOrders('SHIPPED')">å·²å‘è´§</a></li>
                <li><a href="#" onclick="filterOrders('DELIVERED')">å·²é€è¾¾</a></li>
                <li><a href="#" onclick="filterOrders('CANCELLED')">å·²å–æ¶ˆ</a></li>
            </ul>
        </div>
        
        <!-- è®¢å•åˆ—è¡¨ -->
        <div class="orders-container">
            <div id="loadingIndicator" class="loading" style="display: none;">
                <p>â³ æ­£åœ¨åŠ è½½æ‚¨çš„è®¢å•...</p>
            </div>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>ğŸ˜” æš‚æ— è®¢å•</h3>
                <p>æ‚¨è¿˜æ²¡æœ‰ä»»ä½•è®¢å•ï¼Œå¿«å»é€‰è´­å•†å“å§ï¼</p>
            </div>
            
            <div id="ordersList">
            </div>
        </div>
        
        <!-- åˆ†é¡µ -->
        <div class="pagination" id="pagination" style="display: none;">
        </div>
    </div>
    
    <script>
        let currentUserId = null;
        let currentStatus = 'ALL';
        let currentPage = 1;
        let pageSize = 5;
        let totalPages = 1;
        let allOrders = [];
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è®¢å•
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥URLå‚æ•°ä¸­çš„ç”¨æˆ·ID
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            if (userId) {
                document.getElementById('userId').value = userId;
                loadMyOrders();
            } else {
                loadMyOrders();
            }
        });
        
        // åŠ è½½æˆ‘çš„è®¢å•
        async function loadMyOrders() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                showMessage('è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }
            
            currentUserId = userId;
            await loadOrders(1);
        }
        
        // åŠ è½½è®¢å•åˆ—è¡¨
        async function loadOrders(page = 1) {
            if (!currentUserId) return;
            
            showLoading(true);
            hideMessage();
            
            try {
                let url = `/api/orders/user/${currentUserId}`;
                
                // å¦‚æœä¸æ˜¯å…¨éƒ¨çŠ¶æ€ï¼Œæ·»åŠ çŠ¶æ€ç­›é€‰
                if (currentStatus !== 'ALL') {
                    url += `/status/${currentStatus}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.code === 200) {
                    allOrders = result.data;
                    currentPage = page;
                    totalPages = Math.ceil(allOrders.length / pageSize);
                    
                    displayOrders();
                    displayPagination();
                    
                    if (allOrders.length === 0) {
                        showMessage('æš‚æ— è®¢å•æ•°æ®', 'success');
                    }
                } else {
                    showMessage('åŠ è½½è®¢å•å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ç­›é€‰è®¢å•
        function filterOrders(status) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.filter-tabs a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
            
            currentStatus = status;
            currentPage = 1;
            displayOrders();
            displayPagination();
        }
        
        // æ˜¾ç¤ºè®¢å•åˆ—è¡¨
        function displayOrders() {
            const ordersList = document.getElementById('ordersList');
            const emptyState = document.getElementById('emptyState');
            
            // åº”ç”¨çŠ¶æ€ç­›é€‰
            let filteredOrders = allOrders;
            if (currentStatus !== 'ALL') {
                filteredOrders = allOrders.filter(order => order.status === currentStatus);
            }
            
            // åº”ç”¨åˆ†é¡µ
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageOrders = filteredOrders.slice(start, end);
            
            if (pageOrders.length === 0) {
                ordersList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            ordersList.innerHTML = pageOrders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-info">
                            <div class="order-no">è®¢å•å·: ${order.orderNo}</div>
                            <div class="order-time">ä¸‹å•æ—¶é—´: ${formatDateTime(order.createTime)}</div>
                        </div>
                        <div class="order-status status-${order.status.toLowerCase()}">
                            ${getStatusText(order.status)}
                        </div>
                    </div>
                    
                    <div class="order-items">
                        ${order.orderItems ? order.orderItems.map(item => `
                            <div class="order-item">
                                <div class="item-image">ğŸ“¦</div>
                                <div class="item-info">
                                    <div class="item-name">${item.productName}</div>
                                    <div class="item-specs">æ•°é‡: ${item.quantity} | å•ä»·: Â¥${item.unitPrice}</div>
                                </div>
                                <div class="item-price">Â¥${item.subtotal}</div>
                            </div>
                        `).join('') : ''}
                    </div>
                    
                    <div class="order-summary">
                        <div class="order-total">
                            æ€»è®¡: Â¥${order.actualAmount || order.totalAmount}
                            ${order.discountAmount > 0 ? `<span style="color: #28a745; font-size: 14px;">(å·²ä¼˜æƒ Â¥${order.discountAmount})</span>` : ''}
                        </div>
                        <div class="order-actions">
                            ${getOrderActions(order)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // è·å–è®¢å•æ“ä½œæŒ‰é’®
        function getOrderActions(order) {
            let actions = `<button class="btn btn-sm btn-secondary" onclick="viewOrderDetail(${order.id})">æŸ¥çœ‹è¯¦æƒ…</button>`;
            
            switch (order.status) {
                case 'PENDING':
                    actions += `<button class="btn btn-sm btn-primary" onclick="payOrder(${order.id})">ç«‹å³æ”¯ä»˜</button>`;
                    actions += `<button class="btn btn-sm btn-danger" onclick="cancelOrder(${order.id})">å–æ¶ˆè®¢å•</button>`;
                    break;
                case 'PAID':
                    actions += `<button class="btn btn-sm btn-success" onclick="confirmReceived(${order.id})">ç¡®è®¤æ”¶è´§</button>`;
                    break;
                case 'SHIPPED':
                    actions += `<button class="btn btn-sm btn-success" onclick="confirmReceived(${order.id})">ç¡®è®¤æ”¶è´§</button>`;
                    break;
                case 'DELIVERED':
                    actions += `<button class="btn btn-sm btn-secondary" onclick="reorder(${order.id})">å†æ¬¡è´­ä¹°</button>`;
                    break;
                case 'CANCELLED':
                    actions += `<button class="btn btn-sm btn-secondary" onclick="reorder(${order.id})">é‡æ–°è´­ä¹°</button>`;
                    break;
            }
            
            return actions;
        }
        
        // æ˜¾ç¤ºåˆ†é¡µ
        function displayPagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            let paginationHTML = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            paginationHTML += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            
            // é¡µç æŒ‰é’®
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span>...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span>...</span>`;
                }
                paginationHTML += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            paginationHTML += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            
            pagination.innerHTML = paginationHTML;
            pagination.style.display = 'flex';
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
        function goToPage(page) {
            currentPage = page;
            displayOrders();
            displayPagination();
        }
        
        // æ”¯ä»˜è®¢å•
        function payOrder(orderId) {
            if (confirm('ç¡®å®šè¦æ”¯ä»˜è¿™ä¸ªè®¢å•å—ï¼Ÿ')) {
                // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°æ”¯ä»˜é¡µé¢æˆ–è°ƒç”¨æ”¯ä»˜æ¥å£
                showMessage('è·³è½¬åˆ°æ”¯ä»˜é¡µé¢...', 'success');
                // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
                setTimeout(() => {
                    loadMyOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
                }, 2000);
            }
        }
        
        // å–æ¶ˆè®¢å•
        async function cancelOrder(orderId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/orders/${orderId}/status?status=CANCELLED`, {
                    method: 'PUT'
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    showMessage('è®¢å•å·²å–æ¶ˆ', 'success');
                    loadMyOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
                } else {
                    showMessage('å–æ¶ˆè®¢å•å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }
        
        // ç¡®è®¤æ”¶è´§
        async function confirmReceived(orderId) {
            if (!confirm('ç¡®å®šå·²æ”¶åˆ°å•†å“å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/orders/${orderId}/status?status=DELIVERED`, {
                    method: 'PUT'
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    showMessage('ç¡®è®¤æ”¶è´§æˆåŠŸ', 'success');
                    loadMyOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
                } else {
                    showMessage('ç¡®è®¤æ”¶è´§å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }
        
        // é‡æ–°è´­ä¹°
        function reorder(orderId) {
            showMessage('é‡æ–°è´­ä¹°åŠŸèƒ½å¼€å‘ä¸­...', 'success');
        }
        
        // æŸ¥çœ‹è®¢å•è¯¦æƒ…
        async function viewOrderDetail(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                const result = await response.json();
                
                if (result.code === 200) {
                    const order = result.data;
                    alert(`è®¢å•è¯¦æƒ…:\nè®¢å•å·: ${order.orderNo}\nçŠ¶æ€: ${getStatusText(order.status)}\næ€»é‡‘é¢: Â¥${order.totalAmount}\nå®é™…æ”¯ä»˜: Â¥${order.actualAmount || order.totalAmount}\næ”¶è´§äºº: ${order.receiverName}\næ”¶è´§åœ°å€: ${order.receiverAddress}`);
                } else {
                    showMessage('è·å–è®¢å•è¯¦æƒ…å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('ordersList').style.display = show ? 'none' : 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('pagination').style.display = show ? 'none' : 'flex';
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    hideMessage();
                }, 3000);
            }
        }
        
        // éšè—æ¶ˆæ¯
        function hideMessage() {
            document.getElementById('messageArea').innerHTML = '';
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'å¾…æ”¯ä»˜',
                'PAID': 'å·²æ”¯ä»˜',
                'SHIPPED': 'å·²å‘è´§',
                'DELIVERED': 'å·²é€è¾¾',
                'CANCELLED': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
